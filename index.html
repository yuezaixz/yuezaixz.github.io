<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="大胃吴的闲话唠嗑">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="大胃吴的闲话唠嗑">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="大胃吴的闲话唠嗑">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/"/>

  <title> 大胃吴的闲话唠嗑 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">大胃吴的闲话唠嗑</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">扯扯技术，唠唠闲话 交流email-xiao303178394@gmail.com</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-首页">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            menu.首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-文章">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            menu.文章
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/05/18/stupid-man-s-dfs-bfs/" itemprop="url">
                  学渣的拓扑排序
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2020-05-18T19:53:43+08:00" content="2020-05-18">
              2020-05-18
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="学渣的拓扑排序"><a href="#学渣的拓扑排序" class="headerlink" title="学渣的拓扑排序"></a>学渣的拓扑排序</h1><p>看了好久的 DFS和BFS题目，还是想不到怎么简单解释清楚拓扑排序。</p>
<p>比较标准的解释就是<br>给定一个包含 n 个节点的有向图 G，我们给出它的节点编号的一种排列，如果满足</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">对于图 G 中的任意一条有向边 (u, v)，u 在排列中都出现在 V 的前面。</div></pre></td></tr></table></figure>
<p>那么称该排列是图 G 的「拓扑排序」。</p>
<p>如果实在理解不了，就记住是一个有向图，但他可以有一些节点独立，他不能存在环。</p>
<h2 id="DFS-深度优先搜索"><a href="#DFS-深度优先搜索" class="headerlink" title="DFS 深度优先搜索"></a>DFS 深度优先搜索</h2><p>如果对二叉树比较熟，那么先序遍历就类似于深度优先搜索。</p>
<p>比如</p>
<table>
<thead>
<tr>
<th>a</th>
<th>→</th>
<th>→</th>
</tr>
</thead>
<tbody>
<tr>
<td>↓</td>
<td>↓</td>
<td>↓</td>
</tr>
<tr>
<td>b</td>
<td>c</td>
<td>d</td>
</tr>
<tr>
<td>↓</td>
<td></td>
<td>↓</td>
</tr>
<tr>
<td>e</td>
<td></td>
<td>f</td>
</tr>
<tr>
<td></td>
<td></td>
<td>↓</td>
</tr>
<tr>
<td></td>
<td></td>
<td>g</td>
</tr>
</tbody>
</table>
<p>那么 a 先放进备忘录memo，备忘录中的元素有3种状态</p>
<ul>
<li>未遍历,记住nil或者0</li>
<li>遍历中,记住1</li>
<li>遍历结束,记住2</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">a 0 b 1 c 2 d 3 e 4 f 5 g 6</div><div class="line">// 先序条件</div><div class="line">edges: [d: [f], b: [e], a: [b, c, d], f: [g]]</div><div class="line"></div><div class="line">// 那么备忘录中的状态变化就是</div><div class="line">遍历a [a: 1] </div><div class="line">找到a的后续节点 b, c, d</div><div class="line">遍历b [b: 1, a: 1]</div><div class="line">找到b的后续节点 e</div><div class="line">遍历e [b: 1, e: 1, a: 1]</div><div class="line">e没有后续节点了，结束标记为2，</div><div class="line">退回到b，b也没有后续节点了，结束标记为2，</div><div class="line">退回到a，遍历a的第二个后续节点c</div><div class="line">遍历c [b: 2, e: 2, a: 1, c: 1]</div><div class="line">c没有后续节点了，结束标记为2，退回到a，继续遍历a的下一个后续节点d</div><div class="line">遍历d [b: 2, e: 2, d: 1, a: 1, c: 2]</div><div class="line">找到d的后续节点 f</div><div class="line">遍历f [b: 2, e: 2, d: 1, 5: 1, a: 1, c: 2]</div><div class="line">找到f的后续节点 g</div><div class="line">遍历g [g: 1, f: 1, e: 2, d: 1, a: 1, b: 2, c: 2]</div><div class="line">g没有后续节点了，结束标记为2，退回到f</div><div class="line">f没有后续节点了，结束标记为2，退回到d</div><div class="line">d没有后续节点了，结束标记为2，退回到a</div><div class="line">a没有后续节点了，结束标记为2，结束</div></pre></td></tr></table></figure>
<p>如果要记录遍历顺序，标记为2的时候，就可以放入results了。<br>由于是深度优先，所以results要reverse下。</p>
<p>如果存在环，那么就会出现要遍历他的时候，他已经是遍历中的状态了，那么这时候就可以直接返回，并标识这不是一个拓扑结构。</p>
<h3 id="例题-课程表"><a href="#例题-课程表" class="headerlink" title="例题-课程表"></a>例题-课程表</h3><p>现在你总共有 n 门课需要选，记为 0 到 n-1。</p>
<p>在选修某些课程之前需要一些先修课程。 例如，想要学习课程 0 ，你需要先完成课程 1 ，我们用一个匹配来表示他们: [0,1]</p>
<p>给定课程总量以及它们的先决条件，返回你为了学完所有课程所安排的学习顺序。</p>
<p>可能会有多个正确的顺序，你只要返回一种就可以了。如果不可能完成所有课程，返回一个空数组。</p>
<p><a href="https://leetcode-cn.com/problems/course-schedule-ii" target="_blank" rel="external">直达链接</a></p>
<h4 id="解题"><a href="#解题" class="headerlink" title="解题"></a>解题</h4><p>前面分析很多了，直接上源码吧</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">findOrder</span><span class="params">(<span class="number">_</span> numCourses: Int, <span class="number">_</span> prerequisites: [[Int]])</span></span> -&gt; [<span class="type">Int</span>] &#123;</div><div class="line">        <span class="keyword">var</span> edges: [<span class="type">Int</span>: [<span class="type">Int</span>]] = [:]</div><div class="line"></div><div class="line">        <span class="keyword">for</span> prerequisite <span class="keyword">in</span> prerequisites &#123;</div><div class="line">            edges[prerequisite[<span class="number">1</span>], <span class="keyword">default</span>: []].append(prerequisite[<span class="number">0</span>])</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">var</span> memo: [<span class="type">Int</span>: <span class="type">Int</span>] = [:]</div><div class="line">        <span class="keyword">var</span> isInvalid = <span class="literal">false</span></div><div class="line">        <span class="keyword">var</span> result: [<span class="type">Int</span>] = []</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">func</span> <span class="title">dfs</span><span class="params">(<span class="number">_</span> i: Int)</span></span> &#123;</div><div class="line">            memo[i] = <span class="number">1</span></div><div class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> edges[i] ?? [] &#123;</div><div class="line">                <span class="keyword">if</span> memo[j] == <span class="literal">nil</span> &#123;</div><div class="line">                    dfs(j)</div><div class="line">                    <span class="keyword">if</span> isInvalid &#123; <span class="keyword">return</span> &#125;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> memo[j] == <span class="number">1</span> &#123;</div><div class="line">                    isInvalid = <span class="literal">true</span></div><div class="line">                    <span class="keyword">return</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            memo[i] = <span class="number">2</span></div><div class="line">            result.append(i)</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span> ..&lt; numCourses <span class="keyword">where</span> !isInvalid &amp;&amp; memo[i] == <span class="literal">nil</span> &#123;</div><div class="line">            dfs(i)</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> isInvalid &#123; <span class="keyword">return</span> [] &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> result.reversed()</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="BFS-广度优先搜索"><a href="#BFS-广度优先搜索" class="headerlink" title="BFS 广度优先搜索"></a>BFS 广度优先搜索</h2><p>广度优先遍历，就类似中序遍历，一层一层的往下。</p>
<p>广度优先需要一个先进先出的队列，队列初始是没有先序的节点，遍历这些节点并塞入他们的后续节点（有多个先序，还需要判断是否先序全部都完成了，所以还需要一个counter记录其先序节点的数量），并且查找该节点的后续节点。</p>
<h3 id="题目-课程表"><a href="#题目-课程表" class="headerlink" title="题目-课程表"></a>题目-课程表</h3><p>题目一样</p>
<h4 id="解题-1"><a href="#解题-1" class="headerlink" title="解题"></a>解题</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">findOrder</span><span class="params">(<span class="number">_</span> numCourses: Int, <span class="number">_</span> prerequisites: [[Int]])</span></span> -&gt; [<span class="type">Int</span>] &#123;</div><div class="line">        <span class="keyword">var</span> edges: [<span class="type">Int</span>: [<span class="type">Int</span>]] = [:]</div><div class="line">        <span class="keyword">var</span> counter: [<span class="type">Int</span>: <span class="type">Int</span>] = [:]</div><div class="line"></div><div class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> prerequisites &#123;</div><div class="line">            edges[p[<span class="number">1</span>], <span class="keyword">default</span>: []].append(p[<span class="number">0</span>])</div><div class="line">            counter[p[<span class="number">0</span>], <span class="keyword">default</span>: <span class="number">0</span>] += <span class="number">1</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">var</span> queue: [<span class="type">Int</span>] = []</div><div class="line"></div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span> ..&lt; numCourses &#123;</div><div class="line">            <span class="keyword">if</span> counter[i] == <span class="literal">nil</span> &#123;</div><div class="line">                queue.append(i)</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">var</span> result: [<span class="type">Int</span>] = []</div><div class="line"></div><div class="line">        <span class="keyword">while</span> !queue.isEmpty &#123;</div><div class="line">            <span class="keyword">let</span> num = queue.removeFirst()</div><div class="line">            result.append(num)</div><div class="line"></div><div class="line">            <span class="keyword">for</span> e <span class="keyword">in</span> edges[num] ?? [] &#123;</div><div class="line">                <span class="keyword">if</span> <span class="keyword">let</span> <span class="built_in">count</span> = counter[e] &#123;</div><div class="line">                    <span class="keyword">if</span> <span class="built_in">count</span> == <span class="number">1</span> &#123;</div><div class="line">                        queue.append(e)</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        counter[e] = <span class="built_in">count</span> - <span class="number">1</span></div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> result.<span class="built_in">count</span> != numCourses &#123;</div><div class="line">            <span class="keyword">return</span> []</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> result</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/05/17/stupid-man-s-dfs/" itemprop="url">
                  学渣的分治算法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2020-05-17T17:25:30+08:00" content="2020-05-17">
              2020-05-17
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="学渣的分治算法"><a href="#学渣的分治算法" class="headerlink" title="学渣的分治算法"></a>学渣的分治算法</h1><p>个人感觉分治算法和区域动规很像，都是把一个大问题拆解成很多小问题。<br>不同的是区域动规是从上往下。<br>而分治算法是从下往上。</p>
<h2 id="一般步骤："><a href="#一般步骤：" class="headerlink" title="一般步骤："></a>一般步骤：</h2><ul>
<li>分解，将问题划分成若干规模较小的同类问题</li>
<li>求解，当子问题足够小，就可以很容易的得到答案</li>
<li>合并，按原问题的要求，将子问题的解逐层合并构成原问题的解</li>
</ul>
<h2 id="二分法"><a href="#二分法" class="headerlink" title="二分法"></a>二分法</h2><p>分治算法所需时间取决于分解后子问题的个数、子问题的复杂度等。<br>而二分法，其划分简单、均匀，是经常采用的一种有效的方法，如二分检索</p>
<h2 id="解题-输出二叉树"><a href="#解题-输出二叉树" class="headerlink" title="解题-输出二叉树"></a>解题-输出二叉树</h2><p>在一个 m*n 的二维字符串数组中输出二叉树，并遵守以下规则：</p>
<ul>
<li>行数 m 应当等于给定二叉树的高度。</li>
<li>列数 n 应当总是奇数。</li>
<li>根节点的值（以字符串格式给出）应当放在可放置的第一行正中间。根节点所在的行与列会将剩余空间划分为两部分（左下部分和右下部分）。你应该将左子树输出在左下部分，右子树输出在右下部分。左下和右下部分应当有相同的大小。即使一个子树为空而另一个非空，你不需要为空的子树输出任何东西，但仍需要为另一个子树留出足够的空间。然而，如果两个子树都为空则不需要为它们留出任何空间。</li>
<li>每个未使用的空间应包含一个空的字符串””。</li>
<li>使用相同的规则输出子树。</li>
</ul>
<p><a href="https://leetcode-cn.com/problems/print-binary-tree" target="_blank" rel="external">直达链接</a></p>
<h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>这道题需要先构建二位数组，所以需要先递归获取到高度，通过高度计算出宽度。<br>然后就可以简单的通过二分搜索来填充这个二位数组了。</p>
<h3 id="解题"><a href="#解题" class="headerlink" title="解题"></a>解题</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TreeNode</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">var</span> val: <span class="type">Int</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">var</span> <span class="keyword">left</span>: <span class="type">TreeNode</span>?</div><div class="line">    <span class="keyword">public</span> <span class="keyword">var</span> <span class="keyword">right</span>: <span class="type">TreeNode</span>?</div><div class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(<span class="number">_</span> val: <span class="type">Int</span>) &#123;</div><div class="line">        <span class="keyword">self</span>.val = val</div><div class="line">        <span class="keyword">self</span>.<span class="keyword">left</span> = <span class="literal">nil</span></div><div class="line">        <span class="keyword">self</span>.<span class="keyword">right</span> = <span class="literal">nil</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">printTree</span><span class="params">(<span class="number">_</span> root: TreeNode?)</span></span> -&gt; [[<span class="type">String</span>]] &#123;</div><div class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> root = root <span class="keyword">else</span> &#123; <span class="keyword">return</span> [] &#125;</div><div class="line">        <span class="keyword">if</span> root.<span class="keyword">left</span> == <span class="literal">nil</span> &amp;&amp; root.<span class="keyword">right</span> == <span class="literal">nil</span> &#123; <span class="keyword">return</span> [[<span class="type">String</span>(root.val)]] &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">let</span> height = treeHeight(root)</div><div class="line">        <span class="keyword">let</span> width = <span class="number">2</span> &lt;&lt; (height - <span class="number">1</span>) - <span class="number">1</span></div><div class="line">        <span class="built_in">print</span>(height, width)</div><div class="line">        </div><div class="line">        <span class="keyword">var</span> result = <span class="type">Array</span>(repeating: <span class="type">Array</span>(repeating: <span class="string">""</span>, <span class="built_in">count</span>: width), <span class="built_in">count</span>: height)</div><div class="line">        </div><div class="line">        dfs(root, result: &amp;result, start: <span class="number">0</span>, end: width - <span class="number">1</span>, deep: <span class="number">0</span>)</div><div class="line">        </div><div class="line">        <span class="keyword">return</span> result</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">dfs</span><span class="params">(<span class="number">_</span> root: TreeNode?, result: <span class="keyword">inout</span> [[String]] ,start: Int, end: Int, deep: Int)</span></span> &#123;</div><div class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> root = root <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</div><div class="line">        <span class="keyword">let</span> mid = (start + end) &gt;&gt; <span class="number">1</span></div><div class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="keyword">left</span> = root.<span class="keyword">left</span> &#123;</div><div class="line">            dfs(<span class="keyword">left</span>, result: &amp;result, start: start, end: mid - <span class="number">1</span>, deep: deep + <span class="number">1</span>)</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="keyword">right</span> = root.<span class="keyword">right</span> &#123;</div><div class="line">            dfs(<span class="keyword">right</span>, result: &amp;result, start: mid + <span class="number">1</span>, end: end, deep: deep + <span class="number">1</span>)</div><div class="line">        &#125;</div><div class="line">        result[deep][mid] = <span class="type">String</span>(root.val)</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">treeHeight</span><span class="params">(<span class="number">_</span> root: TreeNode?)</span></span> -&gt; <span class="type">Int</span> &#123;</div><div class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> root = root <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="number">0</span> &#125;</div><div class="line">        <span class="keyword">if</span> root.<span class="keyword">left</span> == <span class="literal">nil</span> &amp;&amp; root.<span class="keyword">right</span> == <span class="literal">nil</span> &#123; <span class="keyword">return</span> <span class="number">1</span> &#125;</div><div class="line">        <span class="keyword">return</span> <span class="built_in">max</span>(treeHeight(root.<span class="keyword">left</span>), treeHeight(root.<span class="keyword">right</span>)) + <span class="number">1</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="double-100"><a href="#double-100" class="headerlink" title="double 100%"></a>double 100%</h3><p><img src="http://image.runmaf.com/2020-05-17-15897074475037.jpg" alt=""></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/05/17/stupid-man-s-area-dp/" itemprop="url">
                  学渣的区域动规
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2020-05-17T11:07:41+08:00" content="2020-05-17">
              2020-05-17
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="学渣的区域动规"><a href="#学渣的区域动规" class="headerlink" title="学渣的区域动规"></a>学渣的区域动规</h1><p>区域动规主要是把一个问题分成具有相同复杂度的小问题，以便从小到大解决问题。</p>
<p>概念比较生硬，直接拿题目来说吧。</p>
<h2 id="沟通交流"><a href="#沟通交流" class="headerlink" title="沟通交流"></a>沟通交流</h2><p>mail: xiao303178394@gmail.com<br>wechat: xiao303178394</p>
<h2 id="青蛙过河"><a href="#青蛙过河" class="headerlink" title="青蛙过河"></a>青蛙过河</h2><p>一只青蛙想要过河。 假定河流被等分为 x 个单元格，并且在每一个单元格内都有可能放有一石子（也有可能没有）。 青蛙可以跳上石头，但是不可以跳入水中。</p>
<p>给定石子的位置列表（用单元格序号升序表示）， 请判定青蛙能否成功过河（即能否在最后一步跳至最后一个石子上）。 开始时， 青蛙默认已站在第一个石子上，并可以假定它第一步只能跳跃一个单位（即只能从单元格1跳至单元格2）。</p>
<p>如果青蛙上一步跳跃了 k 个单位，那么它接下来的跳跃距离只能选择为 k - 1、k 或 k + 1个单位。 另请注意，青蛙只能向前方（终点的方向）跳跃。</p>
<p><a href="https://leetcode-cn.com/problems/frog-jump" target="_blank" rel="external">直达链接：</a></p>
<h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>把问题化解成一堆小问题。</p>
<ul>
<li>能否跳到位置需要为0的石头？可以，跳0步</li>
<li>能否跳到位置为1的石头？上一步跳了0，那么这一步跳0+1,所以可以跳到</li>
<li>能否跳到位置为i的石头？上一步跳到k，跳了j（j可能有几种情况或），那么 stones[i] = (stones[k] + j + 1 ) || (stones[k] + j ) || (stones[k] + j - 1 )成立的话，就可以跳到</li>
<li>…</li>
</ul>
<h3 id="转移方程"><a href="#转移方程" class="headerlink" title="转移方程"></a>转移方程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">// j in dp[k], i = k + j</div><div class="line">if k in dp and i in dp:</div><div class="line">	dp[i] = Set[所有满足条件的j]</div></pre></td></tr></table></figure>
<h3 id="状态标识"><a href="#状态标识" class="headerlink" title="状态标识"></a>状态标识</h3><p>stones 为输入数列<br>m 为数字的数量</p>
<p>dp是一个Dict<int: set<int="">&gt;的数据结构<br>key是i，i为位置序号<br>value为跳到i的跳跃距离集合，所以dp[i][j]存在则代表可以通过最后一步j的跳远距离，跳跃到序号为i的石头</int:></p>
<p>k标识上一步的位置序号</p>
<h3 id="边界"><a href="#边界" class="headerlink" title="边界"></a>边界</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">dp[0] = Set[0]</div></pre></td></tr></table></figure>
<h3 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h3><p>dp[stones[m - 1]] 非空</p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">canCross</span><span class="params">(<span class="number">_</span> stones: [Int])</span></span> -&gt; <span class="type">Bool</span> &#123;</div><div class="line">        <span class="keyword">let</span> m = stones.<span class="built_in">count</span></div><div class="line">        <span class="keyword">if</span> m &lt;= <span class="number">1</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">true</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">var</span> dp = <span class="type">Dictionary</span>&lt;<span class="type">Int</span>, <span class="type">Set</span>&lt;<span class="type">Int</span>&gt;&gt;()</div><div class="line">        </div><div class="line">        <span class="keyword">for</span> stone <span class="keyword">in</span> stones &#123;</div><div class="line">            dp[stone] = <span class="type">Set</span>&lt;<span class="type">Int</span>&gt;()</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        dp[stones[<span class="number">0</span>]]?.insert(<span class="number">0</span>)</div><div class="line">        </div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span> ..&lt; m &#123;</div><div class="line">            <span class="keyword">let</span> curr = stones[i]</div><div class="line">            <span class="keyword">let</span> si = dp[curr]!</div><div class="line">            </div><div class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> si &#123;</div><div class="line">                <span class="keyword">for</span> j <span class="keyword">in</span> k - <span class="number">1</span> ... k + <span class="number">1</span> &#123;</div><div class="line">                    <span class="keyword">if</span> dp.keys.<span class="built_in">contains</span>(curr + j) &#123;</div><div class="line">                        dp[curr + j]?.insert(j)</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">return</span> !dp[stones[m - <span class="number">1</span>]]!.isEmpty</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">assert</span>(<span class="type">Solution</span>().canCross([<span class="number">0</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">8</span>,<span class="number">12</span>,<span class="number">17</span>]) == <span class="literal">true</span>)</div><div class="line"><span class="built_in">assert</span>(<span class="type">Solution</span>().canCross([<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">11</span>]) == <span class="literal">false</span>)</div><div class="line"><span class="built_in">assert</span>(<span class="type">Solution</span>().canCross([<span class="number">0</span>,<span class="number">2</span>]) == <span class="literal">false</span>)</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/05/17/stupid-man-s-linear-dp/" itemprop="url">
                  学渣的线性动规
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2020-05-17T00:20:33+08:00" content="2020-05-17">
              2020-05-17
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="学渣的线性动规"><a href="#学渣的线性动规" class="headerlink" title="学渣的线性动规"></a>学渣的线性动规</h1><p>线性DP比较好的例子就是 三角形最小路径和，LIS，LCS问题了。</p>
<h2 id="LIS"><a href="#LIS" class="headerlink" title="LIS"></a>LIS</h2><p>给定一个无序的整数数组，找到其中最长上升子序列的长度。</p>
<p><a href="https://leetcode-cn.com/problems/longest-increasing-subsequence/" target="_blank" rel="external">直达链接</a></p>
<h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>给定n个整数A1,A2,A3…An。按照从左往右的顺序选择尽可能多的整数，组成一个上升子序列，其中相邻元素不能相等</p>
<h3 id="转移方程"><a href="#转移方程" class="headerlink" title="转移方程"></a>转移方程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">dp[i]=max&#123;1+dp[j]&#125;(0&lt;=j&lt;i,s[j]&lt;s[i])</div></pre></td></tr></table></figure>
<h3 id="边界"><a href="#边界" class="headerlink" title="边界"></a>边界</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">dp[0] = 1</div></pre></td></tr></table></figure>
<h3 id="状态标识"><a href="#状态标识" class="headerlink" title="状态标识"></a>状态标识</h3><p>s 为输入数列<br>dp[i]表示以s[i]为结尾的“最大上升子序列长度”</p>
<h3 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h3><p>max{dp[i]}(0&lt;=i&lt;n)</p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">lis</span><span class="params">(<span class="number">_</span> s: [Int])</span></span> -&gt; <span class="type">Int</span> &#123;</div><div class="line">        <span class="keyword">var</span> dp = <span class="type">Array</span>(repeating: <span class="number">1</span>, <span class="built_in">count</span>: s.<span class="built_in">count</span>)</div><div class="line">        </div><div class="line">        <span class="keyword">var</span> result = <span class="number">0</span></div><div class="line">        </div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span> ..&lt; dp.<span class="built_in">count</span> &#123;</div><div class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="number">0</span> ..&lt; i &#123;</div><div class="line">                <span class="keyword">if</span> s[j] &lt; s[i] &#123;</div><div class="line">                    dp[i] = <span class="built_in">max</span>(dp[i], dp[j] + <span class="number">1</span>)</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            result = <span class="built_in">max</span>(dp[i], result)</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">return</span> result</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="LCS解1，二位数组"><a href="#LCS解1，二位数组" class="headerlink" title="LCS解1，二位数组"></a>LCS解1，二位数组</h2><p>给定两个字符串 text1 和 text2，返回这两个字符串的最长公共子序列的长度。</p>
<p><a href="https://leetcode-cn.com/problems/longest-common-subsequence/" target="_blank" rel="external">直达链接</a></p>
<h3 id="问题描述-1"><a href="#问题描述-1" class="headerlink" title="问题描述"></a>问题描述</h3><p>给定两个长度分别为n,m的字符串a,b,求既是a的子序列，又是b的子序列的字符串的长度最长是多少</p>
<h3 id="转移方程-1"><a href="#转移方程-1" class="headerlink" title="转移方程"></a>转移方程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">if a[i] == b[j]:</div><div class="line">	dp[i][j] = dp[i - 1][j - 1] + 1</div><div class="line">else:</div><div class="line">	dp[i][j] = max(dp[i - 1][j], dp[i][j - 1])</div></pre></td></tr></table></figure>
<h3 id="边界-1"><a href="#边界-1" class="headerlink" title="边界"></a>边界</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">dp[i][0] = 0</div><div class="line">dp[0][j] = 0</div></pre></td></tr></table></figure>
<h3 id="状态标识-1"><a href="#状态标识-1" class="headerlink" title="状态标识"></a>状态标识</h3><p>a,b 为输入字符串<br>n,m 为a,b的长度</p>
<p>dp[i][j]表示a[0 ..&lt; i]与b[0 ..&lt; j]的最长公共子序列的长度</p>
<h3 id="目标-1"><a href="#目标-1" class="headerlink" title="目标"></a>目标</h3><p>dp[n][m]</p>
<h3 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">longestCommonSubsequence</span><span class="params">(<span class="number">_</span> a: String, <span class="number">_</span> b: String)</span></span> -&gt; <span class="type">Int</span> &#123;</div><div class="line">        <span class="keyword">let</span> m = a.<span class="built_in">count</span></div><div class="line">        <span class="keyword">let</span> n = b.<span class="built_in">count</span></div><div class="line">        <span class="keyword">if</span> m == <span class="number">0</span> || n == <span class="number">0</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">var</span> dp = <span class="type">Array</span>(repeating: <span class="type">Array</span>(repeating: <span class="number">0</span>, <span class="built_in">count</span>: n + <span class="number">1</span>), <span class="built_in">count</span>: m + <span class="number">1</span>)</div><div class="line">        </div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1</span> ... m &#123;</div><div class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="number">1</span> ... n &#123;</div><div class="line">                <span class="keyword">if</span> a[a.index(a.startIndex, offsetBy: i - <span class="number">1</span>)] == b[b.index(b.startIndex, offsetBy: j - <span class="number">1</span>)] &#123;</div><div class="line">                    dp[i][j] = dp[i - <span class="number">1</span>][j - <span class="number">1</span>] + <span class="number">1</span></div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    dp[i][j] = <span class="built_in">max</span>(dp[i-<span class="number">1</span>][j], dp[i][j-<span class="number">1</span>])</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">return</span> dp[m][n]</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><p>但是用二位数组，时间复杂度在leetcode上过不了关，所以得考虑其他动态方案的方式。</p>
<h2 id="LCS解2，一维数组"><a href="#LCS解2，一维数组" class="headerlink" title="LCS解2，一维数组"></a>LCS解2，一维数组</h2><p>几个优化的点</p>
<ul>
<li>一个是用一维数组</li>
<li>二是不用String而是一开始就把String转成Array<character>，加快查询和修改的效率</character></li>
</ul>
<h3 id="转移方程-2"><a href="#转移方程-2" class="headerlink" title="转移方程"></a>转移方程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">// a.count &gt; b.count</div><div class="line"></div><div class="line">if a[j] == b[i]:</div><div class="line">	dp[j] = dp[j - 1] + 1</div><div class="line">else:</div><div class="line">	dp[j] = max(dp[j - 1], dp[j])</div></pre></td></tr></table></figure>
<h3 id="边界-2"><a href="#边界-2" class="headerlink" title="边界"></a>边界</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">dp[0] = 0</div></pre></td></tr></table></figure>
<h3 id="状态标识-2"><a href="#状态标识-2" class="headerlink" title="状态标识"></a>状态标识</h3><p>a,b 为输入字符串转换的数组<br>m, n 为a,b的长度， m &gt;= n</p>
<p>dp[j]表示a[0 ..&lt; j]与b的最长公共子序列的长度</p>
<h3 id="目标-2"><a href="#目标-2" class="headerlink" title="目标"></a>目标</h3><p>dp[m]</p>
<h3 id="实现-2"><a href="#实现-2" class="headerlink" title="实现"></a>实现</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">longestCommonSubsequence</span><span class="params">(<span class="number">_</span> text1: String, <span class="number">_</span> text2: String)</span></span> -&gt; <span class="type">Int</span> &#123;</div><div class="line">        <span class="keyword">var</span> a = text1</div><div class="line">        <span class="keyword">var</span> b = text2</div><div class="line">        <span class="keyword">var</span> m = a.<span class="built_in">count</span></div><div class="line">        <span class="keyword">var</span> n = b.<span class="built_in">count</span></div><div class="line">        </div><div class="line">        <span class="keyword">if</span> m == <span class="number">0</span> || n == <span class="number">0</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span></div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> m &lt; n &#123;</div><div class="line">            <span class="keyword">let</span> temp = m</div><div class="line">            m = n</div><div class="line">            n = temp</div><div class="line">            a = text2</div><div class="line">            b = text1</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">var</span> dp = <span class="type">Array</span>(repeating: <span class="number">0</span>, <span class="built_in">count</span>: m + <span class="number">1</span>)</div><div class="line">        </div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1</span> ... n &#123;</div><div class="line">            <span class="keyword">var</span> cur = <span class="number">0</span></div><div class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="number">1</span> ... m &#123;</div><div class="line">                <span class="keyword">let</span> leftTop = cur</div><div class="line">                cur = dp[j]</div><div class="line">                <span class="keyword">if</span> a[a.index(a.startIndex, offsetBy: j - <span class="number">1</span>)] == b[b.index(b.startIndex, offsetBy: i - <span class="number">1</span>)] &#123;</div><div class="line">                    dp[j] = leftTop + <span class="number">1</span></div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    dp[j] = <span class="built_in">max</span>(dp[j - <span class="number">1</span>], dp[j])</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">            </div><div class="line">        <span class="keyword">return</span> dp[m]</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="double-100"><a href="#double-100" class="headerlink" title="double 100%"></a>double 100%</h3><p><img src="http://image.runmaf.com/2020-05-17-15896421497757.jpg" alt=""></p>
<h2 id="三角形最小路径和"><a href="#三角形最小路径和" class="headerlink" title="三角形最小路径和"></a>三角形最小路径和</h2><p>给定一个三角形，找出自顶向下的最小路径和。每一步只能移动到下一行中相邻的结点上。</p>
<p>相邻的结点 在这里指的是 下标 与 上一层结点下标 相同或者等于 上一层结点下标 + 1 的两个结点。</p>
<p><a href="https://leetcode-cn.com/problems/triangle" target="_blank" rel="external">直达链接</a></p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>题目有表示用空间复杂度为O(n)有加分，那么肯定要考虑用一位数组来动态规划了。</p>
<h3 id="转移方程-3"><a href="#转移方程-3" class="headerlink" title="转移方程"></a>转移方程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">dp[j] = triangle[i][j] + min(dp[j], dp[i])</div></pre></td></tr></table></figure>
<h3 id="边界-3"><a href="#边界-3" class="headerlink" title="边界"></a>边界</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">dp[0] = triangle[0][0]</div></pre></td></tr></table></figure>
<h3 id="状态标识-3"><a href="#状态标识-3" class="headerlink" title="状态标识"></a>状态标识</h3><p>triangle 为三角形的二维数组<br>m为行数，n为最后一行列数<br>i为行索引，j为列索引</p>
<h3 id="目标-3"><a href="#目标-3" class="headerlink" title="目标"></a>目标</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">min&#123;dp[0 ..&lt; n]&#125;</div></pre></td></tr></table></figure>
<h3 id="实现-3"><a href="#实现-3" class="headerlink" title="实现"></a>实现</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">minimumTotal</span><span class="params">(<span class="number">_</span> triangle: [[Int]])</span></span> -&gt; <span class="type">Int</span> &#123;</div><div class="line">        <span class="keyword">let</span> columnCount = triangle.<span class="built_in">count</span></div><div class="line">        </div><div class="line">        <span class="keyword">if</span> columnCount &lt;= <span class="number">1</span> &#123;</div><div class="line">            <span class="keyword">return</span> triangle.first?.first ?? <span class="number">0</span></div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">var</span> dp = <span class="type">Array</span>(repeating: <span class="type">Int</span>.<span class="built_in">max</span>, <span class="built_in">count</span>: triangle.last?.<span class="built_in">count</span> ?? <span class="number">0</span>)</div><div class="line">        dp[<span class="number">0</span>] = triangle.first?.first ?? <span class="number">0</span></div><div class="line">        </div><div class="line">        <span class="keyword">for</span> columnIndex <span class="keyword">in</span> <span class="number">1</span> ..&lt; columnCount &#123;</div><div class="line">            <span class="keyword">let</span> row = triangle[columnIndex]</div><div class="line">            <span class="keyword">let</span> rowCount = row.<span class="built_in">count</span></div><div class="line">            </div><div class="line">            <span class="keyword">var</span> lastLeft = <span class="type">Int</span>.<span class="built_in">max</span></div><div class="line">            </div><div class="line">            <span class="keyword">for</span> rowIndex <span class="keyword">in</span> <span class="number">0</span> ..&lt; rowCount &#123;</div><div class="line">                <span class="keyword">let</span> temp = lastLeft</div><div class="line">                lastLeft = dp[rowIndex]</div><div class="line">                dp[rowIndex] = row[rowIndex] + <span class="built_in">min</span>(temp, dp[rowIndex])</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> dp.<span class="built_in">min</span>() ?? <span class="number">0</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">assert</span>(<span class="type">Solution</span>().minimumTotal([[<span class="number">2</span>],[<span class="number">3</span>, <span class="number">4</span>],[<span class="number">6</span>, <span class="number">5</span>, <span class="number">7</span>],[<span class="number">4</span>,<span class="number">1</span>,<span class="number">8</span>,<span class="number">3</span>]]) == <span class="number">11</span>)</div></pre></td></tr></table></figure>
<h3 id="double-100-1"><a href="#double-100-1" class="headerlink" title="double 100%"></a>double 100%</h3><p><img src="http://image.runmaf.com/2020-05-17-15896455723167.jpg" alt=""></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/05/16/stupid-man-s-dp/" itemprop="url">
                  学渣的DP动态规划算法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2020-05-16T00:19:18+08:00" content="2020-05-16">
              2020-05-16
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="学渣的DP动态规划算法"><a href="#学渣的DP动态规划算法" class="headerlink" title="学渣的DP动态规划算法"></a>学渣的DP动态规划算法</h1><h2 id="什么是DP"><a href="#什么是DP" class="headerlink" title="什么是DP"></a>什么是DP</h2><p>对于非算法专业的渣渣，看各种专业的解释有点脑壳疼。不过悟出了点自己的感觉，记录下。</p>
<p>其实拿递归来理解会比较好理解，毕竟递归大家大学都学过，很容易懂。</p>
<font color="red">递归是从上往下方式，而DP则是从下往上的。</font>

<p>算法其实都是计算机的穷举，只是怎么更聪明更高效更节省空间的穷举。拿斐波列次数列来理解是最好不过的了。</p>
<h3 id="斐波列次的递归Swift实现"><a href="#斐波列次的递归Swift实现" class="headerlink" title="斐波列次的递归Swift实现"></a>斐波列次的递归Swift实现</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">fibonacci</span><span class="params">(<span class="number">_</span> n: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</div><div class="line">        <span class="keyword">if</span> n == <span class="number">0</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span> <span class="comment">// 987次</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> n == <span class="number">1</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>  <span class="comment">// 1597次</span></div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">return</span> fibonacci(n - <span class="number">1</span>) + fibonacci(n - <span class="number">2</span>)  <span class="comment">// 2583次</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">assert</span>(<span class="type">Solution</span>().fibonacci(<span class="number">17</span>) == <span class="number">1597</span>)</div></pre></td></tr></table></figure>
<p>怎么样，是不是很恐怖，看似优雅的递归方式，执行次数竟然这么多，效率如此低，要是大点的数就完全算不出来了。</p>
<h3 id="斐波列次的DP算法Swift实现"><a href="#斐波列次的DP算法Swift实现" class="headerlink" title="斐波列次的DP算法Swift实现"></a>斐波列次的DP算法Swift实现</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">class Solution &#123;</div><div class="line">    func dpFibonacci(_ n: Int) -&gt; Int &#123;</div><div class="line">        var dp = Array.init(repeating: 0, count: n + 1)</div><div class="line">        dp[0] = 0</div><div class="line">        dp[1] = 1</div><div class="line">        for i in 2 ..&lt; dp.count &#123;</div><div class="line">            dp[i] = dp[i - 1] + dp[i - 2] // 16次</div><div class="line">        &#125;</div><div class="line">        return dp[n]</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">assert(Solution().dpFibonacci(17) == 1597)</div></pre></td></tr></table></figure>
<p>怎么样，是不是觉得效果更高了。<br>我们直接从最底下，最简单，问题规模最小的 f(1) 和 f(2) 开始往上推，直到推到我们想要的答案 f(20)。</p>
<h2 id="状态转移方程"><a href="#状态转移方程" class="headerlink" title="状态转移方程"></a>状态转移方程</h2><p>状态转移方程是解决DP问题的核心,其实也就代表着暴力破解的方式,但不要小看暴力破解.</p>
<p>比如斐波列次数列的状态转移方式就是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">dp[i] = dp[i-1] + dp[i-2]</div></pre></td></tr></table></figure>
<p>这算比较简单的，复杂实例前，先让了解下几种动态规划的类型：</p>
<ul>
<li>线性动规</li>
<li>区域动规</li>
<li>树形动规</li>
<li>背包动规</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>下篇文章树下线性动规划</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/04/05/native-app-flutter-hybrid-in-flutter-boost/" itemprop="url">
                  移动端的flutter_boost混编实现
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2020-04-05T00:11:22+08:00" content="2020-04-05">
              2020-04-05
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="移动端的flutter-boost混编实现"><a href="#移动端的flutter-boost混编实现" class="headerlink" title="移动端的flutter_boost混编实现"></a>移动端的flutter_boost混编实现</h1><h2 id="Flutter简介"><a href="#Flutter简介" class="headerlink" title="Flutter简介"></a>Flutter简介</h2><p>Flutter是谷歌的全平台UI框架，使用dart语法，在移动端通过Skia渲染，可以快速在iOS和Android上构建高质量的原生用户界面，其优势在于</p>
<ul>
<li>极高的开发与交付效率，良好的开发体验</li>
<li>优秀的跨多端多平台能力</li>
<li>极强的UI表现力</li>
</ul>
<p><a href="https://flutterchina.club/get-started/install/" target="_blank" rel="external">环境搭建参考</a></p>
<h2 id="flutter混编架构方案"><a href="#flutter混编架构方案" class="headerlink" title="flutter混编架构方案"></a>flutter混编架构方案</h2><p>VV iOS组目前已完成了较好的组件化架构，很多通用业务层都已经组件化了，比如Login等。Flutter模块再自己在实现就难免重复造轮子了，因此，我们可以创建<a href="https://flutter.dev/docs/development/packages-and-plugins/developing-packages" target="_blank" rel="external">flutter plugin</a>与原生的交互，类似于一种C-S模型。其中Flutter为Client层，原生为Server层，两者通过MethodChannel进行消息通信，原生端向Flutter提供已有的Native组件功能。<br>然后将Flutter Plugin上传到私有<a href="https://flutter.dev/docs/development/packages-and-plugins/using-packages" target="_blank" rel="external">pub</a>库。<br>这时候创建<a href="https://flutter.dev/docs/development/add-to-app/ios/project-setup" target="_blank" rel="external">flutter module</a>，依赖需要的plugin，并添加<a href="https://github.com/alibaba/flutter_boost" target="_blank" rel="external">flutter boost</a>依赖，再在原生工程中依赖这个module就好了。<br>当flutter开发已经有一定规模时候，module甚至可以按业务再拆分成多个业务module混编入Native App。<br><img src="http://image.runmaf.com/2020-04-05-15860110916044.jpg" alt=""></p>
<h3 id="Hello-VV-First-Flutter-Module"><a href="#Hello-VV-First-Flutter-Module" class="headerlink" title="Hello VV First Flutter Module"></a>Hello VV First Flutter Module</h3><p>本文只描述如何创建flutter module并添加flutter_boost依赖，然后嵌入原生工程。module中会依赖一个plugin（webview_flutter）来模拟方案中的架构。<br>本文以VVLife iOS App中嵌入Flutter实现的登陆和我的模块举例（安卓上的实现也由庄宏展验证可成功嵌入）。</p>
<h4 id="1、Create-Module"><a href="#1、Create-Module" class="headerlink" title="1、Create Module"></a>1、Create Module</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">flutter create -t module vv_demo_flutter_module</div></pre></td></tr></table></figure>
<p><img src="http://image.runmaf.com/2020-04-05-15855645220209.jpg" alt=""></p>
<h4 id="2、创建anroid和ios文件"><a href="#2、创建anroid和ios文件" class="headerlink" title="2、创建anroid和ios文件"></a>2、创建anroid和ios文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">flutter make-host-app-editable</div></pre></td></tr></table></figure>
<p><img src="http://image.runmaf.com/2020-04-05-15855649980991.jpg" alt=""></p>
<h4 id="3、修改bundle-id及profile"><a href="#3、修改bundle-id及profile" class="headerlink" title="3、修改bundle_id及profile"></a>3、修改bundle_id及profile</h4><p>这里需要创建出来的iOS项目中，修改下bundle_id，否则之后的module编译会出现错误。</p>
<p><img src="http://image.runmaf.com/2020-04-05-15855650416465.jpg" alt=""><br><img src="http://image.runmaf.com/2020-04-05-15855651593446.jpg" alt=""></p>
<p>否则build时候会提示错误<br><img src="http://image.runmaf.com/2020-04-05-15855650858821.jpg" alt=""></p>
<h4 id="4、添加flutter-boost依赖"><a href="#4、添加flutter-boost依赖" class="headerlink" title="4、添加flutter_boost依赖"></a>4、添加flutter_boost依赖</h4><p> 打开pubspec.yaml并将以下行添加到依赖项，然后  flutter packages get一下</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">flutter_boost: ^1.12.13</div></pre></td></tr></table></figure>
<p>flutter_boost的介绍可以看<a href="https://mp.weixin.qq.com/s?__biz=MzU4MDUxOTI5NA==&amp;mid=2247484367&amp;idx=1&amp;sn=fcbc485f068dae5de9f68d52607ea08f&amp;chksm=fd54d7deca235ec86249a9e3714ec18be8b2d6dc580cae19e4e5113533a6c5b44dfa5813c4c3&amp;scene=0&amp;subscene=131&amp;clicktime=1551942425&amp;ascene=7&amp;devicetype=android-28&amp;version=2700033b&amp;nettype=ctnet&amp;abtest_cookie=BAABAAoACwASABMABAAklx4AVpkeAMSZHgDWmR4AAAA%3D&amp;lang=zh_CN&amp;pass_ticket=1qvHqOsbLBHv3wwAcw577EHhNjg6EKXqTfnOiFbbbaw%3D&amp;wx_header=1" target="_blank" rel="external">闲鱼APP团队的技术文章</a></p>
<p><img src="http://image.runmaf.com/2020-04-05-15860114455529.jpg" alt=""></p>
<h4 id="5、创建Widget并注册到路由"><a href="#5、创建Widget并注册到路由" class="headerlink" title="5、创建Widget并注册到路由"></a>5、创建Widget并注册到路由</h4><p>在main.dart中注册一下路由，过程和使用命名路由相似</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">FlutterBoost.singleton.registerPageBuilders(&#123;</div><div class="line">      &apos;flutter_login&apos;: (pageName, params, _) =&gt; VVLoginPage(),</div><div class="line">      &apos;flutter_mine&apos;: (pageName, params, _) =&gt; VVHomeMinePage(userName: params[&quot;name&quot;], imageUrl: params[&quot;imageUrl&quot;],),</div><div class="line">      &apos;flutter_customer_service&apos;: (pageName, params, _) =&gt;</div><div class="line">          CustomerServicePage(),</div><div class="line">    &#125;);</div></pre></td></tr></table></figure>
<h4 id="6、build"><a href="#6、build" class="headerlink" title="6、build"></a>6、build</h4><p>执行 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">flutter build ios --debug  </div><div class="line">// 或</div><div class="line">flutter build ios --release --no-codesign</div></pre></td></tr></table></figure>
<p><img src="http://image.runmaf.com/2020-04-05-15855653044387.jpg" alt=""></p>
<h4 id="7、在VVLife-App工程中添加依赖"><a href="#7、在VVLife-App工程中添加依赖" class="headerlink" title="7、在VVLife App工程中添加依赖"></a>7、在VVLife App工程中添加依赖</h4><p>修改VVLife工程的Podfile文件，添加对module的引入。修改后执行 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">pod install</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">flutter_application_path = &apos;../../Demo/vv_demo_flutter_module/&apos;</div><div class="line">load File.join(flutter_application_path, &apos;.ios&apos;, &apos;Flutter&apos;, &apos;podhelper.rb&apos;)</div><div class="line"></div><div class="line">target &apos;VVLife&apos; do</div><div class="line"></div><div class="line">  use_frameworks!</div><div class="line">  </div><div class="line">  commonPod_Tag</div><div class="line">  thirdPod</div><div class="line">  install_all_flutter_pods flutter_application_path</div><div class="line">#  hawkeye</div><div class="line">  </div><div class="line">  target &apos;VVLifeTests&apos; do</div><div class="line">    inherit! :search_paths</div><div class="line">    </div><div class="line">  end</div><div class="line">  </div><div class="line">end</div></pre></td></tr></table></figure>
<p>这里暂时使用相对路径方式引用，真正工程应用得换个方式。<br>考虑有两种方式：</p>
<ul>
<li>在APP工程根目录中引用flutter module项目，这样相对路径就一定是根目录下。然后通过 build Phases脚本来对flutter进行构建</li>
<li>将flutter module编译后的framework都进行pod库创建，发布到VV私有Pod仓库</li>
</ul>
<p>前者灵活但需要原生开发者都要安装flutter开发环境，后者方便不需要环境依赖，特别在业务经常变更情况下，不过自动化构建可以解决该问题。</p>
<h4 id="8、依赖是如何添加到Native-APP的"><a href="#8、依赖是如何添加到Native-APP的" class="headerlink" title="8、依赖是如何添加到Native APP的"></a>8、依赖是如何添加到Native APP的</h4><p>上一步骤中，起到引入作用核心在这句话</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># flutter_application_path是拼接后的podhelper.rb文件所在路径</div><div class="line"># install_all_flutter_pods该ruby脚本中需要执行的脚本函数</div><div class="line">install_all_flutter_pods flutter_application_path</div></pre></td></tr></table></figure>
<p>那我们再来看看install_all_flutter_pods函数的实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">def install_all_flutter_pods(flutter_application_path = nil)</div><div class="line">  # flutter默认目录结构是 root-&gt;.iOS-&gt;Fluuter-&gt;podhelper.rb，所以向上两层则是根目录</div><div class="line">  flutter_application_path ||= File.join(&apos;..&apos;, &apos;..&apos;)</div><div class="line">  # 引入Flutter引擎依赖pod</div><div class="line">  # 他会在根目录下创建一个engine目录，将本地flutter环境中的Flutter.framework及Flutter.podspec复制过来</div><div class="line">  install_flutter_engine_pod	</div><div class="line">  </div><div class="line">  # 引入Flutter Plugin编译后的pod</div><div class="line">  install_flutter_plugin_pods(flutter_application_path)</div><div class="line">  </div><div class="line">  # 引入当前flutter module编译后的pod</div><div class="line">  install_flutter_application_pod(flutter_application_path)</div><div class="line">end</div></pre></td></tr></table></figure>
<p>具体执行流程比较复杂，参考该图，有兴趣可以去看看该ruby脚本，特别是fake framework那段真的很妙。</p>
<p><img src="http://image.runmaf.com/2020-04-05-15860550737776.jpg" alt=""></p>
<h4 id="9、原生端路由实现"><a href="#9、原生端路由实现" class="headerlink" title="9、原生端路由实现"></a>9、原生端路由实现</h4><p>原生端路由不想flutter端是注册方式实现。<br>原生端需要一个url解释器，他会收到flutter端传来的url，对其进行url解析及参数解析，然后根据这些信息跳转到相应的页面或者进行相应的操作。</p>
<p>创建PlatformRouterImp.swift</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">class PlatformRouterImp: NSObject, FLBPlatform &#123;</div><div class="line">    func open(_ url: String, urlParams: [AnyHashable : Any], exts: [AnyHashable : Any], completion: @escaping (Bool) -&gt; Void) &#123;</div><div class="line">        // ...native端及flutter端调用open方法都会执行这里</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    func present(_ url: String, urlParams: [AnyHashable : Any], exts: [AnyHashable : Any], completion: @escaping (Bool) -&gt; Void) &#123;</div><div class="line">        // ...native端及flutter端调用present方法都会执行这里</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    func close(_ uid: String, result: [AnyHashable : Any], exts: [AnyHashable : Any], completion: @escaping (Bool) -&gt; Void) &#123;</div><div class="line">        // flutter端调用close方法都会执行这里</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    func navigationController() -&gt; UINavigationController &#123;</div><div class="line">        // native端及flutter端不管是open还是present都会执行这里</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="10、AppDelegate中初始并设置该解释器"><a href="#10、AppDelegate中初始并设置该解释器" class="headerlink" title="10、AppDelegate中初始并设置该解释器"></a>10、AppDelegate中初始并设置该解释器</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">let router = PlatformRouterImp.init();</div><div class="line">FlutterBoostPlugin.sharedInstance().startFlutter(with: router, onStart: &#123; (engine) in</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="11、调用并push到flutter端的模块"><a href="#11、调用并push到flutter端的模块" class="headerlink" title="11、调用并push到flutter端的模块"></a>11、调用并push到flutter端的模块</h4><p>调用在flutter端的登陆页面。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">let loginController = FLBFlutterViewContainer()</div><div class="line">loginController.setName(&quot;flutter_login&quot;, params: [:])</div><div class="line">let flutterLoginController = VLLoginFlutterController()</div><div class="line">flutterLoginController.registerNativeListener()</div></pre></td></tr></table></figure>
<p>这里我还创建了一个flutterLoginController，它作用相当于MVC中的Controller，来实现与Flutter页面的交互。<br>当然，这是建立在这个flutter页面只负责呈现，M和C的作用还是由原生来实现的前提下。<br>如果这个业务组件纯粹由flutter端掌控的话，原生只需要监听flutter端的open和close事件及时作出页面跳转操作即可。</p>
<h4 id="12、flutter端调用native端模块"><a href="#12、flutter端调用native端模块" class="headerlink" title="12、flutter端调用native端模块"></a>12、flutter端调用native端模块</h4><p>如果flutter端该页面的生命周期结束了，准备将页面导航的控制权交回给native，那么可以使用open方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">FlutterBoost.singleton.open(&quot;vvlife://guidepage&quot;, urlParams: &#123;&quot;autoPlay&quot;: true&#125;, exts: &#123;&quot;native&quot;: true&#125;)</div></pre></td></tr></table></figure>
<ul>
<li>url 打开页面的url，最好可以和原生的路由一致，这样native端可以和flutter端维护同一份路由，否则还需要一份映射表，将增加本来已经很多的hard code</li>
<li>urlParams  传递给native端的信息，如这里的含义就是guide页面进行自动播放方式打开。</li>
<li>exts  是附加信息，这里含义是打开的将是一个原生界面。</li>
</ul>
<p>然后在 <code>PlatformRouterImp.swift</code> 的open函数中根据传递的信息进行跳转即可。</p>
<h4 id="0、结束"><a href="#0、结束" class="headerlink" title="0、结束"></a>0、结束</h4><p>一个简单的module嵌入原生的例子就完成了，实际使用还会有需要细节需要研究。比如一个linsten关闭的时机及生命周期维护等，本文只是flutter混编的一个引子，具体实际应用还需要整个团队一起摸索。</p>
<h2 id="一些思考"><a href="#一些思考" class="headerlink" title="一些思考"></a>一些思考</h2><p>flutter混编现在还是有许多不足的地方，比如hard code如何标准化，比如复杂模型如何传递，比如动态特性如何实现等。</p>
<h3 id="hard-code"><a href="#hard-code" class="headerlink" title="hard code"></a>hard code</h3><p>在多端交互中，hard code一直都是一个难题。像客户端与服务端的请求访问，其实也都一直是硬编码，所以才会产生的RESTFULL API来标准化接口试hard code尽量标准化。<br>所以只能通过协议和规范约束flutter和native端。</p>
<p>其实在客户端组件化方案中，其实也一直都有hard code的问题，像当前VVLife、VVParner中依赖的SWRouter。虽然通过常量减少了这种问题，但是传递参数这方面并没有解决，新人来后如果使用到旧页面，要不得自己翻代码，要不就只能问老前辈了。老前辈时间久了肯定也记不到之前的param需要什么。</p>
<h3 id="复杂模型"><a href="#复杂模型" class="headerlink" title="复杂模型"></a>复杂模型</h3><p>例如商品模型，它包含几十个字段。如果是传字典或传 json, 那么数据提供方（native）和使用方（flutter）都需要专门理解并实现一下这种模型的各种字段，对开发效率影响很大。暂时也没什么好的办法规避。</p>
<h3 id="动态化"><a href="#动态化" class="headerlink" title="动态化"></a>动态化</h3><p>其实前两点都是小问题，动态化才是限制flutter的关键。<br>实现动态化是交付效率提升的重要方式。对于VV上线后必将强运营强时效性特性来说，动态化几乎是一个必备的诉求，但从技术上看也是一个非常敏感的需求，苹果一直在抑制应用方在动态化，像JSPatch就是过于“为所欲为”被喊停了。<br>当前flutter动态化成熟商用的方案一种是自己实现Dart SDK及相应DSL解释器，一个是大厂自己用的不开源得自己实现开发维护成本巨大，另一个是自定义的模板引擎对新人需要学习成本。<br>另一种方案是Web on Flutter，其UI表现一般。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/03/26/React-Native-Animated-划重点：两个细节排查两个小时/" itemprop="url">
                  React-Native Animated 划重点：两个细节排查两个小时
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2018-03-26T01:08:24+08:00" content="2018-03-26">
              2018-03-26
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>其实就是React-Native Animated两个细节引发的问题，但查的好辛苦，记录下。</p>
<h1 id="表现"><a href="#表现" class="headerlink" title="表现"></a>表现</h1><ul>
<li>start函数里的结束回调不运行</li>
<li>页面不刷新去渲染</li>
<li>强行setState会发现 value.__getValue()是undefined或NaN</li>
</ul>
<h2 id="原因：toValue是number类型"><a href="#原因：toValue是number类型" class="headerlink" title="原因：toValue是number类型"></a>原因：toValue是number类型</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Animated.timing(_value1, &#123;</div><div class="line">    duration: <span class="number">100</span>,</div><div class="line">    toValue: point1 <span class="comment">//划重点：toValue 是number，不要用Animated.Value对象了</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h2 id="原因：start后记得要setState"><a href="#原因：start后记得要setState" class="headerlink" title="原因：start后记得要setState"></a>原因：start后记得要setState</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Animated.parallel([</div><div class="line"><span class="comment">//...</span></div><div class="line">]).start();</div><div class="line"></div><div class="line"><span class="keyword">this</span>.setState(<span class="keyword">this</span>.state);<span class="comment">//划重点：这个必须设置，否则动画不会触发setState</span></div></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>总之还是React-Native步数，Animated更不熟，多记录，多学习RN怎么排查问题。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/03/21/在React-Native应用中通过React-Art实现点击礼花效果/" itemprop="url">
                  在React-Native应用中通过React-Art实现点击礼花效果
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2018-03-21T14:15:52+08:00" content="2018-03-21">
              2018-03-21
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>实际上这个例子并不需要使用react-art就能实现，但是我们将使用react-art来实现一种良好的效果。那这个例子中我们要完成的是什么呢？礼花🎉秀。并不花哨，只需要点击屏幕，一朵礼花就将要发射到你点击的地方并展开。</p>
<h2 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h2><p>这就是我们要实现的效果。</p>
<p><img src="http://7oxfjd.com2.z0.glb.qiniucdn.com/2018-03-21-preview_3.gif" alt="preview_3"></p>
<h2 id="start-project"><a href="#start-project" class="headerlink" title="start project"></a>start project</h2><p>就像普通的项目那样，创建一个空白的React-Native工程，然后把index.js里的自动生成代码改为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">import React, &#123;</div><div class="line">    Component</div><div class="line">&#125;from &apos;react&apos;;</div><div class="line"></div><div class="line">import &#123;</div><div class="line">    ART as Art,</div><div class="line">    StyleSheet,</div><div class="line">    View,</div><div class="line">    Dimensions,</div><div class="line">    TouchableWithoutFeedback,</div><div class="line">    Animated</div><div class="line">&#125; from &apos;react-native&apos;;</div><div class="line"></div><div class="line">var &#123;</div><div class="line">    width,</div><div class="line">    height</div><div class="line">&#125; = Dimensions.get(&apos;window&apos;);</div><div class="line"></div><div class="line">var &#123;</div><div class="line">    Surface,</div><div class="line">    Shape,</div><div class="line">    Path,</div><div class="line">    Group,</div><div class="line">    Transform</div><div class="line">&#125; = Art;</div><div class="line"></div><div class="line">var AnimatedShape = Animated.createAnimatedComponent(Shape);</div><div class="line">var AnimatedGroup = Animated.createAnimatedComponent(Group);</div></pre></td></tr></table></figure>
<p>我们引入了Animated API，react-art库，还有一些ART的组件。然后我要创建AnimatedShape和AnimatedGroup，这些让我们可以设置fill, opacity, x, y这些动画属性，可以让动画效果准确有效。</p>
<p>接着，我们创建styles</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">var styles = StyleSheet.create(&#123;</div><div class="line">  container: &#123;</div><div class="line">    flex: 1,</div><div class="line">    flexDirection: &apos;column&apos;</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>是的，这就是我们动画的发生的组件了。</p>
<p>然后创建我们的组件类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">export default class App extends Component&lt;Props&gt; &#123;</div><div class="line">    state = &#123;</div><div class="line">        fireworks: []</div><div class="line">    &#125;</div><div class="line">    render()&#123;</div><div class="line">        return (</div><div class="line">            &lt;View style=&#123;styles.container&#125;&gt;</div><div class="line">                &lt;TouchableWithoutFeedback&gt;</div><div class="line">                    &lt;View&gt;</div><div class="line">                        &lt;Surface width=&#123;width&#125; height=&#123;height&#125;&gt;</div><div class="line">                        &lt;/Surface&gt;</div><div class="line">                    &lt;/View&gt;</div><div class="line">                &lt;/TouchableWithoutFeedback&gt;</div><div class="line">            &lt;/View&gt;</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样我们的启动空白工程就完成了。一个容器View，包含TouchableWithoutFeedback让我们能获取点击的坐标。在Touchable中需要有一个View在包装我们的react-art Surface组件，它可以设置宽高。我们的例子需要一个全屏的画布，所以我们通过获取屏幕尺寸并设置给Surface组件。</p>
<h2 id="让炮弹飞一会"><a href="#让炮弹飞一会" class="headerlink" title="让炮弹飞一会"></a>让炮弹飞一会</h2><p>让我们想象发送炮弹的情景：一个炮弹从屏幕底部中央处发射到我们在屏幕上点击的位置。</p>
<p>那也就是我们要通过react-art绘制一个圆；还要有一个可以触地点击事件的函数去获取我们点击的位置；还要通过Animated将圆发射到点击的位置；最后在点击的位置渲染出这个炮弹。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">&lt;TouchableWithoutFeedback onPress=&#123;this._handleAddFirework&#125;&gt;</div></pre></td></tr></table></figure>
<p>我们将使用TouchableWithoutFeedback在用户点击屏幕时候回调函数去增加礼花到队列中。然后渲染时候在队列中读取炮弹并绘制。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">class AnimatedCircle extends Component&lt;Props&gt; &#123;</div><div class="line">    render()&#123;</div><div class="line">        var radius = this.props.radius;</div><div class="line">        var path = Path().moveTo(0, -radius)</div><div class="line">            .arc(0, radius * 2, radius)</div><div class="line">            .arc(0, radius * -2, radius)</div><div class="line">            .close();</div><div class="line">        return (</div><div class="line">            &lt;AnimatedShape d=&#123;path&#125;  &#123;...this.props&#125;/&gt;</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看起来我们只是把AnimatedShape包装起来，也就是组件化，这样可以尽可能是复用代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">const MORTAR_RADIUS = 5</div><div class="line">///...</div><div class="line">_handleAddFirework = (e) =&gt; &#123;</div><div class="line">    var _shootingPosition = new Animated.ValueXY(&#123;x: width/2, y: height - MORTAR_RADIUS&#125;);</div><div class="line"></div><div class="line">    this.state.fireworks.push(&#123;</div><div class="line">        shootingPosition: _shootingPosition,</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    Animated.timing(_shootingPosition, &#123;</div><div class="line">        duration: 300,</div><div class="line">        toValue: &#123;</div><div class="line">            y: e.nativeEvent.locationY,</div><div class="line">            x: e.nativeEvent.locationX</div><div class="line">        &#125;</div><div class="line">    &#125;).start()</div><div class="line"></div><div class="line">    this.setState(this.state);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>好的，让我们停下来分析下代码。</p>
<p>函数的第一行_shootingPosition，我们创建了一个Animated的向量值类型，这是默认值，也就是炮弹发送出来的地方，就是水平中央，并距离底部MORTAR_RADIUS的距离，使用常量方便我们修改尺寸时候可以不用修改代码，MORTAR_RADIUS会设置为5，因为我们炮弹的半径也是5.</p>
<p>然后我们将它添加到一个礼花的数组中，稍会我们就要发射他们了。</p>
<p>然后我们开始创建动画。我们想让炮弹经过300毫秒到达用户点击的位置，所以我们设置toValue为用户点击的位置。然后我们执行动画。对，我们还没有渲染任何东西但相信我马上我们就要看到第一步的效果了。</p>
<p>最后我们设置state，他会引发再渲染，然后我们就可以渲染我们的礼花了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">&lt;Surface width=&#123;width&#125; height=&#123;height&#125;&gt;</div><div class="line">    &#123;</div><div class="line">        this.state.fireworks.map((firework, index) =&gt; &#123;</div><div class="line">            return &lt;AnimatedCircle</div><div class="line">                radius=&#123;MORTAR_RADIUS&#125;</div><div class="line">                x=&#123;firework.shootingPosition.x&#125;</div><div class="line">                y=&#123;firework.shootingPosition.y&#125;</div><div class="line">                key=&#123;&quot;circle&quot;+index&#125;</div><div class="line">                fill=&quot;#000&quot;</div><div class="line">            /&gt;</div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line">&lt;/Surface&gt;</div></pre></td></tr></table></figure>
<p>上面代码中我们映射了state中的每个炮弹成AnimatedCircle，并设置相应的x,y值。在我们的例子中，我们要给炮弹填充黑色为初始颜色。</p>
<p>到此位置，运行代码可以看到初步的效果了。</p>
<p><img src="http://7oxfjd.com2.z0.glb.qiniucdn.com/2018-03-21-preview_1.gif" alt="preview_1"></p>
<h2 id="消失的炮弹"><a href="#消失的炮弹" class="headerlink" title="消失的炮弹"></a>消失的炮弹</h2><p>是的，炮弹并不是这样粘贴在屏幕上的。所以我们要让他们消失。start()函数可以设置一个回调，当动画结束后会回调他。</p>
<p>所以数组中的炮弹需要唯一标识，我们可以使用shootingPosition来标识它们并过滤出他们来。</p>
<p>像下面这样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Animated.timing(_shootingPosition, &#123;</div><div class="line">    duration: 300,</div><div class="line">    toValue: &#123;</div><div class="line">        y: e.nativeEvent.locationY,</div><div class="line">        x: e.nativeEvent.locationX</div><div class="line">    &#125;</div><div class="line">&#125;).start(this.removeSelf.bind(this, _shootingPosition))</div><div class="line"></div><div class="line">this.setState(this.state);</div><div class="line">//...</div><div class="line"></div><div class="line">removeSelf = (_shootingPosition)=&gt; &#123;</div><div class="line">    this.setState(&#123;</div><div class="line">        fireworks: this.state.fireworks.filter((firework) =&gt; firework.shootingPosition !== _shootingPosition)</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>终于它运行起来像个炮弹了。</p>
<h2 id="逃离黑白世界"><a href="#逃离黑白世界" class="headerlink" title="逃离黑白世界"></a>逃离黑白世界</h2><p>现在我们开始让炮弹不只是一个黑点。让我们假设它是个火球，那我们可以让他在黄和橙色之间变换颜色。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">const SHOOTING_COLORS = [</div><div class="line">    &apos;rgb(234,238,112)&apos;, //Yellow</div><div class="line">    &apos;rgb(245,137,12)&apos; //Orange</div><div class="line">];</div></pre></td></tr></table></figure>
<p>我们要调用的interpolate函数只适用于rgb，因此使用rgb而不是hex。</p>
<p>现在我们就创建另一个Animated value，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">adjustShootingFill = (_shootingColor, value) =&gt; &#123;</div><div class="line">    Animated.timing(_shootingColor, &#123;</div><div class="line">        duration: 16,</div><div class="line">        toValue: _shootingColor.__getAnimatedValue() == 0 ? 1 : 0</div><div class="line">    &#125;).start()</div><div class="line">&#125;</div><div class="line"></div><div class="line">_handleAddFirework = (e) =&gt; &#123;</div><div class="line">    var _shootingPosition = new Animated.ValueXY(&#123;x: width/2, y: height - MORTAR_RADIUS&#125;);</div><div class="line">    var _shootingColor = new Animated.Value(0);</div><div class="line"></div><div class="line">    this.state.fireworks.push(&#123;</div><div class="line">        shootingPosition: _shootingPosition,</div><div class="line">        shootingColor: _shootingColor,</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    _shootingPosition.addListener(this.adjustShootingFill.bind(null, _shootingColor));</div><div class="line"></div><div class="line">    Animated.timing(_shootingPosition, &#123;</div><div class="line">        duration: 300,</div><div class="line">        toValue: &#123;</div><div class="line">            y: e.nativeEvent.locationY,</div><div class="line">            x: e.nativeEvent.locationX</div><div class="line">        &#125;</div><div class="line">    &#125;).start(this.removeSelf.bind(this, _shootingPosition))</div><div class="line"></div><div class="line">    this.setState(this.state);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>开始我们添加了一个Animated.Value，默认设置为0.我们把它添加到我们的炮弹集合中。</p>
<p>然后我们添加了一个监听器在_shootingPosition，这样当炮弹位置发生变化的时候将调用设置的回调函数。回调中我们不断的通过变换黄和橙色。通过Animated.timing函数执行变色动画，这个动画在16内完成，__getAnimatedValue可以获取当前值并且变换成另一个。</p>
<p>所以，每16毫秒，炮弹的颜色都是黄→橙→黄→橙……循环下去。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">&lt;Surface width=&#123;width&#125; height=&#123;height&#125;&gt;</div><div class="line">    &#123;</div><div class="line">        this.state.fireworks.map((firework, index) =&gt; &#123;</div><div class="line">            var _shootingFill = firework.shootingColor.interpolate(&#123;</div><div class="line">                inputRange: [0,1],</div><div class="line">                outputRange: SHOOTING_COLORS</div><div class="line">            &#125;);</div><div class="line">            return &lt;AnimatedCircle</div><div class="line">                radius=&#123;MORTAR_RADIUS&#125;</div><div class="line">                key=&#123;&quot;circle&quot;+index&#125;</div><div class="line">                x=&#123;firework.shootingPosition.x&#125;</div><div class="line">                y=&#123;firework.shootingPosition.y&#125;</div><div class="line">                fill=&#123;_shootingFill&#125;</div><div class="line">            /&gt;</div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line">&lt;/Surface&gt;</div></pre></td></tr></table></figure>
<p>我们需要创建一个interpolator，它封装了Animated Value到颜色映射的逻辑，映射是像这样的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">0 =&gt; yellow</div><div class="line">1 =&gt; orange</div></pre></td></tr></table></figure>
<p>然后，我们的效果离预期右近一步了。</p>
<p><img src="http://7oxfjd.com2.z0.glb.qiniucdn.com/2018-03-21-preview_2.gif" alt="preview_2"></p>
<h2 id="炸裂吧，炮弹"><a href="#炸裂吧，炮弹" class="headerlink" title="炸裂吧，炮弹"></a>炸裂吧，炮弹</h2><p>有趣的时间到了，炸裂吧，炮弹。</p>
<p>我们的炮弹概念非常简单，我们将创建20个向外爆开的圆，我们也可以制作各种各样的尾巴，还可以四处飞行，甚至做一些很酷的效果，但是那是之后的事情了，我们先完成这最基本的效果。</p>
<p>我们先创建一些变量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">const PARTICLE_RADIUS = 30; // 炸开粒子的范围半径</div><div class="line">const PARTICLE_COUNT = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20]; // 每个爆开有多少粒子</div><div class="line"></div><div class="line">//粒子的颜色变化域</div><div class="line">const PARTICLE_COLORS = [</div><div class="line">    &apos;rgba(54, 17, 52, 100)&apos;,</div><div class="line">    &apos;rgba(176, 34, 140, 100)&apos;,</div><div class="line">    &apos;rgba(234, 55, 136, 100)&apos;,</div><div class="line">    &apos;rgba(229, 107, 112, 100)&apos;,</div><div class="line">    &apos;rgba(243, 145, 160, 100)&apos;</div><div class="line">]</div></pre></td></tr></table></figure>
<p>PARTICLE_RADIUS定义了每个爆炸的范围有多大；PARTICLE_COUNT定义了粒子的数量；最后，PARTICLE_COLORS定义了粒子有多少种不同的颜色，所以，每个爆炸将在这几种颜色之间变化。<br>为了简单起见，我们将使每个粒子具有相同的颜色，这意味着我们只需要1个Animated.Value。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> _particleColor = <span class="keyword">new</span> Animated.Value(<span class="number">0</span>);</div><div class="line"><span class="keyword">var</span> _particleRadius = <span class="keyword">new</span> Animated.Value(<span class="number">0</span>);</div><div class="line"><span class="keyword">var</span> _coreOpacity = <span class="keyword">new</span> Animated.Value(<span class="number">1</span>);</div></pre></td></tr></table></figure>
<p>我们还需要一个Animated.Value作为我们的半径，默认为0，所以它开始隐藏。 另一个Animated.Value是透明的动画。当我们的炮弹炸开后隐藏它。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> _particlePositions = PARTICLE_COUNT.map(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">new</span> Animated.ValueXY(&#123;<span class="attr">x</span>: <span class="number">0</span>, <span class="attr">y</span>: <span class="number">0</span>&#125;));</div></pre></td></tr></table></figure>
<p>每个粒子将有不同的坐标，所以例子中我们需要20个Animated.ValueXY。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">this.state.fireworks.push(&#123;</div><div class="line">    shootingPosition: _shootingPosition,</div><div class="line">    shootingColor: _shootingColor,</div><div class="line">    particleColor: _particleColor,</div><div class="line">    particleRadius: _particleRadius,</div><div class="line">    coreOpacity: _coreOpacity,</div><div class="line">    particlePositions: _particlePositions</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>添加新的对象，过会我们就渲染它们。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">function getXYParticle(total, i, radius) &#123;</div><div class="line">    var angle = 360/total*i;</div><div class="line"></div><div class="line">    var x = Math.round((radius*2) * Math.cos(angle - (Math.PI/2)));</div><div class="line">    var y = Math.round((radius*2) * Math.sin(angle - (Math.PI/2)));</div><div class="line"></div><div class="line">    return &#123;</div><div class="line">        x: x,</div><div class="line">        y: y</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">var _animatedParticles = [</div><div class="line">    Animated.timing(_particleRadius, &#123;</div><div class="line">        duration: 700,</div><div class="line">        toValue: 1</div><div class="line">    &#125;),</div><div class="line">    Animated.timing(_coreOpacity, &#123;</div><div class="line">        duration: 200,</div><div class="line">        toValue: 0</div><div class="line">    &#125;)</div><div class="line">]</div><div class="line"></div><div class="line">var _movingParticles = _particlePositions.map((particle, i) =&gt; &#123;</div><div class="line">    var _xy = getXYParticle(PARTICLE_COUNT.length, i, PARTICLE_RADIUS);</div><div class="line">    return Animated.timing(particle, &#123;</div><div class="line">        duration: 250,</div><div class="line">        toValue: _xy</div><div class="line">    &#125;)</div><div class="line">&#125;)</div><div class="line"></div><div class="line">_animatedParticles = _animatedParticles.concat(_movingParticles);</div></pre></td></tr></table></figure>
<p>这些都是为我们接下来要做的事情做准备，将我们的动画都排成序列。</p>
<p>我们创建了一系列需要发生的动画。首先是扩展每个_particleRadius，我们已经确定完全炸开的动画时长为700毫秒。 _particleRadius实际上是粒子尺寸，也就是我们只是放大这个圆，看起来像是向外爆炸，但是这会在我们的渲染函数中显示出来。</p>
<p>我们将_coreOpacity（也就是我们的炮弹）设置为在200毫秒内消失。</p>
<p>我们需要为每个粒子创建动画，让粒子从我们目前的炮弹位置发射到粒子圆范围内的不同点。然后我们通过一个算法，计算粒子x,y的位置。</p>
<p>然后又用到Animated.timing，让粒子花费250毫秒到达它的位置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Animated.sequence([</div><div class="line">  Animated.timing(_shootingPosition, &#123;</div><div class="line">    duration: 300,</div><div class="line">    toValue: &#123;</div><div class="line">      y: e.nativeEvent.locationY,</div><div class="line">      x: e.nativeEvent.locationX</div><div class="line">    &#125;</div><div class="line">  &#125;),</div><div class="line">  Animated.parallel(_animatedParticles)</div><div class="line">]).start(this.removeSelf.bind(this, _shootingPosition));</div></pre></td></tr></table></figure>
<p>现在将我们的动画列队列。因为我们希望炮弹先射击，然后到达指定位置后爆炸。所以我们使用Animated.sequence实现这个先后顺序。</p>
<p>我们首先将我们的炮弹移动到用户触摸的位置。下一部分将我们所有的爆炸动画封装成Animated.parallel。这与Animated.sequence相反，它表示同时执行所有这些动画。</p>
<p>这样，我们的炮弹渐渐消失，我们的粒子膨胀，颜色变化，爆炸向外都会同时发生。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">adjustParticleFill = (_particleColor, value) =&gt; &#123;</div><div class="line">    var _currentFill = _particleColor.__getAnimatedValue(),</div><div class="line">    _particleFill = _currentFill === 5 ? 0 : _currentFill + 1;</div><div class="line"></div><div class="line">    Animated.timing(_particleColor, &#123;</div><div class="line">        duration: 16,</div><div class="line">        toValue: _particleFill</div><div class="line">    &#125;).start()</div><div class="line">&#125;</div><div class="line"></div><div class="line">_handleAddFirework = (e) =&gt; &#123;</div><div class="line">    //...</div><div class="line"></div><div class="line">    _shootingPosition.addListener(this.adjustShootingFill.bind(null, _shootingColor));</div><div class="line">    _particleRadius.addListener(this.adjustParticleFill.bind(null, _particleColor));</div><div class="line">    </div><div class="line">    //...</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后我们需要去改变粒子的颜色。所以像之前那样，我们创建一个回调函数去监听粒子的半径变化。不同的是，现在我们有5种颜色需要变化。</p>
<p>现在我们要开始渲染新的效果了，我们将移到一个不同的函数里面去处理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">&lt;Surface width=&#123;width&#125; height=&#123;height&#125;&gt;</div><div class="line">  &#123;this.getFireworks()&#125;</div><div class="line">&lt;/Surface&gt;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">getFireworks = () =&gt; &#123;</div><div class="line">       return this.state.fireworks.map((firework, i) =&gt; &#123;</div><div class="line"></div><div class="line">           var _shootingFill = firework.shootingColor.interpolate(&#123;</div><div class="line">               inputRange: [0,1],</div><div class="line">               outputRange: SHOOTING_COLORS</div><div class="line">           &#125;);</div><div class="line"></div><div class="line">           var _particleFill = firework.particleColor.interpolate(&#123;</div><div class="line">               inputRange: [0,1,2,3,4],</div><div class="line">               outputRange: PARTICLE_COLORS</div><div class="line">           &#125;);</div><div class="line"></div><div class="line">           return (</div><div class="line">               &lt;AnimatedGroup</div><div class="line">                   x=&#123;firework.shootingPosition.x&#125;</div><div class="line">                   y=&#123;firework.shootingPosition.y&#125;</div><div class="line">                   key=&#123;&quot;group_&quot;+i&#125;</div><div class="line">               &gt;</div><div class="line">                   &lt;AnimatedCircle</div><div class="line">                       opacity=&#123;firework.coreOpacity&#125;</div><div class="line">                       radius=&#123;MORTAR_RADIUS&#125;</div><div class="line">                       fill=&#123;_shootingFill&#125;</div><div class="line">                       key=&#123;&quot;circle_&quot;+i&#125;</div><div class="line">                   /&gt;</div><div class="line">                   &lt;Group&gt;</div><div class="line">                       &#123;</div><div class="line">                           PARTICLE_COUNT.map((v, j) =&gt; &#123;</div><div class="line">                               return &lt;AnimatedCircle</div><div class="line">                                   x=&#123;firework.particlePositions[j].x&#125;</div><div class="line">                                   y=&#123;firework.particlePositions[j].y&#125;</div><div class="line">                                   key=&#123;&quot;particles_&quot;+j&#125;</div><div class="line">                                   scaleX=&#123;firework.particleRadius&#125;</div><div class="line">                                   scaleY=&#123;firework.particleRadius&#125;</div><div class="line">                                   radius=&#123;PARTICLE_RADIUS&#125;</div><div class="line">                                   fill=&#123;_particleFill&#125;</div><div class="line">                               /&gt;</div><div class="line">                           &#125;)</div><div class="line">                       &#125;</div><div class="line">                   &lt;/Group&gt;</div><div class="line">               &lt;/AnimatedGroup&gt;</div><div class="line">           );</div><div class="line">       &#125;)</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>还是和之前变换炮弹颜色一样，我们还是使用interpolation来变化粒子的5种颜色。</p>
<p>这里不同的是使用AnimatedGroup，我们将坐标从x,y设置到AnimatedGroup中。</p>
<p>AnimatedGroup打包了炮弹和所有的粒子。这样我们可以让我们的粒子从0,0开始向外移动，AnimatedGroup将确保所有的坐标都能正确处理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">&lt;AnimatedCircle</div><div class="line">  opacity=&#123;firework.coreOpacity&#125;</div><div class="line">  radius=&#123;MORTAR_RADIUS&#125;</div><div class="line">  fill=&#123;_shootingFill&#125;</div><div class="line">/&gt;</div></pre></td></tr></table></figure>
<p>可以看到把coreOpacity动画放在粒子这，然后他将在200毫秒内消失。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">&lt;Group&gt;</div><div class="line">  &#123;</div><div class="line">    PARTICLE_COUNT.map((v, j) =&gt; &#123;</div><div class="line">      return &lt;AnimatedCircle</div><div class="line">        x=&#123;firework.particlePositions[j].x&#125;</div><div class="line">        y=&#123;firework.particlePositions[j].y&#125;</div><div class="line">        key=&#123;&quot;particles_&quot;+j&#125;</div><div class="line">        scaleX=&#123;firework.particleRadius&#125;</div><div class="line">        scaleY=&#123;firework.particleRadius&#125;</div><div class="line">        radius=&#123;PARTICLE_RADIUS&#125;</div><div class="line">        fill=&#123;_particleFill&#125;</div><div class="line">      /&gt;</div><div class="line">    &#125;)</div><div class="line">  &#125;</div><div class="line">&lt;/Group&gt;</div></pre></td></tr></table></figure>
<p>我们把粒子都放在Group组件里。我们映射出20个粒子，x和y的值由getXYParticle函数来确定。</p>
<p>你可以注意到，我们把particleRadius传递给了scaleX和scaleY属性，因为AnimatedCircle带有的radius属性不具有可动画性，所以通过缩放到0的方式来完全隐藏。</p>
<p>这样，我们就可以将其扩大到完整的尺寸，并使其看起来像爆炸一样，这样实际上的效果更好。</p>
<p>最后我们使用在顶部定义的PARTICLE_RADIUS，也就是每个炮弹的大小，然后将_particleFill设置为这5种颜色的interpolation。</p>
<h2 id="发射"><a href="#发射" class="headerlink" title="发射"></a>发射</h2><p>完工！我们有了🎉！<br>运行起来就可以看到效果</p>
<p><img src="http://7oxfjd.com2.z0.glb.qiniucdn.com/2018-03-21-preview_3.gif" alt="preview_3"></p>
<h3 id="Final-Code"><a href="#Final-Code" class="headerlink" title="Final Code"></a>Final Code</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">import React, &#123;</div><div class="line">    Component</div><div class="line">&#125;from &apos;react&apos;;</div><div class="line"></div><div class="line">import &#123;</div><div class="line">    ART as Art,</div><div class="line">    StyleSheet,</div><div class="line">    View,</div><div class="line">    Dimensions,</div><div class="line">    TouchableWithoutFeedback,</div><div class="line">    Animated</div><div class="line">&#125; from &apos;react-native&apos;;</div><div class="line"></div><div class="line">var &#123;</div><div class="line">    width,</div><div class="line">    height</div><div class="line">&#125; = Dimensions.get(&apos;window&apos;);</div><div class="line"></div><div class="line">var &#123;</div><div class="line">    Surface,</div><div class="line">    Shape,</div><div class="line">    Path,</div><div class="line">    Group,</div><div class="line">    Transform</div><div class="line">&#125; = Art;</div><div class="line"></div><div class="line">var AnimatedShape = Animated.createAnimatedComponent(Shape);</div><div class="line">var AnimatedGroup = Animated.createAnimatedComponent(Group);</div><div class="line"></div><div class="line">const MORTAR_RADIUS = 5</div><div class="line"></div><div class="line">const SHOOTING_COLORS = [</div><div class="line">    &apos;rgb(234,238,112)&apos;, //Yellow</div><div class="line">    &apos;rgb(245,137,12)&apos; //Orange</div><div class="line">];</div><div class="line"></div><div class="line">const PARTICLE_RADIUS = 30; // 炸开粒子的范围半径</div><div class="line">const PARTICLE_COUNT = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20]; // 每个爆开有多少粒子</div><div class="line"></div><div class="line">//粒子的颜色变化域</div><div class="line">const PARTICLE_COLORS = [</div><div class="line">    &apos;rgba(54, 17, 52, 100)&apos;,</div><div class="line">    &apos;rgba(176, 34, 140, 100)&apos;,</div><div class="line">    &apos;rgba(234, 55, 136, 100)&apos;,</div><div class="line">    &apos;rgba(229, 107, 112, 100)&apos;,</div><div class="line">    &apos;rgba(243, 145, 160, 100)&apos;</div><div class="line">]</div><div class="line"></div><div class="line">export default class App extends Component&lt;Props&gt; &#123;</div><div class="line">    state = &#123;</div><div class="line">        fireworks: []</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    adjustShootingFill = (_shootingColor, value) =&gt; &#123;</div><div class="line">        Animated.timing(_shootingColor, &#123;</div><div class="line">            duration: 16,</div><div class="line">            toValue: _shootingColor.__getAnimatedValue() == 0 ? 1 : 0</div><div class="line">        &#125;).start()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    adjustParticleFill = (_particleColor, value) =&gt; &#123;</div><div class="line">        var _currentFill = _particleColor.__getAnimatedValue(),</div><div class="line">        _particleFill = _currentFill === 5 ? 0 : _currentFill + 1;</div><div class="line"></div><div class="line">        Animated.timing(_particleColor, &#123;</div><div class="line">            duration: 16,</div><div class="line">            toValue: _particleFill</div><div class="line">        &#125;).start()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    _handleAddFirework = (e) =&gt; &#123;</div><div class="line">        var _shootingPosition = new Animated.ValueXY(&#123;x: width/2, y: height - MORTAR_RADIUS&#125;);</div><div class="line">        var _shootingColor = new Animated.Value(0);</div><div class="line">        var _particleColor = new Animated.Value(0);</div><div class="line">        var _particleRadius = new Animated.Value(0);</div><div class="line">        var _coreOpacity = new Animated.Value(1);</div><div class="line"></div><div class="line">        var _particlePositions = PARTICLE_COUNT.map(() =&gt; new Animated.ValueXY(&#123;x: 0, y: 0&#125;));</div><div class="line"></div><div class="line">        this.state.fireworks.push(&#123;</div><div class="line">            shootingPosition: _shootingPosition,</div><div class="line">            shootingColor: _shootingColor,</div><div class="line">            particleColor: _particleColor,</div><div class="line">            particleRadius: _particleRadius,</div><div class="line">            coreOpacity: _coreOpacity,</div><div class="line">            particlePositions: _particlePositions</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        _shootingPosition.addListener(this.adjustShootingFill.bind(null, _shootingColor));</div><div class="line">        _particleRadius.addListener(this.adjustParticleFill.bind(null, _particleColor));</div><div class="line"></div><div class="line">        function getXYParticle(total, i, radius) &#123;</div><div class="line">            var angle = 360/total*i;</div><div class="line"></div><div class="line">            var x = Math.round((radius*2) * Math.cos(angle - (Math.PI/2)));</div><div class="line">            var y = Math.round((radius*2) * Math.sin(angle - (Math.PI/2)));</div><div class="line"></div><div class="line">            return &#123;</div><div class="line">                x: x,</div><div class="line">                y: y</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        var _animatedParticles = [</div><div class="line">            Animated.timing(_particleRadius, &#123;</div><div class="line">                duration: 700,</div><div class="line">                toValue: 1</div><div class="line">            &#125;),</div><div class="line">            Animated.timing(_coreOpacity, &#123;</div><div class="line">                duration: 200,</div><div class="line">                toValue: 0</div><div class="line">            &#125;)</div><div class="line">        ]</div><div class="line"></div><div class="line">        var _movingParticles = _particlePositions.map((particle, i) =&gt; &#123;</div><div class="line">            var _xy = getXYParticle(PARTICLE_COUNT.length, i, PARTICLE_RADIUS);</div><div class="line">            return Animated.timing(particle, &#123;</div><div class="line">                duration: 250,</div><div class="line">                toValue: _xy</div><div class="line">            &#125;)</div><div class="line">        &#125;)</div><div class="line"></div><div class="line">        _animatedParticles = _animatedParticles.concat(_movingParticles);</div><div class="line"></div><div class="line">        Animated.sequence([</div><div class="line">            Animated.timing(_shootingPosition, &#123;</div><div class="line">                duration: 300,</div><div class="line">                toValue: &#123;</div><div class="line">                    y: e.nativeEvent.locationY,</div><div class="line">                    x: e.nativeEvent.locationX</div><div class="line">                &#125;</div><div class="line">            &#125;),</div><div class="line">            Animated.parallel(_animatedParticles)</div><div class="line">        ]).start(this.removeSelf.bind(this, _shootingPosition));</div><div class="line"></div><div class="line">        this.setState(this.state);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    removeSelf = (_shootingPosition)=&gt; &#123;</div><div class="line">        this.setState(&#123;</div><div class="line">            fireworks: this.state.fireworks.filter((firework) =&gt; firework.shootingPosition !== _shootingPosition)</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    getFireworks = () =&gt; &#123;</div><div class="line">        return this.state.fireworks.map((firework, i) =&gt; &#123;</div><div class="line"></div><div class="line">            var _shootingFill = firework.shootingColor.interpolate(&#123;</div><div class="line">                inputRange: [0,1],</div><div class="line">                outputRange: SHOOTING_COLORS</div><div class="line">            &#125;);</div><div class="line"></div><div class="line">            var _particleFill = firework.particleColor.interpolate(&#123;</div><div class="line">                inputRange: [0,1,2,3,4],</div><div class="line">                outputRange: PARTICLE_COLORS</div><div class="line">            &#125;);</div><div class="line"></div><div class="line">            return (</div><div class="line">                &lt;AnimatedGroup</div><div class="line">                    x=&#123;firework.shootingPosition.x&#125;</div><div class="line">                    y=&#123;firework.shootingPosition.y&#125;</div><div class="line">                    key=&#123;&quot;group_&quot;+i&#125;</div><div class="line">                &gt;</div><div class="line">                    &lt;AnimatedCircle</div><div class="line">                        opacity=&#123;firework.coreOpacity&#125;</div><div class="line">                        radius=&#123;MORTAR_RADIUS&#125;</div><div class="line">                        fill=&#123;_shootingFill&#125;</div><div class="line">                        key=&#123;&quot;circle_&quot;+i&#125;</div><div class="line">                    /&gt;</div><div class="line">                    &lt;Group&gt;</div><div class="line">                        &#123;</div><div class="line">                            PARTICLE_COUNT.map((v, j) =&gt; &#123;</div><div class="line">                                return &lt;AnimatedCircle</div><div class="line">                                    x=&#123;firework.particlePositions[j].x&#125;</div><div class="line">                                    y=&#123;firework.particlePositions[j].y&#125;</div><div class="line">                                    key=&#123;&quot;particles_&quot;+j&#125;</div><div class="line">                                    scaleX=&#123;firework.particleRadius&#125;</div><div class="line">                                    scaleY=&#123;firework.particleRadius&#125;</div><div class="line">                                    radius=&#123;PARTICLE_RADIUS&#125;</div><div class="line">                                    fill=&#123;_particleFill&#125;</div><div class="line">                                /&gt;</div><div class="line">                            &#125;)</div><div class="line">                        &#125;</div><div class="line">                    &lt;/Group&gt;</div><div class="line">                &lt;/AnimatedGroup&gt;</div><div class="line">            );</div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    render()&#123;</div><div class="line">        return (</div><div class="line">            &lt;View style=&#123;styles.container&#125;&gt;</div><div class="line">                &lt;TouchableWithoutFeedback onPress=&#123;this._handleAddFirework&#125; &gt;</div><div class="line">                    &lt;View&gt;</div><div class="line">                        &lt;Surface width=&#123;width&#125; height=&#123;height&#125;&gt;</div><div class="line">                            &#123;this.getFireworks()&#125;</div><div class="line">                        &lt;/Surface&gt;</div><div class="line">                    &lt;/View&gt;</div><div class="line">                &lt;/TouchableWithoutFeedback&gt;</div><div class="line">            &lt;/View&gt;</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">var styles = StyleSheet.create(&#123;</div><div class="line">    container: &#123;</div><div class="line">        flex: 1,</div><div class="line">        flexDirection: &apos;column&apos;</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">class AnimatedCircle extends Component&lt;Props&gt; &#123;</div><div class="line">    render()&#123;</div><div class="line">        var radius = this.props.radius;</div><div class="line">        var path = Path().moveTo(0, -radius)</div><div class="line">            .arc(0, radius * 2, radius)</div><div class="line">            .arc(0, radius * -2, radius)</div><div class="line">            .close();</div><div class="line">        return (</div><div class="line">            &lt;AnimatedShape d=&#123;path&#125;  &#123;...this.props&#125;/&gt;</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/02/01/iOS低功耗蓝牙开发指西-译/" itemprop="url">
                  iOS低功耗蓝牙开发指西[译]
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2018-02-01T11:05:20+08:00" content="2018-02-01">
              2018-02-01
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="iOS低功耗蓝牙开发指西-译"><a href="#iOS低功耗蓝牙开发指西-译" class="headerlink" title="iOS低功耗蓝牙开发指西[译]"></a>iOS低功耗蓝牙开发指西[译]</h1><h2 id="译文"><a href="#译文" class="headerlink" title="译文"></a>译文</h2><p>链接：<a href="https://codeburst.io/getting-started-with-bluetooth-low-energy-on-ios-ada3090fc9cc" target="_blank" rel="external">Getting started with Bluetooth Low Energy on iOS</a><br>作者：<a href="https://codeburst.io/@yostane?source=post_header_lockup" target="_blank" rel="external">Yassine benabbas</a></p>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>低功耗蓝牙(BLE)是蓝牙4.0最重要的特性之一。使用BLE进行设备间通信的功耗对比传统蓝牙大大的降低了。另一个重大的进步就是用户用系统设置取代了手动配对。这篇文章的核心内容为快速介绍BLE及展示从零开始创建iOS应用去连接一个BLE外设。</p>
<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>低功耗蓝牙缩写为BLE。首先要澄清，蓝牙4.0定义了包括经典蓝牙协议、高速蓝牙协议和低功耗蓝牙协议在内的一系列的技术规范，所以请仔细检查外设对于BLE的兼容性。</p>
<p>要识别一个外设是否为BLE外设，可以检查它是否带有『Bluetooth smart』、『Bluetooth Low Energy』或『BLE』标识。</p>
<p>现在我们有了一些BLE外设，我们将在下一节看到它们如何通信。</p>
<h2 id="中心设备和外设的BLE通信"><a href="#中心设备和外设的BLE通信" class="headerlink" title="中心设备和外设的BLE通信"></a>中心设备和外设的BLE通信</h2><p>在BLE世界有两种设备：外设和中心设备。</p>
<p>外设是一个设备暴露出一些服务，提供数据的读写。</p>
<p>中心设备是一个设备可以连接多个外设并与他们进行数据的读写。通信的连接是由中心设备来发起并初始化的。</p>
<p>在一个C/S架构模型中，中心设备可以认为是客户端，外设可以看做是服务端。</p>
<p>一些设备可以同时作为中心设备和外设存在，比如iOS和Mac设备。</p>
<p>外设/中心设备例子：</p>
<ul>
<li>像小米手环这类型智能手环就是一个外设</li>
<li>iPhone手机连接了一个只能手环，就扮演了中心设备的角色</li>
</ul>
<p><img src="http://7oxfjd.com2.z0.glb.qiniucdn.com/2018-02-01-15173883632616.png" alt=""></p>
<div align="center"><font color="blue" size="2" face="verdana">源自:<a href="https://learn.adafruit.com/introduction-to-bluetooth-low-energy/gatt" target="_blank" rel="external">https://learn.adafruit.com/introduction-to-bluetooth-low-energy/gatt</a></font></div>

<p>在下一章节，我们将介绍BLE中存在的通信方式。</p>
<h2 id="BLE通信方式"><a href="#BLE通信方式" class="headerlink" title="BLE通信方式"></a>BLE通信方式</h2><p>有两种通信方式：</p>
<ul>
<li>广播通信模式(Advertising mode)：外设定时的广播附带一些信息，周围可能发现广播的中心设备都可以接收这些信息。这种模式允许一个外设被中心设备发现，因此把他叫做广告（advertising）。在这种模式下，可以直接通过GAP广播进行交换简单的信息。从外设角度看，这是一个外设对应多个中心设备的模式。</li>
<li>连接模式(Connected mode)：允许一个中心设备和外设交换复杂的数据。GATT协议描述了这种模式是如何创建会话进行通信的。从外设角度说，这是种一对一的模式。</li>
</ul>
<p>但有一些规则：</p>
<ul>
<li>一个中心设备不能连接另一个中心设备，一个外设不能连接另一个外设</li>
<li>一个外设同时时间只能连接一个中心设备</li>
</ul>
<p>在下一章节，我们降更深入的钻研连接模式通信的细节。</p>
<h2 id="BLE在连接模式的通信"><a href="#BLE在连接模式的通信" class="headerlink" title="BLE在连接模式的通信"></a>BLE在连接模式的通信</h2><h3 id="服务与特征"><a href="#服务与特征" class="headerlink" title="服务与特征"></a>服务与特征</h3><p>GATT协议定义了中心设备如何与可连接的外设通信。首先数据的结构是这样定义的：</p>
<ul>
<li>外设暴露中心设备可进行读、写与被通知的属性。这些属性每一个都被称作为特征(characteristic)。一个特征也伴随着一个描述符(descriptor)来解释它；</li>
<li>特征被分组为服务(service)；</li>
<li>我们也可以将服务分组成一个配置文件(profile)。</li>
</ul>
<p>让我们举一个例子：心率监测器是一个BLE外设，他有一个心率配置文件，该配置文件有两个服务（心率服务及设备信息服务）。心率服务定义了一个读特征可以提供测量的心率结果。它也定义了一个写特征用于告诉外设它现在处于身体的什么位置。然后设备信息服务包含关于模型、固件版本等设备信息。</p>
<p>每个特征和服务都被定义了唯一标识，这个唯一标识被称作UUID。有一些预定义好的标准服务与特征的UUID，如果你有兴趣，可以在该<a href="https://www.bluetooth.com/specifications/gatt/services and https://www.bluetooth.com/specifications/gatt/characteristics" target="_blank" rel="external">链接</a>中延伸阅读。当然，你可以为你自己的服务和特征定义UUID。你也没有义务去回避预定义的UUID。标准的UUID是16位的，自定义的则是128位的，他们一般用十六进制表示。例如心率服务的UUID是16位的：0x180D，而自定义可以是:6E400001-B5A3-F393-E0A9-E50E24DCCA9E。<br><img src="http://7oxfjd.com2.z0.glb.qiniucdn.com/2018-02-01-15173911787186.png" alt=""></p>
<p>下一章节我们将介绍典型的BLE使用案例。</p>
<h2 id="典型的蓝牙使用案例"><a href="#典型的蓝牙使用案例" class="headerlink" title="典型的蓝牙使用案例"></a>典型的蓝牙使用案例</h2><p>该章节我们将介绍典型的BLE使用案例。有非常多可能的BLE使用场景，但我们将描述最常见的这种。</p>
<p>BLE搜索APP：他的用途为在你想要发现并测试BLE的位置发现周围蓝牙设备的情况，具体为以下功能：</p>
<ul>
<li>发现外设的广播服务</li>
<li>中心设备发现这些广播服务并把它们显示给用户</li>
<li>用户从列表中选择一个外设</li>
<li>中心设备连接选中的外设并把该外设所有的服务展现给用户</li>
<li>用户可以选择一个服务</li>
<li>中心设备询问外设当前选择的服务有哪些特征并展示给用户</li>
<li>用户可以选择一项特征并执行一些允许的操作(比如读，或者写，又或者被通知)</li>
</ul>
<p>这类型的应用有BlueCap和LightBlue，可以从AppStore中下载。</p>
<p>还有很多经典的使用案例，比如：</p>
<ul>
<li>APP可以扫描一些特定的广播服务的设备</li>
<li>APP可以连接特定的设备，比如智能手环</li>
<li>APP接着可以通过特定的特征和决定好的服务来获取一些信息，比如步数</li>
<li>APP可以断开外设的连接，下一次可以立即重连上</li>
</ul>
<p>这种类型的应用使用起来更加简易上手，只需要用户进行了第一次连接，之后就可以自动的快速连接上，当前很多智能设备的交互都遵循该思路，有的甚至更加简易。 例如，小米手环的官方应用，我们也将在本文末尾开发遵循该规范的小米手环应用程序</p>
<p>下一章节，我们将检查我们的苹果设备是否支持BLE。</p>
<h2 id="BLE与Apple"><a href="#BLE与Apple" class="headerlink" title="BLE与Apple"></a>BLE与Apple</h2><p>苹果很早的就在他们的软硬件中支持BLE了，这里有一些回顾</p>
<ul>
<li>iOS5的SDK引入了蓝牙核心(Core Bluetooth)框架，该框架允许BLE设备作为中央设备或外设进行交互</li>
<li>从iPhone 4S开始，所有的iOS设备都支持BLE</li>
<li>如果你的Mac支持BLE，那么你的iOS模拟器也支持。</li>
</ul>
<p>支持BLE的首批Mac电脑有</p>
<ul>
<li>2011年中的MacBook Air</li>
<li>2011年年中的Mac mini</li>
<li>2012年中期视网膜(retina)及非视网膜版本的MacBook Pro</li>
<li>2012年底的iMacs</li>
</ul>
<p>了解了这点，并且您目前拥有Mac、iPhone或iPad，那么就可以开始编写一些BLE应用程序。</p>
<h2 id="在iOS上开发蓝牙应用程序"><a href="#在iOS上开发蓝牙应用程序" class="headerlink" title="在iOS上开发蓝牙应用程序"></a>在iOS上开发蓝牙应用程序</h2><p>当你要开发一款通过BLE与其他硬件交互的应用程序，你需要先问自己三个问题：</p>
<ul>
<li>我是要与中心设备交互，还是与外设交互？</li>
<li>配置文件是什么？也就是外设有哪些服务和特征？</li>
<li>我将使用到哪个框架或库？</li>
</ul>
<p>首先，第一个问题的答案决定了应用程序将实现那种类型的BLE设备。如果我们想要交互的设备是一个中心设备，那么APP将扮演的就是外设的角色。反之，如果我们想与一个外设通信，那么我们的APP就将是一个中心设备。</p>
<p>其次，实现明确好服务与特征可以让应用程序与BLE设备很快的无缝对接。否则将不知道如何进行通信。</p>
<p>最后，开发BLE应用，选择一个最适合的框架是非常的重要。对我来说，这是最重要的原因有两个，第一个是在开始传递数据前由很多的异步任务，第二个是这个过程可能会因为很多原因失败，那么，选择一个简化这些任务的框架就是非常重要的了。</p>
<p>以我的经历来说，我选择过两种框架：</p>
<ul>
<li>Core Bluetooth，他是苹果开发的BLE框架，从iOS5开始就包含在iOS SDK中。这个框架严重依赖于代理(delegate)，并且他有丰富而完善的文档及示例代码。唯一不足的就是这个框架有些时间长了，不够新颖。</li>
<li>BlueCap，它是一个在Core Bluetooth之上的swift软件包。他支持iOS9以上的系统，需要Xcode 8.2来开发。他依赖于Future而不是Delegate，如果你不是很熟悉Future，那么这将花费你一些时间去熟悉它，但相信我，这些是值得的，比起delegate，这将让你感到更自然。</li>
</ul>
<p>由于我们将要开发的这个项目支持iOS11，并且用Swift4编写，我毫无犹豫的选择了BlueCap ：）。在下一节中，我将要创建一个简单的中心设备应用，他将与一个Mac上通过Bleno模拟的外设进行通信。</p>
<h2 id="实现中心设备的iOS应用"><a href="#实现中心设备的iOS应用" class="headerlink" title="实现中心设备的iOS应用"></a>实现中心设备的iOS应用</h2><p>首先，我们将通过Mac模拟一个外设，如果你有你也可以使用自己的外设。</p>
<h3 id="通过Mac模拟一个外设"><a href="#通过Mac模拟一个外设" class="headerlink" title="通过Mac模拟一个外设"></a>通过Mac模拟一个外设</h3><p>有很多不同的技术可以通过Mac模拟一个BLE外设。第一个闪现在我脑子里的想法就是创建一个基于Core Bluetooth的Mac APP来扮演外设的角色。这也有个叫<a href="https://github.com/sandeepmistry/bleno" target="_blank" rel="external">bleno</a> 的node.js模块，他可以很快的实现一个BLE外设。本文中我们将使用bleno。这里我介绍下快速启用它的过程：</p>
<ul>
<li>安装Xcode</li>
<li>安装node.js</li>
<li>打开一个终端，通过 <figure class="highlight plain"><figcaption><span>install bleno``` 命令来安装bleno模块</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"> * 下载bleno的github仓库(https://github.com/sandeepmistry/bleno)[https://github.com/sandeepmistry/bleno]</div><div class="line"> * 打开一个终端并进入 examples/echo 文件夹</div><div class="line"> * 运行 ```node main.js``` 。如果你遇到“missing module”的错误提示，你需要使用npm安装“module”，然后再试一次</div><div class="line"></div><div class="line">整个过程的命令如下：</div><div class="line"></div><div class="line"> ```bash</div><div class="line"> $git clone https://github.com/sandeepmistry/bleno bleno</div><div class="line"> $cd bleno</div><div class="line"> $npm install bleno</div><div class="line"> $cd examples/echo</div><div class="line"> # $npm install module</div><div class="line"> $ node main.js</div><div class="line">bleno - echo</div><div class="line">on -&gt; stateChange: poweredOn</div><div class="line">on -&gt; advertisingStart: success</div></pre></td></tr></table></figure></li>
</ul>
<p>如果你看到最后的输出，说明你成功了。<br>你已经在你的电脑上模拟了一个Local Name为『echo』的BLE外设，广播服务的UUID为EC00，你可以查看main.js文件看看他是如何运行的。<br>当我们连接上，可以发现一个UUID为 “ec0e” 的特征可用于读、写和通知。这些都定义在characteristics.js中，文件中还定义了如何处理读、写和通知。</p>
<p>现在我们有了一个功能完整的外设，那让我们开始开发一个微型的iOS应用与这个外设进行交互吧。</p>
<h3 id="iOS中心设备应用"><a href="#iOS中心设备应用" class="headerlink" title="iOS中心设备应用"></a>iOS中心设备应用</h3><p>这中心设备APP将非常简洁。他搜索广播为echo的设备，第一个发现的就直接连上。接着，APP让我们从ec0e特征读写数据。我们可以通过以下步骤来初始化工程：</p>
<ul>
<li>创建一个简单的应用</li>
</ul>
<p><img src="http://7oxfjd.com2.z0.glb.qiniucdn.com/2018-02-01-15174493294792.jpg" alt=""></p>
<ul>
<li>给你的应用命名为SimpleBleCentral，并且选择Swift</li>
</ul>
<p><img src="http://7oxfjd.com2.z0.glb.qiniucdn.com/2018-02-01-15174494036052.jpg" alt=""></p>
<p>现在，工程已经创建好了，我们将添加BlueCap框架(<a href="https://github.com/troystribling/BlueCap)[https://github.com/troystribling/BlueCap]。有很多不同的方法添加，比如Cocoapods、Carthage，这里用Cocoapods方式导入，这里不详细介绍如何使用Cocoapods导入第三方库。" target="_blank" rel="external">https://github.com/troystribling/BlueCap)[https://github.com/troystribling/BlueCap]。有很多不同的方法添加，比如Cocoapods、Carthage，这里用Cocoapods方式导入，这里不详细介绍如何使用Cocoapods导入第三方库。</a></p>
<p>我们也要添加CoreBluetooth框架到项目中，因为BlueCap是依赖于CoreBluetoothde。<br><img src="http://7oxfjd.com2.z0.glb.qiniucdn.com/2018-02-01-15174508768320.jpg" alt=""></p>
<p>下一步是在项目的属性中添加中心设备功能。要做的就是运行后台模式并检查Bluetooth LE的可访问性。</p>
<p><img src="http://7oxfjd.com2.z0.glb.qiniucdn.com/2018-02-01-15174511314563.jpg" alt=""></p>
<p>我们的storyboard包含了一个ViewController，他可以在扫描我们想要使用特征的时候展示一个等待指示器。当我们发现了特征，ViewController则展现出一个可交互的视图供读写该特征。</p>
<p><img src="http://7oxfjd.com2.z0.glb.qiniucdn.com/2018-02-01-15174520548884.jpg" alt=""></p>
<p>我们的view controller要完成以下任务：</p>
<ul>
<li>初始化CentralManager，他是BlueCapKit的一个中心设备类，可用来扫描外设</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//初始化并定义一个标识的Key，这个Key之后可以用来重用该Manage类</span></div><div class="line"><span class="keyword">let</span> manager = <span class="type">CentralManager</span>(options: [<span class="type">CBCentralManagerOptionRestoreIdentifierKey</span> : <span class="string">"CentralMangerKey"</span> <span class="keyword">as</span> <span class="type">NSString</span>])</div><div class="line"></div><div class="line"><span class="comment">//一个feture流，当该管理类状态发生变化的时候，他会通知我们</span></div><div class="line"><span class="keyword">let</span> stateChangeFuture = manager.whenStateChanges()</div></pre></td></tr></table></figure>
<ul>
<li>扫描广播包含ec00服务的外设</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//如果蓝牙是开启的，那么就可以扫描</span></div><div class="line"><span class="keyword">let</span> scanFuture = stateChangeFuture.flatMap &#123; state -&gt; <span class="type">FutureStream</span>&lt;<span class="type">Peripheral</span>&gt; <span class="keyword">in</span></div><div class="line">    <span class="keyword">switch</span> state &#123;</div><div class="line">    <span class="keyword">case</span> .poweredOn:</div><div class="line">        <span class="type">DispatchQueue</span>.main.async &#123;</div><div class="line">            <span class="keyword">self</span>.connectionStatusLabel.text = <span class="string">"start scanning"</span></div><div class="line">            <span class="built_in">print</span>(<span class="keyword">self</span>.connectionStatusLabel.text!)</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//扫描广播了服务为ec00的设备</span></div><div class="line">        <span class="keyword">return</span> manager.startScanning(forServiceUUIDs: [serviceUUID])</div><div class="line">    <span class="keyword">case</span> .poweredOff:</div><div class="line">        <span class="keyword">throw</span> <span class="type">AppError</span>.poweredOff</div><div class="line">    <span class="keyword">case</span> .unauthorized, .unsupported:</div><div class="line">        <span class="keyword">throw</span> <span class="type">AppError</span>.invalidState</div><div class="line">    <span class="keyword">case</span> .resetting:</div><div class="line">        <span class="keyword">throw</span> <span class="type">AppError</span>.resetting</div><div class="line">    <span class="keyword">case</span> .unknown:</div><div class="line">        <span class="keyword">throw</span> <span class="type">AppError</span>.unknown</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>第一个找到有该服务的类，我们连接他</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//连接第一个找到的设备</span></div><div class="line"><span class="keyword">let</span> connectionFuture = scanFuture.flatMap &#123; peripheral -&gt; <span class="type">FutureStream</span>&lt;<span class="type">Peripheral</span>&gt; <span class="keyword">in</span></div><div class="line">    <span class="comment">//找到了立即停止扫描</span></div><div class="line">    manager.stopScanning()</div><div class="line">    <span class="type">DispatchQueue</span>.main.async &#123;</div><div class="line">        <span class="keyword">self</span>.connectionStatusLabel.text = <span class="string">"Found peripheral \(peripheral.identifier.uuidString). Trying to connect"</span></div><div class="line">        <span class="built_in">print</span>(<span class="keyword">self</span>.connectionStatusLabel.text!)</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//连接</span></div><div class="line">    <span class="keyword">return</span> peripheral.connect(connectionTimeout: <span class="number">10</span>, capacity: <span class="number">5</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>接着，我们寻找为“ec00”的服务，这步有点像重复了上一步，但是实例化服务对象是非常重要的，它将帮我们找到需要的特征</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//找到"ec00"的服务，并访问他的特征</span></div><div class="line"><span class="keyword">let</span> discoveryFuture = connectionFuture.flatMap &#123; peripheral -&gt; <span class="type">Future</span>&lt;<span class="type">Peripheral</span>&gt; <span class="keyword">in</span></div><div class="line">    <span class="keyword">return</span> peripheral.discoverServices([serviceUUID])</div><div class="line">    &#125;.flatMap &#123; discoveredPeripheral -&gt; <span class="type">Future</span>&lt;<span class="type">Service</span>&gt; <span class="keyword">in</span></div><div class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> service = discoveredPeripheral.service(serviceUUID) <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="type">AppError</span>.serviceNotFound</div><div class="line">        &#125;</div><div class="line">        peripheral = discoveredPeripheral</div><div class="line">        <span class="type">DispatchQueue</span>.main.async &#123;</div><div class="line">            <span class="keyword">self</span>.connectionStatusLabel.text = <span class="string">"Discovered service \(service.uuid.uuidString). Trying to discover characteristics"</span></div><div class="line">            <span class="built_in">print</span>(<span class="keyword">self</span>.connectionStatusLabel.text!)</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//开始检查找到的服务，寻找为"ec0e"的特征</span></div><div class="line">        <span class="keyword">return</span> service.discoverCharacteristics([dateCharacteristicUUID])</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>找到”ec0e”的特征，然后注册通知</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> 1- 检查这特征是否被找到</span></div><div class="line"><span class="comment"> 2- 注册通知</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">let</span> dataFuture = discoveryFuture.flatMap &#123; service -&gt; <span class="type">Future</span>&lt;<span class="type">Characteristic</span>&gt; <span class="keyword">in</span></div><div class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> dataCharacteristic = service.characteristic(dateCharacteristicUUID) <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="type">AppError</span>.dataCharactertisticNotFound</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">self</span>.dataCharacteristic = dataCharacteristic</div><div class="line">    <span class="type">DispatchQueue</span>.main.async &#123;</div><div class="line">        <span class="keyword">self</span>.connectionStatusLabel.text = <span class="string">"Discovered characteristic \(dataCharacteristic.uuid.uuidString). COOL :)"</span></div><div class="line">        <span class="built_in">print</span>(<span class="keyword">self</span>.connectionStatusLabel.text!)</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//当我们找到了该特征，我们可以展示特征交互视图</span></div><div class="line">    <span class="type">DispatchQueue</span>.main.async &#123;</div><div class="line">        <span class="keyword">self</span>.loadingView.isHidden = <span class="literal">true</span></div><div class="line">        <span class="keyword">self</span>.characteristicView.isHidden = <span class="literal">false</span></div><div class="line">    &#125;</div><div class="line">    <span class="comment">//从特征读取数据</span></div><div class="line">    <span class="keyword">self</span>.read()</div><div class="line">    <span class="comment">//告诉特征开启值变化的通知</span></div><div class="line">    <span class="keyword">return</span> dataCharacteristic.startNotifying()</div><div class="line">    &#125;.flatMap &#123; characteristic -&gt; <span class="type">FutureStream</span>&lt;(characteristic: <span class="type">Characteristic</span>, data: <span class="type">Data</span>?)&gt; <span class="keyword">in</span></div><div class="line">        <span class="comment">//注册接收值变化通知</span></div><div class="line">        <span class="keyword">return</span> characteristic.receiveNotificationUpdates(capacity: <span class="number">10</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//每当值变化，都会调用该闭包</span></div><div class="line">dataFuture.onSuccess &#123; (<span class="number">_</span>, data) <span class="keyword">in</span></div><div class="line">    <span class="keyword">let</span> s = <span class="type">String</span>(data:data!, encoding: .utf8)</div><div class="line">    <span class="type">DispatchQueue</span>.main.async &#123;</div><div class="line">        <span class="keyword">self</span>.notifiedValueLabel.text = <span class="string">"notified value is \(s)"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>也可以使用一个简单的函数链来完成以上所有步骤。<br>获得了特征对象，我们就能对它读写数据了。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">read</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="comment">//read a value from the characteristic</span></div><div class="line">    <span class="keyword">let</span> readFuture = <span class="keyword">self</span>.dataCharacteristic?.read(timeout: <span class="number">5</span>)</div><div class="line">    readFuture?.onSuccess &#123; (<span class="number">_</span>) <span class="keyword">in</span></div><div class="line">        <span class="comment">//the value is in the dataValue property</span></div><div class="line">        <span class="keyword">let</span> s = <span class="type">String</span>(data:(<span class="keyword">self</span>.dataCharacteristic?.dataValue)!, encoding: .utf8)</div><div class="line">        <span class="type">DispatchQueue</span>.main.async &#123;</div><div class="line">            <span class="keyword">self</span>.valueLabel.text = <span class="string">"Read value is \(s)"</span></div><div class="line">            <span class="built_in">print</span>(<span class="keyword">self</span>.valueLabel.text!)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    readFuture?.onFailure &#123; (<span class="number">_</span>) <span class="keyword">in</span></div><div class="line">        <span class="keyword">self</span>.valueLabel.text = <span class="string">"read error"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">write</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="keyword">self</span>.valueToWriteTextField.resignFirstResponder()</div><div class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> text = <span class="keyword">self</span>.valueToWriteTextField.text <span class="keyword">else</span>&#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//write a value to the characteristic</span></div><div class="line">    <span class="keyword">let</span> writeFuture = <span class="keyword">self</span>.dataCharacteristic?.write(data:text.data(using: .utf8)!)</div><div class="line">    writeFuture?.onSuccess(completion: &#123; (<span class="number">_</span>) <span class="keyword">in</span></div><div class="line">        <span class="built_in">print</span>(<span class="string">"write succes"</span>)</div><div class="line">    &#125;)</div><div class="line">    writeFuture?.onFailure(completion: &#123; (e) <span class="keyword">in</span></div><div class="line">        <span class="built_in">print</span>(<span class="string">"write failed"</span>)</div><div class="line">    &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>本文是对蓝牙低功耗的粗浅的学习。BLE是一个蓝牙标准，允许无需在系统设置中进行配对的进行连接通信以降低通信的功耗。我们再iOS上实现了一个蓝牙中心设备，它连接到了Mac上模拟的外设。<br>我们可以使用BLE做很多的事情。例如我们可以在智能手环上编写我们自己的应用程序。又例如，我们也可以在Arduino主板上安装BLE芯片，通过他实现很多有趣的应用。译者接触过的很多个智能产品的项目，核心芯片都是Nordic。</p>
<p>该项目的源码可以在GitHub上看到，(<a href="https://github.com/yostane/iOS-BlueCap-Example)[https://github.com/yostane/iOS-BlueCap-Example]。" target="_blank" rel="external">https://github.com/yostane/iOS-BlueCap-Example)[https://github.com/yostane/iOS-BlueCap-Example]。</a></p>
<p>赶紧动手实现下才是最快乐的事情:)。</p>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><p><a href="https://oleb.net/blog/2013/04/starting-bluetooth-low-energy-development-ios/" target="_blank" rel="external">https://oleb.net/blog/2013/04/starting-bluetooth-low-energy-development-ios/</a></p>
<p><a href="https://docs.mbed.com/docs/ble-intros/en/latest/Introduction/BLEInDepth/" target="_blank" rel="external">https://docs.mbed.com/docs/ble-intros/en/latest/Introduction/BLEInDepth/</a></p>
<p><a href="https://stackoverflow.com/questions/17732321/peripheral-and-central-at-the-same-time-on-ios" target="_blank" rel="external">https://stackoverflow.com/questions/17732321/peripheral-and-central-at-the-same-time-on-ios</a></p>
<p><a href="https://learn.adafruit.com/introduction-to-bluetooth-low-energy/gatt" target="_blank" rel="external">https://learn.adafruit.com/introduction-to-bluetooth-low-energy/gatt</a></p>
<p><a href="https://www.bluetooth.com/specifications/generic-attributes-overvie" target="_blank" rel="external">https://www.bluetooth.com/specifications/generic-attributes-overvie</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/16/Xcode-9-0-beta5-编辑Storyboard时闪退问题/" itemprop="url">
                  Xcode 9.0 beta5,编辑Storyboard时闪退问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2017-08-16T10:37:01+08:00" content="2017-08-16">
              2017-08-16
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h1><p>最近吃螃蟹，一直使用Xcode9 Beta版本（其实就是新项目直接用Swift4写了，省得到时候还要再做适配）。然而遇到了很多问题，一些问题也就不说了，但这次遇到这个问题，实在不能忍，升级到Xcode 9.0 beta5后，项目的主Storyboard打不开了。</p>
<h1 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h1><p>Xcode闪退日志如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div></pre></td><td class="code"><pre><div class="line">Process:               Xcode [33099]  </div><div class="line">Path:                  /Applications/Xcode-beta.app/Contents/MacOS/Xcode  </div><div class="line">Identifier:            com.apple.dt.Xcode  </div><div class="line">Version:               9.0 (13226.5)  </div><div class="line">Build Info:            IDEFrameworks-13226005000000000~14  </div><div class="line">Code Type:             X86-64 (Native)  </div><div class="line">Parent Process:        ??? [1]  </div><div class="line">Responsible:           Xcode [33099]  </div><div class="line">User ID:               1700997662  </div><div class="line">  </div><div class="line">  </div><div class="line">Date/Time:             2017-08-10 15:45:59.315 -0400  </div><div class="line">OS Version:            Mac OS X 10.12.6 (16G29)  </div><div class="line">Report Version:        12  </div><div class="line">Anonymous UUID:        4C707867-0F4B-A4D5-CFF4-F497B7B7F058  </div><div class="line">  </div><div class="line">  </div><div class="line">  </div><div class="line">  </div><div class="line">Time Awake Since Boot: 1200000 seconds  </div><div class="line">  </div><div class="line">  </div><div class="line">System Integrity Protection: enabled  </div><div class="line">  </div><div class="line">  </div><div class="line">Crashed Thread:        0  Dispatch queue: com.apple.main-thread  </div><div class="line">  </div><div class="line">  </div><div class="line">Exception Type:        EXC_CRASH (SIGABRT)  </div><div class="line">Exception Codes:       0x0000000000000000, 0x0000000000000000  </div><div class="line">Exception Note:        EXC_CORPSE_NOTIFY  </div><div class="line">  </div><div class="line">  </div><div class="line">Application Specific Information:  </div><div class="line">ProductBuildVersion: 9M202q  </div><div class="line">ASSERTION FAILURE in /Library/Caches/com.apple.xbs/Sources/IDEInterfaceBuilder/IDEInterfaceBuilder-13178.6/InterfaceBuilderKit/Document/StoryboardDocument/Metrics/IBStoryboardMetricsInferrer.m:128  </div><div class="line">Details:  Failed to push inherited simulated metrics to all scenes.  </div><div class="line">Object:   &lt;IBStoryboardMetricsInferrer: 0x7fb91138a690&gt;  </div><div class="line">Method:   -rebuildInferredMetrics  </div><div class="line">Thread:   &lt;NSThread: 0x7fb907c18050&gt;&#123;number = 1, name = main&#125;  </div><div class="line">Hints:   </div><div class="line">  0: Replacement view is installing: &lt;IBStoryboardCanvasViewController: 0x7fb911167ee0 representing: (null)&gt;  </div><div class="line">Backtrace:  </div><div class="line">  0   -[IDEAssertionHandler handleFailureInMethod:object:fileName:lineNumber:assertionSignature:messageFormat:arguments:] (in IDEKit)  </div><div class="line">  1   _DVTAssertionHandler (in DVTFoundation)  </div><div class="line">  2   _DVTAssertionFailureHandler (in DVTFoundation)  </div><div class="line">  3   -[IBStoryboardMetricsInferrer rebuildInferredMetrics] (in IDEInterfaceBuilderKit)  </div><div class="line">  4   -[DVTDelayedInvocation runBlock:] (in DVTFoundation)  </div><div class="line">  5   -[DVTDelayedInvocation invokeIfNeeded] (in DVTFoundation)  </div><div class="line">  6   -[DVTDelayedInvocation invoke] (in DVTFoundation)  </div><div class="line">  7   -[IBCocoaTouchDocumentPlatformAdapter updateDocumentSimulatedMetricsWithDeviceConfiguration:] (in IDEInterfaceBuilderCocoaTouchIntegration)  </div><div class="line">  8   -[IBDocument switchToDeviceConfigurationWithoutFrameDeciding:] (in IDEInterfaceBuilderKit)  </div><div class="line">  9   -[IBDocument switchToDeviceConfiguration:] (in IDEInterfaceBuilderKit)  </div><div class="line">10   -[IBCanvasViewController _addDeviceBarIfNeeded] (in IDEInterfaceBuilderKit)  </div><div class="line">11   -[IBAbstractDocumentEditor didFinishLoadingSubViewControllers] (in IDEInterfaceBuilderKit)  </div><div class="line">12   -[IBAbstractDocumentEditor replacementView:didInstallViewController:] (in IDEInterfaceBuilderKit)  </div><div class="line">13   __42-[DVTReplacementView _setupViewController]_block_invoke (in DVTKit)  </div><div class="line">14   DVTInvokeWithFailureHint (in DVTFoundation)  </div><div class="line">15   -[DVTReplacementView _setupViewController] (in DVTKit)  </div><div class="line">16   -[DVTReplacementView installedViewController] (in DVTKit)  </div><div class="line">17   -[IBAbstractDocumentEditor viewDidInstall] (in IDEInterfaceBuilderKit)  </div><div class="line">18   -[IBStoryboardDocumentEditor viewDidInstall] (in IDEInterfaceBuilderKit)  </div><div class="line">19   -[DVTViewController _viewDidInstall] (in DVTKit)  </div><div class="line">20   -[_DVTViewController_ViewLifecycleInterpositions viewDidMoveToWindow] (in DVTKit)  </div><div class="line">21   -[NSView _setWindow:] (in AppKit)  </div><div class="line">22   -[NSView addSubview:] (in AppKit)  </div><div class="line">23   -[NSView setSubviews:] (in AppKit)  </div><div class="line">24   -[DVTBorderedView setContentView:] (in DVTKit)  </div><div class="line">25   -[IDEEditorContext _setEditorView] (in IDEKit)  </div><div class="line">26   -[IDEEditorContext setupNewEditor:] (in IDEKit)  </div><div class="line">27   __91-[IDEEditorContext _openNavigableItem:documentExtension:document:shouldInstallEditorBlock:]_block_invoke (in IDEKit)  </div><div class="line">28   -[IDEEditorContext _performBlockInsideReentrantGuard:] (in IDEKit)  </div><div class="line">29   -[IDEEditorContext _openNavigableItem:documentExtension:document:shouldInstallEditorBlock:] (in IDEKit)  </div><div class="line">30   -[IDEEditorContext _openNavigableItem:withContentsOfURL:documentExtension:shouldInstallEditorBlock:] (in IDEKit)  </div><div class="line">31   -[IDEEditorContext _notifyDelegateAndOpenNavigableItem:withContentsURL:documentExtensionIdentifier:locationToSelect:annotationRepresentedObject:stateDictionary:annotationWantsIndicatorAnimation:exploreAnnotationRepresentedObject:highlightSelection:alwaysReplaceExistingNavigableItem:skipSubDocumentNavigationUnlessEditorIsReplaced:] (in IDEKit)  </div><div class="line">32   -[IDEEditorContext _notifyDelegateAndOpenEditorOpenSpecifier:updateHistory:] (in IDEKit)  </div><div class="line">33   -[IDEEditorContext openEditorOpenSpecifier:updateHistory:] (in IDEKit)  </div><div class="line">34   -[IDEEditorContext openEditorOpenSpecifier:] (in IDEKit)  </div><div class="line">35   -[IDEEditorModeViewController openEditorOpenSpecifier:editorContext:] (in IDEKit)  </div><div class="line">36   -[IDEEditorArea _openEditorOpenSpecifier:editorContext:takeFocus:] (in IDEKit)  </div><div class="line">37   __108+[IDEEditorCoordinator _doOpenEditorOpenSpecifier:forWorkspaceTabController:editorContext:target:takeFocus:]_block_invoke_2 (in IDEKit)  </div><div class="line">38   __108+[IDEEditorCoordinator _doOpenEditorOpenSpecifier:forWorkspaceTabController:editorContext:target:takeFocus:]_block_invoke (in IDEKit)  </div><div class="line">39   +[IDEEditorCoordinator _doOpenWithWorkspaceTabController:editorContext:target:allowFallback:documentURL:usingBlock:] (in IDEKit)  </div><div class="line">40   +[IDEEditorCoordinator _doOpenEditorOpenSpecifier:forWorkspaceTabController:editorContext:target:takeFocus:] (in IDEKit)  </div><div class="line">41   -[_IDEOpenRequest _primitiveRunIfNecessary] (in IDEKit)  </div><div class="line">42   -[_IDEOpenRequest _runIfNecessary] (in IDEKit)  </div><div class="line">43   __NSFireDelayedPerform (in Foundation)  </div><div class="line">44   __CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__ (in CoreFoundation)  </div><div class="line">45   __CFRunLoopDoTimer (in CoreFoundation)  </div><div class="line">46   __CFRunLoopDoTimers (in CoreFoundation)  </div><div class="line">47   __CFRunLoopRun (in CoreFoundation)  </div><div class="line">48   CFRunLoopRunSpecific (in CoreFoundation)  </div><div class="line">49   RunCurrentEventLoopInMode (in HIToolbox)  </div><div class="line">50   ReceiveNextEventCommon (in HIToolbox)  </div><div class="line">51   _BlockUntilNextEventMatchingListInModeWithFilter (in HIToolbox)  </div><div class="line">52   _DPSNextEvent (in AppKit)  </div><div class="line">53   -[NSApplication(NSEvent) _nextEventMatchingEventMask:untilDate:inMode:dequeue:] (in AppKit)  </div><div class="line">54   -[DVTApplication nextEventMatchingMask:untilDate:inMode:dequeue:] (in DVTKit)  </div><div class="line">55   -[NSApplication run] (in AppKit)  </div><div class="line">56   NSApplicationMain (in AppKit)  </div><div class="line">57   start (in libdyld.dylib)</div></pre></td></tr></table></figure>
<h1 id="寻找解决方案"><a href="#寻找解决方案" class="headerlink" title="寻找解决方案"></a>寻找解决方案</h1><p>看到Apple Developer Forums上很多人提了类似的问题，但并没有人踢出解决方案。</p>
<p>从日志看，只有关键词inherited，但把相关的都去掉了，也并没有效果。</p>
<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><p>通过尝试重新创建Storyboard进行测试，还有就是git往前回退找一个不闪退版本的Storyboard，通过他们之间的比较，猜测可能是gestureRecognizers的问题。</p>
<p>然后，把gestureRecognizers相关的部分都删了，通过代码实现gesture，就不会出现闪退问题了，真是运气好。</p>
<p>删除以下3部分代码。</p>
<pre><code>&lt;!-- 删除&lt;gestureRecognizers/&gt; --&gt;

&lt;!--
&lt;connections&gt;
    &lt;outletCollection property=&quot;gestureRecognizers&quot; destination=&quot;ngk-1s-19f&quot; appends=&quot;YES&quot; id=&quot;xDu-EO-3XT&quot;/&gt;
&lt;/connections&gt;
--&gt;

&lt;!--
&lt;tapGestureRecognizer id=&quot;ngk-1s-19f&quot;&gt;
    &lt;connections&gt;
        &lt;action selector=&quot;tapConnectGestureAction:&quot; destination=&quot;TSL-wS-yk1&quot; id=&quot;VZS-RM-dhp&quot;/&gt;
        &lt;segue destination=&quot;7YZ-oH-7MN&quot; kind=&quot;presentation&quot; id=&quot;WjS-a1-0BG&quot;/&gt;
    &lt;/connections&gt;
&lt;/tapGestureRecognizer&gt;
--&gt;
</code></pre>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="David Woo" />
          <p class="site-author-name" itemprop="name">David Woo</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/">
              <span class="site-state-item-count">105</span>
              <span class="site-state-item-name">Artikel</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">195</span>
                <span class="site-state-item-name">Kategorien</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">Tags</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">David Woo</span>
</div>

<div class="powered-by">
  Erstellt mit  <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  




  
  

  

  

  

</body>
</html>
