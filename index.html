<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="大胃吴的闲话唠嗑">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="大胃吴的闲话唠嗑">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="大胃吴的闲话唠嗑">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/"/>

  <title> 大胃吴的闲话唠嗑 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">大胃吴的闲话唠嗑</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">扯扯技术，唠唠闲话 交流email-xiao303178394@gmail.com</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-首页">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            menu.首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-文章">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            menu.文章
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/05/27/optimize-big-amount-cell-image-load/" itemprop="url">
                  优化无限数量快速滑动情况的Cell Image加载过程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2020-05-27T20:49:19+08:00" content="2020-05-27">
              2020-05-27
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="TableView图片加载优化"><a href="#TableView图片加载优化" class="headerlink" title="TableView图片加载优化"></a>TableView图片加载优化</h1><h2 id="Situation"><a href="#Situation" class="headerlink" title="Situation"></a>Situation</h2><p>昨天被位大佬问到当一个TableView有无限多的Cell，当快速滑动时候，如何避免由于加载图片造成的卡顿问题。<br>UITableView算最常用的UIKit控件之一了，苹果已经为它做了很多优化，比如重用池就解决了反复创建Cell造成的性能问题。<br>但像iPhone5S上还是无法运行流畅滑动TableView，Cell的离屏渲染、Cell过大、Cell滑动过程大图片加载、业务逻辑阻塞线程等都是造成滑动不流畅的原因。<br>大图片可以考虑把加载图片的block添加到DefaultRunLoopMode上执行，但大佬说的图片较小，需要滑动过程就立即展现，确实很少会有这种情况，因为一般产品设计和交互设计上，都会有分页加载逻辑，不会出现可以让用户疯狂无限滑动情况。</p>
<p>不过这个问题还是可以研究一下的TableView图片加载优化。</p>
<p><a href="https://github.com/yuezaixz/DwOptimizeCellImageLoad/tree/start_project" target="_blank" rel="external">初始工程分支</a></p>
<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><ul>
<li>大量图片，url不一致不会被cache命中。</li>
<li>快速滑动卡顿或者滑动结束后图片无法加载，因为中间N张图片正在加载，体验糟糕</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">extension ViewController: UITableViewDelegate, UITableViewDataSource &#123;</div><div class="line">    </div><div class="line">    func tableView(_ tableView: UITableView, heightForRowAt indexPath: IndexPath) -&gt; CGFloat &#123;</div><div class="line">        return 60.0</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -&gt; Int &#123;</div><div class="line">        10000</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -&gt; UITableViewCell &#123;</div><div class="line">        let cell = tableView.dequeueReusableCell(withIdentifier: ImageTableViewCell.kReuseIdentifier, for: indexPath) as! ImageTableViewCell</div><div class="line">        cell.loadImage(imageUrlStr: imageUrlStrs[indexPath.row % 8] + &quot;?random=&quot; + randomStrUtil.getRandomStringOfLength(length: 10))</div><div class="line">        return cell</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Task"><a href="#Task" class="headerlink" title="Task"></a>Task</h2><p>可以从几个方面去考虑优化：</p>
<ul>
<li>异步渲染，本案例中不使用这个方式，可以使用AsyncDisplayKit(现在叫Texture)</li>
<li>根据行为区分加载策略，快速滑动时候，只加载内存缓存的图片，因为磁盘加载还需要解码，生成位图，也是耗时操作；滑动或者减速后才正常通过全缓存和网络进行加载</li>
</ul>
<h2 id="Action"><a href="#Action" class="headerlink" title="Action"></a>Action</h2><h3 id="根据滚动的交互，来控制load"><a href="#根据滚动的交互，来控制load" class="headerlink" title="根据滚动的交互，来控制load"></a>根据滚动的交互，来控制load</h3><ul>
<li>finalPureLand为放开拖动时候的区域finalPureLand</li>
<li>刚刚拖拽时:finalPureLand=nil</li>
<li>拖拽完毕的减速过程:速度超过一个常量则finalPureLand=Rect，否则还是nil，finalPureLand有值情况，判断当前界面展现的cell是否在相应范围内，在的话加载内存中图片，没加载到则不加载</li>
<li>减速还未完全停止时再次拖拽:finalPureLand=nil</li>
<li>手势跟随过程中，仍然加载图片</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">extension ViewController: UIScrollViewDelegate &#123;</div><div class="line">    </div><div class="line">    // 刚开始拖动，可以加载图片</div><div class="line">    func scrollViewWillBeginDragging(_ scrollView: UIScrollView) &#123;</div><div class="line">        finalPureLand = nil</div><div class="line">        </div><div class="line">        loadImageIfNeed()</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    // 滚动过程中，如果手势跟随，加载图片</div><div class="line">    func scrollViewDidScroll(_ scrollView: UIScrollView) &#123;</div><div class="line">        if scrollView.isTracking &#123;</div><div class="line">            loadImageIfNeed()</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    // 手势放开，根据速度判断是否要启用内存加载机制</div><div class="line">    func scrollViewWillEndDragging(_ scrollView: UIScrollView, withVelocity velocity: CGPoint, targetContentOffset: UnsafeMutablePointer&lt;CGPoint&gt;) &#123;</div><div class="line">        // 速度低的话，加载，速度快的话，等减速</div><div class="line">        // 1 是个magicNum，DEMO项目不要太注意细节 =。。=</div><div class="line">        if velocity.y &gt; 1 &#123;</div><div class="line">            finalPureLand = CGRect(x: targetContentOffset.pointee.x, y: targetContentOffset.pointee.y, width: scrollView.frame.size.width, height: scrollView.frame.size.height)</div><div class="line">        &#125; else &#123;</div><div class="line">            finalPureLand = nil</div><div class="line">            loadImageIfNeed()</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    // 结束减速，正常加载图片</div><div class="line">    func scrollViewDidEndDecelerating(_ scrollView: UIScrollView) &#123;</div><div class="line">        finalPureLand = nil</div><div class="line">        loadImageIfNeed()</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    func loadImageIfNeed() &#123;</div><div class="line">        for cell in tableView.visibleCells &#123;</div><div class="line">            if let indexPath = tableView.indexPath(for: cell), let imageCell = cell as? ImageTableViewCell &#123;</div><div class="line">                </div><div class="line">                // 制造一些可以在内存中展现的cell</div><div class="line">                let urlStr = indexPath.row / 10 % 5 == 1 ? imageUrlStrs[indexPath.row % 8] : (imageUrlStrs[indexPath.row % 8] + &quot;?random=\(indexPath.row)&quot;)</div><div class="line">                let cellRect = tableView.rectForRow(at: indexPath)</div><div class="line">                imageCell.loadImage(imageUrlStr: urlStr, landRect: finalPureLand, cellFrame: cellRect)</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="磁盘加载机制"><a href="#磁盘加载机制" class="headerlink" title="磁盘加载机制"></a>磁盘加载机制</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">func loadImage(imageUrlStr: String, landRect: CGRect?, cellFrame: CGRect) &#123;</div><div class="line">        guard !isLoad else &#123; return &#125;</div><div class="line">        if let landRect = landRect, !landRect.intersects(cellFrame) &#123;</div><div class="line">            // 如果滑动中为减速，则只加载内存中的。</div><div class="line">            // 如果加载硬盘中的，硬盘中的加载后要解析转换成位图，也会造成卡顿</div><div class="line">            if let image = ImageCache.default.retrieveImageInMemoryCache(forKey: imageUrlStr) &#123;</div><div class="line">                isLoad = true</div><div class="line">                avatarImageView.image = image</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">            loadImage(imageUrlStr: imageUrlStr)</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="Result"><a href="#Result" class="headerlink" title="Result"></a>Result</h2><p>效果上看起来，比start分支的效果和体验好太多了。<br>本DEMO只是个实例，具体应用还需要进一步优化，并且需要通过TableView和ImageView的扩展或者继承来实现，达到组件复用。</p>
<p><a href="https://github.com/yuezaixz/DwOptimizeCellImageLoad" target="_blank" rel="external">源码地址</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/05/18/stupid-man-s-Greedy-algo/" itemprop="url">
                  学渣的贪婪算法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2020-05-18T22:24:39+08:00" content="2020-05-18">
              2020-05-18
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="学渣的贪婪算法"><a href="#学渣的贪婪算法" class="headerlink" title="学渣的贪婪算法"></a>学渣的贪婪算法</h1><p>贪婪算法是寻找最优解的常用算法。<br>一般先要确定每一步贪婪的逻辑是什么，也就是在当前状态下最好/最优的选择判断方式，并以此希望最后推导出来的结果是最好的。</p>
<h2 id="沟通交流"><a href="#沟通交流" class="headerlink" title="沟通交流"></a>沟通交流</h2><p>mail: xiao303178394@gmail.com<br>wechat: xiao303178394</p>
<h2 id="有时候不是最优解"><a href="#有时候不是最优解" class="headerlink" title="有时候不是最优解"></a>有时候不是最优解</h2><p>由于只是贪婪局部利益的最大化，他有时候的结果并不是最优解。</p>
<p>比如这个问题，需要找给顾客41分钱，现在的货币只有 25 分、20分、10 分、5 分和 1 分四种硬币</p>
<p>贪婪算法的话，就是尽可能给更大面额的钱，那么就是 25-&gt;10-&gt;5-&gt;1，但其实20-&gt;20-&gt;1才是最优解。</p>
<h2 id="三步骤"><a href="#三步骤" class="headerlink" title="三步骤"></a>三步骤</h2><ul>
<li>从某个初始解出发，设定好最优策略</li>
<li>采用迭代的过程，当可以向目标前进一步时，就根据局部最优策略，得到一部分解，缩小问题规模；</li>
<li>将所有解综合起来。</li>
</ul>
<h2 id="课程问题"><a href="#课程问题" class="headerlink" title="课程问题"></a>课程问题</h2><p>这里有 n 门不同的在线课程，他们按从 1 到 n 编号。每一门课程有一定的持续上课时间（课程时间）t 以及关闭时间第 d 天。一门课要持续学习 t 天直到第 d 天时要完成，你将会从第 1 天开始。</p>
<p>给出 n 个在线课程用 (t, d) 对表示。你的任务是找出最多可以修几门课。</p>
<p><a href="https://leetcode-cn.com/problems/course-schedule-iii" target="_blank" rel="external">直达链接</a></p>
<h3 id="最优策略"><a href="#最优策略" class="headerlink" title="最优策略"></a>最优策略</h3><p>以下是LeetCode官方的最优策略，挺妙的，确实我这脑子想不到：</p>
<blockquote>
<p>如果两门课 (t1, d1) 和 (t2, d2) 满足 d1 &lt;= d2，即后者的结束时间不晚于前者，那么我们先学习前者再学习后者总是最优的。因为如果先学习前者，即需要满足 x + t1 &lt;= d1 且 x + t1 + t2 &lt;= d2；如果先学习后者，则需要满足 x + t2 &lt;= d2 且 x + t1 + t2 &lt;= d1。如果后者中的 x + t1 + t2 &lt;= d1 成立，那么显然有 x + t1 &lt;= d1 且 x + t1 + t2 &lt;= d1 &lt;= d2，即前者一定成立；反之如果 x = 0, (t1, d1) = (2, 3), (t2, d2) = (5, 100)，那么前者成立且后者不成立。因此先学习前者再学习后者总是最优的。</p>
</blockquote>
<p>基于上面的结论，我们可以将课程按照完成时间 d 递增排序。</p>
<h3 id="回溯调整"><a href="#回溯调整" class="headerlink" title="回溯调整"></a>回溯调整</h3><p>ti与di为当前遍历到的课程开始时间与结束时间</p>
<p>如果当前优先队列中所有课程的时间之和 t 与 ti 之和大于 di，那么找到当前优先队列中课程时间最大的课程 (tj, dj)，如果 tj &gt; ti，则将它移出优先队列，并把 (ti, di) 加入优先队列中。</p>
<h3 id="优化时间复杂度"><a href="#优化时间复杂度" class="headerlink" title="优化时间复杂度"></a>优化时间复杂度</h3><p>因为每次都要调整队列的耗时在长度异常大情况下耗时严重，所以做个小优化，记录下当前的最大时间，只当满足需要替换条件的时候，才做队列排序。</p>
<h3 id="解题"><a href="#解题" class="headerlink" title="解题"></a>解题</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">class Solution &#123;</div><div class="line">    func scheduleCourse(_ courses: [[Int]]) -&gt; Int &#123;</div><div class="line">        let courses = courses.sorted &#123; (c1, c2) -&gt; Bool in</div><div class="line">            if c1[1] == c2[1] &#123;</div><div class="line">                return c1[0] &lt; c2[0]</div><div class="line">            &#125;</div><div class="line">            return c1[1] &lt; c2[1]</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        var sum = 0</div><div class="line">        </div><div class="line">        var queue:[Int] = []</div><div class="line">        // 一个小优化，不然时间达不到要求，每次都要排序</div><div class="line">        var maxCTime: Int = 0</div><div class="line">        </div><div class="line">        for c in courses &#123;</div><div class="line">            if sum + c[0] &lt;= c[1] &#123;</div><div class="line">                sum += c[0]</div><div class="line">                queue.append(c[0])</div><div class="line">                maxCTime = max(c[0], maxCTime)</div><div class="line">            &#125; else &#123;</div><div class="line">                if maxCTime &gt; c[0] &#123;</div><div class="line">                    queue.sort()</div><div class="line">                    sum += c[0] - queue.removeLast()</div><div class="line">                    maxCTime = queue.last ?? 0</div><div class="line">                    queue.append(c[0])</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        return queue.count</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="double-100"><a href="#double-100" class="headerlink" title="double 100%"></a>double 100%</h3><p><img src="http://image.runmaf.com/2020-05-17-15897250256218.jpg" alt=""></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/05/18/stupid-man-s-dfs-bfs/" itemprop="url">
                  学渣的拓扑排序
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2020-05-18T19:53:43+08:00" content="2020-05-18">
              2020-05-18
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="学渣的拓扑排序"><a href="#学渣的拓扑排序" class="headerlink" title="学渣的拓扑排序"></a>学渣的拓扑排序</h1><p>看了好久的 DFS和BFS题目，还是想不到怎么简单解释清楚拓扑排序。</p>
<p>比较标准的解释就是<br>给定一个包含 n 个节点的有向图 G，我们给出它的节点编号的一种排列，如果满足</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">对于图 G 中的任意一条有向边 (u, v)，u 在排列中都出现在 V 的前面。</div></pre></td></tr></table></figure>
<p>那么称该排列是图 G 的「拓扑排序」。</p>
<p>如果实在理解不了，就记住是一个有向图，但他可以有一些节点独立，他不能存在环。</p>
<h2 id="DFS-深度优先搜索"><a href="#DFS-深度优先搜索" class="headerlink" title="DFS 深度优先搜索"></a>DFS 深度优先搜索</h2><p>如果对二叉树比较熟，那么先序遍历就类似于深度优先搜索。</p>
<p>比如</p>
<table>
<thead>
<tr>
<th>a</th>
<th>→</th>
<th>→</th>
</tr>
</thead>
<tbody>
<tr>
<td>↓</td>
<td>↓</td>
<td>↓</td>
</tr>
<tr>
<td>b</td>
<td>c</td>
<td>d</td>
</tr>
<tr>
<td>↓</td>
<td></td>
<td>↓</td>
</tr>
<tr>
<td>e</td>
<td></td>
<td>f</td>
</tr>
<tr>
<td></td>
<td></td>
<td>↓</td>
</tr>
<tr>
<td></td>
<td></td>
<td>g</td>
</tr>
</tbody>
</table>
<p>那么 a 先放进备忘录memo，备忘录中的元素有3种状态</p>
<ul>
<li>未遍历,记住nil或者0</li>
<li>遍历中,记住1</li>
<li>遍历结束,记住2</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">a 0 b 1 c 2 d 3 e 4 f 5 g 6</div><div class="line">// 先序条件</div><div class="line">edges: [d: [f], b: [e], a: [b, c, d], f: [g]]</div><div class="line"></div><div class="line">// 那么备忘录中的状态变化就是</div><div class="line">遍历a [a: 1] </div><div class="line">找到a的后续节点 b, c, d</div><div class="line">遍历b [b: 1, a: 1]</div><div class="line">找到b的后续节点 e</div><div class="line">遍历e [b: 1, e: 1, a: 1]</div><div class="line">e没有后续节点了，结束标记为2，</div><div class="line">退回到b，b也没有后续节点了，结束标记为2，</div><div class="line">退回到a，遍历a的第二个后续节点c</div><div class="line">遍历c [b: 2, e: 2, a: 1, c: 1]</div><div class="line">c没有后续节点了，结束标记为2，退回到a，继续遍历a的下一个后续节点d</div><div class="line">遍历d [b: 2, e: 2, d: 1, a: 1, c: 2]</div><div class="line">找到d的后续节点 f</div><div class="line">遍历f [b: 2, e: 2, d: 1, 5: 1, a: 1, c: 2]</div><div class="line">找到f的后续节点 g</div><div class="line">遍历g [g: 1, f: 1, e: 2, d: 1, a: 1, b: 2, c: 2]</div><div class="line">g没有后续节点了，结束标记为2，退回到f</div><div class="line">f没有后续节点了，结束标记为2，退回到d</div><div class="line">d没有后续节点了，结束标记为2，退回到a</div><div class="line">a没有后续节点了，结束标记为2，结束</div></pre></td></tr></table></figure>
<p>如果要记录遍历顺序，标记为2的时候，就可以放入results了。<br>由于是深度优先，所以results要reverse下。</p>
<p>如果存在环，那么就会出现要遍历他的时候，他已经是遍历中的状态了，那么这时候就可以直接返回，并标识这不是一个拓扑结构。</p>
<h3 id="例题-课程表"><a href="#例题-课程表" class="headerlink" title="例题-课程表"></a>例题-课程表</h3><p>现在你总共有 n 门课需要选，记为 0 到 n-1。</p>
<p>在选修某些课程之前需要一些先修课程。 例如，想要学习课程 0 ，你需要先完成课程 1 ，我们用一个匹配来表示他们: [0,1]</p>
<p>给定课程总量以及它们的先决条件，返回你为了学完所有课程所安排的学习顺序。</p>
<p>可能会有多个正确的顺序，你只要返回一种就可以了。如果不可能完成所有课程，返回一个空数组。</p>
<p><a href="https://leetcode-cn.com/problems/course-schedule-ii" target="_blank" rel="external">直达链接</a></p>
<h4 id="解题"><a href="#解题" class="headerlink" title="解题"></a>解题</h4><p>前面分析很多了，直接上源码吧</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">findOrder</span><span class="params">(<span class="number">_</span> numCourses: Int, <span class="number">_</span> prerequisites: [[Int]])</span></span> -&gt; [<span class="type">Int</span>] &#123;</div><div class="line">        <span class="keyword">var</span> edges: [<span class="type">Int</span>: [<span class="type">Int</span>]] = [:]</div><div class="line"></div><div class="line">        <span class="keyword">for</span> prerequisite <span class="keyword">in</span> prerequisites &#123;</div><div class="line">            edges[prerequisite[<span class="number">1</span>], <span class="keyword">default</span>: []].append(prerequisite[<span class="number">0</span>])</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">var</span> memo: [<span class="type">Int</span>: <span class="type">Int</span>] = [:]</div><div class="line">        <span class="keyword">var</span> isInvalid = <span class="literal">false</span></div><div class="line">        <span class="keyword">var</span> result: [<span class="type">Int</span>] = []</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">func</span> <span class="title">dfs</span><span class="params">(<span class="number">_</span> i: Int)</span></span> &#123;</div><div class="line">            memo[i] = <span class="number">1</span></div><div class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> edges[i] ?? [] &#123;</div><div class="line">                <span class="keyword">if</span> memo[j] == <span class="literal">nil</span> &#123;</div><div class="line">                    dfs(j)</div><div class="line">                    <span class="keyword">if</span> isInvalid &#123; <span class="keyword">return</span> &#125;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> memo[j] == <span class="number">1</span> &#123;</div><div class="line">                    isInvalid = <span class="literal">true</span></div><div class="line">                    <span class="keyword">return</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            memo[i] = <span class="number">2</span></div><div class="line">            result.append(i)</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span> ..&lt; numCourses <span class="keyword">where</span> !isInvalid &amp;&amp; memo[i] == <span class="literal">nil</span> &#123;</div><div class="line">            dfs(i)</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> isInvalid &#123; <span class="keyword">return</span> [] &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> result.reversed()</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="BFS-广度优先搜索"><a href="#BFS-广度优先搜索" class="headerlink" title="BFS 广度优先搜索"></a>BFS 广度优先搜索</h2><p>广度优先遍历，就类似中序遍历，一层一层的往下。</p>
<p>广度优先需要一个先进先出的队列，队列初始是没有先序的节点，遍历这些节点并塞入他们的后续节点（有多个先序，还需要判断是否先序全部都完成了，所以还需要一个counter记录其先序节点的数量），并且查找该节点的后续节点。</p>
<h3 id="题目-课程表"><a href="#题目-课程表" class="headerlink" title="题目-课程表"></a>题目-课程表</h3><p>题目一样</p>
<h4 id="解题-1"><a href="#解题-1" class="headerlink" title="解题"></a>解题</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">findOrder</span><span class="params">(<span class="number">_</span> numCourses: Int, <span class="number">_</span> prerequisites: [[Int]])</span></span> -&gt; [<span class="type">Int</span>] &#123;</div><div class="line">        <span class="keyword">var</span> edges: [<span class="type">Int</span>: [<span class="type">Int</span>]] = [:]</div><div class="line">        <span class="keyword">var</span> counter: [<span class="type">Int</span>: <span class="type">Int</span>] = [:]</div><div class="line"></div><div class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> prerequisites &#123;</div><div class="line">            edges[p[<span class="number">1</span>], <span class="keyword">default</span>: []].append(p[<span class="number">0</span>])</div><div class="line">            counter[p[<span class="number">0</span>], <span class="keyword">default</span>: <span class="number">0</span>] += <span class="number">1</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">var</span> queue: [<span class="type">Int</span>] = []</div><div class="line"></div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span> ..&lt; numCourses &#123;</div><div class="line">            <span class="keyword">if</span> counter[i] == <span class="literal">nil</span> &#123;</div><div class="line">                queue.append(i)</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">var</span> result: [<span class="type">Int</span>] = []</div><div class="line"></div><div class="line">        <span class="keyword">while</span> !queue.isEmpty &#123;</div><div class="line">            <span class="keyword">let</span> num = queue.removeFirst()</div><div class="line">            result.append(num)</div><div class="line"></div><div class="line">            <span class="keyword">for</span> e <span class="keyword">in</span> edges[num] ?? [] &#123;</div><div class="line">                <span class="keyword">if</span> <span class="keyword">let</span> <span class="built_in">count</span> = counter[e] &#123;</div><div class="line">                    <span class="keyword">if</span> <span class="built_in">count</span> == <span class="number">1</span> &#123;</div><div class="line">                        queue.append(e)</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        counter[e] = <span class="built_in">count</span> - <span class="number">1</span></div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> result.<span class="built_in">count</span> != numCourses &#123;</div><div class="line">            <span class="keyword">return</span> []</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> result</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/05/17/stupid-man-s-dfs/" itemprop="url">
                  学渣的分治算法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2020-05-17T17:25:30+08:00" content="2020-05-17">
              2020-05-17
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="学渣的分治算法"><a href="#学渣的分治算法" class="headerlink" title="学渣的分治算法"></a>学渣的分治算法</h1><p>个人感觉分治算法和区域动规很像，都是把一个大问题拆解成很多小问题。<br>不同的是区域动规是从上往下。<br>而分治算法是从下往上。</p>
<h2 id="一般步骤："><a href="#一般步骤：" class="headerlink" title="一般步骤："></a>一般步骤：</h2><ul>
<li>分解，将问题划分成若干规模较小的同类问题</li>
<li>求解，当子问题足够小，就可以很容易的得到答案</li>
<li>合并，按原问题的要求，将子问题的解逐层合并构成原问题的解</li>
</ul>
<h2 id="二分法"><a href="#二分法" class="headerlink" title="二分法"></a>二分法</h2><p>分治算法所需时间取决于分解后子问题的个数、子问题的复杂度等。<br>而二分法，其划分简单、均匀，是经常采用的一种有效的方法，如二分检索</p>
<h2 id="解题-输出二叉树"><a href="#解题-输出二叉树" class="headerlink" title="解题-输出二叉树"></a>解题-输出二叉树</h2><p>在一个 m*n 的二维字符串数组中输出二叉树，并遵守以下规则：</p>
<ul>
<li>行数 m 应当等于给定二叉树的高度。</li>
<li>列数 n 应当总是奇数。</li>
<li>根节点的值（以字符串格式给出）应当放在可放置的第一行正中间。根节点所在的行与列会将剩余空间划分为两部分（左下部分和右下部分）。你应该将左子树输出在左下部分，右子树输出在右下部分。左下和右下部分应当有相同的大小。即使一个子树为空而另一个非空，你不需要为空的子树输出任何东西，但仍需要为另一个子树留出足够的空间。然而，如果两个子树都为空则不需要为它们留出任何空间。</li>
<li>每个未使用的空间应包含一个空的字符串””。</li>
<li>使用相同的规则输出子树。</li>
</ul>
<p><a href="https://leetcode-cn.com/problems/print-binary-tree" target="_blank" rel="external">直达链接</a></p>
<h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>这道题需要先构建二位数组，所以需要先递归获取到高度，通过高度计算出宽度。<br>然后就可以简单的通过二分搜索来填充这个二位数组了。</p>
<h3 id="解题"><a href="#解题" class="headerlink" title="解题"></a>解题</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TreeNode</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">var</span> val: <span class="type">Int</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">var</span> <span class="keyword">left</span>: <span class="type">TreeNode</span>?</div><div class="line">    <span class="keyword">public</span> <span class="keyword">var</span> <span class="keyword">right</span>: <span class="type">TreeNode</span>?</div><div class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(<span class="number">_</span> val: <span class="type">Int</span>) &#123;</div><div class="line">        <span class="keyword">self</span>.val = val</div><div class="line">        <span class="keyword">self</span>.<span class="keyword">left</span> = <span class="literal">nil</span></div><div class="line">        <span class="keyword">self</span>.<span class="keyword">right</span> = <span class="literal">nil</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">printTree</span><span class="params">(<span class="number">_</span> root: TreeNode?)</span></span> -&gt; [[<span class="type">String</span>]] &#123;</div><div class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> root = root <span class="keyword">else</span> &#123; <span class="keyword">return</span> [] &#125;</div><div class="line">        <span class="keyword">if</span> root.<span class="keyword">left</span> == <span class="literal">nil</span> &amp;&amp; root.<span class="keyword">right</span> == <span class="literal">nil</span> &#123; <span class="keyword">return</span> [[<span class="type">String</span>(root.val)]] &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">let</span> height = treeHeight(root)</div><div class="line">        <span class="keyword">let</span> width = <span class="number">2</span> &lt;&lt; (height - <span class="number">1</span>) - <span class="number">1</span></div><div class="line">        <span class="built_in">print</span>(height, width)</div><div class="line">        </div><div class="line">        <span class="keyword">var</span> result = <span class="type">Array</span>(repeating: <span class="type">Array</span>(repeating: <span class="string">""</span>, <span class="built_in">count</span>: width), <span class="built_in">count</span>: height)</div><div class="line">        </div><div class="line">        dfs(root, result: &amp;result, start: <span class="number">0</span>, end: width - <span class="number">1</span>, deep: <span class="number">0</span>)</div><div class="line">        </div><div class="line">        <span class="keyword">return</span> result</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">dfs</span><span class="params">(<span class="number">_</span> root: TreeNode?, result: <span class="keyword">inout</span> [[String]] ,start: Int, end: Int, deep: Int)</span></span> &#123;</div><div class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> root = root <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</div><div class="line">        <span class="keyword">let</span> mid = (start + end) &gt;&gt; <span class="number">1</span></div><div class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="keyword">left</span> = root.<span class="keyword">left</span> &#123;</div><div class="line">            dfs(<span class="keyword">left</span>, result: &amp;result, start: start, end: mid - <span class="number">1</span>, deep: deep + <span class="number">1</span>)</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="keyword">right</span> = root.<span class="keyword">right</span> &#123;</div><div class="line">            dfs(<span class="keyword">right</span>, result: &amp;result, start: mid + <span class="number">1</span>, end: end, deep: deep + <span class="number">1</span>)</div><div class="line">        &#125;</div><div class="line">        result[deep][mid] = <span class="type">String</span>(root.val)</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">treeHeight</span><span class="params">(<span class="number">_</span> root: TreeNode?)</span></span> -&gt; <span class="type">Int</span> &#123;</div><div class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> root = root <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="number">0</span> &#125;</div><div class="line">        <span class="keyword">if</span> root.<span class="keyword">left</span> == <span class="literal">nil</span> &amp;&amp; root.<span class="keyword">right</span> == <span class="literal">nil</span> &#123; <span class="keyword">return</span> <span class="number">1</span> &#125;</div><div class="line">        <span class="keyword">return</span> <span class="built_in">max</span>(treeHeight(root.<span class="keyword">left</span>), treeHeight(root.<span class="keyword">right</span>)) + <span class="number">1</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="double-100"><a href="#double-100" class="headerlink" title="double 100%"></a>double 100%</h3><p><img src="http://image.runmaf.com/2020-05-17-15897074475037.jpg" alt=""></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/05/17/stupid-man-s-area-dp/" itemprop="url">
                  学渣的区域动规
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2020-05-17T11:07:41+08:00" content="2020-05-17">
              2020-05-17
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="学渣的区域动规"><a href="#学渣的区域动规" class="headerlink" title="学渣的区域动规"></a>学渣的区域动规</h1><p>区域动规主要是把一个问题分成具有相同复杂度的小问题，以便从小到大解决问题。</p>
<p>概念比较生硬，直接拿题目来说吧。</p>
<h2 id="沟通交流"><a href="#沟通交流" class="headerlink" title="沟通交流"></a>沟通交流</h2><p>mail: xiao303178394@gmail.com<br>wechat: xiao303178394</p>
<h2 id="青蛙过河"><a href="#青蛙过河" class="headerlink" title="青蛙过河"></a>青蛙过河</h2><p>一只青蛙想要过河。 假定河流被等分为 x 个单元格，并且在每一个单元格内都有可能放有一石子（也有可能没有）。 青蛙可以跳上石头，但是不可以跳入水中。</p>
<p>给定石子的位置列表（用单元格序号升序表示）， 请判定青蛙能否成功过河（即能否在最后一步跳至最后一个石子上）。 开始时， 青蛙默认已站在第一个石子上，并可以假定它第一步只能跳跃一个单位（即只能从单元格1跳至单元格2）。</p>
<p>如果青蛙上一步跳跃了 k 个单位，那么它接下来的跳跃距离只能选择为 k - 1、k 或 k + 1个单位。 另请注意，青蛙只能向前方（终点的方向）跳跃。</p>
<p><a href="https://leetcode-cn.com/problems/frog-jump" target="_blank" rel="external">直达链接：</a></p>
<h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>把问题化解成一堆小问题。</p>
<ul>
<li>能否跳到位置需要为0的石头？可以，跳0步</li>
<li>能否跳到位置为1的石头？上一步跳了0，那么这一步跳0+1,所以可以跳到</li>
<li>能否跳到位置为i的石头？上一步跳到k，跳了j（j可能有几种情况或），那么 stones[i] = (stones[k] + j + 1 ) || (stones[k] + j ) || (stones[k] + j - 1 )成立的话，就可以跳到</li>
<li>…</li>
</ul>
<h3 id="转移方程"><a href="#转移方程" class="headerlink" title="转移方程"></a>转移方程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">// j in dp[k], i = k + j</div><div class="line">if k in dp and i in dp:</div><div class="line">	dp[i] = Set[所有满足条件的j]</div></pre></td></tr></table></figure>
<h3 id="状态标识"><a href="#状态标识" class="headerlink" title="状态标识"></a>状态标识</h3><p>stones 为输入数列<br>m 为数字的数量</p>
<p>dp是一个Dict<int: set<int="">&gt;的数据结构<br>key是i，i为位置序号<br>value为跳到i的跳跃距离集合，所以dp[i][j]存在则代表可以通过最后一步j的跳远距离，跳跃到序号为i的石头</int:></p>
<p>k标识上一步的位置序号</p>
<h3 id="边界"><a href="#边界" class="headerlink" title="边界"></a>边界</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">dp[0] = Set[0]</div></pre></td></tr></table></figure>
<h3 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h3><p>dp[stones[m - 1]] 非空</p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">canCross</span><span class="params">(<span class="number">_</span> stones: [Int])</span></span> -&gt; <span class="type">Bool</span> &#123;</div><div class="line">        <span class="keyword">let</span> m = stones.<span class="built_in">count</span></div><div class="line">        <span class="keyword">if</span> m &lt;= <span class="number">1</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">true</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">var</span> dp = <span class="type">Dictionary</span>&lt;<span class="type">Int</span>, <span class="type">Set</span>&lt;<span class="type">Int</span>&gt;&gt;()</div><div class="line">        </div><div class="line">        <span class="keyword">for</span> stone <span class="keyword">in</span> stones &#123;</div><div class="line">            dp[stone] = <span class="type">Set</span>&lt;<span class="type">Int</span>&gt;()</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        dp[stones[<span class="number">0</span>]]?.insert(<span class="number">0</span>)</div><div class="line">        </div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span> ..&lt; m &#123;</div><div class="line">            <span class="keyword">let</span> curr = stones[i]</div><div class="line">            <span class="keyword">let</span> si = dp[curr]!</div><div class="line">            </div><div class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> si &#123;</div><div class="line">                <span class="keyword">for</span> j <span class="keyword">in</span> k - <span class="number">1</span> ... k + <span class="number">1</span> &#123;</div><div class="line">                    <span class="keyword">if</span> dp.keys.<span class="built_in">contains</span>(curr + j) &#123;</div><div class="line">                        dp[curr + j]?.insert(j)</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">return</span> !dp[stones[m - <span class="number">1</span>]]!.isEmpty</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">assert</span>(<span class="type">Solution</span>().canCross([<span class="number">0</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">8</span>,<span class="number">12</span>,<span class="number">17</span>]) == <span class="literal">true</span>)</div><div class="line"><span class="built_in">assert</span>(<span class="type">Solution</span>().canCross([<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">11</span>]) == <span class="literal">false</span>)</div><div class="line"><span class="built_in">assert</span>(<span class="type">Solution</span>().canCross([<span class="number">0</span>,<span class="number">2</span>]) == <span class="literal">false</span>)</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/05/17/stupid-man-s-linear-dp/" itemprop="url">
                  学渣的线性动规
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2020-05-17T00:20:33+08:00" content="2020-05-17">
              2020-05-17
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="学渣的线性动规"><a href="#学渣的线性动规" class="headerlink" title="学渣的线性动规"></a>学渣的线性动规</h1><p>线性DP比较好的例子就是 三角形最小路径和，LIS，LCS问题了。</p>
<h2 id="LIS"><a href="#LIS" class="headerlink" title="LIS"></a>LIS</h2><p>给定一个无序的整数数组，找到其中最长上升子序列的长度。</p>
<p><a href="https://leetcode-cn.com/problems/longest-increasing-subsequence/" target="_blank" rel="external">直达链接</a></p>
<h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>给定n个整数A1,A2,A3…An。按照从左往右的顺序选择尽可能多的整数，组成一个上升子序列，其中相邻元素不能相等</p>
<h3 id="转移方程"><a href="#转移方程" class="headerlink" title="转移方程"></a>转移方程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">dp[i]=max&#123;1+dp[j]&#125;(0&lt;=j&lt;i,s[j]&lt;s[i])</div></pre></td></tr></table></figure>
<h3 id="边界"><a href="#边界" class="headerlink" title="边界"></a>边界</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">dp[0] = 1</div></pre></td></tr></table></figure>
<h3 id="状态标识"><a href="#状态标识" class="headerlink" title="状态标识"></a>状态标识</h3><p>s 为输入数列<br>dp[i]表示以s[i]为结尾的“最大上升子序列长度”</p>
<h3 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h3><p>max{dp[i]}(0&lt;=i&lt;n)</p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">lis</span><span class="params">(<span class="number">_</span> s: [Int])</span></span> -&gt; <span class="type">Int</span> &#123;</div><div class="line">        <span class="keyword">var</span> dp = <span class="type">Array</span>(repeating: <span class="number">1</span>, <span class="built_in">count</span>: s.<span class="built_in">count</span>)</div><div class="line">        </div><div class="line">        <span class="keyword">var</span> result = <span class="number">0</span></div><div class="line">        </div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span> ..&lt; dp.<span class="built_in">count</span> &#123;</div><div class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="number">0</span> ..&lt; i &#123;</div><div class="line">                <span class="keyword">if</span> s[j] &lt; s[i] &#123;</div><div class="line">                    dp[i] = <span class="built_in">max</span>(dp[i], dp[j] + <span class="number">1</span>)</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            result = <span class="built_in">max</span>(dp[i], result)</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">return</span> result</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="LCS解1，二位数组"><a href="#LCS解1，二位数组" class="headerlink" title="LCS解1，二位数组"></a>LCS解1，二位数组</h2><p>给定两个字符串 text1 和 text2，返回这两个字符串的最长公共子序列的长度。</p>
<p><a href="https://leetcode-cn.com/problems/longest-common-subsequence/" target="_blank" rel="external">直达链接</a></p>
<h3 id="问题描述-1"><a href="#问题描述-1" class="headerlink" title="问题描述"></a>问题描述</h3><p>给定两个长度分别为n,m的字符串a,b,求既是a的子序列，又是b的子序列的字符串的长度最长是多少</p>
<h3 id="转移方程-1"><a href="#转移方程-1" class="headerlink" title="转移方程"></a>转移方程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">if a[i] == b[j]:</div><div class="line">	dp[i][j] = dp[i - 1][j - 1] + 1</div><div class="line">else:</div><div class="line">	dp[i][j] = max(dp[i - 1][j], dp[i][j - 1])</div></pre></td></tr></table></figure>
<h3 id="边界-1"><a href="#边界-1" class="headerlink" title="边界"></a>边界</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">dp[i][0] = 0</div><div class="line">dp[0][j] = 0</div></pre></td></tr></table></figure>
<h3 id="状态标识-1"><a href="#状态标识-1" class="headerlink" title="状态标识"></a>状态标识</h3><p>a,b 为输入字符串<br>n,m 为a,b的长度</p>
<p>dp[i][j]表示a[0 ..&lt; i]与b[0 ..&lt; j]的最长公共子序列的长度</p>
<h3 id="目标-1"><a href="#目标-1" class="headerlink" title="目标"></a>目标</h3><p>dp[n][m]</p>
<h3 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">longestCommonSubsequence</span><span class="params">(<span class="number">_</span> a: String, <span class="number">_</span> b: String)</span></span> -&gt; <span class="type">Int</span> &#123;</div><div class="line">        <span class="keyword">let</span> m = a.<span class="built_in">count</span></div><div class="line">        <span class="keyword">let</span> n = b.<span class="built_in">count</span></div><div class="line">        <span class="keyword">if</span> m == <span class="number">0</span> || n == <span class="number">0</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">var</span> dp = <span class="type">Array</span>(repeating: <span class="type">Array</span>(repeating: <span class="number">0</span>, <span class="built_in">count</span>: n + <span class="number">1</span>), <span class="built_in">count</span>: m + <span class="number">1</span>)</div><div class="line">        </div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1</span> ... m &#123;</div><div class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="number">1</span> ... n &#123;</div><div class="line">                <span class="keyword">if</span> a[a.index(a.startIndex, offsetBy: i - <span class="number">1</span>)] == b[b.index(b.startIndex, offsetBy: j - <span class="number">1</span>)] &#123;</div><div class="line">                    dp[i][j] = dp[i - <span class="number">1</span>][j - <span class="number">1</span>] + <span class="number">1</span></div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    dp[i][j] = <span class="built_in">max</span>(dp[i-<span class="number">1</span>][j], dp[i][j-<span class="number">1</span>])</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">return</span> dp[m][n]</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><p>但是用二位数组，时间复杂度在leetcode上过不了关，所以得考虑其他动态方案的方式。</p>
<h2 id="LCS解2，一维数组"><a href="#LCS解2，一维数组" class="headerlink" title="LCS解2，一维数组"></a>LCS解2，一维数组</h2><p>几个优化的点</p>
<ul>
<li>一个是用一维数组</li>
<li>二是不用String而是一开始就把String转成Array<character>，加快查询和修改的效率</character></li>
</ul>
<h3 id="转移方程-2"><a href="#转移方程-2" class="headerlink" title="转移方程"></a>转移方程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">// a.count &gt; b.count</div><div class="line"></div><div class="line">if a[j] == b[i]:</div><div class="line">	dp[j] = dp[j - 1] + 1</div><div class="line">else:</div><div class="line">	dp[j] = max(dp[j - 1], dp[j])</div></pre></td></tr></table></figure>
<h3 id="边界-2"><a href="#边界-2" class="headerlink" title="边界"></a>边界</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">dp[0] = 0</div></pre></td></tr></table></figure>
<h3 id="状态标识-2"><a href="#状态标识-2" class="headerlink" title="状态标识"></a>状态标识</h3><p>a,b 为输入字符串转换的数组<br>m, n 为a,b的长度， m &gt;= n</p>
<p>dp[j]表示a[0 ..&lt; j]与b的最长公共子序列的长度</p>
<h3 id="目标-2"><a href="#目标-2" class="headerlink" title="目标"></a>目标</h3><p>dp[m]</p>
<h3 id="实现-2"><a href="#实现-2" class="headerlink" title="实现"></a>实现</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">longestCommonSubsequence</span><span class="params">(<span class="number">_</span> text1: String, <span class="number">_</span> text2: String)</span></span> -&gt; <span class="type">Int</span> &#123;</div><div class="line">        <span class="keyword">var</span> a = text1</div><div class="line">        <span class="keyword">var</span> b = text2</div><div class="line">        <span class="keyword">var</span> m = a.<span class="built_in">count</span></div><div class="line">        <span class="keyword">var</span> n = b.<span class="built_in">count</span></div><div class="line">        </div><div class="line">        <span class="keyword">if</span> m == <span class="number">0</span> || n == <span class="number">0</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span></div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> m &lt; n &#123;</div><div class="line">            <span class="keyword">let</span> temp = m</div><div class="line">            m = n</div><div class="line">            n = temp</div><div class="line">            a = text2</div><div class="line">            b = text1</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">var</span> dp = <span class="type">Array</span>(repeating: <span class="number">0</span>, <span class="built_in">count</span>: m + <span class="number">1</span>)</div><div class="line">        </div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1</span> ... n &#123;</div><div class="line">            <span class="keyword">var</span> cur = <span class="number">0</span></div><div class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="number">1</span> ... m &#123;</div><div class="line">                <span class="keyword">let</span> leftTop = cur</div><div class="line">                cur = dp[j]</div><div class="line">                <span class="keyword">if</span> a[a.index(a.startIndex, offsetBy: j - <span class="number">1</span>)] == b[b.index(b.startIndex, offsetBy: i - <span class="number">1</span>)] &#123;</div><div class="line">                    dp[j] = leftTop + <span class="number">1</span></div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    dp[j] = <span class="built_in">max</span>(dp[j - <span class="number">1</span>], dp[j])</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">            </div><div class="line">        <span class="keyword">return</span> dp[m]</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="double-100"><a href="#double-100" class="headerlink" title="double 100%"></a>double 100%</h3><p><img src="http://image.runmaf.com/2020-05-17-15896421497757.jpg" alt=""></p>
<h2 id="三角形最小路径和"><a href="#三角形最小路径和" class="headerlink" title="三角形最小路径和"></a>三角形最小路径和</h2><p>给定一个三角形，找出自顶向下的最小路径和。每一步只能移动到下一行中相邻的结点上。</p>
<p>相邻的结点 在这里指的是 下标 与 上一层结点下标 相同或者等于 上一层结点下标 + 1 的两个结点。</p>
<p><a href="https://leetcode-cn.com/problems/triangle" target="_blank" rel="external">直达链接</a></p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>题目有表示用空间复杂度为O(n)有加分，那么肯定要考虑用一位数组来动态规划了。</p>
<h3 id="转移方程-3"><a href="#转移方程-3" class="headerlink" title="转移方程"></a>转移方程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">dp[j] = triangle[i][j] + min(dp[j], dp[i])</div></pre></td></tr></table></figure>
<h3 id="边界-3"><a href="#边界-3" class="headerlink" title="边界"></a>边界</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">dp[0] = triangle[0][0]</div></pre></td></tr></table></figure>
<h3 id="状态标识-3"><a href="#状态标识-3" class="headerlink" title="状态标识"></a>状态标识</h3><p>triangle 为三角形的二维数组<br>m为行数，n为最后一行列数<br>i为行索引，j为列索引</p>
<h3 id="目标-3"><a href="#目标-3" class="headerlink" title="目标"></a>目标</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">min&#123;dp[0 ..&lt; n]&#125;</div></pre></td></tr></table></figure>
<h3 id="实现-3"><a href="#实现-3" class="headerlink" title="实现"></a>实现</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">minimumTotal</span><span class="params">(<span class="number">_</span> triangle: [[Int]])</span></span> -&gt; <span class="type">Int</span> &#123;</div><div class="line">        <span class="keyword">let</span> columnCount = triangle.<span class="built_in">count</span></div><div class="line">        </div><div class="line">        <span class="keyword">if</span> columnCount &lt;= <span class="number">1</span> &#123;</div><div class="line">            <span class="keyword">return</span> triangle.first?.first ?? <span class="number">0</span></div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">var</span> dp = <span class="type">Array</span>(repeating: <span class="type">Int</span>.<span class="built_in">max</span>, <span class="built_in">count</span>: triangle.last?.<span class="built_in">count</span> ?? <span class="number">0</span>)</div><div class="line">        dp[<span class="number">0</span>] = triangle.first?.first ?? <span class="number">0</span></div><div class="line">        </div><div class="line">        <span class="keyword">for</span> columnIndex <span class="keyword">in</span> <span class="number">1</span> ..&lt; columnCount &#123;</div><div class="line">            <span class="keyword">let</span> row = triangle[columnIndex]</div><div class="line">            <span class="keyword">let</span> rowCount = row.<span class="built_in">count</span></div><div class="line">            </div><div class="line">            <span class="keyword">var</span> lastLeft = <span class="type">Int</span>.<span class="built_in">max</span></div><div class="line">            </div><div class="line">            <span class="keyword">for</span> rowIndex <span class="keyword">in</span> <span class="number">0</span> ..&lt; rowCount &#123;</div><div class="line">                <span class="keyword">let</span> temp = lastLeft</div><div class="line">                lastLeft = dp[rowIndex]</div><div class="line">                dp[rowIndex] = row[rowIndex] + <span class="built_in">min</span>(temp, dp[rowIndex])</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> dp.<span class="built_in">min</span>() ?? <span class="number">0</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">assert</span>(<span class="type">Solution</span>().minimumTotal([[<span class="number">2</span>],[<span class="number">3</span>, <span class="number">4</span>],[<span class="number">6</span>, <span class="number">5</span>, <span class="number">7</span>],[<span class="number">4</span>,<span class="number">1</span>,<span class="number">8</span>,<span class="number">3</span>]]) == <span class="number">11</span>)</div></pre></td></tr></table></figure>
<h3 id="double-100-1"><a href="#double-100-1" class="headerlink" title="double 100%"></a>double 100%</h3><p><img src="http://image.runmaf.com/2020-05-17-15896455723167.jpg" alt=""></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/05/16/stupid-man-s-dp/" itemprop="url">
                  学渣的DP动态规划算法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2020-05-16T00:19:18+08:00" content="2020-05-16">
              2020-05-16
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="学渣的DP动态规划算法"><a href="#学渣的DP动态规划算法" class="headerlink" title="学渣的DP动态规划算法"></a>学渣的DP动态规划算法</h1><h2 id="什么是DP"><a href="#什么是DP" class="headerlink" title="什么是DP"></a>什么是DP</h2><p>对于非算法专业的渣渣，看各种专业的解释有点脑壳疼。不过悟出了点自己的感觉，记录下。</p>
<p>其实拿递归来理解会比较好理解，毕竟递归大家大学都学过，很容易懂。</p>
<font color="red">递归是从上往下方式，而DP则是从下往上的。</font>

<p>算法其实都是计算机的穷举，只是怎么更聪明更高效更节省空间的穷举。拿斐波列次数列来理解是最好不过的了。</p>
<h3 id="斐波列次的递归Swift实现"><a href="#斐波列次的递归Swift实现" class="headerlink" title="斐波列次的递归Swift实现"></a>斐波列次的递归Swift实现</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">fibonacci</span><span class="params">(<span class="number">_</span> n: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</div><div class="line">        <span class="keyword">if</span> n == <span class="number">0</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span> <span class="comment">// 987次</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> n == <span class="number">1</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>  <span class="comment">// 1597次</span></div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">return</span> fibonacci(n - <span class="number">1</span>) + fibonacci(n - <span class="number">2</span>)  <span class="comment">// 2583次</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">assert</span>(<span class="type">Solution</span>().fibonacci(<span class="number">17</span>) == <span class="number">1597</span>)</div></pre></td></tr></table></figure>
<p>怎么样，是不是很恐怖，看似优雅的递归方式，执行次数竟然这么多，效率如此低，要是大点的数就完全算不出来了。</p>
<h3 id="斐波列次的DP算法Swift实现"><a href="#斐波列次的DP算法Swift实现" class="headerlink" title="斐波列次的DP算法Swift实现"></a>斐波列次的DP算法Swift实现</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">class Solution &#123;</div><div class="line">    func dpFibonacci(_ n: Int) -&gt; Int &#123;</div><div class="line">        var dp = Array.init(repeating: 0, count: n + 1)</div><div class="line">        dp[0] = 0</div><div class="line">        dp[1] = 1</div><div class="line">        for i in 2 ..&lt; dp.count &#123;</div><div class="line">            dp[i] = dp[i - 1] + dp[i - 2] // 16次</div><div class="line">        &#125;</div><div class="line">        return dp[n]</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">assert(Solution().dpFibonacci(17) == 1597)</div></pre></td></tr></table></figure>
<p>怎么样，是不是觉得效果更高了。<br>我们直接从最底下，最简单，问题规模最小的 f(1) 和 f(2) 开始往上推，直到推到我们想要的答案 f(20)。</p>
<h2 id="状态转移方程"><a href="#状态转移方程" class="headerlink" title="状态转移方程"></a>状态转移方程</h2><p>状态转移方程是解决DP问题的核心,其实也就代表着暴力破解的方式,但不要小看暴力破解.</p>
<p>比如斐波列次数列的状态转移方式就是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">dp[i] = dp[i-1] + dp[i-2]</div></pre></td></tr></table></figure>
<p>这算比较简单的，复杂实例前，先让了解下几种动态规划的类型：</p>
<ul>
<li>线性动规</li>
<li>区域动规</li>
<li>树形动规</li>
<li>背包动规</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>下篇文章树下线性动规划</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/04/05/native-app-flutter-hybrid-in-flutter-boost/" itemprop="url">
                  移动端的flutter_boost混编实现
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2020-04-05T00:11:22+08:00" content="2020-04-05">
              2020-04-05
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="移动端的flutter-boost混编实现"><a href="#移动端的flutter-boost混编实现" class="headerlink" title="移动端的flutter_boost混编实现"></a>移动端的flutter_boost混编实现</h1><h2 id="Flutter简介"><a href="#Flutter简介" class="headerlink" title="Flutter简介"></a>Flutter简介</h2><p>Flutter是谷歌的全平台UI框架，使用dart语法，在移动端通过Skia渲染，可以快速在iOS和Android上构建高质量的原生用户界面，其优势在于</p>
<ul>
<li>极高的开发与交付效率，良好的开发体验</li>
<li>优秀的跨多端多平台能力</li>
<li>极强的UI表现力</li>
</ul>
<p><a href="https://flutterchina.club/get-started/install/" target="_blank" rel="external">环境搭建参考</a></p>
<h2 id="flutter混编架构方案"><a href="#flutter混编架构方案" class="headerlink" title="flutter混编架构方案"></a>flutter混编架构方案</h2><p>VV iOS组目前已完成了较好的组件化架构，很多通用业务层都已经组件化了，比如Login等。Flutter模块再自己在实现就难免重复造轮子了，因此，我们可以创建<a href="https://flutter.dev/docs/development/packages-and-plugins/developing-packages" target="_blank" rel="external">flutter plugin</a>与原生的交互，类似于一种C-S模型。其中Flutter为Client层，原生为Server层，两者通过MethodChannel进行消息通信，原生端向Flutter提供已有的Native组件功能。<br>然后将Flutter Plugin上传到私有<a href="https://flutter.dev/docs/development/packages-and-plugins/using-packages" target="_blank" rel="external">pub</a>库。<br>这时候创建<a href="https://flutter.dev/docs/development/add-to-app/ios/project-setup" target="_blank" rel="external">flutter module</a>，依赖需要的plugin，并添加<a href="https://github.com/alibaba/flutter_boost" target="_blank" rel="external">flutter boost</a>依赖，再在原生工程中依赖这个module就好了。<br>当flutter开发已经有一定规模时候，module甚至可以按业务再拆分成多个业务module混编入Native App。<br><img src="http://image.runmaf.com/2020-04-05-15860110916044.jpg" alt=""></p>
<h3 id="Hello-VV-First-Flutter-Module"><a href="#Hello-VV-First-Flutter-Module" class="headerlink" title="Hello VV First Flutter Module"></a>Hello VV First Flutter Module</h3><p>本文只描述如何创建flutter module并添加flutter_boost依赖，然后嵌入原生工程。module中会依赖一个plugin（webview_flutter）来模拟方案中的架构。<br>本文以VVLife iOS App中嵌入Flutter实现的登陆和我的模块举例（安卓上的实现也由庄宏展验证可成功嵌入）。</p>
<h4 id="1、Create-Module"><a href="#1、Create-Module" class="headerlink" title="1、Create Module"></a>1、Create Module</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">flutter create -t module vv_demo_flutter_module</div></pre></td></tr></table></figure>
<p><img src="http://image.runmaf.com/2020-04-05-15855645220209.jpg" alt=""></p>
<h4 id="2、创建anroid和ios文件"><a href="#2、创建anroid和ios文件" class="headerlink" title="2、创建anroid和ios文件"></a>2、创建anroid和ios文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">flutter make-host-app-editable</div></pre></td></tr></table></figure>
<p><img src="http://image.runmaf.com/2020-04-05-15855649980991.jpg" alt=""></p>
<h4 id="3、修改bundle-id及profile"><a href="#3、修改bundle-id及profile" class="headerlink" title="3、修改bundle_id及profile"></a>3、修改bundle_id及profile</h4><p>这里需要创建出来的iOS项目中，修改下bundle_id，否则之后的module编译会出现错误。</p>
<p><img src="http://image.runmaf.com/2020-04-05-15855650416465.jpg" alt=""><br><img src="http://image.runmaf.com/2020-04-05-15855651593446.jpg" alt=""></p>
<p>否则build时候会提示错误<br><img src="http://image.runmaf.com/2020-04-05-15855650858821.jpg" alt=""></p>
<h4 id="4、添加flutter-boost依赖"><a href="#4、添加flutter-boost依赖" class="headerlink" title="4、添加flutter_boost依赖"></a>4、添加flutter_boost依赖</h4><p> 打开pubspec.yaml并将以下行添加到依赖项，然后  flutter packages get一下</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">flutter_boost: ^1.12.13</div></pre></td></tr></table></figure>
<p>flutter_boost的介绍可以看<a href="https://mp.weixin.qq.com/s?__biz=MzU4MDUxOTI5NA==&amp;mid=2247484367&amp;idx=1&amp;sn=fcbc485f068dae5de9f68d52607ea08f&amp;chksm=fd54d7deca235ec86249a9e3714ec18be8b2d6dc580cae19e4e5113533a6c5b44dfa5813c4c3&amp;scene=0&amp;subscene=131&amp;clicktime=1551942425&amp;ascene=7&amp;devicetype=android-28&amp;version=2700033b&amp;nettype=ctnet&amp;abtest_cookie=BAABAAoACwASABMABAAklx4AVpkeAMSZHgDWmR4AAAA%3D&amp;lang=zh_CN&amp;pass_ticket=1qvHqOsbLBHv3wwAcw577EHhNjg6EKXqTfnOiFbbbaw%3D&amp;wx_header=1" target="_blank" rel="external">闲鱼APP团队的技术文章</a></p>
<p><img src="http://image.runmaf.com/2020-04-05-15860114455529.jpg" alt=""></p>
<h4 id="5、创建Widget并注册到路由"><a href="#5、创建Widget并注册到路由" class="headerlink" title="5、创建Widget并注册到路由"></a>5、创建Widget并注册到路由</h4><p>在main.dart中注册一下路由，过程和使用命名路由相似</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">FlutterBoost.singleton.registerPageBuilders(&#123;</div><div class="line">      &apos;flutter_login&apos;: (pageName, params, _) =&gt; VVLoginPage(),</div><div class="line">      &apos;flutter_mine&apos;: (pageName, params, _) =&gt; VVHomeMinePage(userName: params[&quot;name&quot;], imageUrl: params[&quot;imageUrl&quot;],),</div><div class="line">      &apos;flutter_customer_service&apos;: (pageName, params, _) =&gt;</div><div class="line">          CustomerServicePage(),</div><div class="line">    &#125;);</div></pre></td></tr></table></figure>
<h4 id="6、build"><a href="#6、build" class="headerlink" title="6、build"></a>6、build</h4><p>执行 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">flutter build ios --debug  </div><div class="line">// 或</div><div class="line">flutter build ios --release --no-codesign</div></pre></td></tr></table></figure>
<p><img src="http://image.runmaf.com/2020-04-05-15855653044387.jpg" alt=""></p>
<h4 id="7、在VVLife-App工程中添加依赖"><a href="#7、在VVLife-App工程中添加依赖" class="headerlink" title="7、在VVLife App工程中添加依赖"></a>7、在VVLife App工程中添加依赖</h4><p>修改VVLife工程的Podfile文件，添加对module的引入。修改后执行 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">pod install</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">flutter_application_path = &apos;../../Demo/vv_demo_flutter_module/&apos;</div><div class="line">load File.join(flutter_application_path, &apos;.ios&apos;, &apos;Flutter&apos;, &apos;podhelper.rb&apos;)</div><div class="line"></div><div class="line">target &apos;VVLife&apos; do</div><div class="line"></div><div class="line">  use_frameworks!</div><div class="line">  </div><div class="line">  commonPod_Tag</div><div class="line">  thirdPod</div><div class="line">  install_all_flutter_pods flutter_application_path</div><div class="line">#  hawkeye</div><div class="line">  </div><div class="line">  target &apos;VVLifeTests&apos; do</div><div class="line">    inherit! :search_paths</div><div class="line">    </div><div class="line">  end</div><div class="line">  </div><div class="line">end</div></pre></td></tr></table></figure>
<p>这里暂时使用相对路径方式引用，真正工程应用得换个方式。<br>考虑有两种方式：</p>
<ul>
<li>在APP工程根目录中引用flutter module项目，这样相对路径就一定是根目录下。然后通过 build Phases脚本来对flutter进行构建</li>
<li>将flutter module编译后的framework都进行pod库创建，发布到VV私有Pod仓库</li>
</ul>
<p>前者灵活但需要原生开发者都要安装flutter开发环境，后者方便不需要环境依赖，特别在业务经常变更情况下，不过自动化构建可以解决该问题。</p>
<h4 id="8、依赖是如何添加到Native-APP的"><a href="#8、依赖是如何添加到Native-APP的" class="headerlink" title="8、依赖是如何添加到Native APP的"></a>8、依赖是如何添加到Native APP的</h4><p>上一步骤中，起到引入作用核心在这句话</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># flutter_application_path是拼接后的podhelper.rb文件所在路径</div><div class="line"># install_all_flutter_pods该ruby脚本中需要执行的脚本函数</div><div class="line">install_all_flutter_pods flutter_application_path</div></pre></td></tr></table></figure>
<p>那我们再来看看install_all_flutter_pods函数的实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">def install_all_flutter_pods(flutter_application_path = nil)</div><div class="line">  # flutter默认目录结构是 root-&gt;.iOS-&gt;Fluuter-&gt;podhelper.rb，所以向上两层则是根目录</div><div class="line">  flutter_application_path ||= File.join(&apos;..&apos;, &apos;..&apos;)</div><div class="line">  # 引入Flutter引擎依赖pod</div><div class="line">  # 他会在根目录下创建一个engine目录，将本地flutter环境中的Flutter.framework及Flutter.podspec复制过来</div><div class="line">  install_flutter_engine_pod	</div><div class="line">  </div><div class="line">  # 引入Flutter Plugin编译后的pod</div><div class="line">  install_flutter_plugin_pods(flutter_application_path)</div><div class="line">  </div><div class="line">  # 引入当前flutter module编译后的pod</div><div class="line">  install_flutter_application_pod(flutter_application_path)</div><div class="line">end</div></pre></td></tr></table></figure>
<p>具体执行流程比较复杂，参考该图，有兴趣可以去看看该ruby脚本，特别是fake framework那段真的很妙。</p>
<p><img src="http://image.runmaf.com/2020-04-05-15860550737776.jpg" alt=""></p>
<h4 id="9、原生端路由实现"><a href="#9、原生端路由实现" class="headerlink" title="9、原生端路由实现"></a>9、原生端路由实现</h4><p>原生端路由不想flutter端是注册方式实现。<br>原生端需要一个url解释器，他会收到flutter端传来的url，对其进行url解析及参数解析，然后根据这些信息跳转到相应的页面或者进行相应的操作。</p>
<p>创建PlatformRouterImp.swift</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">class PlatformRouterImp: NSObject, FLBPlatform &#123;</div><div class="line">    func open(_ url: String, urlParams: [AnyHashable : Any], exts: [AnyHashable : Any], completion: @escaping (Bool) -&gt; Void) &#123;</div><div class="line">        // ...native端及flutter端调用open方法都会执行这里</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    func present(_ url: String, urlParams: [AnyHashable : Any], exts: [AnyHashable : Any], completion: @escaping (Bool) -&gt; Void) &#123;</div><div class="line">        // ...native端及flutter端调用present方法都会执行这里</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    func close(_ uid: String, result: [AnyHashable : Any], exts: [AnyHashable : Any], completion: @escaping (Bool) -&gt; Void) &#123;</div><div class="line">        // flutter端调用close方法都会执行这里</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    func navigationController() -&gt; UINavigationController &#123;</div><div class="line">        // native端及flutter端不管是open还是present都会执行这里</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="10、AppDelegate中初始并设置该解释器"><a href="#10、AppDelegate中初始并设置该解释器" class="headerlink" title="10、AppDelegate中初始并设置该解释器"></a>10、AppDelegate中初始并设置该解释器</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">let router = PlatformRouterImp.init();</div><div class="line">FlutterBoostPlugin.sharedInstance().startFlutter(with: router, onStart: &#123; (engine) in</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="11、调用并push到flutter端的模块"><a href="#11、调用并push到flutter端的模块" class="headerlink" title="11、调用并push到flutter端的模块"></a>11、调用并push到flutter端的模块</h4><p>调用在flutter端的登陆页面。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">let loginController = FLBFlutterViewContainer()</div><div class="line">loginController.setName(&quot;flutter_login&quot;, params: [:])</div><div class="line">let flutterLoginController = VLLoginFlutterController()</div><div class="line">flutterLoginController.registerNativeListener()</div></pre></td></tr></table></figure>
<p>这里我还创建了一个flutterLoginController，它作用相当于MVC中的Controller，来实现与Flutter页面的交互。<br>当然，这是建立在这个flutter页面只负责呈现，M和C的作用还是由原生来实现的前提下。<br>如果这个业务组件纯粹由flutter端掌控的话，原生只需要监听flutter端的open和close事件及时作出页面跳转操作即可。</p>
<h4 id="12、flutter端调用native端模块"><a href="#12、flutter端调用native端模块" class="headerlink" title="12、flutter端调用native端模块"></a>12、flutter端调用native端模块</h4><p>如果flutter端该页面的生命周期结束了，准备将页面导航的控制权交回给native，那么可以使用open方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">FlutterBoost.singleton.open(&quot;vvlife://guidepage&quot;, urlParams: &#123;&quot;autoPlay&quot;: true&#125;, exts: &#123;&quot;native&quot;: true&#125;)</div></pre></td></tr></table></figure>
<ul>
<li>url 打开页面的url，最好可以和原生的路由一致，这样native端可以和flutter端维护同一份路由，否则还需要一份映射表，将增加本来已经很多的hard code</li>
<li>urlParams  传递给native端的信息，如这里的含义就是guide页面进行自动播放方式打开。</li>
<li>exts  是附加信息，这里含义是打开的将是一个原生界面。</li>
</ul>
<p>然后在 <code>PlatformRouterImp.swift</code> 的open函数中根据传递的信息进行跳转即可。</p>
<h4 id="0、结束"><a href="#0、结束" class="headerlink" title="0、结束"></a>0、结束</h4><p>一个简单的module嵌入原生的例子就完成了，实际使用还会有需要细节需要研究。比如一个linsten关闭的时机及生命周期维护等，本文只是flutter混编的一个引子，具体实际应用还需要整个团队一起摸索。</p>
<h2 id="一些思考"><a href="#一些思考" class="headerlink" title="一些思考"></a>一些思考</h2><p>flutter混编现在还是有许多不足的地方，比如hard code如何标准化，比如复杂模型如何传递，比如动态特性如何实现等。</p>
<h3 id="hard-code"><a href="#hard-code" class="headerlink" title="hard code"></a>hard code</h3><p>在多端交互中，hard code一直都是一个难题。像客户端与服务端的请求访问，其实也都一直是硬编码，所以才会产生的RESTFULL API来标准化接口试hard code尽量标准化。<br>所以只能通过协议和规范约束flutter和native端。</p>
<p>其实在客户端组件化方案中，其实也一直都有hard code的问题，像当前VVLife、VVParner中依赖的SWRouter。虽然通过常量减少了这种问题，但是传递参数这方面并没有解决，新人来后如果使用到旧页面，要不得自己翻代码，要不就只能问老前辈了。老前辈时间久了肯定也记不到之前的param需要什么。</p>
<h3 id="复杂模型"><a href="#复杂模型" class="headerlink" title="复杂模型"></a>复杂模型</h3><p>例如商品模型，它包含几十个字段。如果是传字典或传 json, 那么数据提供方（native）和使用方（flutter）都需要专门理解并实现一下这种模型的各种字段，对开发效率影响很大。暂时也没什么好的办法规避。</p>
<h3 id="动态化"><a href="#动态化" class="headerlink" title="动态化"></a>动态化</h3><p>其实前两点都是小问题，动态化才是限制flutter的关键。<br>实现动态化是交付效率提升的重要方式。对于VV上线后必将强运营强时效性特性来说，动态化几乎是一个必备的诉求，但从技术上看也是一个非常敏感的需求，苹果一直在抑制应用方在动态化，像JSPatch就是过于“为所欲为”被喊停了。<br>当前flutter动态化成熟商用的方案一种是自己实现Dart SDK及相应DSL解释器，一个是大厂自己用的不开源得自己实现开发维护成本巨大，另一个是自定义的模板引擎对新人需要学习成本。<br>另一种方案是Web on Flutter，其UI表现一般。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/03/26/React-Native-Animated-划重点：两个细节排查两个小时/" itemprop="url">
                  React-Native Animated 划重点：两个细节排查两个小时
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2018-03-26T01:08:24+08:00" content="2018-03-26">
              2018-03-26
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>其实就是React-Native Animated两个细节引发的问题，但查的好辛苦，记录下。</p>
<h1 id="表现"><a href="#表现" class="headerlink" title="表现"></a>表现</h1><ul>
<li>start函数里的结束回调不运行</li>
<li>页面不刷新去渲染</li>
<li>强行setState会发现 value.__getValue()是undefined或NaN</li>
</ul>
<h2 id="原因：toValue是number类型"><a href="#原因：toValue是number类型" class="headerlink" title="原因：toValue是number类型"></a>原因：toValue是number类型</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Animated.timing(_value1, &#123;</div><div class="line">    duration: <span class="number">100</span>,</div><div class="line">    toValue: point1 <span class="comment">//划重点：toValue 是number，不要用Animated.Value对象了</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h2 id="原因：start后记得要setState"><a href="#原因：start后记得要setState" class="headerlink" title="原因：start后记得要setState"></a>原因：start后记得要setState</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Animated.parallel([</div><div class="line"><span class="comment">//...</span></div><div class="line">]).start();</div><div class="line"></div><div class="line"><span class="keyword">this</span>.setState(<span class="keyword">this</span>.state);<span class="comment">//划重点：这个必须设置，否则动画不会触发setState</span></div></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>总之还是React-Native步数，Animated更不熟，多记录，多学习RN怎么排查问题。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/03/21/在React-Native应用中通过React-Art实现点击礼花效果/" itemprop="url">
                  在React-Native应用中通过React-Art实现点击礼花效果
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2018-03-21T14:15:52+08:00" content="2018-03-21">
              2018-03-21
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>实际上这个例子并不需要使用react-art就能实现，但是我们将使用react-art来实现一种良好的效果。那这个例子中我们要完成的是什么呢？礼花🎉秀。并不花哨，只需要点击屏幕，一朵礼花就将要发射到你点击的地方并展开。</p>
<h2 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h2><p>这就是我们要实现的效果。</p>
<p><img src="http://7oxfjd.com2.z0.glb.qiniucdn.com/2018-03-21-preview_3.gif" alt="preview_3"></p>
<h2 id="start-project"><a href="#start-project" class="headerlink" title="start project"></a>start project</h2><p>就像普通的项目那样，创建一个空白的React-Native工程，然后把index.js里的自动生成代码改为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">import React, &#123;</div><div class="line">    Component</div><div class="line">&#125;from &apos;react&apos;;</div><div class="line"></div><div class="line">import &#123;</div><div class="line">    ART as Art,</div><div class="line">    StyleSheet,</div><div class="line">    View,</div><div class="line">    Dimensions,</div><div class="line">    TouchableWithoutFeedback,</div><div class="line">    Animated</div><div class="line">&#125; from &apos;react-native&apos;;</div><div class="line"></div><div class="line">var &#123;</div><div class="line">    width,</div><div class="line">    height</div><div class="line">&#125; = Dimensions.get(&apos;window&apos;);</div><div class="line"></div><div class="line">var &#123;</div><div class="line">    Surface,</div><div class="line">    Shape,</div><div class="line">    Path,</div><div class="line">    Group,</div><div class="line">    Transform</div><div class="line">&#125; = Art;</div><div class="line"></div><div class="line">var AnimatedShape = Animated.createAnimatedComponent(Shape);</div><div class="line">var AnimatedGroup = Animated.createAnimatedComponent(Group);</div></pre></td></tr></table></figure>
<p>我们引入了Animated API，react-art库，还有一些ART的组件。然后我要创建AnimatedShape和AnimatedGroup，这些让我们可以设置fill, opacity, x, y这些动画属性，可以让动画效果准确有效。</p>
<p>接着，我们创建styles</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">var styles = StyleSheet.create(&#123;</div><div class="line">  container: &#123;</div><div class="line">    flex: 1,</div><div class="line">    flexDirection: &apos;column&apos;</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>是的，这就是我们动画的发生的组件了。</p>
<p>然后创建我们的组件类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">export default class App extends Component&lt;Props&gt; &#123;</div><div class="line">    state = &#123;</div><div class="line">        fireworks: []</div><div class="line">    &#125;</div><div class="line">    render()&#123;</div><div class="line">        return (</div><div class="line">            &lt;View style=&#123;styles.container&#125;&gt;</div><div class="line">                &lt;TouchableWithoutFeedback&gt;</div><div class="line">                    &lt;View&gt;</div><div class="line">                        &lt;Surface width=&#123;width&#125; height=&#123;height&#125;&gt;</div><div class="line">                        &lt;/Surface&gt;</div><div class="line">                    &lt;/View&gt;</div><div class="line">                &lt;/TouchableWithoutFeedback&gt;</div><div class="line">            &lt;/View&gt;</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样我们的启动空白工程就完成了。一个容器View，包含TouchableWithoutFeedback让我们能获取点击的坐标。在Touchable中需要有一个View在包装我们的react-art Surface组件，它可以设置宽高。我们的例子需要一个全屏的画布，所以我们通过获取屏幕尺寸并设置给Surface组件。</p>
<h2 id="让炮弹飞一会"><a href="#让炮弹飞一会" class="headerlink" title="让炮弹飞一会"></a>让炮弹飞一会</h2><p>让我们想象发送炮弹的情景：一个炮弹从屏幕底部中央处发射到我们在屏幕上点击的位置。</p>
<p>那也就是我们要通过react-art绘制一个圆；还要有一个可以触地点击事件的函数去获取我们点击的位置；还要通过Animated将圆发射到点击的位置；最后在点击的位置渲染出这个炮弹。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">&lt;TouchableWithoutFeedback onPress=&#123;this._handleAddFirework&#125;&gt;</div></pre></td></tr></table></figure>
<p>我们将使用TouchableWithoutFeedback在用户点击屏幕时候回调函数去增加礼花到队列中。然后渲染时候在队列中读取炮弹并绘制。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">class AnimatedCircle extends Component&lt;Props&gt; &#123;</div><div class="line">    render()&#123;</div><div class="line">        var radius = this.props.radius;</div><div class="line">        var path = Path().moveTo(0, -radius)</div><div class="line">            .arc(0, radius * 2, radius)</div><div class="line">            .arc(0, radius * -2, radius)</div><div class="line">            .close();</div><div class="line">        return (</div><div class="line">            &lt;AnimatedShape d=&#123;path&#125;  &#123;...this.props&#125;/&gt;</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看起来我们只是把AnimatedShape包装起来，也就是组件化，这样可以尽可能是复用代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">const MORTAR_RADIUS = 5</div><div class="line">///...</div><div class="line">_handleAddFirework = (e) =&gt; &#123;</div><div class="line">    var _shootingPosition = new Animated.ValueXY(&#123;x: width/2, y: height - MORTAR_RADIUS&#125;);</div><div class="line"></div><div class="line">    this.state.fireworks.push(&#123;</div><div class="line">        shootingPosition: _shootingPosition,</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    Animated.timing(_shootingPosition, &#123;</div><div class="line">        duration: 300,</div><div class="line">        toValue: &#123;</div><div class="line">            y: e.nativeEvent.locationY,</div><div class="line">            x: e.nativeEvent.locationX</div><div class="line">        &#125;</div><div class="line">    &#125;).start()</div><div class="line"></div><div class="line">    this.setState(this.state);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>好的，让我们停下来分析下代码。</p>
<p>函数的第一行_shootingPosition，我们创建了一个Animated的向量值类型，这是默认值，也就是炮弹发送出来的地方，就是水平中央，并距离底部MORTAR_RADIUS的距离，使用常量方便我们修改尺寸时候可以不用修改代码，MORTAR_RADIUS会设置为5，因为我们炮弹的半径也是5.</p>
<p>然后我们将它添加到一个礼花的数组中，稍会我们就要发射他们了。</p>
<p>然后我们开始创建动画。我们想让炮弹经过300毫秒到达用户点击的位置，所以我们设置toValue为用户点击的位置。然后我们执行动画。对，我们还没有渲染任何东西但相信我马上我们就要看到第一步的效果了。</p>
<p>最后我们设置state，他会引发再渲染，然后我们就可以渲染我们的礼花了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">&lt;Surface width=&#123;width&#125; height=&#123;height&#125;&gt;</div><div class="line">    &#123;</div><div class="line">        this.state.fireworks.map((firework, index) =&gt; &#123;</div><div class="line">            return &lt;AnimatedCircle</div><div class="line">                radius=&#123;MORTAR_RADIUS&#125;</div><div class="line">                x=&#123;firework.shootingPosition.x&#125;</div><div class="line">                y=&#123;firework.shootingPosition.y&#125;</div><div class="line">                key=&#123;&quot;circle&quot;+index&#125;</div><div class="line">                fill=&quot;#000&quot;</div><div class="line">            /&gt;</div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line">&lt;/Surface&gt;</div></pre></td></tr></table></figure>
<p>上面代码中我们映射了state中的每个炮弹成AnimatedCircle，并设置相应的x,y值。在我们的例子中，我们要给炮弹填充黑色为初始颜色。</p>
<p>到此位置，运行代码可以看到初步的效果了。</p>
<p><img src="http://7oxfjd.com2.z0.glb.qiniucdn.com/2018-03-21-preview_1.gif" alt="preview_1"></p>
<h2 id="消失的炮弹"><a href="#消失的炮弹" class="headerlink" title="消失的炮弹"></a>消失的炮弹</h2><p>是的，炮弹并不是这样粘贴在屏幕上的。所以我们要让他们消失。start()函数可以设置一个回调，当动画结束后会回调他。</p>
<p>所以数组中的炮弹需要唯一标识，我们可以使用shootingPosition来标识它们并过滤出他们来。</p>
<p>像下面这样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Animated.timing(_shootingPosition, &#123;</div><div class="line">    duration: 300,</div><div class="line">    toValue: &#123;</div><div class="line">        y: e.nativeEvent.locationY,</div><div class="line">        x: e.nativeEvent.locationX</div><div class="line">    &#125;</div><div class="line">&#125;).start(this.removeSelf.bind(this, _shootingPosition))</div><div class="line"></div><div class="line">this.setState(this.state);</div><div class="line">//...</div><div class="line"></div><div class="line">removeSelf = (_shootingPosition)=&gt; &#123;</div><div class="line">    this.setState(&#123;</div><div class="line">        fireworks: this.state.fireworks.filter((firework) =&gt; firework.shootingPosition !== _shootingPosition)</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>终于它运行起来像个炮弹了。</p>
<h2 id="逃离黑白世界"><a href="#逃离黑白世界" class="headerlink" title="逃离黑白世界"></a>逃离黑白世界</h2><p>现在我们开始让炮弹不只是一个黑点。让我们假设它是个火球，那我们可以让他在黄和橙色之间变换颜色。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">const SHOOTING_COLORS = [</div><div class="line">    &apos;rgb(234,238,112)&apos;, //Yellow</div><div class="line">    &apos;rgb(245,137,12)&apos; //Orange</div><div class="line">];</div></pre></td></tr></table></figure>
<p>我们要调用的interpolate函数只适用于rgb，因此使用rgb而不是hex。</p>
<p>现在我们就创建另一个Animated value，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">adjustShootingFill = (_shootingColor, value) =&gt; &#123;</div><div class="line">    Animated.timing(_shootingColor, &#123;</div><div class="line">        duration: 16,</div><div class="line">        toValue: _shootingColor.__getAnimatedValue() == 0 ? 1 : 0</div><div class="line">    &#125;).start()</div><div class="line">&#125;</div><div class="line"></div><div class="line">_handleAddFirework = (e) =&gt; &#123;</div><div class="line">    var _shootingPosition = new Animated.ValueXY(&#123;x: width/2, y: height - MORTAR_RADIUS&#125;);</div><div class="line">    var _shootingColor = new Animated.Value(0);</div><div class="line"></div><div class="line">    this.state.fireworks.push(&#123;</div><div class="line">        shootingPosition: _shootingPosition,</div><div class="line">        shootingColor: _shootingColor,</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    _shootingPosition.addListener(this.adjustShootingFill.bind(null, _shootingColor));</div><div class="line"></div><div class="line">    Animated.timing(_shootingPosition, &#123;</div><div class="line">        duration: 300,</div><div class="line">        toValue: &#123;</div><div class="line">            y: e.nativeEvent.locationY,</div><div class="line">            x: e.nativeEvent.locationX</div><div class="line">        &#125;</div><div class="line">    &#125;).start(this.removeSelf.bind(this, _shootingPosition))</div><div class="line"></div><div class="line">    this.setState(this.state);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>开始我们添加了一个Animated.Value，默认设置为0.我们把它添加到我们的炮弹集合中。</p>
<p>然后我们添加了一个监听器在_shootingPosition，这样当炮弹位置发生变化的时候将调用设置的回调函数。回调中我们不断的通过变换黄和橙色。通过Animated.timing函数执行变色动画，这个动画在16内完成，__getAnimatedValue可以获取当前值并且变换成另一个。</p>
<p>所以，每16毫秒，炮弹的颜色都是黄→橙→黄→橙……循环下去。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">&lt;Surface width=&#123;width&#125; height=&#123;height&#125;&gt;</div><div class="line">    &#123;</div><div class="line">        this.state.fireworks.map((firework, index) =&gt; &#123;</div><div class="line">            var _shootingFill = firework.shootingColor.interpolate(&#123;</div><div class="line">                inputRange: [0,1],</div><div class="line">                outputRange: SHOOTING_COLORS</div><div class="line">            &#125;);</div><div class="line">            return &lt;AnimatedCircle</div><div class="line">                radius=&#123;MORTAR_RADIUS&#125;</div><div class="line">                key=&#123;&quot;circle&quot;+index&#125;</div><div class="line">                x=&#123;firework.shootingPosition.x&#125;</div><div class="line">                y=&#123;firework.shootingPosition.y&#125;</div><div class="line">                fill=&#123;_shootingFill&#125;</div><div class="line">            /&gt;</div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line">&lt;/Surface&gt;</div></pre></td></tr></table></figure>
<p>我们需要创建一个interpolator，它封装了Animated Value到颜色映射的逻辑，映射是像这样的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">0 =&gt; yellow</div><div class="line">1 =&gt; orange</div></pre></td></tr></table></figure>
<p>然后，我们的效果离预期右近一步了。</p>
<p><img src="http://7oxfjd.com2.z0.glb.qiniucdn.com/2018-03-21-preview_2.gif" alt="preview_2"></p>
<h2 id="炸裂吧，炮弹"><a href="#炸裂吧，炮弹" class="headerlink" title="炸裂吧，炮弹"></a>炸裂吧，炮弹</h2><p>有趣的时间到了，炸裂吧，炮弹。</p>
<p>我们的炮弹概念非常简单，我们将创建20个向外爆开的圆，我们也可以制作各种各样的尾巴，还可以四处飞行，甚至做一些很酷的效果，但是那是之后的事情了，我们先完成这最基本的效果。</p>
<p>我们先创建一些变量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">const PARTICLE_RADIUS = 30; // 炸开粒子的范围半径</div><div class="line">const PARTICLE_COUNT = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20]; // 每个爆开有多少粒子</div><div class="line"></div><div class="line">//粒子的颜色变化域</div><div class="line">const PARTICLE_COLORS = [</div><div class="line">    &apos;rgba(54, 17, 52, 100)&apos;,</div><div class="line">    &apos;rgba(176, 34, 140, 100)&apos;,</div><div class="line">    &apos;rgba(234, 55, 136, 100)&apos;,</div><div class="line">    &apos;rgba(229, 107, 112, 100)&apos;,</div><div class="line">    &apos;rgba(243, 145, 160, 100)&apos;</div><div class="line">]</div></pre></td></tr></table></figure>
<p>PARTICLE_RADIUS定义了每个爆炸的范围有多大；PARTICLE_COUNT定义了粒子的数量；最后，PARTICLE_COLORS定义了粒子有多少种不同的颜色，所以，每个爆炸将在这几种颜色之间变化。<br>为了简单起见，我们将使每个粒子具有相同的颜色，这意味着我们只需要1个Animated.Value。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> _particleColor = <span class="keyword">new</span> Animated.Value(<span class="number">0</span>);</div><div class="line"><span class="keyword">var</span> _particleRadius = <span class="keyword">new</span> Animated.Value(<span class="number">0</span>);</div><div class="line"><span class="keyword">var</span> _coreOpacity = <span class="keyword">new</span> Animated.Value(<span class="number">1</span>);</div></pre></td></tr></table></figure>
<p>我们还需要一个Animated.Value作为我们的半径，默认为0，所以它开始隐藏。 另一个Animated.Value是透明的动画。当我们的炮弹炸开后隐藏它。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> _particlePositions = PARTICLE_COUNT.map(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">new</span> Animated.ValueXY(&#123;<span class="attr">x</span>: <span class="number">0</span>, <span class="attr">y</span>: <span class="number">0</span>&#125;));</div></pre></td></tr></table></figure>
<p>每个粒子将有不同的坐标，所以例子中我们需要20个Animated.ValueXY。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">this.state.fireworks.push(&#123;</div><div class="line">    shootingPosition: _shootingPosition,</div><div class="line">    shootingColor: _shootingColor,</div><div class="line">    particleColor: _particleColor,</div><div class="line">    particleRadius: _particleRadius,</div><div class="line">    coreOpacity: _coreOpacity,</div><div class="line">    particlePositions: _particlePositions</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>添加新的对象，过会我们就渲染它们。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">function getXYParticle(total, i, radius) &#123;</div><div class="line">    var angle = 360/total*i;</div><div class="line"></div><div class="line">    var x = Math.round((radius*2) * Math.cos(angle - (Math.PI/2)));</div><div class="line">    var y = Math.round((radius*2) * Math.sin(angle - (Math.PI/2)));</div><div class="line"></div><div class="line">    return &#123;</div><div class="line">        x: x,</div><div class="line">        y: y</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">var _animatedParticles = [</div><div class="line">    Animated.timing(_particleRadius, &#123;</div><div class="line">        duration: 700,</div><div class="line">        toValue: 1</div><div class="line">    &#125;),</div><div class="line">    Animated.timing(_coreOpacity, &#123;</div><div class="line">        duration: 200,</div><div class="line">        toValue: 0</div><div class="line">    &#125;)</div><div class="line">]</div><div class="line"></div><div class="line">var _movingParticles = _particlePositions.map((particle, i) =&gt; &#123;</div><div class="line">    var _xy = getXYParticle(PARTICLE_COUNT.length, i, PARTICLE_RADIUS);</div><div class="line">    return Animated.timing(particle, &#123;</div><div class="line">        duration: 250,</div><div class="line">        toValue: _xy</div><div class="line">    &#125;)</div><div class="line">&#125;)</div><div class="line"></div><div class="line">_animatedParticles = _animatedParticles.concat(_movingParticles);</div></pre></td></tr></table></figure>
<p>这些都是为我们接下来要做的事情做准备，将我们的动画都排成序列。</p>
<p>我们创建了一系列需要发生的动画。首先是扩展每个_particleRadius，我们已经确定完全炸开的动画时长为700毫秒。 _particleRadius实际上是粒子尺寸，也就是我们只是放大这个圆，看起来像是向外爆炸，但是这会在我们的渲染函数中显示出来。</p>
<p>我们将_coreOpacity（也就是我们的炮弹）设置为在200毫秒内消失。</p>
<p>我们需要为每个粒子创建动画，让粒子从我们目前的炮弹位置发射到粒子圆范围内的不同点。然后我们通过一个算法，计算粒子x,y的位置。</p>
<p>然后又用到Animated.timing，让粒子花费250毫秒到达它的位置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Animated.sequence([</div><div class="line">  Animated.timing(_shootingPosition, &#123;</div><div class="line">    duration: 300,</div><div class="line">    toValue: &#123;</div><div class="line">      y: e.nativeEvent.locationY,</div><div class="line">      x: e.nativeEvent.locationX</div><div class="line">    &#125;</div><div class="line">  &#125;),</div><div class="line">  Animated.parallel(_animatedParticles)</div><div class="line">]).start(this.removeSelf.bind(this, _shootingPosition));</div></pre></td></tr></table></figure>
<p>现在将我们的动画列队列。因为我们希望炮弹先射击，然后到达指定位置后爆炸。所以我们使用Animated.sequence实现这个先后顺序。</p>
<p>我们首先将我们的炮弹移动到用户触摸的位置。下一部分将我们所有的爆炸动画封装成Animated.parallel。这与Animated.sequence相反，它表示同时执行所有这些动画。</p>
<p>这样，我们的炮弹渐渐消失，我们的粒子膨胀，颜色变化，爆炸向外都会同时发生。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">adjustParticleFill = (_particleColor, value) =&gt; &#123;</div><div class="line">    var _currentFill = _particleColor.__getAnimatedValue(),</div><div class="line">    _particleFill = _currentFill === 5 ? 0 : _currentFill + 1;</div><div class="line"></div><div class="line">    Animated.timing(_particleColor, &#123;</div><div class="line">        duration: 16,</div><div class="line">        toValue: _particleFill</div><div class="line">    &#125;).start()</div><div class="line">&#125;</div><div class="line"></div><div class="line">_handleAddFirework = (e) =&gt; &#123;</div><div class="line">    //...</div><div class="line"></div><div class="line">    _shootingPosition.addListener(this.adjustShootingFill.bind(null, _shootingColor));</div><div class="line">    _particleRadius.addListener(this.adjustParticleFill.bind(null, _particleColor));</div><div class="line">    </div><div class="line">    //...</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后我们需要去改变粒子的颜色。所以像之前那样，我们创建一个回调函数去监听粒子的半径变化。不同的是，现在我们有5种颜色需要变化。</p>
<p>现在我们要开始渲染新的效果了，我们将移到一个不同的函数里面去处理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">&lt;Surface width=&#123;width&#125; height=&#123;height&#125;&gt;</div><div class="line">  &#123;this.getFireworks()&#125;</div><div class="line">&lt;/Surface&gt;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">getFireworks = () =&gt; &#123;</div><div class="line">       return this.state.fireworks.map((firework, i) =&gt; &#123;</div><div class="line"></div><div class="line">           var _shootingFill = firework.shootingColor.interpolate(&#123;</div><div class="line">               inputRange: [0,1],</div><div class="line">               outputRange: SHOOTING_COLORS</div><div class="line">           &#125;);</div><div class="line"></div><div class="line">           var _particleFill = firework.particleColor.interpolate(&#123;</div><div class="line">               inputRange: [0,1,2,3,4],</div><div class="line">               outputRange: PARTICLE_COLORS</div><div class="line">           &#125;);</div><div class="line"></div><div class="line">           return (</div><div class="line">               &lt;AnimatedGroup</div><div class="line">                   x=&#123;firework.shootingPosition.x&#125;</div><div class="line">                   y=&#123;firework.shootingPosition.y&#125;</div><div class="line">                   key=&#123;&quot;group_&quot;+i&#125;</div><div class="line">               &gt;</div><div class="line">                   &lt;AnimatedCircle</div><div class="line">                       opacity=&#123;firework.coreOpacity&#125;</div><div class="line">                       radius=&#123;MORTAR_RADIUS&#125;</div><div class="line">                       fill=&#123;_shootingFill&#125;</div><div class="line">                       key=&#123;&quot;circle_&quot;+i&#125;</div><div class="line">                   /&gt;</div><div class="line">                   &lt;Group&gt;</div><div class="line">                       &#123;</div><div class="line">                           PARTICLE_COUNT.map((v, j) =&gt; &#123;</div><div class="line">                               return &lt;AnimatedCircle</div><div class="line">                                   x=&#123;firework.particlePositions[j].x&#125;</div><div class="line">                                   y=&#123;firework.particlePositions[j].y&#125;</div><div class="line">                                   key=&#123;&quot;particles_&quot;+j&#125;</div><div class="line">                                   scaleX=&#123;firework.particleRadius&#125;</div><div class="line">                                   scaleY=&#123;firework.particleRadius&#125;</div><div class="line">                                   radius=&#123;PARTICLE_RADIUS&#125;</div><div class="line">                                   fill=&#123;_particleFill&#125;</div><div class="line">                               /&gt;</div><div class="line">                           &#125;)</div><div class="line">                       &#125;</div><div class="line">                   &lt;/Group&gt;</div><div class="line">               &lt;/AnimatedGroup&gt;</div><div class="line">           );</div><div class="line">       &#125;)</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>还是和之前变换炮弹颜色一样，我们还是使用interpolation来变化粒子的5种颜色。</p>
<p>这里不同的是使用AnimatedGroup，我们将坐标从x,y设置到AnimatedGroup中。</p>
<p>AnimatedGroup打包了炮弹和所有的粒子。这样我们可以让我们的粒子从0,0开始向外移动，AnimatedGroup将确保所有的坐标都能正确处理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">&lt;AnimatedCircle</div><div class="line">  opacity=&#123;firework.coreOpacity&#125;</div><div class="line">  radius=&#123;MORTAR_RADIUS&#125;</div><div class="line">  fill=&#123;_shootingFill&#125;</div><div class="line">/&gt;</div></pre></td></tr></table></figure>
<p>可以看到把coreOpacity动画放在粒子这，然后他将在200毫秒内消失。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">&lt;Group&gt;</div><div class="line">  &#123;</div><div class="line">    PARTICLE_COUNT.map((v, j) =&gt; &#123;</div><div class="line">      return &lt;AnimatedCircle</div><div class="line">        x=&#123;firework.particlePositions[j].x&#125;</div><div class="line">        y=&#123;firework.particlePositions[j].y&#125;</div><div class="line">        key=&#123;&quot;particles_&quot;+j&#125;</div><div class="line">        scaleX=&#123;firework.particleRadius&#125;</div><div class="line">        scaleY=&#123;firework.particleRadius&#125;</div><div class="line">        radius=&#123;PARTICLE_RADIUS&#125;</div><div class="line">        fill=&#123;_particleFill&#125;</div><div class="line">      /&gt;</div><div class="line">    &#125;)</div><div class="line">  &#125;</div><div class="line">&lt;/Group&gt;</div></pre></td></tr></table></figure>
<p>我们把粒子都放在Group组件里。我们映射出20个粒子，x和y的值由getXYParticle函数来确定。</p>
<p>你可以注意到，我们把particleRadius传递给了scaleX和scaleY属性，因为AnimatedCircle带有的radius属性不具有可动画性，所以通过缩放到0的方式来完全隐藏。</p>
<p>这样，我们就可以将其扩大到完整的尺寸，并使其看起来像爆炸一样，这样实际上的效果更好。</p>
<p>最后我们使用在顶部定义的PARTICLE_RADIUS，也就是每个炮弹的大小，然后将_particleFill设置为这5种颜色的interpolation。</p>
<h2 id="发射"><a href="#发射" class="headerlink" title="发射"></a>发射</h2><p>完工！我们有了🎉！<br>运行起来就可以看到效果</p>
<p><img src="http://7oxfjd.com2.z0.glb.qiniucdn.com/2018-03-21-preview_3.gif" alt="preview_3"></p>
<h3 id="Final-Code"><a href="#Final-Code" class="headerlink" title="Final Code"></a>Final Code</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">import React, &#123;</div><div class="line">    Component</div><div class="line">&#125;from &apos;react&apos;;</div><div class="line"></div><div class="line">import &#123;</div><div class="line">    ART as Art,</div><div class="line">    StyleSheet,</div><div class="line">    View,</div><div class="line">    Dimensions,</div><div class="line">    TouchableWithoutFeedback,</div><div class="line">    Animated</div><div class="line">&#125; from &apos;react-native&apos;;</div><div class="line"></div><div class="line">var &#123;</div><div class="line">    width,</div><div class="line">    height</div><div class="line">&#125; = Dimensions.get(&apos;window&apos;);</div><div class="line"></div><div class="line">var &#123;</div><div class="line">    Surface,</div><div class="line">    Shape,</div><div class="line">    Path,</div><div class="line">    Group,</div><div class="line">    Transform</div><div class="line">&#125; = Art;</div><div class="line"></div><div class="line">var AnimatedShape = Animated.createAnimatedComponent(Shape);</div><div class="line">var AnimatedGroup = Animated.createAnimatedComponent(Group);</div><div class="line"></div><div class="line">const MORTAR_RADIUS = 5</div><div class="line"></div><div class="line">const SHOOTING_COLORS = [</div><div class="line">    &apos;rgb(234,238,112)&apos;, //Yellow</div><div class="line">    &apos;rgb(245,137,12)&apos; //Orange</div><div class="line">];</div><div class="line"></div><div class="line">const PARTICLE_RADIUS = 30; // 炸开粒子的范围半径</div><div class="line">const PARTICLE_COUNT = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20]; // 每个爆开有多少粒子</div><div class="line"></div><div class="line">//粒子的颜色变化域</div><div class="line">const PARTICLE_COLORS = [</div><div class="line">    &apos;rgba(54, 17, 52, 100)&apos;,</div><div class="line">    &apos;rgba(176, 34, 140, 100)&apos;,</div><div class="line">    &apos;rgba(234, 55, 136, 100)&apos;,</div><div class="line">    &apos;rgba(229, 107, 112, 100)&apos;,</div><div class="line">    &apos;rgba(243, 145, 160, 100)&apos;</div><div class="line">]</div><div class="line"></div><div class="line">export default class App extends Component&lt;Props&gt; &#123;</div><div class="line">    state = &#123;</div><div class="line">        fireworks: []</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    adjustShootingFill = (_shootingColor, value) =&gt; &#123;</div><div class="line">        Animated.timing(_shootingColor, &#123;</div><div class="line">            duration: 16,</div><div class="line">            toValue: _shootingColor.__getAnimatedValue() == 0 ? 1 : 0</div><div class="line">        &#125;).start()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    adjustParticleFill = (_particleColor, value) =&gt; &#123;</div><div class="line">        var _currentFill = _particleColor.__getAnimatedValue(),</div><div class="line">        _particleFill = _currentFill === 5 ? 0 : _currentFill + 1;</div><div class="line"></div><div class="line">        Animated.timing(_particleColor, &#123;</div><div class="line">            duration: 16,</div><div class="line">            toValue: _particleFill</div><div class="line">        &#125;).start()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    _handleAddFirework = (e) =&gt; &#123;</div><div class="line">        var _shootingPosition = new Animated.ValueXY(&#123;x: width/2, y: height - MORTAR_RADIUS&#125;);</div><div class="line">        var _shootingColor = new Animated.Value(0);</div><div class="line">        var _particleColor = new Animated.Value(0);</div><div class="line">        var _particleRadius = new Animated.Value(0);</div><div class="line">        var _coreOpacity = new Animated.Value(1);</div><div class="line"></div><div class="line">        var _particlePositions = PARTICLE_COUNT.map(() =&gt; new Animated.ValueXY(&#123;x: 0, y: 0&#125;));</div><div class="line"></div><div class="line">        this.state.fireworks.push(&#123;</div><div class="line">            shootingPosition: _shootingPosition,</div><div class="line">            shootingColor: _shootingColor,</div><div class="line">            particleColor: _particleColor,</div><div class="line">            particleRadius: _particleRadius,</div><div class="line">            coreOpacity: _coreOpacity,</div><div class="line">            particlePositions: _particlePositions</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        _shootingPosition.addListener(this.adjustShootingFill.bind(null, _shootingColor));</div><div class="line">        _particleRadius.addListener(this.adjustParticleFill.bind(null, _particleColor));</div><div class="line"></div><div class="line">        function getXYParticle(total, i, radius) &#123;</div><div class="line">            var angle = 360/total*i;</div><div class="line"></div><div class="line">            var x = Math.round((radius*2) * Math.cos(angle - (Math.PI/2)));</div><div class="line">            var y = Math.round((radius*2) * Math.sin(angle - (Math.PI/2)));</div><div class="line"></div><div class="line">            return &#123;</div><div class="line">                x: x,</div><div class="line">                y: y</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        var _animatedParticles = [</div><div class="line">            Animated.timing(_particleRadius, &#123;</div><div class="line">                duration: 700,</div><div class="line">                toValue: 1</div><div class="line">            &#125;),</div><div class="line">            Animated.timing(_coreOpacity, &#123;</div><div class="line">                duration: 200,</div><div class="line">                toValue: 0</div><div class="line">            &#125;)</div><div class="line">        ]</div><div class="line"></div><div class="line">        var _movingParticles = _particlePositions.map((particle, i) =&gt; &#123;</div><div class="line">            var _xy = getXYParticle(PARTICLE_COUNT.length, i, PARTICLE_RADIUS);</div><div class="line">            return Animated.timing(particle, &#123;</div><div class="line">                duration: 250,</div><div class="line">                toValue: _xy</div><div class="line">            &#125;)</div><div class="line">        &#125;)</div><div class="line"></div><div class="line">        _animatedParticles = _animatedParticles.concat(_movingParticles);</div><div class="line"></div><div class="line">        Animated.sequence([</div><div class="line">            Animated.timing(_shootingPosition, &#123;</div><div class="line">                duration: 300,</div><div class="line">                toValue: &#123;</div><div class="line">                    y: e.nativeEvent.locationY,</div><div class="line">                    x: e.nativeEvent.locationX</div><div class="line">                &#125;</div><div class="line">            &#125;),</div><div class="line">            Animated.parallel(_animatedParticles)</div><div class="line">        ]).start(this.removeSelf.bind(this, _shootingPosition));</div><div class="line"></div><div class="line">        this.setState(this.state);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    removeSelf = (_shootingPosition)=&gt; &#123;</div><div class="line">        this.setState(&#123;</div><div class="line">            fireworks: this.state.fireworks.filter((firework) =&gt; firework.shootingPosition !== _shootingPosition)</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    getFireworks = () =&gt; &#123;</div><div class="line">        return this.state.fireworks.map((firework, i) =&gt; &#123;</div><div class="line"></div><div class="line">            var _shootingFill = firework.shootingColor.interpolate(&#123;</div><div class="line">                inputRange: [0,1],</div><div class="line">                outputRange: SHOOTING_COLORS</div><div class="line">            &#125;);</div><div class="line"></div><div class="line">            var _particleFill = firework.particleColor.interpolate(&#123;</div><div class="line">                inputRange: [0,1,2,3,4],</div><div class="line">                outputRange: PARTICLE_COLORS</div><div class="line">            &#125;);</div><div class="line"></div><div class="line">            return (</div><div class="line">                &lt;AnimatedGroup</div><div class="line">                    x=&#123;firework.shootingPosition.x&#125;</div><div class="line">                    y=&#123;firework.shootingPosition.y&#125;</div><div class="line">                    key=&#123;&quot;group_&quot;+i&#125;</div><div class="line">                &gt;</div><div class="line">                    &lt;AnimatedCircle</div><div class="line">                        opacity=&#123;firework.coreOpacity&#125;</div><div class="line">                        radius=&#123;MORTAR_RADIUS&#125;</div><div class="line">                        fill=&#123;_shootingFill&#125;</div><div class="line">                        key=&#123;&quot;circle_&quot;+i&#125;</div><div class="line">                    /&gt;</div><div class="line">                    &lt;Group&gt;</div><div class="line">                        &#123;</div><div class="line">                            PARTICLE_COUNT.map((v, j) =&gt; &#123;</div><div class="line">                                return &lt;AnimatedCircle</div><div class="line">                                    x=&#123;firework.particlePositions[j].x&#125;</div><div class="line">                                    y=&#123;firework.particlePositions[j].y&#125;</div><div class="line">                                    key=&#123;&quot;particles_&quot;+j&#125;</div><div class="line">                                    scaleX=&#123;firework.particleRadius&#125;</div><div class="line">                                    scaleY=&#123;firework.particleRadius&#125;</div><div class="line">                                    radius=&#123;PARTICLE_RADIUS&#125;</div><div class="line">                                    fill=&#123;_particleFill&#125;</div><div class="line">                                /&gt;</div><div class="line">                            &#125;)</div><div class="line">                        &#125;</div><div class="line">                    &lt;/Group&gt;</div><div class="line">                &lt;/AnimatedGroup&gt;</div><div class="line">            );</div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    render()&#123;</div><div class="line">        return (</div><div class="line">            &lt;View style=&#123;styles.container&#125;&gt;</div><div class="line">                &lt;TouchableWithoutFeedback onPress=&#123;this._handleAddFirework&#125; &gt;</div><div class="line">                    &lt;View&gt;</div><div class="line">                        &lt;Surface width=&#123;width&#125; height=&#123;height&#125;&gt;</div><div class="line">                            &#123;this.getFireworks()&#125;</div><div class="line">                        &lt;/Surface&gt;</div><div class="line">                    &lt;/View&gt;</div><div class="line">                &lt;/TouchableWithoutFeedback&gt;</div><div class="line">            &lt;/View&gt;</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">var styles = StyleSheet.create(&#123;</div><div class="line">    container: &#123;</div><div class="line">        flex: 1,</div><div class="line">        flexDirection: &apos;column&apos;</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">class AnimatedCircle extends Component&lt;Props&gt; &#123;</div><div class="line">    render()&#123;</div><div class="line">        var radius = this.props.radius;</div><div class="line">        var path = Path().moveTo(0, -radius)</div><div class="line">            .arc(0, radius * 2, radius)</div><div class="line">            .arc(0, radius * -2, radius)</div><div class="line">            .close();</div><div class="line">        return (</div><div class="line">            &lt;AnimatedShape d=&#123;path&#125;  &#123;...this.props&#125;/&gt;</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="David Woo" />
          <p class="site-author-name" itemprop="name">David Woo</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/">
              <span class="site-state-item-count">107</span>
              <span class="site-state-item-name">Artikel</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">195</span>
                <span class="site-state-item-name">Kategorien</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">Tags</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">David Woo</span>
</div>

<div class="powered-by">
  Erstellt mit  <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  




  
  

  

  

  

</body>
</html>
