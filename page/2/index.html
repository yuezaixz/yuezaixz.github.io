<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="大胃吴的闲话唠嗑">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="大胃吴的闲话唠嗑">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="大胃吴的闲话唠嗑">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/page/2/"/>

  <title> 大胃吴的闲话唠嗑 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">大胃吴的闲话唠嗑</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">扯扯技术，唠唠闲话 交流email-xiao303178394@gmail.com</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-首页">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            menu.首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-文章">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            menu.文章
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/02/01/iOS低功耗蓝牙开发指西-译/" itemprop="url">
                  iOS低功耗蓝牙开发指西[译]
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2018-02-01T11:05:20+08:00" content="2018-02-01">
              2018-02-01
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="iOS低功耗蓝牙开发指西-译"><a href="#iOS低功耗蓝牙开发指西-译" class="headerlink" title="iOS低功耗蓝牙开发指西[译]"></a>iOS低功耗蓝牙开发指西[译]</h1><h2 id="译文"><a href="#译文" class="headerlink" title="译文"></a>译文</h2><p>链接：<a href="https://codeburst.io/getting-started-with-bluetooth-low-energy-on-ios-ada3090fc9cc" target="_blank" rel="external">Getting started with Bluetooth Low Energy on iOS</a><br>作者：<a href="https://codeburst.io/@yostane?source=post_header_lockup" target="_blank" rel="external">Yassine benabbas</a></p>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>低功耗蓝牙(BLE)是蓝牙4.0最重要的特性之一。使用BLE进行设备间通信的功耗对比传统蓝牙大大的降低了。另一个重大的进步就是用户用系统设置取代了手动配对。这篇文章的核心内容为快速介绍BLE及展示从零开始创建iOS应用去连接一个BLE外设。</p>
<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>低功耗蓝牙缩写为BLE。首先要澄清，蓝牙4.0定义了包括经典蓝牙协议、高速蓝牙协议和低功耗蓝牙协议在内的一系列的技术规范，所以请仔细检查外设对于BLE的兼容性。</p>
<p>要识别一个外设是否为BLE外设，可以检查它是否带有『Bluetooth smart』、『Bluetooth Low Energy』或『BLE』标识。</p>
<p>现在我们有了一些BLE外设，我们将在下一节看到它们如何通信。</p>
<h2 id="中心设备和外设的BLE通信"><a href="#中心设备和外设的BLE通信" class="headerlink" title="中心设备和外设的BLE通信"></a>中心设备和外设的BLE通信</h2><p>在BLE世界有两种设备：外设和中心设备。</p>
<p>外设是一个设备暴露出一些服务，提供数据的读写。</p>
<p>中心设备是一个设备可以连接多个外设并与他们进行数据的读写。通信的连接是由中心设备来发起并初始化的。</p>
<p>在一个C/S架构模型中，中心设备可以认为是客户端，外设可以看做是服务端。</p>
<p>一些设备可以同时作为中心设备和外设存在，比如iOS和Mac设备。</p>
<p>外设/中心设备例子：</p>
<ul>
<li>像小米手环这类型智能手环就是一个外设</li>
<li>iPhone手机连接了一个只能手环，就扮演了中心设备的角色</li>
</ul>
<p><img src="http://7oxfjd.com2.z0.glb.qiniucdn.com/2018-02-01-15173883632616.png" alt=""></p>
<div align="center"><font color="blue" size="2" face="verdana">源自:<a href="https://learn.adafruit.com/introduction-to-bluetooth-low-energy/gatt" target="_blank" rel="external">https://learn.adafruit.com/introduction-to-bluetooth-low-energy/gatt</a></font></div>

<p>在下一章节，我们将介绍BLE中存在的通信方式。</p>
<h2 id="BLE通信方式"><a href="#BLE通信方式" class="headerlink" title="BLE通信方式"></a>BLE通信方式</h2><p>有两种通信方式：</p>
<ul>
<li>广播通信模式(Advertising mode)：外设定时的广播附带一些信息，周围可能发现广播的中心设备都可以接收这些信息。这种模式允许一个外设被中心设备发现，因此把他叫做广告（advertising）。在这种模式下，可以直接通过GAP广播进行交换简单的信息。从外设角度看，这是一个外设对应多个中心设备的模式。</li>
<li>连接模式(Connected mode)：允许一个中心设备和外设交换复杂的数据。GATT协议描述了这种模式是如何创建会话进行通信的。从外设角度说，这是种一对一的模式。</li>
</ul>
<p>但有一些规则：</p>
<ul>
<li>一个中心设备不能连接另一个中心设备，一个外设不能连接另一个外设</li>
<li>一个外设同时时间只能连接一个中心设备</li>
</ul>
<p>在下一章节，我们降更深入的钻研连接模式通信的细节。</p>
<h2 id="BLE在连接模式的通信"><a href="#BLE在连接模式的通信" class="headerlink" title="BLE在连接模式的通信"></a>BLE在连接模式的通信</h2><h3 id="服务与特征"><a href="#服务与特征" class="headerlink" title="服务与特征"></a>服务与特征</h3><p>GATT协议定义了中心设备如何与可连接的外设通信。首先数据的结构是这样定义的：</p>
<ul>
<li>外设暴露中心设备可进行读、写与被通知的属性。这些属性每一个都被称作为特征(characteristic)。一个特征也伴随着一个描述符(descriptor)来解释它；</li>
<li>特征被分组为服务(service)；</li>
<li>我们也可以将服务分组成一个配置文件(profile)。</li>
</ul>
<p>让我们举一个例子：心率监测器是一个BLE外设，他有一个心率配置文件，该配置文件有两个服务（心率服务及设备信息服务）。心率服务定义了一个读特征可以提供测量的心率结果。它也定义了一个写特征用于告诉外设它现在处于身体的什么位置。然后设备信息服务包含关于模型、固件版本等设备信息。</p>
<p>每个特征和服务都被定义了唯一标识，这个唯一标识被称作UUID。有一些预定义好的标准服务与特征的UUID，如果你有兴趣，可以在该<a href="https://www.bluetooth.com/specifications/gatt/services and https://www.bluetooth.com/specifications/gatt/characteristics" target="_blank" rel="external">链接</a>中延伸阅读。当然，你可以为你自己的服务和特征定义UUID。你也没有义务去回避预定义的UUID。标准的UUID是16位的，自定义的则是128位的，他们一般用十六进制表示。例如心率服务的UUID是16位的：0x180D，而自定义可以是:6E400001-B5A3-F393-E0A9-E50E24DCCA9E。<br><img src="http://7oxfjd.com2.z0.glb.qiniucdn.com/2018-02-01-15173911787186.png" alt=""></p>
<p>下一章节我们将介绍典型的BLE使用案例。</p>
<h2 id="典型的蓝牙使用案例"><a href="#典型的蓝牙使用案例" class="headerlink" title="典型的蓝牙使用案例"></a>典型的蓝牙使用案例</h2><p>该章节我们将介绍典型的BLE使用案例。有非常多可能的BLE使用场景，但我们将描述最常见的这种。</p>
<p>BLE搜索APP：他的用途为在你想要发现并测试BLE的位置发现周围蓝牙设备的情况，具体为以下功能：</p>
<ul>
<li>发现外设的广播服务</li>
<li>中心设备发现这些广播服务并把它们显示给用户</li>
<li>用户从列表中选择一个外设</li>
<li>中心设备连接选中的外设并把该外设所有的服务展现给用户</li>
<li>用户可以选择一个服务</li>
<li>中心设备询问外设当前选择的服务有哪些特征并展示给用户</li>
<li>用户可以选择一项特征并执行一些允许的操作(比如读，或者写，又或者被通知)</li>
</ul>
<p>这类型的应用有BlueCap和LightBlue，可以从AppStore中下载。</p>
<p>还有很多经典的使用案例，比如：</p>
<ul>
<li>APP可以扫描一些特定的广播服务的设备</li>
<li>APP可以连接特定的设备，比如智能手环</li>
<li>APP接着可以通过特定的特征和决定好的服务来获取一些信息，比如步数</li>
<li>APP可以断开外设的连接，下一次可以立即重连上</li>
</ul>
<p>这种类型的应用使用起来更加简易上手，只需要用户进行了第一次连接，之后就可以自动的快速连接上，当前很多智能设备的交互都遵循该思路，有的甚至更加简易。 例如，小米手环的官方应用，我们也将在本文末尾开发遵循该规范的小米手环应用程序</p>
<p>下一章节，我们将检查我们的苹果设备是否支持BLE。</p>
<h2 id="BLE与Apple"><a href="#BLE与Apple" class="headerlink" title="BLE与Apple"></a>BLE与Apple</h2><p>苹果很早的就在他们的软硬件中支持BLE了，这里有一些回顾</p>
<ul>
<li>iOS5的SDK引入了蓝牙核心(Core Bluetooth)框架，该框架允许BLE设备作为中央设备或外设进行交互</li>
<li>从iPhone 4S开始，所有的iOS设备都支持BLE</li>
<li>如果你的Mac支持BLE，那么你的iOS模拟器也支持。</li>
</ul>
<p>支持BLE的首批Mac电脑有</p>
<ul>
<li>2011年中的MacBook Air</li>
<li>2011年年中的Mac mini</li>
<li>2012年中期视网膜(retina)及非视网膜版本的MacBook Pro</li>
<li>2012年底的iMacs</li>
</ul>
<p>了解了这点，并且您目前拥有Mac、iPhone或iPad，那么就可以开始编写一些BLE应用程序。</p>
<h2 id="在iOS上开发蓝牙应用程序"><a href="#在iOS上开发蓝牙应用程序" class="headerlink" title="在iOS上开发蓝牙应用程序"></a>在iOS上开发蓝牙应用程序</h2><p>当你要开发一款通过BLE与其他硬件交互的应用程序，你需要先问自己三个问题：</p>
<ul>
<li>我是要与中心设备交互，还是与外设交互？</li>
<li>配置文件是什么？也就是外设有哪些服务和特征？</li>
<li>我将使用到哪个框架或库？</li>
</ul>
<p>首先，第一个问题的答案决定了应用程序将实现那种类型的BLE设备。如果我们想要交互的设备是一个中心设备，那么APP将扮演的就是外设的角色。反之，如果我们想与一个外设通信，那么我们的APP就将是一个中心设备。</p>
<p>其次，实现明确好服务与特征可以让应用程序与BLE设备很快的无缝对接。否则将不知道如何进行通信。</p>
<p>最后，开发BLE应用，选择一个最适合的框架是非常的重要。对我来说，这是最重要的原因有两个，第一个是在开始传递数据前由很多的异步任务，第二个是这个过程可能会因为很多原因失败，那么，选择一个简化这些任务的框架就是非常重要的了。</p>
<p>以我的经历来说，我选择过两种框架：</p>
<ul>
<li>Core Bluetooth，他是苹果开发的BLE框架，从iOS5开始就包含在iOS SDK中。这个框架严重依赖于代理(delegate)，并且他有丰富而完善的文档及示例代码。唯一不足的就是这个框架有些时间长了，不够新颖。</li>
<li>BlueCap，它是一个在Core Bluetooth之上的swift软件包。他支持iOS9以上的系统，需要Xcode 8.2来开发。他依赖于Future而不是Delegate，如果你不是很熟悉Future，那么这将花费你一些时间去熟悉它，但相信我，这些是值得的，比起delegate，这将让你感到更自然。</li>
</ul>
<p>由于我们将要开发的这个项目支持iOS11，并且用Swift4编写，我毫无犹豫的选择了BlueCap ：）。在下一节中，我将要创建一个简单的中心设备应用，他将与一个Mac上通过Bleno模拟的外设进行通信。</p>
<h2 id="实现中心设备的iOS应用"><a href="#实现中心设备的iOS应用" class="headerlink" title="实现中心设备的iOS应用"></a>实现中心设备的iOS应用</h2><p>首先，我们将通过Mac模拟一个外设，如果你有你也可以使用自己的外设。</p>
<h3 id="通过Mac模拟一个外设"><a href="#通过Mac模拟一个外设" class="headerlink" title="通过Mac模拟一个外设"></a>通过Mac模拟一个外设</h3><p>有很多不同的技术可以通过Mac模拟一个BLE外设。第一个闪现在我脑子里的想法就是创建一个基于Core Bluetooth的Mac APP来扮演外设的角色。这也有个叫<a href="https://github.com/sandeepmistry/bleno" target="_blank" rel="external">bleno</a> 的node.js模块，他可以很快的实现一个BLE外设。本文中我们将使用bleno。这里我介绍下快速启用它的过程：</p>
<ul>
<li>安装Xcode</li>
<li>安装node.js</li>
<li>打开一个终端，通过 <figure class="highlight plain"><figcaption><span>install bleno``` 命令来安装bleno模块</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"> * 下载bleno的github仓库(https://github.com/sandeepmistry/bleno)[https://github.com/sandeepmistry/bleno]</div><div class="line"> * 打开一个终端并进入 examples/echo 文件夹</div><div class="line"> * 运行 ```node main.js``` 。如果你遇到“missing module”的错误提示，你需要使用npm安装“module”，然后再试一次</div><div class="line"></div><div class="line">整个过程的命令如下：</div><div class="line"></div><div class="line"> ```bash</div><div class="line"> $git clone https://github.com/sandeepmistry/bleno bleno</div><div class="line"> $cd bleno</div><div class="line"> $npm install bleno</div><div class="line"> $cd examples/echo</div><div class="line"> # $npm install module</div><div class="line"> $ node main.js</div><div class="line">bleno - echo</div><div class="line">on -&gt; stateChange: poweredOn</div><div class="line">on -&gt; advertisingStart: success</div></pre></td></tr></table></figure></li>
</ul>
<p>如果你看到最后的输出，说明你成功了。<br>你已经在你的电脑上模拟了一个Local Name为『echo』的BLE外设，广播服务的UUID为EC00，你可以查看main.js文件看看他是如何运行的。<br>当我们连接上，可以发现一个UUID为 “ec0e” 的特征可用于读、写和通知。这些都定义在characteristics.js中，文件中还定义了如何处理读、写和通知。</p>
<p>现在我们有了一个功能完整的外设，那让我们开始开发一个微型的iOS应用与这个外设进行交互吧。</p>
<h3 id="iOS中心设备应用"><a href="#iOS中心设备应用" class="headerlink" title="iOS中心设备应用"></a>iOS中心设备应用</h3><p>这中心设备APP将非常简洁。他搜索广播为echo的设备，第一个发现的就直接连上。接着，APP让我们从ec0e特征读写数据。我们可以通过以下步骤来初始化工程：</p>
<ul>
<li>创建一个简单的应用</li>
</ul>
<p><img src="http://7oxfjd.com2.z0.glb.qiniucdn.com/2018-02-01-15174493294792.jpg" alt=""></p>
<ul>
<li>给你的应用命名为SimpleBleCentral，并且选择Swift</li>
</ul>
<p><img src="http://7oxfjd.com2.z0.glb.qiniucdn.com/2018-02-01-15174494036052.jpg" alt=""></p>
<p>现在，工程已经创建好了，我们将添加BlueCap框架(<a href="https://github.com/troystribling/BlueCap)[https://github.com/troystribling/BlueCap]。有很多不同的方法添加，比如Cocoapods、Carthage，这里用Cocoapods方式导入，这里不详细介绍如何使用Cocoapods导入第三方库。" target="_blank" rel="external">https://github.com/troystribling/BlueCap)[https://github.com/troystribling/BlueCap]。有很多不同的方法添加，比如Cocoapods、Carthage，这里用Cocoapods方式导入，这里不详细介绍如何使用Cocoapods导入第三方库。</a></p>
<p>我们也要添加CoreBluetooth框架到项目中，因为BlueCap是依赖于CoreBluetoothde。<br><img src="http://7oxfjd.com2.z0.glb.qiniucdn.com/2018-02-01-15174508768320.jpg" alt=""></p>
<p>下一步是在项目的属性中添加中心设备功能。要做的就是运行后台模式并检查Bluetooth LE的可访问性。</p>
<p><img src="http://7oxfjd.com2.z0.glb.qiniucdn.com/2018-02-01-15174511314563.jpg" alt=""></p>
<p>我们的storyboard包含了一个ViewController，他可以在扫描我们想要使用特征的时候展示一个等待指示器。当我们发现了特征，ViewController则展现出一个可交互的视图供读写该特征。</p>
<p><img src="http://7oxfjd.com2.z0.glb.qiniucdn.com/2018-02-01-15174520548884.jpg" alt=""></p>
<p>我们的view controller要完成以下任务：</p>
<ul>
<li>初始化CentralManager，他是BlueCapKit的一个中心设备类，可用来扫描外设</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//初始化并定义一个标识的Key，这个Key之后可以用来重用该Manage类</span></div><div class="line"><span class="keyword">let</span> manager = <span class="type">CentralManager</span>(options: [<span class="type">CBCentralManagerOptionRestoreIdentifierKey</span> : <span class="string">"CentralMangerKey"</span> <span class="keyword">as</span> <span class="type">NSString</span>])</div><div class="line"></div><div class="line"><span class="comment">//一个feture流，当该管理类状态发生变化的时候，他会通知我们</span></div><div class="line"><span class="keyword">let</span> stateChangeFuture = manager.whenStateChanges()</div></pre></td></tr></table></figure>
<ul>
<li>扫描广播包含ec00服务的外设</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//如果蓝牙是开启的，那么就可以扫描</span></div><div class="line"><span class="keyword">let</span> scanFuture = stateChangeFuture.flatMap &#123; state -&gt; <span class="type">FutureStream</span>&lt;<span class="type">Peripheral</span>&gt; <span class="keyword">in</span></div><div class="line">    <span class="keyword">switch</span> state &#123;</div><div class="line">    <span class="keyword">case</span> .poweredOn:</div><div class="line">        <span class="type">DispatchQueue</span>.main.async &#123;</div><div class="line">            <span class="keyword">self</span>.connectionStatusLabel.text = <span class="string">"start scanning"</span></div><div class="line">            <span class="built_in">print</span>(<span class="keyword">self</span>.connectionStatusLabel.text!)</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//扫描广播了服务为ec00的设备</span></div><div class="line">        <span class="keyword">return</span> manager.startScanning(forServiceUUIDs: [serviceUUID])</div><div class="line">    <span class="keyword">case</span> .poweredOff:</div><div class="line">        <span class="keyword">throw</span> <span class="type">AppError</span>.poweredOff</div><div class="line">    <span class="keyword">case</span> .unauthorized, .unsupported:</div><div class="line">        <span class="keyword">throw</span> <span class="type">AppError</span>.invalidState</div><div class="line">    <span class="keyword">case</span> .resetting:</div><div class="line">        <span class="keyword">throw</span> <span class="type">AppError</span>.resetting</div><div class="line">    <span class="keyword">case</span> .unknown:</div><div class="line">        <span class="keyword">throw</span> <span class="type">AppError</span>.unknown</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>第一个找到有该服务的类，我们连接他</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//连接第一个找到的设备</span></div><div class="line"><span class="keyword">let</span> connectionFuture = scanFuture.flatMap &#123; peripheral -&gt; <span class="type">FutureStream</span>&lt;<span class="type">Peripheral</span>&gt; <span class="keyword">in</span></div><div class="line">    <span class="comment">//找到了立即停止扫描</span></div><div class="line">    manager.stopScanning()</div><div class="line">    <span class="type">DispatchQueue</span>.main.async &#123;</div><div class="line">        <span class="keyword">self</span>.connectionStatusLabel.text = <span class="string">"Found peripheral \(peripheral.identifier.uuidString). Trying to connect"</span></div><div class="line">        <span class="built_in">print</span>(<span class="keyword">self</span>.connectionStatusLabel.text!)</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//连接</span></div><div class="line">    <span class="keyword">return</span> peripheral.connect(connectionTimeout: <span class="number">10</span>, capacity: <span class="number">5</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>接着，我们寻找为“ec00”的服务，这步有点像重复了上一步，但是实例化服务对象是非常重要的，它将帮我们找到需要的特征</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//找到"ec00"的服务，并访问他的特征</span></div><div class="line"><span class="keyword">let</span> discoveryFuture = connectionFuture.flatMap &#123; peripheral -&gt; <span class="type">Future</span>&lt;<span class="type">Peripheral</span>&gt; <span class="keyword">in</span></div><div class="line">    <span class="keyword">return</span> peripheral.discoverServices([serviceUUID])</div><div class="line">    &#125;.flatMap &#123; discoveredPeripheral -&gt; <span class="type">Future</span>&lt;<span class="type">Service</span>&gt; <span class="keyword">in</span></div><div class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> service = discoveredPeripheral.service(serviceUUID) <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="type">AppError</span>.serviceNotFound</div><div class="line">        &#125;</div><div class="line">        peripheral = discoveredPeripheral</div><div class="line">        <span class="type">DispatchQueue</span>.main.async &#123;</div><div class="line">            <span class="keyword">self</span>.connectionStatusLabel.text = <span class="string">"Discovered service \(service.uuid.uuidString). Trying to discover characteristics"</span></div><div class="line">            <span class="built_in">print</span>(<span class="keyword">self</span>.connectionStatusLabel.text!)</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//开始检查找到的服务，寻找为"ec0e"的特征</span></div><div class="line">        <span class="keyword">return</span> service.discoverCharacteristics([dateCharacteristicUUID])</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>找到”ec0e”的特征，然后注册通知</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> 1- 检查这特征是否被找到</span></div><div class="line"><span class="comment"> 2- 注册通知</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">let</span> dataFuture = discoveryFuture.flatMap &#123; service -&gt; <span class="type">Future</span>&lt;<span class="type">Characteristic</span>&gt; <span class="keyword">in</span></div><div class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> dataCharacteristic = service.characteristic(dateCharacteristicUUID) <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="type">AppError</span>.dataCharactertisticNotFound</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">self</span>.dataCharacteristic = dataCharacteristic</div><div class="line">    <span class="type">DispatchQueue</span>.main.async &#123;</div><div class="line">        <span class="keyword">self</span>.connectionStatusLabel.text = <span class="string">"Discovered characteristic \(dataCharacteristic.uuid.uuidString). COOL :)"</span></div><div class="line">        <span class="built_in">print</span>(<span class="keyword">self</span>.connectionStatusLabel.text!)</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//当我们找到了该特征，我们可以展示特征交互视图</span></div><div class="line">    <span class="type">DispatchQueue</span>.main.async &#123;</div><div class="line">        <span class="keyword">self</span>.loadingView.isHidden = <span class="literal">true</span></div><div class="line">        <span class="keyword">self</span>.characteristicView.isHidden = <span class="literal">false</span></div><div class="line">    &#125;</div><div class="line">    <span class="comment">//从特征读取数据</span></div><div class="line">    <span class="keyword">self</span>.read()</div><div class="line">    <span class="comment">//告诉特征开启值变化的通知</span></div><div class="line">    <span class="keyword">return</span> dataCharacteristic.startNotifying()</div><div class="line">    &#125;.flatMap &#123; characteristic -&gt; <span class="type">FutureStream</span>&lt;(characteristic: <span class="type">Characteristic</span>, data: <span class="type">Data</span>?)&gt; <span class="keyword">in</span></div><div class="line">        <span class="comment">//注册接收值变化通知</span></div><div class="line">        <span class="keyword">return</span> characteristic.receiveNotificationUpdates(capacity: <span class="number">10</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//每当值变化，都会调用该闭包</span></div><div class="line">dataFuture.onSuccess &#123; (<span class="number">_</span>, data) <span class="keyword">in</span></div><div class="line">    <span class="keyword">let</span> s = <span class="type">String</span>(data:data!, encoding: .utf8)</div><div class="line">    <span class="type">DispatchQueue</span>.main.async &#123;</div><div class="line">        <span class="keyword">self</span>.notifiedValueLabel.text = <span class="string">"notified value is \(s)"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>也可以使用一个简单的函数链来完成以上所有步骤。<br>获得了特征对象，我们就能对它读写数据了。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">read</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="comment">//read a value from the characteristic</span></div><div class="line">    <span class="keyword">let</span> readFuture = <span class="keyword">self</span>.dataCharacteristic?.read(timeout: <span class="number">5</span>)</div><div class="line">    readFuture?.onSuccess &#123; (<span class="number">_</span>) <span class="keyword">in</span></div><div class="line">        <span class="comment">//the value is in the dataValue property</span></div><div class="line">        <span class="keyword">let</span> s = <span class="type">String</span>(data:(<span class="keyword">self</span>.dataCharacteristic?.dataValue)!, encoding: .utf8)</div><div class="line">        <span class="type">DispatchQueue</span>.main.async &#123;</div><div class="line">            <span class="keyword">self</span>.valueLabel.text = <span class="string">"Read value is \(s)"</span></div><div class="line">            <span class="built_in">print</span>(<span class="keyword">self</span>.valueLabel.text!)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    readFuture?.onFailure &#123; (<span class="number">_</span>) <span class="keyword">in</span></div><div class="line">        <span class="keyword">self</span>.valueLabel.text = <span class="string">"read error"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">write</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="keyword">self</span>.valueToWriteTextField.resignFirstResponder()</div><div class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> text = <span class="keyword">self</span>.valueToWriteTextField.text <span class="keyword">else</span>&#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//write a value to the characteristic</span></div><div class="line">    <span class="keyword">let</span> writeFuture = <span class="keyword">self</span>.dataCharacteristic?.write(data:text.data(using: .utf8)!)</div><div class="line">    writeFuture?.onSuccess(completion: &#123; (<span class="number">_</span>) <span class="keyword">in</span></div><div class="line">        <span class="built_in">print</span>(<span class="string">"write succes"</span>)</div><div class="line">    &#125;)</div><div class="line">    writeFuture?.onFailure(completion: &#123; (e) <span class="keyword">in</span></div><div class="line">        <span class="built_in">print</span>(<span class="string">"write failed"</span>)</div><div class="line">    &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>本文是对蓝牙低功耗的粗浅的学习。BLE是一个蓝牙标准，允许无需在系统设置中进行配对的进行连接通信以降低通信的功耗。我们再iOS上实现了一个蓝牙中心设备，它连接到了Mac上模拟的外设。<br>我们可以使用BLE做很多的事情。例如我们可以在智能手环上编写我们自己的应用程序。又例如，我们也可以在Arduino主板上安装BLE芯片，通过他实现很多有趣的应用。译者接触过的很多个智能产品的项目，核心芯片都是Nordic。</p>
<p>该项目的源码可以在GitHub上看到，(<a href="https://github.com/yostane/iOS-BlueCap-Example)[https://github.com/yostane/iOS-BlueCap-Example]。" target="_blank" rel="external">https://github.com/yostane/iOS-BlueCap-Example)[https://github.com/yostane/iOS-BlueCap-Example]。</a></p>
<p>赶紧动手实现下才是最快乐的事情:)。</p>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><p><a href="https://oleb.net/blog/2013/04/starting-bluetooth-low-energy-development-ios/" target="_blank" rel="external">https://oleb.net/blog/2013/04/starting-bluetooth-low-energy-development-ios/</a></p>
<p><a href="https://docs.mbed.com/docs/ble-intros/en/latest/Introduction/BLEInDepth/" target="_blank" rel="external">https://docs.mbed.com/docs/ble-intros/en/latest/Introduction/BLEInDepth/</a></p>
<p><a href="https://stackoverflow.com/questions/17732321/peripheral-and-central-at-the-same-time-on-ios" target="_blank" rel="external">https://stackoverflow.com/questions/17732321/peripheral-and-central-at-the-same-time-on-ios</a></p>
<p><a href="https://learn.adafruit.com/introduction-to-bluetooth-low-energy/gatt" target="_blank" rel="external">https://learn.adafruit.com/introduction-to-bluetooth-low-energy/gatt</a></p>
<p><a href="https://www.bluetooth.com/specifications/generic-attributes-overvie" target="_blank" rel="external">https://www.bluetooth.com/specifications/generic-attributes-overvie</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/16/Xcode-9-0-beta5-编辑Storyboard时闪退问题/" itemprop="url">
                  Xcode 9.0 beta5,编辑Storyboard时闪退问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2017-08-16T10:37:01+08:00" content="2017-08-16">
              2017-08-16
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h1><p>最近吃螃蟹，一直使用Xcode9 Beta版本（其实就是新项目直接用Swift4写了，省得到时候还要再做适配）。然而遇到了很多问题，一些问题也就不说了，但这次遇到这个问题，实在不能忍，升级到Xcode 9.0 beta5后，项目的主Storyboard打不开了。</p>
<h1 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h1><p>Xcode闪退日志如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div></pre></td><td class="code"><pre><div class="line">Process:               Xcode [33099]  </div><div class="line">Path:                  /Applications/Xcode-beta.app/Contents/MacOS/Xcode  </div><div class="line">Identifier:            com.apple.dt.Xcode  </div><div class="line">Version:               9.0 (13226.5)  </div><div class="line">Build Info:            IDEFrameworks-13226005000000000~14  </div><div class="line">Code Type:             X86-64 (Native)  </div><div class="line">Parent Process:        ??? [1]  </div><div class="line">Responsible:           Xcode [33099]  </div><div class="line">User ID:               1700997662  </div><div class="line">  </div><div class="line">  </div><div class="line">Date/Time:             2017-08-10 15:45:59.315 -0400  </div><div class="line">OS Version:            Mac OS X 10.12.6 (16G29)  </div><div class="line">Report Version:        12  </div><div class="line">Anonymous UUID:        4C707867-0F4B-A4D5-CFF4-F497B7B7F058  </div><div class="line">  </div><div class="line">  </div><div class="line">  </div><div class="line">  </div><div class="line">Time Awake Since Boot: 1200000 seconds  </div><div class="line">  </div><div class="line">  </div><div class="line">System Integrity Protection: enabled  </div><div class="line">  </div><div class="line">  </div><div class="line">Crashed Thread:        0  Dispatch queue: com.apple.main-thread  </div><div class="line">  </div><div class="line">  </div><div class="line">Exception Type:        EXC_CRASH (SIGABRT)  </div><div class="line">Exception Codes:       0x0000000000000000, 0x0000000000000000  </div><div class="line">Exception Note:        EXC_CORPSE_NOTIFY  </div><div class="line">  </div><div class="line">  </div><div class="line">Application Specific Information:  </div><div class="line">ProductBuildVersion: 9M202q  </div><div class="line">ASSERTION FAILURE in /Library/Caches/com.apple.xbs/Sources/IDEInterfaceBuilder/IDEInterfaceBuilder-13178.6/InterfaceBuilderKit/Document/StoryboardDocument/Metrics/IBStoryboardMetricsInferrer.m:128  </div><div class="line">Details:  Failed to push inherited simulated metrics to all scenes.  </div><div class="line">Object:   &lt;IBStoryboardMetricsInferrer: 0x7fb91138a690&gt;  </div><div class="line">Method:   -rebuildInferredMetrics  </div><div class="line">Thread:   &lt;NSThread: 0x7fb907c18050&gt;&#123;number = 1, name = main&#125;  </div><div class="line">Hints:   </div><div class="line">  0: Replacement view is installing: &lt;IBStoryboardCanvasViewController: 0x7fb911167ee0 representing: (null)&gt;  </div><div class="line">Backtrace:  </div><div class="line">  0   -[IDEAssertionHandler handleFailureInMethod:object:fileName:lineNumber:assertionSignature:messageFormat:arguments:] (in IDEKit)  </div><div class="line">  1   _DVTAssertionHandler (in DVTFoundation)  </div><div class="line">  2   _DVTAssertionFailureHandler (in DVTFoundation)  </div><div class="line">  3   -[IBStoryboardMetricsInferrer rebuildInferredMetrics] (in IDEInterfaceBuilderKit)  </div><div class="line">  4   -[DVTDelayedInvocation runBlock:] (in DVTFoundation)  </div><div class="line">  5   -[DVTDelayedInvocation invokeIfNeeded] (in DVTFoundation)  </div><div class="line">  6   -[DVTDelayedInvocation invoke] (in DVTFoundation)  </div><div class="line">  7   -[IBCocoaTouchDocumentPlatformAdapter updateDocumentSimulatedMetricsWithDeviceConfiguration:] (in IDEInterfaceBuilderCocoaTouchIntegration)  </div><div class="line">  8   -[IBDocument switchToDeviceConfigurationWithoutFrameDeciding:] (in IDEInterfaceBuilderKit)  </div><div class="line">  9   -[IBDocument switchToDeviceConfiguration:] (in IDEInterfaceBuilderKit)  </div><div class="line">10   -[IBCanvasViewController _addDeviceBarIfNeeded] (in IDEInterfaceBuilderKit)  </div><div class="line">11   -[IBAbstractDocumentEditor didFinishLoadingSubViewControllers] (in IDEInterfaceBuilderKit)  </div><div class="line">12   -[IBAbstractDocumentEditor replacementView:didInstallViewController:] (in IDEInterfaceBuilderKit)  </div><div class="line">13   __42-[DVTReplacementView _setupViewController]_block_invoke (in DVTKit)  </div><div class="line">14   DVTInvokeWithFailureHint (in DVTFoundation)  </div><div class="line">15   -[DVTReplacementView _setupViewController] (in DVTKit)  </div><div class="line">16   -[DVTReplacementView installedViewController] (in DVTKit)  </div><div class="line">17   -[IBAbstractDocumentEditor viewDidInstall] (in IDEInterfaceBuilderKit)  </div><div class="line">18   -[IBStoryboardDocumentEditor viewDidInstall] (in IDEInterfaceBuilderKit)  </div><div class="line">19   -[DVTViewController _viewDidInstall] (in DVTKit)  </div><div class="line">20   -[_DVTViewController_ViewLifecycleInterpositions viewDidMoveToWindow] (in DVTKit)  </div><div class="line">21   -[NSView _setWindow:] (in AppKit)  </div><div class="line">22   -[NSView addSubview:] (in AppKit)  </div><div class="line">23   -[NSView setSubviews:] (in AppKit)  </div><div class="line">24   -[DVTBorderedView setContentView:] (in DVTKit)  </div><div class="line">25   -[IDEEditorContext _setEditorView] (in IDEKit)  </div><div class="line">26   -[IDEEditorContext setupNewEditor:] (in IDEKit)  </div><div class="line">27   __91-[IDEEditorContext _openNavigableItem:documentExtension:document:shouldInstallEditorBlock:]_block_invoke (in IDEKit)  </div><div class="line">28   -[IDEEditorContext _performBlockInsideReentrantGuard:] (in IDEKit)  </div><div class="line">29   -[IDEEditorContext _openNavigableItem:documentExtension:document:shouldInstallEditorBlock:] (in IDEKit)  </div><div class="line">30   -[IDEEditorContext _openNavigableItem:withContentsOfURL:documentExtension:shouldInstallEditorBlock:] (in IDEKit)  </div><div class="line">31   -[IDEEditorContext _notifyDelegateAndOpenNavigableItem:withContentsURL:documentExtensionIdentifier:locationToSelect:annotationRepresentedObject:stateDictionary:annotationWantsIndicatorAnimation:exploreAnnotationRepresentedObject:highlightSelection:alwaysReplaceExistingNavigableItem:skipSubDocumentNavigationUnlessEditorIsReplaced:] (in IDEKit)  </div><div class="line">32   -[IDEEditorContext _notifyDelegateAndOpenEditorOpenSpecifier:updateHistory:] (in IDEKit)  </div><div class="line">33   -[IDEEditorContext openEditorOpenSpecifier:updateHistory:] (in IDEKit)  </div><div class="line">34   -[IDEEditorContext openEditorOpenSpecifier:] (in IDEKit)  </div><div class="line">35   -[IDEEditorModeViewController openEditorOpenSpecifier:editorContext:] (in IDEKit)  </div><div class="line">36   -[IDEEditorArea _openEditorOpenSpecifier:editorContext:takeFocus:] (in IDEKit)  </div><div class="line">37   __108+[IDEEditorCoordinator _doOpenEditorOpenSpecifier:forWorkspaceTabController:editorContext:target:takeFocus:]_block_invoke_2 (in IDEKit)  </div><div class="line">38   __108+[IDEEditorCoordinator _doOpenEditorOpenSpecifier:forWorkspaceTabController:editorContext:target:takeFocus:]_block_invoke (in IDEKit)  </div><div class="line">39   +[IDEEditorCoordinator _doOpenWithWorkspaceTabController:editorContext:target:allowFallback:documentURL:usingBlock:] (in IDEKit)  </div><div class="line">40   +[IDEEditorCoordinator _doOpenEditorOpenSpecifier:forWorkspaceTabController:editorContext:target:takeFocus:] (in IDEKit)  </div><div class="line">41   -[_IDEOpenRequest _primitiveRunIfNecessary] (in IDEKit)  </div><div class="line">42   -[_IDEOpenRequest _runIfNecessary] (in IDEKit)  </div><div class="line">43   __NSFireDelayedPerform (in Foundation)  </div><div class="line">44   __CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__ (in CoreFoundation)  </div><div class="line">45   __CFRunLoopDoTimer (in CoreFoundation)  </div><div class="line">46   __CFRunLoopDoTimers (in CoreFoundation)  </div><div class="line">47   __CFRunLoopRun (in CoreFoundation)  </div><div class="line">48   CFRunLoopRunSpecific (in CoreFoundation)  </div><div class="line">49   RunCurrentEventLoopInMode (in HIToolbox)  </div><div class="line">50   ReceiveNextEventCommon (in HIToolbox)  </div><div class="line">51   _BlockUntilNextEventMatchingListInModeWithFilter (in HIToolbox)  </div><div class="line">52   _DPSNextEvent (in AppKit)  </div><div class="line">53   -[NSApplication(NSEvent) _nextEventMatchingEventMask:untilDate:inMode:dequeue:] (in AppKit)  </div><div class="line">54   -[DVTApplication nextEventMatchingMask:untilDate:inMode:dequeue:] (in DVTKit)  </div><div class="line">55   -[NSApplication run] (in AppKit)  </div><div class="line">56   NSApplicationMain (in AppKit)  </div><div class="line">57   start (in libdyld.dylib)</div></pre></td></tr></table></figure>
<h1 id="寻找解决方案"><a href="#寻找解决方案" class="headerlink" title="寻找解决方案"></a>寻找解决方案</h1><p>看到Apple Developer Forums上很多人提了类似的问题，但并没有人踢出解决方案。</p>
<p>从日志看，只有关键词inherited，但把相关的都去掉了，也并没有效果。</p>
<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><p>通过尝试重新创建Storyboard进行测试，还有就是git往前回退找一个不闪退版本的Storyboard，通过他们之间的比较，猜测可能是gestureRecognizers的问题。</p>
<p>然后，把gestureRecognizers相关的部分都删了，通过代码实现gesture，就不会出现闪退问题了，真是运气好。</p>
<p>删除以下3部分代码。</p>
<pre><code>&lt;!-- 删除&lt;gestureRecognizers/&gt; --&gt;

&lt;!--
&lt;connections&gt;
    &lt;outletCollection property=&quot;gestureRecognizers&quot; destination=&quot;ngk-1s-19f&quot; appends=&quot;YES&quot; id=&quot;xDu-EO-3XT&quot;/&gt;
&lt;/connections&gt;
--&gt;

&lt;!--
&lt;tapGestureRecognizer id=&quot;ngk-1s-19f&quot;&gt;
    &lt;connections&gt;
        &lt;action selector=&quot;tapConnectGestureAction:&quot; destination=&quot;TSL-wS-yk1&quot; id=&quot;VZS-RM-dhp&quot;/&gt;
        &lt;segue destination=&quot;7YZ-oH-7MN&quot; kind=&quot;presentation&quot; id=&quot;WjS-a1-0BG&quot;/&gt;
    &lt;/connections&gt;
&lt;/tapGestureRecognizer&gt;
--&gt;
</code></pre>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/26/终端通过Shadowsocks科学上网/" itemprop="url">
                  终端通过Shadowsocks科学上网
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2016-10-26T21:09:12+08:00" content="2016-10-26">
              2016-10-26
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="终端通过Shadowsocks科学上网"><a href="#终端通过Shadowsocks科学上网" class="headerlink" title="终端通过Shadowsocks科学上网"></a>终端通过Shadowsocks科学上网</h1><h2 id="安装polipo"><a href="#安装polipo" class="headerlink" title="安装polipo"></a>安装polipo</h2><p>polipo是一个轻量级的缓存web代理程序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo brew install polipo</div></pre></td></tr></table></figure>
<h2 id="设置自动启动"><a href="#设置自动启动" class="headerlink" title="设置自动启动"></a>设置自动启动</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ ln -sfv /usr/local/opt/polipo/*.plist ~/Library/LaunchAgents</div><div class="line">/Users/David_Woo/Library/LaunchAgents/homebrew.mxcl.polipo.plist -&gt; /usr/local/opt/polipo/homebrew.mxcl.polipo.plist</div></pre></td></tr></table></figure>
<h2 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$sudo vim /usr/local/opt/polipo/homebrew.mxcl.polipo.plist</div></pre></td></tr></table></figure>
<p>增加一行\<string>socksParentProxy=localhost:1080\</string>,完全替换应该也是ok的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div><div class="line">&lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;</div><div class="line">&lt;plist version=&quot;1.0&quot;&gt;</div><div class="line">  &lt;dict&gt;</div><div class="line">    &lt;key&gt;Label&lt;/key&gt;</div><div class="line">    &lt;string&gt;homebrew.mxcl.polipo&lt;/string&gt;</div><div class="line">    &lt;key&gt;RunAtLoad&lt;/key&gt;</div><div class="line">    &lt;true/&gt;</div><div class="line">    &lt;key&gt;KeepAlive&lt;/key&gt;</div><div class="line">    &lt;true/&gt;</div><div class="line">    &lt;key&gt;ProgramArguments&lt;/key&gt;</div><div class="line">    &lt;array&gt;</div><div class="line">        &lt;string&gt;/usr/local/opt/polipo/bin/polipo&lt;/string&gt;</div><div class="line">        &lt;string&gt;socksParentProxy=localhost:1080&lt;/string&gt;</div><div class="line">    &lt;/array&gt;</div><div class="line">    &lt;key&gt;SoftResourceLimits&lt;/key&gt;</div><div class="line">    &lt;dict&gt;</div><div class="line">      &lt;key&gt;NumberOfFiles&lt;/key&gt;</div><div class="line">      &lt;integer&gt;20480&lt;/integer&gt;</div><div class="line">    &lt;/dict&gt;</div><div class="line">  &lt;/dict&gt;</div><div class="line">&lt;/plist&gt;</div></pre></td></tr></table></figure>
<h2 id="重启及启动"><a href="#重启及启动" class="headerlink" title="重启及启动"></a>重启及启动</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ launchctl unload ~/Library/LaunchAgents/homebrew.mxcl.polipo.plist</div><div class="line">$ launchctl load ~/Library/LaunchAgents/homebrew.mxcl.polipo.plist</div></pre></td></tr></table></figure>
<h2 id="验证是否成功"><a href="#验证是否成功" class="headerlink" title="验证是否成功"></a>验证是否成功</h2><p>之后命令都以 http_proxy=<a href="http://localhost:8123" target="_blank" rel="external">http://localhost:8123</a> 开头</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">wudiweideMacBook-Pro-2:~ David_Woo$ curl ip.gs</div><div class="line">当前 IP：27.152.75.207 来自：中国福建厦门 电信</div><div class="line">wudiweideMacBook-Pro-2:~ David_Woo$ http_proxy=http://localhost:8123 curl ip.gs</div><div class="line">当前 IP：23.83.239.21 来自：美国加利福尼亚州费利蒙</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/12/Core-Plot针对设计的一些应用/" itemprop="url">
                  Core Plot针对设计的一些应用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2016-09-12T11:27:16+08:00" content="2016-09-12">
              2016-09-12
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Core-Plot针对设计的一些应用"><a href="#Core-Plot针对设计的一些应用" class="headerlink" title="Core Plot针对设计的一些应用"></a>Core Plot针对设计的一些应用</h1><h2 id="设计样式"><a href="#设计样式" class="headerlink" title="设计样式"></a>设计样式</h2><p>这次APP结果页界面改版，收到了这个图表样式的设计，之前图表使用的库，一部分用Core Plot，一部分用自己实现的一个轻量级曲线图（只支持画曲线和一些曲线动画效果），由于时间比较紧，没有打算在自己实现的曲线图上增加如此多的自定义功能，所以把Core Plot研究了下，了解下这些设计要如何自定义。<br><img src="http://7oxfjd.com2.z0.glb.qiniucdn.com/2016-09-12-1.png" alt="1"></p>
<h2 id="拆分细节"><a href="#拆分细节" class="headerlink" title="拆分细节"></a>拆分细节</h2><p>先要分析下，这个图表有哪些东西需要自定义</p>
<ul>
<li>曲线需要打点，打点的图形是两个圆叠加出来的，而且打的点有4种样式：处于阈值范围内点（小白绿点），超出阈值范围点（小白红点），当前点处于阈值范围内点（大白绿点），当期点超出阈值范围点（大白红点）</li>
<li>x轴label（当前点label颜色不一样）和点上方的label实现</li>
<li>曲线的范围不固定，曲线的阈值范围是大于等于某值或小于等于某值，所以绿和红的是不固定的</li>
<li>y轴label分2种颜色，majorTickLine也分两种颜色</li>
</ul>
<p>预期外问题</p>
<ul>
<li>x轴和y轴的label，会超出范围，就是在图表范围外了，所以不显示出来</li>
</ul>
<h2 id="解决问题"><a href="#解决问题" class="headerlink" title="解决问题"></a>解决问题</h2><h3 id="两个圆叠加的打点"><a href="#两个圆叠加的打点" class="headerlink" title="两个圆叠加的打点"></a>两个圆叠加的打点</h3><p>这个其实就是普通的打点画圆，但是远外层line的宽度设置大一点，就可以实现这个效果了，代码如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">CPTScatterPlot *rightScatterPlot_ = [[CPTScatterPlot alloc] init];</div><div class="line">rightScatterPlot_.identifier = <span class="string">@"rightScatterPlot"</span>;</div><div class="line">rightScatterPlot_.interpolation = CPTScatterPlotInterpolationCurved;</div><div class="line"><span class="comment">// 注意：这里为什么成nil，后面一节就说到</span></div><div class="line">rightScatterPlot_.dataLineStyle = <span class="literal">nil</span>;</div><div class="line">rightScatterPlot_.dataSource    = <span class="keyword">self</span>;</div><div class="line">rightScatterPlot_.areaBaseValue = CPTDecimalFromString ( <span class="string">@"0.0"</span> );</div><div class="line"></div><div class="line"><span class="comment">// Add plot symbols: 表示数值的符号的形状</span></div><div class="line">CPTMutableLineStyle * symbolLineStyle = [CPTMutableLineStyle lineStyle];</div><div class="line">symbolLineStyle.lineColor = [CPTColor whiteColor];</div><div class="line">symbolLineStyle.lineWidth = <span class="number">3.0</span>;<span class="comment">//白色范围宽度3</span></div><div class="line"></div><div class="line">CPTPlotSymbol * plotSymbol = [CPTPlotSymbol ellipsePlotSymbol];</div><div class="line">plotSymbol.fill          = [CPTFill fillWithColor:[CPTColor colorWithComponentRed:<span class="number">65.0</span>/<span class="number">255.0</span> green:<span class="number">117.0</span>/<span class="number">255.0</span> blue:<span class="number">5.0</span>/<span class="number">255.0</span> alpha:<span class="number">1.0</span>]];<span class="comment">//绿色</span></div><div class="line">plotSymbol.lineStyle     = symbolLineStyle;</div><div class="line">plotSymbol.size          = <span class="built_in">CGSizeMake</span>(<span class="number">10.0</span>, <span class="number">10.0</span>);<span class="comment">//整个圆的大小，大绿点就把这个圆大一些，line的宽度也大一些</span></div><div class="line">rightScatterPlot_.plotSymbol = plotSymbol;</div><div class="line"></div><div class="line">[graph_ addPlot:rightScatterPlot_];</div></pre></td></tr></table></figure>
<h3 id="多种打点的样式"><a href="#多种打点的样式" class="headerlink" title="多种打点的样式"></a>多种打点的样式</h3><p>这里Core Plot并不支持，为了实现该设计，用了一个方法，就是这种图表，其实我画了4个CPTScatterPlot来实现，也就是上一节『rightScatterPlot_.dataLineStyle = nil;』的原因，因为我只为了打点，不画曲线。<br>然后在datasource的代理方法中根据identifier来返回数据，返回的是nil就是该点在该x值上不画，如下代码</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ([plot.identifier isEqual:<span class="string">@"dataScatterPlot"</span>]) &#123;<span class="comment">//画曲线</span></div><div class="line">    <span class="keyword">return</span> [[datas_ objectAtIndex:[datas_ count] - index<span class="number">-1</span>] valueForKey:key_];</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> ([plot.identifier isEqual:<span class="string">@"rightScatterPlot"</span>]) &#123;<span class="comment">//画阈值范围内点</span></div><div class="line">    <span class="keyword">if</span> (index == [datas_ count] - <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (isMore_) &#123;<span class="comment">//isMore_为初始化参数，规定阈值的比较是大于等于还是小于等于</span></div><div class="line">        <span class="keyword">return</span> [[[datas_ objectAtIndex:[datas_ count] - index<span class="number">-1</span>] valueForKey:key_] floatValue] &lt;= threshold_ ? [[datas_ objectAtIndex:[datas_ count] - index<span class="number">-1</span>] valueForKey:key_] : <span class="literal">nil</span> ;<span class="comment">//不是阈值范围内的点，就不画小绿点了</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> [[[datas_ objectAtIndex:[datas_ count] - index<span class="number">-1</span>] valueForKey:key_] floatValue] &gt;= threshold_ ? [[datas_ objectAtIndex:[datas_ count] - index<span class="number">-1</span>] valueForKey:key_] : <span class="literal">nil</span> ;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> ([plot.identifier isEqual:<span class="string">@"errorScatterPlot"</span>]) &#123;<span class="comment">//画阈值范围外的点</span></div><div class="line">    <span class="keyword">if</span> (index == [datas_ count] - <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (isMore_) &#123;</div><div class="line">        <span class="keyword">return</span> [[[datas_ objectAtIndex:[datas_ count] - index<span class="number">-1</span>] valueForKey:key_] floatValue] &gt;= threshold_ ? [[datas_ objectAtIndex:[datas_ count] - index<span class="number">-1</span>] valueForKey:key_] : <span class="literal">nil</span> ;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> [[[datas_ objectAtIndex:[datas_ count] - index<span class="number">-1</span>] valueForKey:key_] floatValue] &lt;= threshold_ ? [[datas_ objectAtIndex:[datas_ count] - index<span class="number">-1</span>] valueForKey:key_] : <span class="literal">nil</span> ;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> ([plot.identifier isEqual:<span class="string">@"currentScatterPlot"</span>]) &#123;<span class="comment">//画当前点</span></div><div class="line">    <span class="keyword">if</span> (index == [datas_ count] - <span class="number">1</span>) &#123;<span class="comment">//是当前点才画</span></div><div class="line">        <span class="keyword">return</span> [[datas_ objectAtIndex:[datas_ count] - index<span class="number">-1</span>] valueForKey:key_];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="点上方的label的实现"><a href="#点上方的label的实现" class="headerlink" title="点上方的label的实现"></a>点上方的label的实现</h3><p> 就在当前点的CPTScatterPlot上实现就好了</p>
 <figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//字体样式</span></div><div class="line">CPTMutableTextStyle *currentTextStyle = [CPTMutableTextStyle textStyle];</div><div class="line">currentTextStyle.color     = [CPTColor colorWithComponentRed:<span class="number">208.0</span>/<span class="number">255.0</span> green:<span class="number">2.0</span>/<span class="number">255.0</span> blue:<span class="number">27.0</span>/<span class="number">255.0</span> alpha:<span class="number">1.0</span>];</div><div class="line">currentTextStyle.fontSize = <span class="number">13</span>;</div><div class="line"></div><div class="line"><span class="comment">//打点的样式</span></div><div class="line">CPTPlotSymbol * plotSymbol = [CPTPlotSymbol ellipsePlotSymbol];</div><div class="line">plotSymbol.fill          = [CPTFill fillWithColor:[CPTColor colorWithComponentRed:<span class="number">208.0</span>/<span class="number">255.0</span> green:<span class="number">2.0</span>/<span class="number">255.0</span> blue:<span class="number">27.0</span>/<span class="number">255.0</span> alpha:<span class="number">1.0</span>]];</div><div class="line"></div><div class="line"><span class="comment">//颜色控制</span></div><div class="line"><span class="keyword">if</span> ( ( isMore_ &amp;&amp; [[[datas_ firstObject] objectForKey:key_] floatValue] &lt;= threshold_ ) || (!isMore_ &amp;&amp; [[[datas_ firstObject] objectForKey:key_] floatValue] &gt;= threshold_)) &#123;</div><div class="line">    currentTextStyle.color     = [CPTColor colorWithComponentRed:<span class="number">65.0</span>/<span class="number">255.0</span> green:<span class="number">117.0</span>/<span class="number">255.0</span> blue:<span class="number">5.0</span>/<span class="number">255.0</span> alpha:<span class="number">1.0</span>];</div><div class="line">    plotSymbol.fill          = [CPTFill fillWithColor:[CPTColor colorWithComponentRed:<span class="number">65.0</span>/<span class="number">255.0</span> green:<span class="number">117.0</span>/<span class="number">255.0</span> blue:<span class="number">5.0</span>/<span class="number">255.0</span> alpha:<span class="number">1.0</span>]];</div><div class="line">&#125;</div><div class="line">plotSymbol.lineStyle     = symbolLineStyle;</div><div class="line">plotSymbol.size          = <span class="built_in">CGSizeMake</span>(<span class="number">15.0</span>, <span class="number">15.0</span>);</div><div class="line">currentScatterPlot_.plotSymbol = plotSymbol;</div><div class="line"><span class="comment">//label位置偏移量，正数为向上偏移</span></div><div class="line">currentScatterPlot_.labelOffset = <span class="number">10</span>;</div><div class="line">currentScatterPlot_.labelTextStyle = currentTextStyle;</div></pre></td></tr></table></figure>
<h3 id="y轴label的实现"><a href="#y轴label的实现" class="headerlink" title="y轴label的实现"></a>y轴label的实现</h3><p>y轴上多个label，在MAX和MIN相差过大情况下画出来不好看，和设计商量后改用只画阈值线的方式</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">-(<span class="built_in">BOOL</span>)axis:(CPTAxis *)axis shouldUpdateAxisLabelsAtLocations:(<span class="built_in">NSSet</span> *)locations</div><div class="line">&#123;</div><div class="line">    CPTXYAxisSet *axisSet = (CPTXYAxisSet *)graph_.axisSet;</div><div class="line">    <span class="keyword">if</span> (axis == axisSet.xAxis) &#123;</div><div class="line">        <span class="comment">//……比较简单，返回日期的label即可，不做说明</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//y轴实现</span></div><div class="line">        <span class="built_in">NSNumberFormatter</span> *formatter = [[<span class="built_in">NSNumberFormatter</span> alloc] init];</div><div class="line">        formatter.numberStyle = <span class="built_in">NSNumberFormatterRoundCeiling</span>;</div><div class="line">        <span class="built_in">CGFloat</span> labelOffset             = axis.labelOffset;</div><div class="line">        CPTMutableTextStyle * newStyle = [axis.labelTextStyle mutableCopy];</div><div class="line">        newStyle.color = [CPTColor colorWithComponentRed:<span class="number">233.0</span>/<span class="number">255.0</span> green:<span class="number">85.0</span>/<span class="number">255.0</span> blue:<span class="number">19.0</span>/<span class="number">255.0</span> alpha:<span class="number">1.0</span>];<span class="comment">//橙色</span></div><div class="line">        CPTTextStyle *theLabelTextStyle = newStyle;</div><div class="line">        CPTTextLayer * newLabelLayer= [[CPTTextLayer alloc] initWithText:threshold_ &gt; <span class="number">50</span> ?[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%ld"</span>,(<span class="keyword">long</span>)threshold_] : [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%.1f"</span>,threshold_] style:theLabelTextStyle];<span class="comment">//这里写比较死，因为图表分两种，步频的曲线就不用显示小数点了</span></div><div class="line">        CPTAxisLabel * newLabel     = [[CPTAxisLabel alloc] initWithContentLayer:newLabelLayer];</div><div class="line">        newLabel.tickLocation       = [<span class="built_in">NSDecimalNumber</span> numberWithDouble:threshold_].decimalValue;</div><div class="line">        newLabel.offset             = labelOffset;</div><div class="line">        </div><div class="line">        axis.majorTickLocations = [<span class="built_in">NSSet</span> setWithObjects:[<span class="built_in">NSDecimalNumber</span> numberWithDouble:threshold_], <span class="literal">nil</span>];</div><div class="line">        axis.axisLabels = [<span class="built_in">NSSet</span> setWithObjects:newLabel,<span class="literal">nil</span>];<span class="comment">//这里label多创建几个，就能实现多个label和majorTickLine的效果，样式不一致只要不同label用不同样式的ContentLayer就好了</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="label超出范围被遮盖的问题"><a href="#label超出范围被遮盖的问题" class="headerlink" title="label超出范围被遮盖的问题"></a>label超出范围被遮盖的问题</h3><p>由于gragh范围限制了，图表值域范围也确定了（x：0~7，y：0~max），x轴label居左，y轴label居下的话，就超出gragh的范围了<br>那么解决办法其实就是把值域范围设置大一些，然后设置坐标轴原点在（0，0）处即可。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">    CPTXYPlotSpace *plotSpace = (CPTXYPlotSpace *)graph_.defaultPlotSpace;</div><div class="line">    </div><div class="line">    <span class="comment">// x y 轴</span></div><div class="line">    CPTMutableLineStyle *majorGridLineStyle = [CPTMutableLineStyle lineStyle];</div><div class="line">    majorGridLineStyle.lineWidth = <span class="number">1.0</span>;</div><div class="line">    majorGridLineStyle.lineColor = [CPTColor colorWithComponentRed:<span class="number">233.0</span>/<span class="number">255.0</span> green:<span class="number">85.0</span>/<span class="number">255.0</span> blue:<span class="number">19.0</span>/<span class="number">255.0</span> alpha:<span class="number">1.0</span>];</div><div class="line">    </div><div class="line">    CPTXYAxisSet *axisSet = (CPTXYAxisSet *)graph_.axisSet;</div><div class="line">    CPTXYAxis *x          = axisSet.xAxis;</div><div class="line">    &#123;</div><div class="line">        x.axisLineStyle               = <span class="literal">nil</span>;</div><div class="line">        x.majorTickLineStyle          = <span class="literal">nil</span>;</div><div class="line">        x.minorTickLineStyle          = <span class="literal">nil</span>;</div><div class="line">        x.majorIntervalLength         = CPTDecimalFromDouble(<span class="number">1</span>);</div><div class="line">        <span class="keyword">if</span> (min_ &gt; <span class="number">0</span>) &#123;</div><div class="line">            x.orthogonalCoordinateDecimal = CPTDecimalFromDouble(min_ + (max_ - min_)/<span class="number">8</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            x.orthogonalCoordinateDecimal = CPTDecimalFromDouble(<span class="number">0.0</span>);</div><div class="line">        &#125;</div><div class="line">        x.minorTicksPerInterval       = <span class="number">1.0</span>;</div><div class="line">        x.tickDirection = CPTSignNegative; <span class="comment">//CPTSignNegative  左  CPTSignPositive  右</span></div><div class="line"><span class="comment">//        x.labelingPolicy = CPTAxisLabelingPolicyNone;</span></div><div class="line">        x.plotSpace = plotSpace;</div><div class="line">        </div><div class="line">        x.delegate = <span class="keyword">self</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    CPTXYAxis *y = axisSet.yAxis;</div><div class="line">    &#123;</div><div class="line">        y.orthogonalCoordinateDecimal = CPTDecimalFromDouble(<span class="number">-0.1</span>);</div><div class="line">        y.majorGridLineStyle          = <span class="literal">nil</span>;</div><div class="line">        y.axisLineStyle               = <span class="literal">nil</span>;</div><div class="line">        y.minorTickLineStyle          = <span class="literal">nil</span>;</div><div class="line">        y.majorTickLineStyle          = majorGridLineStyle;</div><div class="line">        y.tickDirection = CPTSignPositive; <span class="comment">//CPTSignNegative  左  CPTSignPositive  右</span></div><div class="line">        y.labelOffset = <span class="number">-25.5</span>;</div><div class="line">        y.majorTickLength = <span class="keyword">self</span>.frame.size.width<span class="number">-35</span>;</div><div class="line">        y.majorTickLocations = [<span class="built_in">NSSet</span> setWithObjects:[<span class="built_in">NSDecimalNumber</span> numberWithDouble:<span class="number">3.3</span>], <span class="literal">nil</span>];</div><div class="line">        </div><div class="line">        y.delegate = <span class="keyword">self</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//初始化范围</span></div><div class="line">    plotSpace.momentumAnimationCurve = CPTAnimationCurveCubicIn;</div><div class="line">    plotSpace.bounceAnimationCurve = CPTAnimationCurveBackIn;</div><div class="line">    plotSpace.momentumAcceleration = <span class="number">20000.0</span>;</div><div class="line">    </div><div class="line">    </div><div class="line">    plotSpace.xRange = [CPTPlotRange plotRangeWithLocation:CPTDecimalFromDouble(<span class="number">-0.9</span>) length:CPTDecimalFromDouble(<span class="number">8</span>)];</div><div class="line">    </div><div class="line">    plotSpace.yRange = [CPTPlotRange plotRangeWithLocation:CPTDecimalFromDouble(min_) length:CPTDecimalFromDouble(max_-min_)];</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/12/从零搭建Flask-Celery-Redis后台任务服务器/" itemprop="url">
                  从零搭建Flask+Celery+Redis后台任务服务器
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2016-09-12T11:27:16+08:00" content="2016-09-12">
              2016-09-12
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="从零搭建Flask-Celery-Redis后台任务服务器"><a href="#从零搭建Flask-Celery-Redis后台任务服务器" class="headerlink" title="从零搭建Flask+Celery+Redis后台任务服务器"></a>从零搭建Flask+Celery+Redis后台任务服务器</h1><h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>记录运动轨迹，那么在记录上传服务器后，要根据轨迹生成几张所需要的轨迹热图，也就是根据传来的经纬度集合，抓取适合的瓦片图，在上面绘制轨迹以及加蒙版等， 生成的图片如下。</p>
<p><img src="http://pathmap-10048881.file.myqcloud.com/pathmap/v0/colorline/RM/a0085622f4a26b1cb5912d82e97763bb/map.jpg" alt="热力图"></p>
<p>本文并不是要说热力图生成的逻辑，只是说说整个服务的架构与配置实现。</p>
<p><strong><em><font color="red">PS.本文主要用作自己记录，有兴趣的可以交流沟通，邮箱：xiao303178394@gmail.com</font></em></strong></p>
<h2 id="大体架构"><a href="#大体架构" class="headerlink" title="大体架构"></a>大体架构</h2><p>手残画了画</p>
<p><img src="http://7oxfjd.com2.z0.glb.qiniucdn.com/2016-10-26-1.jpg" alt="1"></p>
<h2 id="搭建环境"><a href="#搭建环境" class="headerlink" title="搭建环境"></a>搭建环境</h2><p>环境：Ubuntu 14.04 Python 2.7</p>
<h3 id="安装git以及下载源码"><a href="#安装git以及下载源码" class="headerlink" title="安装git以及下载源码"></a>安装git以及下载源码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ sudo apt-get update</div><div class="line">$ sudo apt-get install git</div><div class="line">$ sudo git clone https://git.coding.net/David_woo/rm-map-api.git rm_api</div></pre></td></tr></table></figure>
<h3 id="安装Pillow的一些底层依赖"><a href="#安装Pillow的一些底层依赖" class="headerlink" title="安装Pillow的一些底层依赖"></a>安装Pillow的一些底层依赖</h3><p>由于热图绘制用到Pillow，所以需要这部，不用Pillow可以无视</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ sudo apt-get install libjpeg-dev zlib1g*</div><div class="line">$ sudo apt-get install libtiff5-dev libjpeg8-dev zlib1g-dev libfreetype6-dev liblcms2-dev libwebp-dev tcl8.6-dev tk8.6-dev python-tk</div></pre></td></tr></table></figure>
<h3 id="安装Python的一些依赖库"><a href="#安装Python的一些依赖库" class="headerlink" title="安装Python的一些依赖库"></a>安装Python的一些依赖库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ sudo apt-get install -y python-pip python-dev build-essential</div><div class="line">$ sudo pip install -r requirements.txt</div><div class="line">$ sudo pip install gunicorn</div></pre></td></tr></table></figure>
<h3 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install nginx</div></pre></td></tr></table></figure>
<h2 id="配置后台服务"><a href="#配置后台服务" class="headerlink" title="配置后台服务"></a>配置后台服务</h2><p>这里用gunicorn做wsgi运行程序，然后nginx做服务器。</p>
<h3 id="gunicorn运行程序"><a href="#gunicorn运行程序" class="headerlink" title="gunicorn运行程序"></a>gunicorn运行程序</h3><p>程序源码根目录下，创建wsgi.py文件，内容如下即可。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line">__doc__ = <span class="string">"""</span></div><div class="line"><span class="string">"""</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> api <span class="keyword">import</span> create_app</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># application = create_app('api/config_dev.cfg')</span></div><div class="line">application = create_app(<span class="string">'api/config_qcloud.cfg'</span>)`</div></pre></td></tr></table></figure>
<p>同样在根目录下，创建gunicorn.cfg，内容如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> multiprocessing</div><div class="line"></div><div class="line">bind = <span class="string">"0.0.0.0:8092"</span></div><div class="line">daemon = <span class="keyword">True</span></div><div class="line">worker_class=<span class="string">"gevent"</span></div><div class="line">pidfile = <span class="string">"/var/run/gunicorn.pid"</span></div><div class="line">workers = multiprocessing.cpu_count() * <span class="number">2</span> + <span class="number">1</span></div><div class="line">worker_connections=<span class="number">1000</span></div><div class="line">backlog = <span class="number">2048</span></div><div class="line">errorlog = <span class="string">"/data/www/rm_api/gunicorn-error.log"</span></div><div class="line">loglevel = <span class="string">"info"</span></div></pre></td></tr></table></figure>
<p>执行命令，就把程序在 127.0.0.1:8092上跑起来了，记住这个地址，之后在nginx的配置上要用到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[david@XXX rmserver]$ sudo /usr/local/bin/python /usr/local/bin/gunicorn -c gunicorn.cfg wsgi:application</div><div class="line">[david@XXX rmserver]$ ps aux | grep gunicorn</div><div class="line">root     30836  0.6  0.1 210704 12696 ?        S    17:21   0:00 /usr/local/bin/python /usr/local/bin/gunicorn -c gunicorn.cfg wsgi:application</div><div class="line">root     30841  9.3  0.4 258636 35516 ?        S    17:21   0:00 /usr/local/bin/python /usr/local/bin/gunicorn -c gunicorn.cfg wsgi:application</div><div class="line">root     30842 10.6  0.4 340304 37748 ?        Sl   17:21   0:00 /usr/local/bin/python /usr/local/bin/gunicorn -c gunicorn.cfg wsgi:application</div><div class="line">root     30843 10.3  0.4 340308 37752 ?        Sl   17:21   0:00 /usr/local/bin/python /usr/local/bin/gunicorn -c gunicorn.cfg wsgi:application</div><div class="line">root     30846  9.3  0.4 258660 35540 ?        S    17:21   0:00 /usr/local/bin/python /usr/local/bin/gunicorn -c gunicorn.cfg wsgi:application</div><div class="line">root     30851  9.3  0.4 258668 35548 ?        S    17:21   0:00 /usr/local/bin/python /usr/local/bin/gunicorn -c gunicorn.cfg wsgi:application</div><div class="line">root     30854  9.3  0.4 258684 35560 ?        S    17:21   0:00 /usr/local/bin/python /usr/local/bin/gunicorn -c gunicorn.cfg wsgi:application</div><div class="line">root     30857  9.0  0.4 258688 35548 ?        S    17:21   0:00 /usr/local/bin/python /usr/local/bin/gunicorn -c gunicorn.cfg wsgi:application</div><div class="line">root     30860  9.0  0.4 258700 35552 ?        S    17:21   0:00 /usr/local/bin/python /usr/local/bin/gunicorn -c gunicorn.cfg wsgi:application</div><div class="line">root     30863 10.0  0.4 340364 37676 ?        Sl   17:21   0:00 /usr/local/bin/python /usr/local/bin/gunicorn -c gunicorn.cfg wsgi:application</div><div class="line">david    30872  0.0  0.0 103248   848 pts/0    S+   17:21   0:00 grep gunicorn</div></pre></td></tr></table></figure>
<h3 id="通过nginx作为服务器"><a href="#通过nginx作为服务器" class="headerlink" title="通过nginx作为服务器"></a>通过nginx作为服务器</h3><p>把nginx的配置放在源码根目录下，通过软链接到nginx/sites-enabled里，我觉得是一个比较好的方式，保证服务器的配置不会丢失。<br>当然，如果用Docker更好了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo ln -s rm_api_nginx.conf /etc/nginx/sites-enabled/</div></pre></td></tr></table></figure>
<p>内容大概如下,127.0.0.1:8092这里就用到了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen 8552;</div><div class="line">    server_name  xxx.xxx.xxx.xxx;</div><div class="line"></div><div class="line">    access_log  logs/nginx_rm_api_https.access.log;</div><div class="line">    error_log  logs/nginx_rm_api_https.error.log;</div><div class="line">    root   html;</div><div class="line">    index  index.html index.htm index.php;</div><div class="line"></div><div class="line">    location ~*$ &#123;</div><div class="line">        resolver xxx.xxx.xxx.xxx;</div><div class="line"></div><div class="line">          proxy_pass            http://127.0.0.1:8092;</div><div class="line">          proxy_redirect        off;</div><div class="line">          proxy_set_header      Host             $host;</div><div class="line">          proxy_set_header      X-Real-IP        $remote_addr;</div><div class="line">          proxy_set_header      X-Forwarded-For  $proxy_add_x_forwarded_for;</div><div class="line">          client_max_body_size  30m;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    location / &#123;</div><div class="line">          proxy_pass            http://127.0.0.1:8092;</div><div class="line">          proxy_redirect        off;</div><div class="line">          proxy_set_header      Host             $host;</div><div class="line">          proxy_set_header      X-Real-IP        $remote_addr;</div><div class="line">          proxy_set_header      X-Forwarded-For  $proxy_add_x_forwarded_for;</div><div class="line">          client_max_body_size  10m;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h2><p>redis这里用到了腾讯的redis服务，一是用来做消息队列，而是用来做瓦片图的缓存。</p>
<p>瓦片图缓存的相关。</p>
<h3 id="消息队列的redis配置及woker的启动"><a href="#消息队列的redis配置及woker的启动" class="headerlink" title="消息队列的redis配置及woker的启动"></a>消息队列的redis配置及woker的启动</h3><p>在源码根目录创建celery_tasks.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment">#coding=utf-8</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> api <span class="keyword">import</span> create_app</div><div class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> Celery, platforms</div><div class="line"><span class="keyword">from</span> celery.app.amqp <span class="keyword">import</span> Queue,Exchange</div><div class="line"></div><div class="line">app = create_app(<span class="string">'api/config_qcloud.cfg'</span>)</div><div class="line"><span class="comment"># app = create_app('api/config_dev.cfg')</span></div><div class="line"><span class="comment"># root执行任务，就必须开启</span></div><div class="line">platforms.C_FORCE_ROOT = <span class="keyword">True</span></div><div class="line"></div><div class="line">celery = Celery(app.import_name, broker=app.config[<span class="string">'CELERY_BROKER_URL'</span>])<span class="comment">#redis的url、密码</span></div><div class="line">celery.conf.update(app.config)</div><div class="line">celery.conf.CELERY_DEFAULT_QUEUE = <span class="string">'rm.map.api'</span></div><div class="line">celery.conf.CELERY_ENABLE_REMOTE_CONTROL = <span class="keyword">False</span></div></pre></td></tr></table></figure>
<p>通过下面命令执行，就通过daemon方式启动了woker</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo celery -A celery_tasks.celery multi start worker  --loglevel=info -P processes -c 4</div></pre></td></tr></table></figure>
<p>想要关闭的话</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo celery multi stopwait worker</div></pre></td></tr></table></figure>
<p><a href="http://docs.celeryproject.org/en/latest/tutorials/daemonizing.html#service-file-celery-service" target="_blank" rel="external">官网参考文献</a></p>
<p>这时候已经启动消息队列的消费者了，但是消息队列的生产者还没有说</p>
<p>如下是extension.py，里面初始化了celery</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment">#coding=utf-8</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> utils.redis_utils <span class="keyword">import</span> RedisConnectionPool</div><div class="line"></div><div class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> Celery</div><div class="line"></div><div class="line"></div><div class="line">__all__ = [<span class="string">'redis'</span>, <span class="string">'fds_client'</span> ,<span class="string">'celery'</span>]</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 使用 Redis Cache 做缓存</span></div><div class="line">redis = RedisConnectionPool(<span class="string">'MAPCACHE'</span>)</div><div class="line"></div><div class="line"><span class="comment"># 使用 celery 做分布式框架</span></div><div class="line">celery = Celery()</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_celery</span><span class="params">(app)</span>:</span></div><div class="line">    <span class="keyword">global</span> celery</div><div class="line">    <span class="comment">#TODO 改成redis</span></div><div class="line">    celery = Celery(app.import_name, broker=app.config[<span class="string">'CELERY_BROKER_URL'</span>])</div><div class="line">    celery.conf.update(app.config)</div><div class="line">    celery.conf.CELERY_DEFAULT_QUEUE = <span class="string">'rm.map.api'</span></div><div class="line">    celery.conf.CELERY_ENABLE_REMOTE_CONTROL = <span class="keyword">False</span></div><div class="line"></div><div class="line">    TaskBase = celery.Task</div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ContextTask</span><span class="params">(TaskBase)</span>:</span></div><div class="line">        abstract = <span class="keyword">True</span></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, *args, **kwargs)</span>:</span></div><div class="line">            <span class="keyword">with</span> app.app_context():</div><div class="line">                <span class="keyword">return</span> TaskBase.__call__(self, *args, **kwargs)</div><div class="line">    celery.Task = ContextTask</div><div class="line">    <span class="keyword">return</span> celery</div></pre></td></tr></table></figure>
<p>然后在函数上通过装饰器方式修饰任务函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> ..extensions <span class="keyword">import</span> celery</div><div class="line"></div><div class="line"><span class="string">'''</span></div><div class="line"><span class="string">生成矩形轨迹路线图</span></div><div class="line"><span class="string">'''</span></div><div class="line"><span class="meta">@celery.task(name='get_pathmap', acks_late=True)</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_pathmap</span><span class="params">(path_map, heat_path)</span>:</span></div><div class="line">		<span class="comment">#......，任务代码</span></div></pre></td></tr></table></figure>
<p>最后如下调用即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#通过配置决定是否用消息队列，方便调试功能</span></div><div class="line"><span class="keyword">if</span> current_app.config.get(<span class="string">'IS_CELERY_WORK'</span>):</div><div class="line">	get_pathmap.delay(path_map, heat_path)</div><div class="line"><span class="keyword">else</span>:</div><div class="line">	get_pathmap(path_map, heat_path)</div></pre></td></tr></table></figure>
<h3 id="瓦片图的reids缓存"><a href="#瓦片图的reids缓存" class="headerlink" title="瓦片图的reids缓存"></a>瓦片图的reids缓存</h3><p>redis_utils.py内容如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> redis</div><div class="line"><span class="keyword">import</span> socket</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisConnectionPool</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name=<span class="string">''</span>, app=None)</span>:</span></div><div class="line">        self.name = name</div><div class="line">        self._pool = <span class="keyword">None</span></div><div class="line">        self.max_try = <span class="number">3</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> app <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">            self.app = app</div><div class="line">            self.init_app(self.app)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            self.app = <span class="keyword">None</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">init_app</span><span class="params">(self, app)</span>:</span></div><div class="line">        self._pool = redis.BlockingConnectionPool(</div><div class="line">            host=app.config.get(<span class="string">"REDIS_%s_HOST"</span>%self.name),</div><div class="line">            port=app.config.get(<span class="string">"REDIS_%s_PORT"</span>%self.name),</div><div class="line">            db=app.config.get(<span class="string">"REDIS_%s_DB"</span>%self.name),</div><div class="line">            password=app.config.get(<span class="string">"REDIS_%s_PASSWORD"</span>%self.name),</div><div class="line">            socket_timeout=app.config.get(<span class="string">"REDIS_%s_TIMEOUT"</span>%self.name),</div><div class="line">            max_connections=app.config.get(<span class="string">"REDIS_%s_POOL_MAX"</span>%self.name),</div><div class="line">            timeout=app.config.get(<span class="string">"REDIS_%s_POOL_MAXWAIT"</span>%self.name)</div><div class="line">        )</div><div class="line">        self.app = app</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_redis</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> redis.Redis(connection_pool=self._pool)</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, item)</span>:</span></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__call_with_retries</span><span class="params">(*args)</span>:</span></div><div class="line">            <span class="keyword">if</span> <span class="keyword">None</span> == self.app:</div><div class="line">                <span class="keyword">raise</span> Exception(<span class="string">'the redis client is not initial!'</span>)</div><div class="line"></div><div class="line">            retry = <span class="number">0</span></div><div class="line">            <span class="keyword">while</span> retry &lt; self.max_try:</div><div class="line">                <span class="keyword">try</span>:</div><div class="line">                  <span class="keyword">return</span> getattr(self.get_redis(), item)(*args)</div><div class="line">                <span class="keyword">except</span> socket.timeout, se:</div><div class="line">                  <span class="keyword">if</span> retry &lt; self.max_try:</div><div class="line">                    retry += <span class="number">1</span></div><div class="line">                  <span class="keyword">else</span>:</div><div class="line">                    <span class="keyword">raise</span> se</div><div class="line"></div><div class="line">        <span class="keyword">return</span> __call_with_retries</div></pre></td></tr></table></figure>
<p>调用时候，判断是否命中即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> redis.exists(redis_key) <span class="keyword">and</span> <span class="keyword">not</span> force_refresh:</div><div class="line">   <span class="keyword">return</span> redis.get(redis_key)</div><div class="line"><span class="keyword">else</span>:</div><div class="line">   str_tile_data = download_tilemap_file(lang, tile_x, tile_y, zoom)</div><div class="line">   ex_dt = timedelta(days=<span class="number">60</span>)</div><div class="line">   redis.set(redis_key, str_tile_data, ex_dt)</div><div class="line">   <span class="keyword">return</span> str_tile_data</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/30/安卓蓝牙模块踩坑集合/" itemprop="url">
                  安卓蓝牙模块踩坑集合
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2016-08-30T14:31:40+08:00" content="2016-08-30">
              2016-08-30
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="安卓蓝牙模块踩坑集合"><a href="#安卓蓝牙模块踩坑集合" class="headerlink" title="安卓蓝牙模块踩坑集合"></a>安卓蓝牙模块踩坑集合</h1><h2 id="对特定的设备进行搜索"><a href="#对特定的设备进行搜索" class="headerlink" title="对特定的设备进行搜索"></a>对特定的设备进行搜索</h2><p>API <figure class="highlight plain"><figcaption><span>BluetoothAdapter.LeScanCallback) ```是安卓系统特地提供出来对特定的设备进行搜索的，官方API说明</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">``` If you want to scan for only specific types of peripherals, you can instead call startLeScan(UUID[], BluetoothAdapter.LeScanCallback), providing an array of UUID objects that specify the GATT services your app supports.</div></pre></td></tr></table></figure></p>
<p>故事听起来都是美好的，实际上，人生很艰难</p>
<ul>
<li>先是这个API设计的很有问题，他 <code>UUID[]</code>是并集而不是合集，就是说，我只能搜一个设备同时兼备两个UUID，而不是这两个UUID的设备都进行搜索，这点iOS API设计就合理很多了。</li>
<li>然后是，这个API在安卓4.3 4.4压根不支持，这就是最坑爹的人，折腾了半天，最后不支持！</li>
</ul>
<h2 id="搜索的回调"><a href="#搜索的回调" class="headerlink" title="搜索的回调"></a>搜索的回调</h2><p>这点倒不算坑，就是要注意的地方<code>BluetoothAdapter.LeScanCallback.onLeScan()</code> 为搜索结果的回调，该方法尽可能尽快把负责的过滤、判断抛到其他线程去做，尽快将回调调用返回了。</p>
<h2 id="同时只能对一个设备进行连接"><a href="#同时只能对一个设备进行连接" class="headerlink" title="同时只能对一个设备进行连接"></a>同时只能对一个设备进行连接</h2><p><code>BluetoothDevice.connectGatt()</code>方法要控制好，不能同时对多个设备进行连接，这点也就不能像iOS那样，进行预连接的根源坑。</p>
<p>如果连接失败了（例如出错，或者连接超时失败），要马上调用 BluetoothGatt.disconnect() 来释放建立连接请求，然后处理下一个设备连接请求，否则就等133出现！</p>
<h2 id="对于属性的操作，同时只能有一个"><a href="#对于属性的操作，同时只能有一个" class="headerlink" title="对于属性的操作，同时只能有一个"></a>对于属性的操作，同时只能有一个</h2><p>不管是<code>writeCharacteristic()</code>写数据，还是设置notify，都是异步的，同时只能有一个，否则可能串线，或者丢失。所以，一定要在上一个写成功的回调后才能进行下一个操作，就这样，还有可能会出现该问题，所以在一些有可能要同时操作的地方，我是等收到了数据才进行下一个操作。比如连接上Podoon鞋垫后要进行时间校正、读版本号、读批次号、读协议栈，就是在前一个notify数据后，才执行下一个，另外特地做了一个Timer循环的去检查。</p>
<h2 id="搜索、连接、断开连接最好放在主线程"><a href="#搜索、连接、断开连接最好放在主线程" class="headerlink" title="搜索、连接、断开连接最好放在主线程"></a>搜索、连接、断开连接最好放在主线程</h2><p>这点看文档看到的，具体有没有效果不清楚，SDK是创建一个 <code>new Handler(context.getMainLooper());</code> ，把消息发送到这个 Handler 中。</p>
<h2 id="连接过程很耗电，尽量时间短"><a href="#连接过程很耗电，尽量时间短" class="headerlink" title="连接过程很耗电，尽量时间短"></a>连接过程很耗电，尽量时间短</h2><p>对BLE设备连接，连接过程要尽量短，如果连接不上，不要盲目进行重连，否这你的电池会很快被消耗掉</p>
<h2 id="作为中心设备，最多只能同时连6（不是非常确定，但是是有限的）个BLE设备"><a href="#作为中心设备，最多只能同时连6（不是非常确定，但是是有限的）个BLE设备" class="headerlink" title="作为中心设备，最多只能同时连6（不是非常确定，但是是有限的）个BLE设备"></a>作为中心设备，最多只能同时连6（不是非常确定，但是是有限的）个BLE设备</h2><p>超过了就很可能会连接失败。如果连接后资源未被释放，也会记做连接的设备进行计算。</p>
<h2 id="资源未被释放导致133问题"><a href="#资源未被释放导致133问题" class="headerlink" title="资源未被释放导致133问题"></a>资源未被释放导致133问题</h2><p>连接蓝牙设备后，在断开时候尽可能对其进行close操作，否则就有可能因为资源未释放干净又连接同一个设备出现133的错误</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/06/07/2016-06-07-dockercong-0dao-1de-bi-ji/" itemprop="url">
                  Docker从0到1的笔记
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2016-06-07T14:25:06+08:00" content="2016-06-07">
              2016-06-07
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Docker从0到1的笔记"><a href="#Docker从0到1的笔记" class="headerlink" title="Docker从0到1的笔记"></a>Docker从0到1的笔记</h1><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="https支持及GPG-key添加"><a href="#https支持及GPG-key添加" class="headerlink" title="https支持及GPG key添加"></a>https支持及GPG key添加</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ sudo apt-get update</div><div class="line">$ sudo apt-get install apt-transport-https ca-certificates</div><div class="line">$ sudo apt-key adv --keyserver hkp://p80.pool.sks-keyservers.net:80 --recv-keys 58118E89F3A912897C070ADBF76221572C52609D</div></pre></td></tr></table></figure>
<h3 id="设置docker镜像源"><a href="#设置docker镜像源" class="headerlink" title="设置docker镜像源"></a>设置docker镜像源</h3><p>编辑<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure></p>
<p>deb <a href="https://apt.dockerproject.org/repo" target="_blank" rel="external">https://apt.dockerproject.org/repo</a> ubuntu-trusty main<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">### 旧版本的清理及验证</div><div class="line"></div><div class="line">```bash</div><div class="line">$ sudo apt-get update</div><div class="line">$ sudo apt-get purge lxc-docker</div><div class="line">$ apt-cache policy docker-engine</div></pre></td></tr></table></figure></p>
<h3 id="添加内核包"><a href="#添加内核包" class="headerlink" title="添加内核包"></a>添加内核包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ sudo apt-get update</div><div class="line">$ sudo apt-get install linux-image-extra-$(uname -r)</div><div class="line">$ sudo apt-get install apparmor</div></pre></td></tr></table></figure>
<h3 id="安装并启动docker"><a href="#安装并启动docker" class="headerlink" title="安装并启动docker"></a>安装并启动docker</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ sudo apt-get update</div><div class="line">$ sudo apt-get install docker-engine</div><div class="line">$ sudo service docker start</div></pre></td></tr></table></figure>
<h3 id="验证docker已启动"><a href="#验证docker已启动" class="headerlink" title="验证docker已启动"></a>验证docker已启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo docker run hello-world</div></pre></td></tr></table></figure>
<h3 id="其他docker可选配置"><a href="#其他docker可选配置" class="headerlink" title="其他docker可选配置"></a>其他docker可选配置</h3><p>还一些docker配置，比如group这里就没做测试，只是单机上测试下简单的功能。</p>
<h2 id="使用案例nodejs-mysql"><a href="#使用案例nodejs-mysql" class="headerlink" title="使用案例nodejs+mysql"></a>使用案例nodejs+mysql</h2><h3 id="创建一个容器测试下"><a href="#创建一个容器测试下" class="headerlink" title="创建一个容器测试下"></a>创建一个容器测试下</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ docker run -it ubuntu</div></pre></td></tr></table></figure>
<ul>
<li>run创建容器</li>
<li>-it创建后会直接给生成的容器创建一个终端</li>
<li>ubuntu创建容器所使用的镜像</li>
</ul>
<p>可以在容器的终端上运行一下命令，查看容器的信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">root@719059da250d:/# lsb_release -a</div><div class="line">No LSB modules are available.</div><div class="line">Distributor ID:    Ubuntu</div><div class="line">Description:    Ubuntu 14.04.4 LTS</div><div class="line">Release:    14.04</div><div class="line">Codename:    trusty</div><div class="line">root@719059da250d:/# exit</div></pre></td></tr></table></figure>
<h3 id="开始案例吧，创建一个mysql的容器"><a href="#开始案例吧，创建一个mysql的容器" class="headerlink" title="开始案例吧，创建一个mysql的容器"></a>开始案例吧，创建一个mysql的容器</h3><p>创建一个文件夹test_database，文件夹结构为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">test_database\setup.sql</div><div class="line">test_database\start.sh</div><div class="line">test_database\stop.sh</div></pre></td></tr></table></figure>
<p>start.sh</p>
<figure class="highlight bash"><figcaption><span>start.sh</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line"></div><div class="line"><span class="comment"># Run the MySQL container, with a database named 'users' and credentials</span></div><div class="line"><span class="comment"># for a users-service user which can access it.</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"Starting DB..."</span></div><div class="line">docker run --name db -d \</div><div class="line"> -e MYSQL_ROOT_PASSWORD=123 \</div><div class="line"> -e MYSQL_DATABASE=users -e MYSQL_USER=users_service -e MYSQL_PASSWORD=123 \</div><div class="line"> -p 3306:3306 mysql:latest</div><div class="line"></div><div class="line"><span class="comment"># Wait for the database service to start up.</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"Waiting for DB to start up..."</span></div><div class="line">docker <span class="built_in">exec</span> db mysqladmin --silent --<span class="built_in">wait</span>=30 -uusers_service -p123 ping || <span class="built_in">exit</span> 1</div><div class="line"></div><div class="line"><span class="comment"># Run the setup script.</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"Setting up initial data..."</span></div><div class="line">docker <span class="built_in">exec</span> -i db mysql -uusers_service -p123 users &lt; setup.sql</div></pre></td></tr></table></figure>
<ul>
<li>–name db 给容器命名</li>
<li>-d 在后台运行</li>
<li>-e 环境变量</li>
<li>-p 端口映射，即宿主机上的3306端口会映射到容器的3306端口上</li>
<li>mysql:latest 最新版本的mysql</li>
</ul>
<p>stop.sh</p>
<figure class="highlight bash"><figcaption><span>stop.sh</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line"></div><div class="line"><span class="comment"># Stop the db and remove the container.</span></div><div class="line">docker stop db &amp;&amp; docker rm db</div></pre></td></tr></table></figure>
<ul>
<li>stop 停止容器</li>
<li>rm 删除容器</li>
</ul>
<p>setup.sql</p>
<figure class="highlight sql"><figcaption><span>setup.sql</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">directory</span> (user_id <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT PRIMARY <span class="keyword">KEY</span>, email <span class="built_in">TEXT</span>, phone_number <span class="built_in">TEXT</span>);</div><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">directory</span> (email, phone_number) <span class="keyword">values</span> (<span class="string">'homer@thesimpsons.com'</span>, <span class="string">'+1 888 123 1111'</span>);</div><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">directory</span> (email, phone_number) <span class="keyword">values</span> (<span class="string">'marge@thesimpsons.com'</span>, <span class="string">'+1 888 123 1112'</span>);</div><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">directory</span> (email, phone_number) <span class="keyword">values</span> (<span class="string">'maggie@thesimpsons.com'</span>, <span class="string">'+1 888 123 1113'</span>);</div><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">directory</span> (email, phone_number) <span class="keyword">values</span> (<span class="string">'lisa@thesimpsons.com'</span>, <span class="string">'+1 888 123 1114'</span>);</div><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">directory</span> (email, phone_number) <span class="keyword">values</span> (<span class="string">'bart@thesimpsons.com'</span>, <span class="string">'+1 888 123 1115'</span>);</div></pre></td></tr></table></figure>
<p>然后直接执行start.sh即可，不用的时候直接执行stop.sh。</p>
<h3 id="构建nodejs-服务端代码"><a href="#构建nodejs-服务端代码" class="headerlink" title="构建nodejs 服务端代码"></a>构建nodejs 服务端代码</h3><p>创建文件夹users-service，然后 <figure class="highlight plain"><figcaption><span>clone</span><a href="https://github.com/yuezaixz/nodejs-in-docker.git```" target="_blank" rel="external">link</a></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">可以先执行```npm start```来测试是否可以运行，如果在浏览器中可以正常访问```localhost:8123/users```，那么就说明代码没问题了。</div><div class="line"></div><div class="line">### 项目中的docker容器配置文件</div><div class="line">在users-service目录中已经有了一个文件Dockerfile,内容为</div></pre></td></tr></table></figure></p>
<h1 id="Use-Node-v4-as-the-base-image"><a href="#Use-Node-v4-as-the-base-image" class="headerlink" title="Use Node v4 as the base image."></a>Use Node v4 as the base image.</h1><p>FROM node:4</p>
<h1 id="Add-everything-in-the-current-directory-to-our-image-in-the-‘app’-folder"><a href="#Add-everything-in-the-current-directory-to-our-image-in-the-‘app’-folder" class="headerlink" title="Add everything in the current directory to our image, in the ‘app’ folder."></a>Add everything in the current directory to our image, in the ‘app’ folder.</h1><p>ADD . /app</p>
<h1 id="Install-dependencies"><a href="#Install-dependencies" class="headerlink" title="Install dependencies"></a>Install dependencies</h1><p>RUN cd /app; \<br>    npm install –production</p>
<h1 id="Expose-our-server-port"><a href="#Expose-our-server-port" class="headerlink" title="Expose our server port."></a>Expose our server port.</h1><p>EXPOSE 8123</p>
<h1 id="Run-our-app"><a href="#Run-our-app" class="headerlink" title="Run our app."></a>Run our app.</h1><p>CMD [“node”, “/app/index.js”]<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">* FROM node:4 用node4作为容器的景象</div><div class="line">* ADD . /app 把当前目录的所有文件都映射为容器中/app文件夹下的内容</div><div class="line">* RUN cd /app; npm install --production 运行容器时候，执行命令，添加项目所需要的依赖</div><div class="line">* EXPOSE 8123 输出端口</div><div class="line">* CMD [&quot;node&quot;, &quot;/app/index.js&quot;] 应用启动命令</div><div class="line"></div><div class="line">### 运行nodejs的docker容器</div><div class="line">在users-service路径下运行以下命令来启动容器</div><div class="line"></div><div class="line">```bash</div><div class="line">$ docker build -t users-service .</div><div class="line">$ docker run -it -p 8123:8123 users-service</div></pre></td></tr></table></figure></p>
<ul>
<li>docker build -t users-service .  根据当前目录的Dockerfile文件在创建容器users-service</li>
</ul>
<h3 id="容器与容器的依赖"><a href="#容器与容器的依赖" class="headerlink" title="容器与容器的依赖"></a>容器与容器的依赖</h3><p>运行上一段命令后会报错，因为当前容器依赖了宿主机上另一个mysql容器，nodejs容器访问容器种的3306端口无法访问到另一台容器的mysql容器。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">--- Customer Service---</div><div class="line">Connecting to customer repository...</div><div class="line">Connected. Starting server...</div><div class="line">Server started successfully, running on port 8123.</div><div class="line">GET /users 500 23.958 ms - 582</div><div class="line">Error: An error occured getting the users: Error: connect ECONNREFUSED 127.0.0.1:3306</div><div class="line">    at Query._callback (/app/repository/repository.js:21:25)</div><div class="line">    at Query.Sequence.end (/app/node_modules/mysql/lib/protocol/sequences/Sequence.js:96:24)</div><div class="line">    at /app/node_modules/mysql/lib/protocol/Protocol.js:399:18</div><div class="line">    at Array.forEach (native)</div><div class="line">    at /app/node_modules/mysql/lib/protocol/Protocol.js:398:13</div><div class="line">    at nextTickCallbackWith0Args (node.js:420:9)</div><div class="line">    at process._tickCallback (node.js:349:13)</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES</div><div class="line">ebcae11742af        users-service       &quot;node /app/index.js&quot;     2 days ago          Up 2 days           0.0.0.0:8123-&gt;8123/tcp   fervent_hopper</div><div class="line">0e6e2bacafa2        mysql:latest        &quot;docker-entrypoint.sh&quot;   2 days ago          Up 2 days           0.0.0.0:3306-&gt;3306/tcp   db</div></pre></td></tr></table></figure>
<p>那么就需要让nodejs容器依赖mysql容器。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -it -p 8123:8123 --link db:db -e DATABASE_HOST=DB users-service</div></pre></td></tr></table></figure>
<ul>
<li>link db:db 连接到容器名为db的容器，把他引用为db</li>
<li>-e DATABASE_HOST=db 设置环境变量</li>
</ul>
<p>查看config.js的代码可以发现，服务端代码配置数据源的方式是 <figure class="highlight plain"><figcaption><span>|| '127.0.0.1'```存在环境变量DATABASE_HOST的时候使用该环境变量</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure></p>
<p>//  config.js<br>//<br>//  Simple application configuration. Extend as needed.<br>module.exports = {<br>    port: process.env.PORT || 8123,<br>  db: {<br>    host: process.env.DATABASE_HOST || ‘127.0.0.1’,<br>    database: ‘users’,<br>    user: ‘users_service’,<br>    password: ‘123’,<br>    port: 3306<br>  }<br>};</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">从下面可以看出，存在一个172.17.0.2，名为db的依赖。</div></pre></td></tr></table></figure>
<p>ubuntu@VM-79-113-ubuntu:~/users-service$ sudo docker exec fervent_hopper cat /etc/hosts<br>127.0.0.1    localhost<br>::1    localhost ip6-localhost ip6-loopback<br>fe00::0    ip6-localnet<br>ff00::0    ip6-mcastprefix<br>ff02::1    ip6-allnodes<br>ff02::2    ip6-allrouters<br>172.17.0.2    db 0e6e2bacafa2<br>172.17.0.3    ebcae11742af<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">再从下面可以看出，DATABASE_HOST指向的就是这个名为db的依赖</div></pre></td></tr></table></figure></p>
<p>ubuntu@VM-79-113-ubuntu:~/users-service$ sudo docker exec fervent_hopper printenv | grep DB<br>DB_PORT=tcp://172.17.0.2:3306<br>DB_PORT_3306_TCP=tcp://172.17.0.2:3306<br>DB_PORT_3306_TCP_ADDR=172.17.0.2<br>DB_PORT_3306_TCP_PORT=3306<br>DB_PORT_3306_TCP_PROTO=tcp<br>DB_NAME=/fervent_hopper/db<br>DB_ENV_MYSQL_ROOT_PASSWORD=123<br>DB_ENV_MYSQL_DATABASE=users<br>DB_ENV_MYSQL_USER=users_service<br>DB_ENV_MYSQL_PASSWORD=123<br>DB_ENV_GOSU_VERSION=1.7<br>DB_ENV_MYSQL_MAJOR=5.7<br>DB_ENV_MYSQL_VERSION=5.7.12-1debian8<br>DATABASE_HOST=DB<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">现在可以在浏览器中试试可以不可以正常访问```localhost:8123/users```，可以的话说明配置没问题了。</div><div class="line"></div><div class="line">## python flask框架的案例</div><div class="line">由于依赖的是外部数据库，所以很简单，只要定义好Docker文件即可。</div></pre></td></tr></table></figure></p>
<p>FROM ubuntu:latest<br>MAINTAINER David Woo “xiao303178394@gmail.com”<br>RUN apt-get update -y<br>RUN apt-get install -y python-pip python-dev build-essential<br>COPY . /app<br>WORKDIR /app<br>RUN pip install -r etc/reqs-dev.txt<br>ENTRYPOINT [“python”]<br>CMD [“manager.py”,”runserver”]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">构建镜像</div></pre></td></tr></table></figure>
<p>sudo docker build -t paodong-mng:latest .<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">运行容器</div></pre></td></tr></table></figure></p>
<p>sudo docker run -d -p 80:8558 paodong-mng<br>```</p>
<h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><ul>
<li>run创建容器</li>
<li>-it创建后会直接给生成的容器创建一个终端</li>
<li>–name db 给容器命名</li>
<li>-d 在后台运行</li>
<li>-e 环境变量</li>
<li>-t mysql 创建tag为mysql的容器</li>
<li>-p 端口映射，即宿主机上的3306端口会映射到容器的3306端口上</li>
<li>mysql:latest 最新版本的mysql</li>
<li>ps 查看所有容器</li>
<li>docker exec -it db /bin/bash 在容器db上执行终端，用bash执行</li>
</ul>
<h2 id="参阅"><a href="#参阅" class="headerlink" title="参阅"></a>参阅</h2><ul>
<li><a href="http://www.dwmkerr.com/learn-docker-by-building-a-microservice/" target="_blank" rel="external">Learn Docker by building a Microservice</a></li>
<li><a href="https://docs.docker.com/engine/installation/linux/ubuntulinux/" target="_blank" rel="external">Installation on ubuntu</a></li>
<li><a href="http://containertutorials.com/docker-compose/flask-simple-app.html" target="_blank" rel="external">Dockerize Simple Flask App</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/07/13/2015-07-13-beginning-ios-pit-over-those-years-i/" itemprop="url">
                  初学IOS那些年踩过的坑（十）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2015-07-13T16:01:53+08:00" content="2015-07-13">
              2015-07-13
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="页面间pop和push导致的问题"><a href="#页面间pop和push导致的问题" class="headerlink" title="页面间pop和push导致的问题"></a>页面间pop和push导致的问题</h2><p>问题描述：问题大概是这样，一个运动中页面RunningViewController，一个首页IndexViewController，一个结果页RunResultViewController<br>运动：IndexViewController–Push–&gt;RunningViewController<br>结束：RunningViewController –Pop–&gt;IndexViewController–push–&gt;</p>
<p>结果IndexViewController的ViewWillAppear会弹出个UIAlertView，其逻辑会造成影响，在IOS8情况下UIAlertView不会弹出（应该是弹出后立马跳到了RunResultViewController），而IOS7情况下到RunResultViewController才弹出该UIAlertView。</p>
<p>该问题很简单，该逻辑其实放错位置了，应该放在ViewDidLoad中，但是从UIAlertView造成的错误逻辑去排查到该问题比较麻烦。</p>
<h2 id="TableView的load时机"><a href="#TableView的load时机" class="headerlink" title="TableView的load时机"></a>TableView的load时机</h2><p>问题描述：在使用FXForm做表单时候，在viewDidLoad中进行了初始化，但是初始化内容无效（同样也是排查比较麻烦，开始没怀疑这个问题）。IOS8是在ViewWillAppear之后（除非你调用了tableView.tableFooterView = … 之类方法，调用后）再进行loadView的操作，而IOS7则是在[super viewDidLoad]之后。最安全的做法就是在ViewWillAppear之后重新调用一次 [tableView reloadData];</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/06/29/2015-06-29-beginning-ios-pit-over-those-years-h/" itemprop="url">
                  初学IOS那些年踩过的坑（九）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2015-06-29T11:25:10+08:00" content="2015-06-29">
              2015-06-29
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="如何让小图片按钮的点击区域变大"><a href="#如何让小图片按钮的点击区域变大" class="headerlink" title="如何让小图片按钮的点击区域变大"></a>如何让小图片按钮的点击区域变大</h2><p>之前经常做的事情就是，用个imageView来放图片，然后用一个更大透明UIButton盖住他，这样有个问题就是，一旦按钮需要有点击高亮效果，就会很麻烦的（各种点击和释放的回调，然后去修改imageView的图片）。</p>
<p>最近发现了个方法，可以用setContentEdgeInsets来设置Button内容的区域。注意，top、bottom等，都是与其距离，比如bottom，就是与底部距离。开始我以为是从(left,top)到(right,bottom)这两个点的范围做图片的位置，然后导致无法得到想要的效果。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//[self.runBtn setContentEdgeInsets:UIEdgeInsetsMake(&lt;#CGFloat top#&gt;, &lt;#CGFloat left#&gt;, &lt;#CGFloat bottom#&gt;, &lt;#CGFloat right#&gt;)];</span></div><div class="line">[<span class="keyword">self</span>.runBtn setContentEdgeInsets:<span class="built_in">UIEdgeInsetsMake</span>(<span class="number">8</span>, <span class="number">18</span>, <span class="number">8</span>, <span class="number">18</span>)];</div></pre></td></tr></table></figure>
<h2 id="view没有设置backgroundColor，setNeedsDisplay后触发drawRect，会导致重复绘制"><a href="#view没有设置backgroundColor，setNeedsDisplay后触发drawRect，会导致重复绘制" class="headerlink" title="view没有设置backgroundColor，setNeedsDisplay后触发drawRect，会导致重复绘制"></a>view没有设置backgroundColor，setNeedsDisplay后触发drawRect，会导致重复绘制</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">-(<span class="keyword">void</span>)drawRect:(<span class="built_in">CGRect</span>)rect&#123;</div><div class="line"><span class="comment">//….</span></div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">-(<span class="keyword">void</span>)touchesMoved:(<span class="built_in">NSSet</span> *)touches withEvent:(<span class="built_in">UIEvent</span> *)event&#123;</div><div class="line"><span class="comment">//….</span></div><div class="line">[<span class="keyword">self</span> setNeedsDisplay];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这时候drawRect中的内容会重复绘制，只要设置backgroundColor就不会重复绘制了。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">lineChartView.backgroundColor = [<span class="built_in">UIColor</span> whiteColor];</div></pre></td></tr></table></figure></p>
<h2 id="ore-Data升级后导致数据升级失败"><a href="#ore-Data升级后导致数据升级失败" class="headerlink" title="ore-Data升级后导致数据升级失败"></a>ore-Data升级后导致数据升级失败</h2><p>用的是MagicRecord，AppDelegate代码中有初始化<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[MagicalRecord setupCoreDataStackWithAutoMigratingSqliteStoreNamed:SQLITE_NAME];</div><div class="line">[MagicalRecord shouldAutoCreateDefaultPersistentStoreCoordinator];</div><div class="line">[MagicalRecord setShouldDeleteStoreOnModelMismatch:<span class="literal">YES</span>];</div><div class="line">[MagicalRecord setupAutoMigratingCoreDataStack];<span class="comment">//这里报错</span></div></pre></td></tr></table></figure></p>
<p>报错内容为Can’t find or automatically infer mapping model for migration。</p>
<p>在SOF上找到了下文，具体原因不明，可能是添加版本时候有错误操作，这时候只要把版本先退回到上一个版本，然后删除新的版本，提交代码（不先提交SVN可能会出问题哦）。然后重新添加一次再提交就OK了。<br><a href="http://stackoverflow.com/questions/7708392/how-to-delete-an-old-unused-data-model-version-in-xcode-4" target="_blank" rel="external">参考</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/05/13/2015-05-13-running-and-being-reading-notes-a/" itemprop="url">
                  跑步圣经读书笔记（一）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2015-05-13T11:30:45+08:00" content="2015-05-13">
              2015-05-13
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="序——于嘉"><a href="#序——于嘉" class="headerlink" title="序——于嘉"></a>序——于嘉</h1><ul>
<li>跑步，没错——人一旦具备运动能力就会做的运动，完全渗透于我的生活中，让我时刻都能感受到它的魅力</li>
<li>我不承认跑步改变了我的生活，而是跑步成了我生活的一部分</li>
<li>这不正是生活在浮躁社会里、快节奏的生活中以及巨大压力之下的我们所迫切需要的吗？</li>
</ul>
<h1 id="序——安德鲁-希恩"><a href="#序——安德鲁-希恩" class="headerlink" title="序——安德鲁-希恩"></a>序——安德鲁-希恩</h1><ul>
<li>和他那一代的大部分人一样，大家毕业后就收起跑鞋，把全部精力奉献给工作和他的家庭（我：时代问题，美国日本都精力这段时期后开始注重运动，而我认为中国还处于这个时期，体育还未回归教育、运动精神尚难达全民，但是这几年貌似好转起来了，无数白领放弃睡懒觉开始晨跑、放弃夜店嗨开始夜跑）。</li>
</ul>
<h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><ul>
<li>跑步让这一切自然而然的发生了，创意必须是自发的，它不能被强迫，不能按照需求被生产出来。</li>
</ul>
<h1 id="第二章"><a href="#第二章" class="headerlink" title="第二章"></a>第二章</h1><ul>
<li>跑步开阔了我们的思维，把我们从每天模式化的活动或思考中挣脱出来，并重新安排我们的日常生活，比如用在吃饭、睡觉和其他休闲活动的时间。跑步不仅改变了我对工作和比赛的态度，改变了我对那些我欣赏的人和欣赏我的人的看法，还使我以一种全新的心态来体验生活——这种心态并非来源于外界，而来源于我的内心。</li>
<li>跑者们之所以选择跑步，并非他们身体单薄不适合打橄榄球，或者没有天赋打不出漂亮的冰球，而是他们真正喜欢上这项运动。跑步让人身体疲惫、肌肉酸疼，但这也不断地挑战着跑者身体的抗压能力，也正是这样的过程中，跑者充分发挥了自己的能力，并且做回真正的自己。</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="David Woo" />
          <p class="site-author-name" itemprop="name">David Woo</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/">
              <span class="site-state-item-count">107</span>
              <span class="site-state-item-name">Artikel</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">195</span>
                <span class="site-state-item-name">Kategorien</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">Tags</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">David Woo</span>
</div>

<div class="powered-by">
  Erstellt mit  <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  




  
  

  

  

  

</body>
</html>
