<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="大胃吴的闲话唠嗑">
<meta property="og:url" content="http://yoursite.com/page/8/index.html">
<meta property="og:site_name" content="大胃吴的闲话唠嗑">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="大胃吴的闲话唠嗑">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/page/8/"/>

  <title> 大胃吴的闲话唠嗑 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">大胃吴的闲话唠嗑</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">扯扯技术，唠唠闲话 交流email-xiao303178394@gmail.com</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-首页">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            menu.首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-文章">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            menu.文章
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/05/02/2014-05-02-python-version-of-fizzbuzzwhizz-a-the-first-night/" itemprop="url">
                  Python版FizzBuzzWhizz(一)--第一晚
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2014-05-02T13:35:00+08:00" content="2014-05-02">
              2014-05-02
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Python/设计/" itemprop="url" rel="index">
                    <span itemprop="name">设计</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Python/设计/fizzbuzzwhizz/" itemprop="url" rel="index">
                    <span itemprop="name">fizzbuzzwhizz</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#1 概述<br><a href="https://github.com/yuezaixz/fizzBuzzWhizz" target="_blank" rel="external">该项目github地址点这</a><br>ThoughtWorks这个被评为世界上最难面试的IT公司，最近搞了个“抛弃简历，用代码说话”的活动，其实就是出了一道题，让程序员们编码实现后发给他们。题目是英国小学生练习除法的一个游戏，比如100名学生玩这个游戏。游戏的规则是：</p>
<ul>
<li>你首先说出三个不同的特殊数，要求必须是个位数，比如3、5、7。</li>
<li>让所有学生拍成一队，然后按顺序报数。</li>
<li>学生报数时，如果所报数字是第一个特殊数（3）的倍数，那么不能说该数字，而要说Fizz；如果所报数字是第二个特殊数（5）的倍数，那么要说Buzz；如果所报数字是第三个特殊数（7）的倍数，那么要说Whizz。</li>
<li>学生报数时，如果所报数字同时是两个特殊数的倍数情况下，也要特殊处理，比如第一个特殊数和第二个特殊数的倍数，那么不能说该数字，而是要说FizzBuzz, 以此类推。如果同时是三个特殊数的倍数，那么要说FizzBuzzWhizz。</li>
<li>学生报数时，如果所报数字包含了第一个特殊数，那么也不能说该数字，而是要说相应的单词，比如本例中第一个特殊数是3，那么要报13的同学应该说Fizz。如果数字中包含了第一个特殊数，那么忽略规则3和规则4，比如要报35的同学只报Fizz，不报BuzzWhizz。</li>
</ul>
<p>现在，我们需要你完成一个程序来模拟这个游戏，它首先接受3个特殊数，然后输出100名学生应该报数的数或单词。比如，<br>输入 3,5,7 输出（片段）<br>1 2 Fizz 4 Buzz Fizz Whizz 8 Fizz Buzz 11 Fizz Fizz Whizz FizzBuzz 16 17 Fizz 19 Buzz … 一直到100<br>那3个单词我是完全不能理解，所以我稍微把题目改了下，改成了Ha Hei Ah。</p>
<p>#2 实现<br>这个题目我自己用Python、Java、node.js都实现了一次，Java主要是用责任链设计模式，Python则通过一行代码实现逻辑功能，node.js类似python。本文主要讲的是完成python的思路。</p>
<p>#3 分析</p>
<h2 id="3-1-可能的情况"><a href="#3-1-可能的情况" class="headerlink" title="3.1 可能的情况"></a>3.1 可能的情况</h2><p>首先分析，1-100之间有几种情况：</p>
<p>1) 数字中含有3。<br>2) 3的倍数，而不是5、7的倍数。<br>2) 5的倍数，而不是3、7的倍数。<br>2) 7的倍数，而不是3、5的倍数。<br>2) 既是3的倍数，又是5的倍数，但不是7的倍数。<br>2) 既是3的倍数，又是7的倍数，但不是5的倍数。<br>2) 既是5的倍数，又是7的倍数，但不是3的倍数。<br>2) 既是3的倍数，又是5的倍数，又是7的倍数。<br>3) 既不是3的倍数，又不是5的倍数，又不是7的倍数。</p>
<h2 id="3-2-条件间的关系"><a href="#3-2-条件间的关系" class="headerlink" title="3.2 条件间的关系"></a>3.2 条件间的关系</h2><p>数字代表优先级，数字相同表示同级别，且数字相同的情况不会同时出现。</p>
<h2 id="3-3-组合条件"><a href="#3-3-组合条件" class="headerlink" title="3.3 组合条件"></a>3.3 组合条件</h2><p>因此，我们可以把数字不同的条件用or连接，序号相同的用and连接。<br>比如这样：条件1 or (条件2  and 条件3 and 条件4……) or 条件10</p>
<h2 id="3-4-再思考"><a href="#3-4-再思考" class="headerlink" title="3.4 再思考"></a>3.4 再思考</h2><p>有没更好的方式呢？再想了下，条件2虽然情况很多种，输出无非是3个单词的集合，且顺序固定。那么我们把条件改一下。<br>条件1 or ( (输出Ha)  and (输出Hei)  and (输出Ah)) or 条件10<br>另外，想到python的一个特殊的语法 str[x:y:z]，大概就是用来截取字符串的，比如’abcdefg’[1:6:2]的输出会是bd。<br>那怎么用呢，比如’Ha’[0<em>2::]这样就是输出’Ha’[x</em>2::]就是输出空字符（x&gt;=1）。那么如果n能被3整除，那么n%3就为0。很好，Perfect！</p>
<p>#4 实现思路</p>
<h2 id="4-1-逻辑实现"><a href="#4-1-逻辑实现" class="headerlink" title="4.1 逻辑实现"></a>4.1 逻辑实现</h2><p>既然有了思路，那么先在python的shell里实现下<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">100</span>):</div><div class="line"><span class="keyword">print</span> (<span class="string">"Ha"</span> <span class="keyword">if</span> str(x).find(str(<span class="number">3</span>)) &gt;=<span class="number">0</span> <span class="keyword">else</span> <span class="string">''</span> ) <span class="keyword">or</span> <span class="string">"Ha"</span>[x%<span class="number">3</span>*<span class="number">2</span>::]+<span class="string">"Hei"</span>[x%<span class="number">5</span>*<span class="number">3</span>::] +<span class="string">"Ah"</span>[x%<span class="number">7</span>*<span class="number">2</span>::] <span class="keyword">or</span> x</div></pre></td></tr></table></figure></p>
<p>看下面的输出信息可以发现，很好，已经可以得到想要的结果了。（这中间当然还有一些Fix，一部到位那么是神人啊）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line">2</div><div class="line">Ha</div><div class="line">4</div><div class="line">Hei</div><div class="line">Ha</div><div class="line">Ah</div><div class="line">8</div><div class="line">Ha</div><div class="line">Hei</div><div class="line">11</div><div class="line">Ha</div><div class="line">Ha</div><div class="line">Ah</div><div class="line">HaHei</div><div class="line">16</div><div class="line">17</div><div class="line">Ha</div><div class="line">19</div><div class="line">Hei</div><div class="line">HaAh</div><div class="line">22</div><div class="line">Ha</div><div class="line">Ha</div><div class="line">Hei</div><div class="line">26</div><div class="line">Ha</div><div class="line">Ah</div><div class="line">29</div><div class="line">Ha</div><div class="line">Ha</div><div class="line">Ha</div><div class="line">……(省略)</div></pre></td></tr></table></figure>
<h2 id="4-2-性能和显示的优化"><a href="#4-2-性能和显示的优化" class="headerlink" title="4.2 性能和显示的优化"></a>4.2 性能和显示的优化</h2><p>这时候效果是达到了，但是没有优化,现在优化，改用xrange在数字量比较大的时候性能可以提升，判断含有3的代码也优化同后面形式一样，并加上原数字进行提示。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">1</span>,<span class="number">101</span>):</div><div class="line">        <span class="keyword">print</span> x,<span class="string">"Ha"</span>[<span class="number">0</span> <span class="keyword">if</span> str(x).find(str(num_a))&gt;<span class="number">-1</span> <span class="keyword">else</span> <span class="number">2</span>:] <span class="keyword">or</span> <span class="string">"Ha"</span>[x%num_a*<span class="number">2</span>::]+<span class="string">"Hei"</span>[x%num_b*<span class="number">3</span>::] +<span class="string">"Ah"</span>[x%num_c*<span class="number">2</span>::] <span class="keyword">or</span> x;</div></pre></td></tr></table></figure></p>
<p>这样改进下性能好了一些，而且提示信息更友好了。</p>
<h2 id="4-3-单元测试"><a href="#4-3-单元测试" class="headerlink" title="4.3 单元测试"></a>4.3 单元测试</h2><p>写模块前，用先写单元测试的方法可以更好的设计松耦合的函数方法。<br><figure class="highlight python"><figcaption><span>testHaHeiAh.py</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding:utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> unittest</div><div class="line"><span class="keyword">import</span> haHeiAh <span class="keyword">as</span> testClass</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">testHaHeiAh</span><span class="params">(unittest.TestCase)</span>:</span></div><div class="line">    <span class="comment">#初始化工作</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setUp</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line">    <span class="comment">#推出清理工作</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">tearDown</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">testHhaHandle</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="comment">#测试被第一个数（3）整除</span></div><div class="line">        self.assertEqual(testClass.hhaHandle(<span class="number">3</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">7</span>),’Ha’,<span class="string">'fail'</span>)</div><div class="line">        <span class="comment">#测试不被任何数整除，且不含有第一个数（3）</span></div><div class="line">        self.assertEqual(testClass.hhaHandle(<span class="number">4</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">7</span>),<span class="number">4</span>,<span class="string">'fail'</span>)</div><div class="line">        <span class="comment">#测试被第二个数（5）整除</span></div><div class="line">        self.assertEqual(testClass.hhaHandle(<span class="number">5</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">7</span>),’Hei’,<span class="string">'fail'</span>)</div><div class="line">        <span class="comment">#测试被第三个数（7）整除</span></div><div class="line">        self.assertEqual(testClass.hhaHandle(<span class="number">7</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">7</span>),’Ah’,<span class="string">'fail'</span>)</div><div class="line">        <span class="comment">#测试同时被两个数整除</span></div><div class="line">        self.assertEqual(testClass.hhaHandle(<span class="number">15</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">7</span>),’Ha’+’Hei’,<span class="string">'fail'</span>)</div><div class="line">        <span class="comment">#测试同时被三个数整除</span></div><div class="line">        self.assertEqual(testClass.hhaHandle(<span class="number">105</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">7</span>),’Ha’+’Hei’+’Ah’,<span class="string">'fail'</span>)</div><div class="line">        <span class="comment">#以下测试除3 5 7外别的数字组合</span></div><div class="line">        self.assertEqual(testClass.hhaHandle(<span class="number">16</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">9</span>),’Ha’,<span class="string">'fail'</span>)</div><div class="line">        self.assertEqual(testClass.hhaHandle(<span class="number">18</span>,<span class="number">3</span>,<span class="number">6</span>,<span class="number">9</span>),’Ha’+’Hei’+’Ah’,<span class="string">'fail'</span>)</div><div class="line">        self.assertEqual(testClass.hhaHandle(<span class="number">24</span>,<span class="number">3</span>,<span class="number">6</span>,<span class="number">8</span>),’Ha’+’Hei’+’Ah’,<span class="string">'fail'</span>)</div><div class="line">        self.assertEqual(testClass.hhaHandle(<span class="number">24</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>),’Ha’+’Hei’+’Ah’,<span class="string">'fail'</span>)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    unittest.main()</div></pre></td></tr></table></figure></p>
<p>现在运行单元测试结果当然是失败，因为这个方法都没有。</p>
<h2 id="4-4-整合成模块"><a href="#4-4-整合成模块" class="headerlink" title="4.4 整合成模块"></a>4.4 整合成模块</h2><p>上面的代码都还只是面向过程级别的，没有可复用性，那么我们就重构一下。<br>模块：<br><figure class="highlight python"><figcaption><span>haHeiAh.py</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">haHeiAh</span><span class="params">(num_a,num_b,num_c)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'the div num is '</span>,num_a,num_b,num_c;</div><div class="line">    <span class="keyword">return</span> [str(num) + <span class="string">":"</span> + str(hhaHandle(num,num_a,num_b,num_c)) <span class="keyword">for</span> num <span class="keyword">in</span> xrange(<span class="number">1</span>,<span class="number">101</span>)];</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hhaHandle</span><span class="params">(num,num_a,num_b,num_c)</span>:</span></div><div class="line">    <span class="keyword">return</span> <span class="string">"Ha"</span>[<span class="number">0</span> <span class="keyword">if</span> str(num).find(str(num_a))&gt;<span class="number">-1</span> <span class="keyword">else</span> <span class="number">2</span>:] <span class="keyword">or</span> <span class="string">"Ha"</span>[num%num_a*<span class="number">2</span>::]+<span class="string">"Hei"</span>[num%num_b*<span class="number">3</span>::] +<span class="string">"Ah"</span>[num%num_c*<span class="number">2</span>::] <span class="keyword">or</span> num;</div></pre></td></tr></table></figure></p>
<h2 id="4-5-执行单元测试"><a href="#4-5-执行单元测试" class="headerlink" title="4.5 执行单元测试"></a>4.5 执行单元测试</h2><p>写好模块接可以执行单元测试了，执行的过程会结合了很多Fix。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">[David@localhost haheiahx]$ python testHaHeiAh.py</div><div class="line">----------------------------------------------------------------------</div><div class="line">Ran 1 test in 0.000s</div><div class="line">OK</div></pre></td></tr></table></figure>
<h2 id="4-6-可运行测试入口来重构"><a href="#4-6-可运行测试入口来重构" class="headerlink" title="4.6 可运行测试入口来重构"></a>4.6 可运行测试入口来重构</h2><p>可运行测试方法：<br><figure class="highlight python"><figcaption><span>test.py</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">testHaHeiAh</span><span class="params">(p_a=<span class="number">3</span>,p_b=<span class="number">5</span>,p_c=<span class="number">7</span>)</span>:</span></div><div class="line">    moduleName = <span class="string">"haHeiAh"</span>;</div><div class="line">    methodName = <span class="string">"haHeiAh"</span>;</div><div class="line"></div><div class="line">    module = __import__(moduleName);</div><div class="line">    method = getattr(module,methodName);</div><div class="line">    <span class="keyword">print</span> method(p_a,p_b,p_c);</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    params = [int(x) <span class="keyword">for</span> x <span class="keyword">in</span> sys.argv[<span class="number">1</span>::] <span class="keyword">if</span> x.__len__() == <span class="number">1</span>];</div><div class="line">    testHaHeiAh() <span class="keyword">if</span> params.__len__() &lt; <span class="number">3</span> <span class="keyword">else</span> testHaHeiAh(params[<span class="number">0</span>],params[<span class="number">1</span>],params[<span class="number">2</span>]);</div></pre></td></tr></table></figure></p>
<p>这下代码好多了。而且3个特殊数字也可以通过用户自己来输入了。具体看下面操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">[David@localhost haheiah]$ python test.py</div><div class="line">the div num is  3 5 7</div><div class="line">[&apos;1:1&apos;, &apos;2:2&apos;, &apos;3:Ha&apos;, &apos;4:4&apos;, &apos;5:Hei&apos;, &apos;6:Ha&apos;, &apos;7:Ah&apos;, &apos;8:8&apos;, &apos;9:Ha&apos;, &apos;10:Hei&apos;, &apos;11:11&apos;, &apos;12:Ha&apos;, &apos;13:Ha&apos;, &apos;14:Ah&apos;, &apos;15:HaHei&apos;, &apos;16:16&apos;, &apos;17:17&apos;, &apos;18:Ha&apos;, &apos;19:19&apos;, &apos;20:Hei&apos;, &apos;21:HaAh&apos;, &apos;22:22&apos;, &apos;23:Ha&apos;, &apos;24:Ha&apos;, &apos;25:Hei&apos;, &apos;26:26&apos;, &apos;27:Ha&apos;, &apos;28:Ah&apos;, &apos;29:29&apos;, &apos;30:Ha&apos;, &apos;31:Ha&apos;, &apos;32:Ha&apos;, &apos;33:Ha&apos;, &apos;34:Ha&apos;, &apos;35:Ha&apos;, &apos;36:Ha&apos;, &apos;37:Ha&apos;, &apos;38:Ha&apos;, &apos;39:Ha&apos;, &apos;40:Hei&apos;, &apos;41:41&apos;, &apos;42:HaAh&apos;, &apos;43:Ha&apos;, &apos;44:44&apos;, &apos;45:HaHei&apos;, &apos;46:46&apos;, &apos;47:47&apos;, &apos;48:Ha&apos;, &apos;49:Ah&apos;, &apos;50:Hei&apos;, &apos;51:Ha&apos;, &apos;52:52&apos;, &apos;53:Ha&apos;, &apos;54:Ha&apos;, &apos;55:Hei&apos;, &apos;56:Ah&apos;, &apos;57:Ha&apos;, &apos;58:58&apos;, &apos;59:59&apos;, &apos;60:HaHei&apos;, &apos;61:61&apos;, &apos;62:62&apos;, &apos;63:Ha&apos;, &apos;64:64&apos;, &apos;65:Hei&apos;, &apos;66:Ha&apos;, &apos;67:67&apos;, &apos;68:68&apos;, &apos;69:Ha&apos;, &apos;70:HeiAh&apos;, &apos;71:71&apos;, &apos;72:Ha&apos;, &apos;73:Ha&apos;, &apos;74:74&apos;, &apos;75:HaHei&apos;, &apos;76:76&apos;, &apos;77:Ah&apos;, &apos;78:Ha&apos;, &apos;79:79&apos;, &apos;80:Hei&apos;, &apos;81:Ha&apos;, &apos;82:82&apos;, &apos;83:Ha&apos;, &apos;84:HaAh&apos;, &apos;85:Hei&apos;, &apos;86:86&apos;, &apos;87:Ha&apos;, &apos;88:88&apos;, &apos;89:89&apos;, &apos;90:HaHei&apos;, &apos;91:Ah&apos;, &apos;92:92&apos;, &apos;93:Ha&apos;, &apos;94:94&apos;, &apos;95:Hei&apos;, &apos;96:Ha&apos;, &apos;97:97&apos;, &apos;98:Ah&apos;, &apos;99:Ha&apos;, &apos;100:Hei&apos;]</div><div class="line">[David@localhost haheiah]$ python test.py 3 6 9</div><div class="line">the div num is  3 6 9</div><div class="line">[&apos;1:1&apos;, &apos;2:2&apos;, &apos;3:Ha&apos;, &apos;4:4&apos;, &apos;5:5&apos;, &apos;6:HaHei&apos;, &apos;7:7&apos;, &apos;8:8&apos;, &apos;9:HaAh&apos;, &apos;10:10&apos;, &apos;11:11&apos;, &apos;12:HaHei&apos;, &apos;13:Ha&apos;, &apos;14:14&apos;, &apos;15:Ha&apos;, &apos;16:16&apos;, &apos;17:17&apos;, &apos;18:HaHeiAh&apos;, &apos;19:19&apos;, &apos;20:20&apos;, &apos;21:Ha&apos;, &apos;22:22&apos;, &apos;23:Ha&apos;, &apos;24:HaHei&apos;, &apos;25:25&apos;, &apos;26:26&apos;, &apos;27:HaAh&apos;, &apos;28:28&apos;, &apos;29:29&apos;, &apos;30:Ha&apos;, &apos;31:Ha&apos;, &apos;32:Ha&apos;, &apos;33:Ha&apos;, &apos;34:Ha&apos;, &apos;35:Ha&apos;, &apos;36:Ha&apos;, &apos;37:Ha&apos;, &apos;38:Ha&apos;, &apos;39:Ha&apos;, &apos;40:40&apos;, &apos;41:41&apos;, &apos;42:HaHei&apos;, &apos;43:Ha&apos;, &apos;44:44&apos;, &apos;45:HaAh&apos;, &apos;46:46&apos;, &apos;47:47&apos;, &apos;48:HaHei&apos;, &apos;49:49&apos;, &apos;50:50&apos;, &apos;51:Ha&apos;, &apos;52:52&apos;, &apos;53:Ha&apos;, &apos;54:HaHeiAh&apos;, &apos;55:55&apos;, &apos;56:56&apos;, &apos;57:Ha&apos;, &apos;58:58&apos;, &apos;59:59&apos;, &apos;60:HaHei&apos;, &apos;61:61&apos;, &apos;62:62&apos;, &apos;63:Ha&apos;, &apos;64:64&apos;, &apos;65:65&apos;, &apos;66:HaHei&apos;, &apos;67:67&apos;, &apos;68:68&apos;, &apos;69:Ha&apos;, &apos;70:70&apos;, &apos;71:71&apos;, &apos;72:HaHeiAh&apos;, &apos;73:Ha&apos;, &apos;74:74&apos;, &apos;75:Ha&apos;, &apos;76:76&apos;, &apos;77:77&apos;, &apos;78:HaHei&apos;, &apos;79:79&apos;, &apos;80:80&apos;, &apos;81:HaAh&apos;, &apos;82:82&apos;, &apos;83:Ha&apos;, &apos;84:HaHei&apos;, &apos;85:85&apos;, &apos;86:86&apos;, &apos;87:Ha&apos;, &apos;88:88&apos;, &apos;89:89&apos;, &apos;90:HaHeiAh&apos;, &apos;91:91&apos;, &apos;92:92&apos;, &apos;93:Ha&apos;, &apos;94:94&apos;, &apos;95:95&apos;, &apos;96:HaHei&apos;, &apos;97:97&apos;, &apos;98:98&apos;, &apos;99:HaAh&apos;, &apos;100:100&apos;]</div></pre></td></tr></table></figure></p>
<p>#5 再思考<br>以上部分是在周二下班后完成的，做到那里也就洗洗睡了。隔天拿起程序不禁又看了下，发现了很多不足，在下一章节我将介绍下还有哪些改进的地方。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/05/01/2014-05-01-spring-framework-core-source-code-analysis-v-registration-resource/" itemprop="url">
                  Spring Framework的核心源码解读（五）-Resource注册
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2014-05-01T15:39:00+08:00" content="2014-05-01">
              2014-05-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/spring/" itemprop="url" rel="index">
                    <span itemprop="name">spring</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/spring/resource/" itemprop="url" rel="index">
                    <span itemprop="name">resource</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/spring/resource/IoC/" itemprop="url" rel="index">
                    <span itemprop="name">IoC</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/spring/resource/IoC/源码分析/" itemprop="url" rel="index">
                    <span itemprop="name">源码分析</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/spring/resource/IoC/源码分析/Resource注册/" itemprop="url" rel="index">
                    <span itemprop="name">Resource注册</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="4-3-Resource注册"><a href="#4-3-Resource注册" class="headerlink" title="4.3 Resource注册"></a>4.3 Resource注册</h2><p>到目前为止，我们已经准备好了Spring需要的数据结构BeanDefinition了，但此时这些数据还不能供IoC容器直接使用，需要在IoC容器中对这些BeanDefinition数据进行注册。<br>前面提到的BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry())调用就是进行BeanDefinition注册。<br><figure class="highlight java"><figcaption><span>BeanDefinitionReaderUtils.java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerBeanDefinition</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params">			BeanDefinitionHolder definitionHolder, BeanDefinitionRegistry registry)</span></span></div><div class="line"><span class="function">			<span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</div><div class="line">		String beanName = definitionHolder.getBeanName();</div><div class="line">		registry.registerBeanDefinition(beanName, definitionHolder.getBeanDefinition());</div><div class="line">		String[] aliases = definitionHolder.getAliases();</div><div class="line">		<span class="keyword">if</span> (aliases != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">for</span> (String aliase : aliases) &#123;</div><div class="line">				registry.registerAlias(beanName, aliase);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>这里又调用了registry.registerBeanDefinition(beanName, definitionHolder.getBeanDefinition())方法，我们这里的registry就是DefaultListableBeanFactory，他实现了BeanDefinitionRegistry接口的该方法。DefaultListableBeanFactory类中通过一个HashMap来持有载入的BeanDefinition的。<br><figure class="highlight java"><figcaption><span>DefaultListableBeanFactory.java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, BeanDefinitionbeanDefinitionMap = <span class="keyword">new</span> ConcurrentHashMap&lt;String, BeanDefinition&gt;();</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> List&lt;StringbeanDefinitionNames = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line"><span class="comment">//…</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinition</span><span class="params">(String beanName, BeanDefinition beanDefinition)</span></span></div><div class="line"><span class="function">			<span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</div><div class="line"></div><div class="line">		Assert.hasText(beanName, <span class="string">"Bean name must not be empty"</span>);</div><div class="line">		Assert.notNull(beanDefinition, <span class="string">"BeanDefinition must not be null"</span>);</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (beanDefinition <span class="keyword">instanceof</span> AbstractBeanDefinition) &#123;</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				((AbstractBeanDefinition) beanDefinition).validate();</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">catch</span> (BeanDefinitionValidationException ex) &#123;</div><div class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(beanDefinition.getResourceDescription(), beanName,</div><div class="line">						<span class="string">"Validation of bean definition failed"</span>, ex);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">//注册的过程需要synchronized，保证数据的一致性</span></div><div class="line">		<span class="keyword">synchronized</span> (<span class="keyword">this</span>.beanDefinitionMap) &#123;</div><div class="line">		    <span class="comment">//这里检查是不是有相同名字的BeanDefinition已经在IoC容器中注册了，如果有相同名字的</span></div><div class="line">		    <span class="comment">//BeanDefinition，但又不允许覆盖，那么会抛出异常</span></div><div class="line">			Object oldBeanDefinition = <span class="keyword">this</span>.beanDefinitionMap.get(beanName);</div><div class="line">			<span class="keyword">if</span> (oldBeanDefinition != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">if</span> (!<span class="keyword">this</span>.allowBeanDefinitionOverriding) &#123;</div><div class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(beanDefinition.getResourceDescription(), beanName,</div><div class="line">							<span class="string">"Cannot register bean definition ["</span> + beanDefinition + <span class="string">"] for bean '"</span> + beanName +</div><div class="line">							<span class="string">"': There is already ["</span> + oldBeanDefinition + <span class="string">"] bound."</span>);</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">else</span> &#123;</div><div class="line"><span class="comment">//如果遇到同名的BeanDefinition，但配置了allowBeanDefinitionOverriding，则覆盖</span></div><div class="line">					<span class="keyword">if</span> (<span class="keyword">this</span>.logger.isInfoEnabled()) &#123;</div><div class="line">						<span class="keyword">this</span>.logger.info(<span class="string">"Overriding bean definition for bean '"</span> + beanName +</div><div class="line">								<span class="string">"': replacing ["</span> + oldBeanDefinition + <span class="string">"] with ["</span> + beanDefinition + <span class="string">"]"</span>);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="comment">//这是正常注册BeanDefinition的过程，把Bean的名字存入到beanDefinitionNames的同时，把</span></div><div class="line">			<span class="comment">//beanName作为Map的key,把beanDefinition作为value存入到IoC容器持有的beanDefinitionMap中去</span></div><div class="line">			<span class="keyword">else</span> &#123;</div><div class="line">				<span class="keyword">this</span>.beanDefinitionNames.add(beanName);</div><div class="line">				<span class="keyword">this</span>.frozenBeanDefinitionNames = <span class="keyword">null</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</div><div class="line"></div><div class="line">			resetBeanDefinition(beanName);</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>完成了BeanDefinition的注册，就完成了IoC容器的整个初始化过程。依赖注入并不输入IoC容器的初始化过程。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/05/01/2014-05-01-spring-framework-core-source-code-analysis-iv-resource-load/" itemprop="url">
                  Spring Framework的核心源码解读（四）-Resource加载
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2014-05-01T15:37:00+08:00" content="2014-05-01">
              2014-05-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/spring/" itemprop="url" rel="index">
                    <span itemprop="name">spring</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/spring/resource/" itemprop="url" rel="index">
                    <span itemprop="name">resource</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/spring/resource/IoC/" itemprop="url" rel="index">
                    <span itemprop="name">IoC</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/spring/resource/IoC/源码分析/" itemprop="url" rel="index">
                    <span itemprop="name">源码分析</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/spring/resource/IoC/源码分析/Resource加载/" itemprop="url" rel="index">
                    <span itemprop="name">Resource加载</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="4-2-Resource载入"><a href="#4-2-Resource载入" class="headerlink" title="4.2 Resource载入"></a>4.2 Resource载入</h2><p>载入过程其实就是把通过配置文件、注解等方式定义的数据转换成IoC容器所需要的数据结构BeanDefinition。IoC容器对Bean的管理和依赖注入功能的实现，是通过对其持有的BeanDefinition进行各种相关操作来完成的。这些BeanDefinition数据在IoC容器中通过一个HashMap来保持和维护。如果有需要，你也可以换成别的方式对数据进行保持和维护。<br>上一章节我已经讲到了Resource的定位，这里已经返回了ServletContextResource，这里接着立马调用loadBeanDefinitions(resources)进行Resource的载入。<br><figure class="highlight java"><figcaption><span>XmlBeanDefinitionReader.java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">loadBeanDefinitions</span><span class="params">(String location, Set&lt;ResourceactualResources)</span> <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</div><div class="line">		ResourceLoader resourceLoader = getResourceLoader();</div><div class="line">		<span class="keyword">if</span> (resourceLoader == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">//……异常，省略</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (resourceLoader <span class="keyword">instanceof</span> ResourcePatternResolver) &#123;</div><div class="line">			<span class="comment">//……这里很少用的，直接跳过</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">// 通过调用DefaultResourceLoader的getResources完成具体的Resource定位</span></div><div class="line">			Resource resource = resourceLoader.getResource(location);</div><div class="line">			<span class="comment">//Resource的载入</span></div><div class="line">			<span class="keyword">int</span> loadCount = **loadBeanDefinitions** (resource);</div><div class="line">			<span class="keyword">if</span> (actualResources != <span class="keyword">null</span>) &#123;</div><div class="line">				actualResources.add(resource);</div><div class="line">			&#125;</div><div class="line">			<span class="comment">//……省略部分代码</span></div><div class="line">			<span class="keyword">return</span> loadCount;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">loadBeanDefinitions</span><span class="params">(Resource... resources)</span> <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</div><div class="line">		Assert.notNull(resources, <span class="string">"Resource array must not be null"</span>);</div><div class="line">		<span class="keyword">int</span> counter = <span class="number">0</span>;</div><div class="line">		<span class="keyword">for</span> (Resource resource : resources) &#123;</div><div class="line">			<span class="comment">//钩子方法</span></div><div class="line">			counter += loadBeanDefinitions(resource);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> counter;</div><div class="line">	&#125;</div><div class="line">上列代码的loadBeanDefinitions(resource)是钩子方法，是通过子类实现的，这里我们直接跳到XmlBeanDefinitionReader类去看看具体实现</div><div class="line">```java XmlBeanDefinitionReader.java</div><div class="line"><span class="comment">//这里是调用的入口</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">loadBeanDefinitions</span><span class="params">(Resource resource)</span> <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</div><div class="line">		<span class="keyword">return</span> loadBeanDefinitions(<span class="keyword">new</span> EncodedResource(resource));</div><div class="line">	&#125;</div><div class="line"><span class="comment">//这里是载入XML形式的BeanDefinition的地方</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">loadBeanDefinitions</span><span class="params">(EncodedResource encodedResource)</span> <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</div><div class="line">	<span class="comment">//……省略部分日志代码，前置监测等</span></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line"><span class="comment">//这里是载入XML形式的BeanDefinition的地方</span></div><div class="line">			InputStream inputStream = encodedResource.getResource().getInputStream();</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				InputSource inputSource = <span class="keyword">new</span> InputSource(inputStream);</div><div class="line">				<span class="keyword">if</span> (encodedResource.getEncoding() != <span class="keyword">null</span>) &#123;</div><div class="line">					inputSource.setEncoding(encodedResource.getEncoding());</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">return</span> doLoadBeanDefinitions(inputSource, encodedResource.getResource());</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">finally</span> &#123;</div><div class="line">				inputStream.close();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"><span class="comment">//省略异常处理</span></div><div class="line">	&#125;</div><div class="line"><span class="comment">//具体的读取过程可以在doLoadBeanDefinitions方法中找到</span></div><div class="line"><span class="comment">//这是从特定的XML文件中实际载入BeanDefinition的地方</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">doLoadBeanDefinitions</span><span class="params">(InputSource inputSource, Resource resource)</span> <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="keyword">int</span> validationMode = getValidationModeForResource(resource);</div><div class="line">		<span class="comment">//这里取得XML文件的Document对象，这个解析过程是由 documentLoader完成的这个documentLoader是DefaultDocumentLoader,在定义documentLoader的地方创建</span></div><div class="line">			Document doc = <span class="keyword">this</span>.documentLoader.loadDocument(</div><div class="line">					inputSource, getEntityResolver(), <span class="keyword">this</span>.errorHandler, validationMode, isNamespaceAware());</div><div class="line">			<span class="comment">//这里启动的是对BeanDefinition解析的详细过程，这个解析会使用到Spring的Bean配置规则，是我们下面需要详细讲解的内容</span></div><div class="line">			<span class="keyword">return</span> registerBeanDefinitions(doc, resource);</div><div class="line">		&#125;</div><div class="line"><span class="comment">//省略异常处理</span></div><div class="line">	&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">registerBeanDefinitions</span><span class="params">(Document doc, Resource resource)</span> <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</div><div class="line"><span class="comment">//这里得到 BeanDefinitionDocumentReader来对XML的BeanDefinition进行解析</span></div><div class="line">		BeanDefinitionDocumentReader documentReader = createBeanDefinitionDocumentReader();</div><div class="line">		documentReader.setEnvironment(<span class="keyword">this</span>.getEnvironment());</div><div class="line">		<span class="keyword">int</span> countBefore = getRegistry().getBeanDefinitionCount();</div><div class="line"><span class="comment">//具体的解析过程在这个registerBeanDefinitions中完成</span></div><div class="line">documentReader.registerBeanDefinitions(doc, createReaderContext(resource));</div><div class="line"><span class="comment">//统计载入bean的数量</span></div><div class="line">		<span class="keyword">return</span> getRegistry().getBeanDefinitionCount() - countBefore;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>BeanDefinition的载入分成两部分，首先通过调用XML的解析器得到document对象，但这些document对象并没有按照Spring的Bean规则进行解析。这里不研究Document是怎么解析的，完成解析后按照Spring的Bean规则进行解析，这个过程是在 documentReader的registerBeanDefinitions()中实现的。<br><figure class="highlight java"><figcaption><span>DefaultBeanDefinitionDocumentReader.java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(Document doc, XmlReaderContext readerContext)</span> </span>&#123;</div><div class="line">		<span class="comment">//省略过程</span></div><div class="line">		doRegisterBeanDefinitions(root);</div><div class="line">	&#125;</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRegisterBeanDefinitions</span><span class="params">(Element root)</span> </span>&#123;</div><div class="line">		<span class="comment">//省略过程</span></div><div class="line">		BeanDefinitionParserDelegate parent = <span class="keyword">this</span>.delegate;</div><div class="line">		<span class="keyword">this</span>.delegate = createHelper(readerContext, root, parent);</div><div class="line">		preProcessXml(root);</div><div class="line">		parseBeanDefinitions(root, <span class="keyword">this</span>.delegate);</div><div class="line">		<span class="comment">//省略过程</span></div><div class="line">	&#125;</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">parseBeanDefinitions</span><span class="params">(Element root, BeanDefinitionParserDelegate delegate)</span> </span>&#123;</div><div class="line">		<span class="comment">//省略部分代码做两件事，1、遍历root，得到的ele对应在Spring BeanDefinition中定义的XML元素。2、判断delegate的命名空间是否匹配</span></div><div class="line">		parseDefaultElement(ele, delegate);</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseDefaultElement</span><span class="params">(Element ele, BeanDefinitionParserDelegate delegate)</span> </span>&#123;</div><div class="line">		<span class="comment">//省略部分代码，大概就是根据节点类型的不同，调用不同的处理方法，我们只研究bean是如何加载的。</span></div><div class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, BEAN_ELEMENT)) &#123;</div><div class="line">			processBeanDefinition(ele, delegate);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processBeanDefinition</span><span class="params">(Element ele, BeanDefinitionParserDelegate delegate)</span> </span>&#123;</div><div class="line">		<span class="comment">// BeanDefinitionHolder是BeanDefinition对象的封装类，封装了BeanDefinition，Bean的名字和别名。用它来完成向IoC容器注册。得到这个BeanDefinitionHolder就意味着BeanDefinition是通过BeanDefinitionParserDelegate对XML元素的信息按照Spring的Bean规则进行解析得到的</span></div><div class="line">		BeanDefinitionHolder bdHolder = delegate.parseBeanDefinitionElement(ele);</div><div class="line">		<span class="keyword">if</span> (bdHolder != <span class="keyword">null</span>) &#123;</div><div class="line">			bdHolder = delegate.decorateBeanDefinitionIfRequired(ele, bdHolder);</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				<span class="comment">// 这里是向IoC容器注册解析得到BeanDefinition的地方			BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry());</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">catch</span> (BeanDefinitionStoreException ex) &#123;</div><div class="line">				<span class="comment">//异常处理</span></div><div class="line">			&#125;</div><div class="line">			<span class="comment">// 在BeanDefinition向IoC容器注册完以后，发送消息</span></div><div class="line">			getReaderContext().fireComponentRegistered(<span class="keyword">new</span> BeanComponentDefinition(bdHolder));</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>DefaultBeanDefinitionDocumentReader类里基本是对各种Spring Bean定义规则的处理。具体的处理（比如找到bean元素，将id、name、alaise等信息读取出来存到BeanDefinitionHolder中去）委托给BeanDefinitionParserDelegate来完成。<br><figure class="highlight java"><figcaption><span>BeanDefinitionParserDelegate.java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> BeanDefinitionHolder <span class="title">parseBeanDefinitionElement</span><span class="params">(Element ele)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> parseBeanDefinitionElement(ele, <span class="keyword">null</span>);</div><div class="line">	&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> BeanDefinitionHolder <span class="title">parseBeanDefinitionElement</span><span class="params">(Element ele, BeanDefinition containingBean)</span> </span>&#123;</div><div class="line">		<span class="comment">//这里取得在&lt;bean&gt;元素中定义的id、name和aliase属性的值</span></div><div class="line">		String id = ele.getAttribute(ID_ATTRIBUTE);</div><div class="line">		String nameAttr = ele.getAttribute(NAME_ATTRIBUTE);</div><div class="line"></div><div class="line">		List&lt;Stringaliases = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">		<span class="keyword">if</span> (StringUtils.hasLength(nameAttr)) &#123;</div><div class="line">			String[] nameArr = StringUtils.tokenizeToStringArray(nameAttr, MULTI_VALUE_ATTRIBUTE_DELIMITERS);</div><div class="line">			aliases.addAll(Arrays.asList(nameArr));</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		String beanName = id;</div><div class="line">		<span class="keyword">if</span> (!StringUtils.hasText(beanName) &amp;&amp; !aliases.isEmpty()) &#123;</div><div class="line">			beanName = aliases.remove(<span class="number">0</span>);</div><div class="line">			<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">				logger.debug(<span class="string">"No XML 'id' specified - using '"</span> + beanName +</div><div class="line">						<span class="string">"' as bean name and "</span> + aliases + <span class="string">" as aliases"</span>);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (containingBean == <span class="keyword">null</span>) &#123;</div><div class="line">			checkNameUniqueness(beanName, aliases, ele);</div><div class="line">		&#125;</div><div class="line"><span class="comment">//这个方法会引发对Bean元素的详细解析,这个数据对象中封装的数据大多都是与&lt;bean&gt;定义相关的，也有很多就是我们在定义Bean时看到的那些Spring标记，比如常见的init-method、destroy-method、factory-method，等等</span></div><div class="line">		AbstractBeanDefinition beanDefinition = parseBeanDefinitionElement(ele, beanName, containingBean);</div><div class="line">		<span class="keyword">if</span> (beanDefinition != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">if</span> (!StringUtils.hasText(beanName)) &#123;</div><div class="line">				<span class="keyword">try</span> &#123;</div><div class="line">					<span class="keyword">if</span> (containingBean != <span class="keyword">null</span>) &#123;</div><div class="line">						beanName = BeanDefinitionReaderUtils.generateBeanName(</div><div class="line">								beanDefinition, <span class="keyword">this</span>.readerContext.getRegistry(), <span class="keyword">true</span>);</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">else</span> &#123;</div><div class="line">						beanName = <span class="keyword">this</span>.readerContext.generateBeanName(beanDefinition);</div><div class="line">						String beanClassName = beanDefinition.getBeanClassName();</div><div class="line">						<span class="keyword">if</span> (beanClassName != <span class="keyword">null</span> &amp;&amp;</div><div class="line">								beanName.startsWith(beanClassName) &amp;&amp; beanName.length() beanClassName.length() &amp;&amp;</div><div class="line">								!<span class="keyword">this</span>.readerContext.getRegistry().isBeanNameInUse(beanClassName)) &#123;</div><div class="line">							aliases.add(beanClassName);</div><div class="line">						&#125;</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">						logger.debug(<span class="string">"Neither XML 'id' nor 'name' specified - "</span> +</div><div class="line">								<span class="string">"using generated bean name ["</span> + beanName + <span class="string">"]"</span>);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">catch</span> (Exception ex) &#123;</div><div class="line">					error(ex.getMessage(), ele);</div><div class="line">					<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			String[] aliasesArray = StringUtils.toStringArray(aliases);</div><div class="line">			<span class="keyword">return</span> <span class="keyword">new</span> BeanDefinitionHolder(beanDefinition, beanName, aliasesArray);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>AbstractBeanDefinition是BeanDefinition非常重要的一个实现类，beanClass、description、lazyInit这些属性都是在配置bean时经常碰到的，也都集中在这里。我们来看看他是如何解析的。<br><figure class="highlight java"><figcaption><span>BeanDefinitionParserDelegate.java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> AbstractBeanDefinition <span class="title">parseBeanDefinitionElement</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params">			Element ele, String beanName, BeanDefinition containingBean)</span> </span>&#123;</div><div class="line"></div><div class="line">		<span class="keyword">this</span>.parseState.push(<span class="keyword">new</span> BeanEntry(beanName));</div><div class="line">		<span class="comment">//这里只读取定义的&lt;bean&gt;中设置的class名字，然后载入到BeanDefinition中去，只是做个</span></div><div class="line">		<span class="comment">//记录，并不涉及对象的实例化过程，对象的实例化实际上是在依赖注入时完成的</span></div><div class="line">		String className = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">if</span> (ele.hasAttribute(CLASS_ATTRIBUTE)) &#123;</div><div class="line">			className = ele.getAttribute(CLASS_ATTRIBUTE).trim();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			String parent = <span class="keyword">null</span>;</div><div class="line">			<span class="keyword">if</span> (ele.hasAttribute(PARENT_ATTRIBUTE)) &#123;</div><div class="line">				parent = ele.getAttribute(PARENT_ATTRIBUTE);</div><div class="line">			&#125;</div><div class="line">			<span class="comment">//这里生成需要的BeanDefinition对象，为Bean定义信息的载入做准备</span></div><div class="line">			AbstractBeanDefinition bd = createBeanDefinition(className, parent);</div><div class="line">			<span class="comment">//这里对当前的Bean元素进行属性解析，并设置description的信息</span></div><div class="line">			parseBeanDefinitionAttributes(ele, beanName, containingBean, bd);</div><div class="line">			bd.setDescription(DomUtils.getChildElementValueByTagName(ele, DESCRIPTION_ELEMENT));</div><div class="line">			<span class="comment">//从名字可以清楚地看到，这里是对各种&lt;bean&gt;元素的信息进行解析的地方</span></div><div class="line">			parseMetaElements(ele, bd);</div><div class="line">			parseLookupOverrideSubElements(ele, bd.getMethodOverrides());</div><div class="line">			parseReplacedMethodSubElements(ele, bd.getMethodOverrides());</div><div class="line">			<span class="comment">//解析&lt;bean&gt;的构造函数设置</span></div><div class="line">			parseConstructorArgElements(ele, bd);</div><div class="line">			<span class="comment">//解析&lt;bean&gt;的property设置</span></div><div class="line">			parsePropertyElements(ele, bd);</div><div class="line">			parseQualifierElements(ele, bd);</div><div class="line"></div><div class="line">			bd.setResource(<span class="keyword">this</span>.readerContext.getResource());</div><div class="line">			bd.setSource(extractSource(ele));</div><div class="line"></div><div class="line">			<span class="keyword">return</span> bd;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">//下面这些异常是在配置Bean出现问题时经常会看到的，在createBeanDefinition时进行的，</span></div><div class="line">		<span class="comment">//会检查Bean的class设置是否正确，比如这个类是否能找到</span></div><div class="line">		<span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</div><div class="line">			error(<span class="string">"Bean class ["</span> + className + <span class="string">"] not found"</span>, ele, ex);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">catch</span> (NoClassDefFoundError err) &#123;</div><div class="line">			error(<span class="string">"Class that bean class ["</span> + className + <span class="string">"] depends on not found"</span>, ele, err);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">catch</span> (Throwable ex) &#123;</div><div class="line">			error(<span class="string">"Unexpected failure during bean definition parsing"</span>, ele, ex);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">finally</span> &#123;</div><div class="line">			<span class="keyword">this</span>.parseState.pop();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>这里就不详细对每个属性如何载入的进行分析了，如果有兴趣的可以自己去研究下，特别是Property的解析还是挺有意思的，因为他可能是值，可能是ref，可能有子元素，子元素可能是Array、List、Set、Map、Prop等。<br>经过这样逐层地解析，我们在XML文件中定义的BeanDefinition就被整个载入到了IoC容器中，并在容器中建立了数据映射。在IoC容器中建立了对应的数据结构，或者说可以看成是POJO对象在IoC容器中的抽象，这些数据结构可以以AbstractBeanDefinition为入口，让IoC容器执行索引、查询和操作。简单的POJO操作背后其实蕴含着一个复杂的抽象过程，经过以上的载入过程，IoC容器大致完成了管理Bean对象的数据准备工作（或者说是初始化过程）。但是，重要的依赖注入实际上在这个时候还没有发生，现在，在IoC容器BeanDefinition中存在的还只是一些静态的配置信息。严格地说，这时候的容器还没有完全起作用，要完全发挥容器的作用，还需完成数据向容器的注册。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/05/01/2014-05-01-spring-framework-interpretation-of-the-core-source-code-c-resource-position/" itemprop="url">
                  Spring Framework的核心源码解读（三）-IoC容器初始化及Resource定位
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2014-05-01T15:32:00+08:00" content="2014-05-01">
              2014-05-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/spring/" itemprop="url" rel="index">
                    <span itemprop="name">spring</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/spring/resource/" itemprop="url" rel="index">
                    <span itemprop="name">resource</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/spring/resource/IoC/" itemprop="url" rel="index">
                    <span itemprop="name">IoC</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/spring/resource/IoC/源码分析/" itemprop="url" rel="index">
                    <span itemprop="name">源码分析</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/spring/resource/IoC/源码分析/Resource定位/" itemprop="url" rel="index">
                    <span itemprop="name">Resource定位</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#4 IoC容器的初始化过程<br>本章继续上个章节，以为例子，讲述下IoC容器的初始化。具体来说，这个启动包括BeanDefinition的Resource定位、载入和注册三个基本过程。<br>Spring把这三个过程分开，使用不同的模块来了完成，如使用相应的ResourceLoader、BeanDefinitionReader等模块，通过这样的设计方式，可以让使用者更灵活地对这三个过程进行剪裁或扩展，定义出最适合自己的IoC容器初始化过程。</p>
<h2 id="4-1-Resource定位"><a href="#4-1-Resource定位" class="headerlink" title="4.1 Resource定位"></a>4.1 Resource定位</h2><p>先回到我们经常使用的ApplicationContext上来，对于不同的实现类，就提供不同的Resource读入功能，比如FileSystemXmlApplicationContext是从文件系统载入Resource，ClassPathXmlApplicationContext是从Class Path载入Resource，而XmlWebApplicationContext则是从Web容器中载入Resource。下UML图表明了context和resource是如何建立关系的。<img src="http://i1.tietuku.com/42fa2ddb2a984f88.jpg" alt=""><br>Context 是把资源的加载、解析和描述工作委托给了 ResourcePatternResolver 类来完成，他相当于一个接头人，他把资源的加载、解析和资源的定义整合在一起便于其他组件使用。<br>不同于FileSystemXmlApplicationContext，XmlWebApplicationContext的refresh不是通过构造函数作为入口的，因为它存在于Web容器中，所以他是从监听器中初始化启动的。<br>首先先看一个时序图，看看Web应用启动的过程。<br> <img src="http://i1.tietuku.com/bac88c46e6d1abd4s.jpg" alt=""><br>对容器的启动来说，refresh是一个很重要的方法，在ContextLoader中通过调用refresh()方法启动整个调用。暂时先跳过之前已经说过的XmlWebApplicationContext加载过程和context初始化过程，直接从refresh()开始分析。这段代码主要包含这样几个步骤：</p>
<ul>
<li>构建 BeanFactory，以便于产生所需的“演员”；</li>
<li>注册可能感兴趣的事件，比如MessageSource、PostProcessor等；</li>
<li>创建 Bean 实例对象</li>
<li>触发被监听的事件</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//这里是 refresh 也就是刷新配置</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>&#123;</div><div class="line">		<span class="keyword">synchronized</span> (<span class="keyword">this</span>.startupShutdownMonitor) &#123;</div><div class="line">			<span class="comment">// 准备需要启动的容器上下文，包括启动时间、当前容器状态等</span></div><div class="line">			prepareRefresh();</div><div class="line">			<span class="comment">// 在子类中创建、启动refreshBeanFactory()的地方</span></div><div class="line">			ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</div><div class="line">			<span class="comment">// 初始化BeanFactory，加载容器所需要的行为</span></div><div class="line">			prepareBeanFactory(beanFactory);</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				<span class="comment">//设置BeanFactoy的后置处理</span></div><div class="line">				postProcessBeanFactory(beanFactory);</div><div class="line">				<span class="comment">//调用BeanFactory的后处理器，这些后处理器是在Bean定义中向容器注册的</span></div><div class="line">invokeBeanFactoryPostProcessors(beanFactory);</div><div class="line"><span class="comment">//注册Bean的后处理器，在Bean创建过程中调用。</span></div><div class="line">				registerBeanPostProcessors(beanFactory);</div><div class="line"><span class="comment">//对上下文中的消息源进行初始化</span></div><div class="line">				initMessageSource();</div><div class="line"><span class="comment">//初始化上下文中的事件机制</span></div><div class="line">				initApplicationEventMulticaster();</div><div class="line"><span class="comment">//初始化其他的特殊Bean</span></div><div class="line">				onRefresh();</div><div class="line">				<span class="comment">//检查监听Bean并且将这些Bean向容器注册</span></div><div class="line">				registerListeners();</div><div class="line">				<span class="comment">//实例化所有的(non-lazy-init)单件</span></div><div class="line">				finishBeanFactoryInitialization(beanFactory);</div><div class="line">				<span class="comment">//发布容器事件，结束Refresh过程</span></div><div class="line">				finishRefresh();</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">catch</span> (BeansException ex) &#123;</div><div class="line">		<span class="comment">//为防止Bean资源占用，在异常处理中，销毁已经在前面过程中生成的单件Bean</span></div><div class="line">				destroyBeans();</div><div class="line">				<span class="comment">// 重置 'active'标志</span></div><div class="line">				cancelRefresh(ex);</div><div class="line">				<span class="keyword">throw</span> ex;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>下列代码为AbstractRefreshableApplicationContext的refreshBeanFactory ()方法。这个方法实现了 AbstractApplicationContext 的抽象方法 refreshBeanFactory，这段代码清楚的说明了 IoC容器 的创建过程。注意容器对象的类型的变化，前面介绍了他有很多子类，在什么情况下使用不同的子类这非常关键。在 refreshBeanFactory 方法中有一行 loadBeanDefinitions(beanFactory)，这个方法将开始加载、解析 Bean 的定义，也就是把用户定义的数据结构转化为 IoC 容器中的特定数据结构。<br><figure class="highlight java"><figcaption><span>AbstractRefreshableApplicationContext.java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">refreshBeanFactory</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">	    <span class="comment">//这里判断，如果已经建立BeanFactory，则销毁并关闭该BeanFactory</span></div><div class="line">		<span class="keyword">if</span> (hasBeanFactory()) &#123;</div><div class="line">			destroyBeans();</div><div class="line">			closeBeanFactory();</div><div class="line">		&#125;</div><div class="line">		<span class="comment">//这里创建并设置持有的DefaultListableBeanFactory的地方同时调用</span></div><div class="line">		<span class="comment">//loadBeanDefinitions再载入BeanDefinition的信息</span></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			DefaultListableBeanFactory beanFactory = createBeanFactory();</div><div class="line">			beanFactory.setSerializationId(getId());</div><div class="line">			customizeBeanFactory(beanFactory);</div><div class="line">	<span class="comment">//该方法是钩子方法，直接调用XmlWebApplicationContext中的实现</span></div><div class="line">	**loadBeanDefinitions(beanFactory);**</div><div class="line">			<span class="keyword">synchronized</span> (<span class="keyword">this</span>.beanFactoryMonitor) &#123;</div><div class="line">				<span class="keyword">this</span>.beanFactory = beanFactory;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">"I/O error parsing bean definition source for "</span> + getDisplayName(), ex);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"><span class="comment">//这就是在上下文中创建DefaultListableBeanFactory的地方，而getInternalParentBeanFactory的具体实现可以参看AbstractApplicationContext中的实现，会根据容器已有的双亲IoC容器的信息来生成DefaultListableBeanFactory的双亲容器</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> DefaultListableBeanFactory <span class="title">createBeanFactory</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> DefaultListableBeanFactory(getInternalParentBeanFactory());</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>前面已经说了有不同子类的实现，那么接着就到具体实现类中去看看。这里因为有许多载入方式，所以通过一个抽象函数（钩子方法）把具体的实现委托给各个子类来实现。这里使用的是xml的载入方式。通过XmlBeanDefinitionReader载入Bean的地方。<br><figure class="highlight java"><figcaption><span>XmlWebApplicationContext.java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">loadBeanDefinitions</span><span class="params">(DefaultListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException, IOException </span>&#123;</div><div class="line">		<span class="comment">// 创建一个XmlBeanDefinitionReader并设置beanFactory.</span></div><div class="line">		XmlBeanDefinitionReader beanDefinitionReader = <span class="keyword">new</span> XmlBeanDefinitionReader(beanFactory);</div><div class="line"></div><div class="line">		<span class="comment">// 通过上下文环境配置reader</span></div><div class="line">		beanDefinitionReader.setEnvironment(<span class="keyword">this</span>.getEnvironment());</div><div class="line">		beanDefinitionReader.setResourceLoader(<span class="keyword">this</span>);</div><div class="line">		beanDefinitionReader.setEntityResolver(<span class="keyword">new</span> ResourceEntityResolver(<span class="keyword">this</span>));</div><div class="line"></div><div class="line">		<span class="comment">// 钩子方法，子类不重载就不做任何操作</span></div><div class="line">		initBeanDefinitionReader(beanDefinitionReader);</div><div class="line">		loadBeanDefinitions(beanDefinitionReader);</div><div class="line">	&#125;</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">loadBeanDefinitions</span><span class="params">(XmlBeanDefinitionReader reader)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line"><span class="comment">//调用基类的获取配置路径方法</span></div><div class="line">		String[] configLocations = getConfigLocations();</div><div class="line">		<span class="keyword">if</span> (configLocations != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">for</span> (String configLocation : configLocations) &#123;</div><div class="line">				reader.loadBeanDefinitions(configLocation);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">	 * 默认的配置文件为 "/WEB-INF/applicationContext.xml"</span></div><div class="line"><span class="comment">	 */</span></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="keyword">protected</span> String[] getDefaultConfigLocations() &#123;</div><div class="line">		<span class="keyword">if</span> (getNamespace() != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">new</span> String[] &#123;DEFAULT_CONFIG_LOCATION_PREFIX + getNamespace() + DEFAULT_CONFIG_LOCATION_SUFFIX&#125;;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">new</span> String[] &#123;DEFAULT_CONFIG_LOCATION&#125;;</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><figcaption><span>AbstractRefreshableConfigApplicationContext.java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> String[] getConfigLocations() &#123;</div><div class="line"><span class="comment">//基类中又调用钩子方法</span></div><div class="line">		<span class="keyword">return</span> (<span class="keyword">this</span>.configLocations != <span class="keyword">null</span> ? <span class="keyword">this</span>.configLocations : getDefaultConfigLocations());</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>具体资源载入是在XmlBeanDefinitionReader读入BeanDefinition时完成的。<br><figure class="highlight java"><figcaption><span>XmlBeanDefinitionReader.java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">loadBeanDefinitions</span><span class="params">(String location, Set&lt;ResourceactualResources)</span> <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</div><div class="line">		ResourceLoader resourceLoader = getResourceLoader();</div><div class="line">		<span class="keyword">if</span> (resourceLoader == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">//……异常，省略</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (resourceLoader <span class="keyword">instanceof</span> ResourcePatternResolver) &#123;</div><div class="line">			<span class="comment">//……这里很少用的，直接跳过</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">// 通过调用DefaultResourceLoader的getResources完成具体的Resource定位</span></div><div class="line">			Resource resource = resourceLoader.getResource(location);</div><div class="line">			<span class="keyword">int</span> loadCount = loadBeanDefinitions(resource);</div><div class="line">			<span class="keyword">if</span> (actualResources != <span class="keyword">null</span>) &#123;</div><div class="line">				actualResources.add(resource);</div><div class="line">			&#125;</div><div class="line">			<span class="comment">//……省略部分代码</span></div><div class="line">			<span class="keyword">return</span> loadCount;</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>对于具体取得resource的过程，我们可以看看DefaultResourceLoader是怎么完成的。<br><figure class="highlight java"><figcaption><span>DefaultResourceLoader.java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Resource <span class="title">getResource</span><span class="params">(String location)</span> </span>&#123;</div><div class="line">		Assert.notNull(location, <span class="string">"Location must not be null"</span>);</div><div class="line">		<span class="comment">//先处理带有classpath表示的Resource</span></div><div class="line">		<span class="keyword">if</span> (location.startsWith(CLASSPATH_URL_PREFIX)) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">new</span> ClassPathResource(location.substring(CLASSPATH_URL_PREFIX.length()), getClassLoader());</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				<span class="comment">// 再尝试处理URL表示的Resource</span></div><div class="line">				URL url = <span class="keyword">new</span> URL(location);</div><div class="line">				<span class="keyword">return</span> <span class="keyword">new</span> UrlResource(url);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">catch</span> (MalformedURLException ex) &#123;</div><div class="line">				<span class="comment">// 如果既不是classpath，又不是URL标示，则把getResource的任务交给getResourceByPath，这个方法有默认实现，但基本用子类实现</span></div><div class="line">				<span class="keyword">return</span> getResourceByPath(location);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>这里使用的是基类AbstractRefreshableWebApplicationContext的实现方式。返回的是ServletContextResource类型的Resource。<br><figure class="highlight java"><figcaption><span>AbstractRefreshableWebApplicationContext.java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> Resource <span class="title">getResourceByPath</span><span class="params">(String path)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ServletContextResource(<span class="keyword">this</span>.servletContext, path);</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>如果是其他的ApplicationContext，那么会对应生成其他种类的Resource，比如ClassPathResource、ServletContextResource等。从下图可以看出Resource接口的设计。在BeanDefinition定位完成的基础上，就可以通过返回的Resource对象来进行BeanDefinition的载入了。现在BeanDefinition所需要的数据还并未读入，这些读入将在下一章节，Resource载入中说明<br><img src="http://i1.tietuku.com/d1d7292220faf75a.jpg" alt=""></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/05/01/2014-05-01-spring-framework-core-source-code-analysis-ii-xmlwebapplicationcontext-introduction/" itemprop="url">
                  Spring Framework的核心源码解读（二）-XmlWebApplicationContext介绍
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2014-05-01T15:29:00+08:00" content="2014-05-01">
              2014-05-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/spring/" itemprop="url" rel="index">
                    <span itemprop="name">spring</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/spring/IoC/" itemprop="url" rel="index">
                    <span itemprop="name">IoC</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/spring/IoC/XmlWebApplicationContext/" itemprop="url" rel="index">
                    <span itemprop="name">XmlWebApplicationContext</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#3 XmlWebApplicationContext<br>XmlWebApplicationContext是开发web应用最常用的上下文环境。</p>
<h2 id="3-1-XmlWebApplicationContext的特性"><a href="#3-1-XmlWebApplicationContext的特性" class="headerlink" title="3.1 XmlWebApplicationContext的特性"></a>3.1 XmlWebApplicationContext的特性</h2><p>XmlWebApplicationContext提供了IoC容器对Web环境ServletAPI的集成，并提供Xml解析器，从而可以从xml文件中获取BeanDefinition数据。<br> <img src="http://i1.tietuku.com/2ba01b6872beb1db.jpg" alt=""></p>
<h2 id="3-2-XmlWebApplicationContext的加载"><a href="#3-2-XmlWebApplicationContext的加载" class="headerlink" title="3.2 XmlWebApplicationContext的加载"></a>3.2 XmlWebApplicationContext的加载</h2><p>在系统中通过配置servlet或者listener（如下代码）就能让web系统从xml中加载BeanDefinition数据。<br><figure class="highlight xml"><figcaption><span>web.xml</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">listener</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span></div><div class="line">        org.springframework.web.context.ContextLoaderListener</div><div class="line">    <span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">listener</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>那再让我们看看ContextLoaderListener的源码片段。从下面的代码可以看出，该监听会判断上下载加载器是否存在，不存在就进行初始化。<br><figure class="highlight java"><figcaption><span>ContextLoaderListener.java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.contextLoader = createContextLoader();</div><div class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.contextLoader == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">this</span>.contextLoader = <span class="keyword">this</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">this</span>.contextLoader.initWebApplicationContext(event.getServletContext());</div></pre></td></tr></table></figure></p>
<p>而initWebApplicationContext()方法中，又通过BeanUtils.instantiateClass(contextClass)来获取ApplicationContext，我们再继续寻找源头。在ContextLoader类中我们找到了determineContextClass()方法。<br><figure class="highlight java"><figcaption><span>ContextLoader.java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> Class&lt;?determineContextClass(ServletContext servletContext) &#123;</div><div class="line">		String contextClassName = servletContext.getInitParameter(CONTEXT_CLASS_PARAM);</div><div class="line">		<span class="keyword">if</span> (contextClassName != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">//通过类加载器加载该类并返回</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> &#123;</div><div class="line">			contextClassName = defaultStrategies.getProperty(WebApplicationContext.class.getName());</div><div class="line">			<span class="comment">//通过类加载器加载该类并返回</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>servletContext.getInitParameter是取web.xml里的配置参数，意思就是先看看我们有没有自己定义context的类，如果我们定义了，直接返回这个class。否则，去defaultStrategies里去取,WebApplicationContext的类名作为key。这里我Ctry+O搜了下defaultStrategies，发现了源头。<br><figure class="highlight java"><figcaption><span>ContextLoader.java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_STRATEGIES_PATH = <span class="string">"ContextLoader.properties"</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Properties defaultStrategies;</div><div class="line"></div><div class="line">	<span class="keyword">static</span> &#123;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			ClassPathResource resource = <span class="keyword">new</span> ClassPathResource(DEFAULT_STRATEGIES_PATH, ContextLoader.class);</div><div class="line">			defaultStrategies = PropertiesLoaderUtils.loadProperties(resource);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Could not load 'ContextLoader.properties': "</span> + ex.getMessage());</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>这里定义的就是我们需要的类。<br><img src="http://i1.tietuku.com/5e8030512d81ede8.jpg" alt=""></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/05/01/2014-05-01-spring-framework-core-source-code-analysis-a-spring-the-overall-structure-and-the-overall-ioc-container-design-introduction/" itemprop="url">
                  Spring Framework的核心源码解读（一）-Spring整体结构以及IoC容器设计整体介绍
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2014-05-01T15:19:00+08:00" content="2014-05-01">
              2014-05-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/spring/" itemprop="url" rel="index">
                    <span itemprop="name">spring</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/spring/application/" itemprop="url" rel="index">
                    <span itemprop="name">application</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/spring/application/IoC/" itemprop="url" rel="index">
                    <span itemprop="name">IoC</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/spring/application/IoC/源码分析/" itemprop="url" rel="index">
                    <span itemprop="name">源码分析</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/spring/application/IoC/源码分析/beanfactory/" itemprop="url" rel="index">
                    <span itemprop="name">beanfactory</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#前言<br>这么久没写博客？我干嘛去了呢？最主要还是项目比较忙，没有大段的时间来看书、研究、写成博文。仅有的时间也只能翻阅下书籍或者技术文章，而自己又不想天天写些心灵鸡汤类的东西。那么就只好罢工这么久了咯。终于遇到五一有空了，安静下来看看书，写写博文。最近一段时间都是Spring 源码相关的，该系列文章内容大多为《Spring技术内幕》这本书的笔记，这本书很不错，推荐阅读。也会发一段Thoughtwork的那个代码招聘的FizzBuzzWhizz相关的内容。<br>敬请期待！</p>
<p>#1 概述</p>
<h2 id="1-1-Spring的整体架构"><a href="#1-1-Spring的整体架构" class="headerlink" title="1.1 Spring的整体架构"></a>1.1 Spring的整体架构</h2><p>Spring 总共有十几个组件，其中核心组件只有三个：Core、Context 和 Beans。AOP、Web等都属于核心上层的特性功能。本文将对Spring核心内容的设计进行分析。<br><img src="http://i1.tietuku.com/154191d85dc03b0c.jpg" alt=""></p>
<p>#2 IoC容器的实现</p>
<h2 id="2-1-控制反转（IOC）"><a href="#2-1-控制反转（IOC）" class="headerlink" title="2.1 控制反转（IOC）"></a>2.1 控制反转（IOC）</h2><p>实际应用的程序基本上都是由多个类彼此合作来实现业务逻辑，这使得每个对象都需要与其合作的对象的引用。但是这样的控制就导致了程序的耦合度非常大，不易于复用，更不易于做单元测试。<br>Martin Flowler 提出了“那些方面的控制被反转了？”这个问题。他得出的结论是：依赖对象的获得被反转了。基于这个结论，他为控制反转创造了一个更好的名字：依赖注入。<br>依赖倒置也是设计模式六大原则之一。在Spring中IoC容器就是这个模式的载体，它可以通过容器对对象进行管理，在对象生成或初始化时直接将数据注入到需要其依赖的对象中。这也是Spring的核心。</p>
<h2 id="2-2-BeanFactory和ApplicationContext的区别"><a href="#2-2-BeanFactory和ApplicationContext的区别" class="headerlink" title="2.2 BeanFactory和ApplicationContext的区别"></a>2.2 BeanFactory和ApplicationContext的区别</h2><p>Spring中容器要分两类，一类是实现BeanFactory接口的简单容器系列，这类容器只实现了容器的最基本功能；另一个是ApplicationContext应用上下文，也就是我们最常用的，项目中的配置文件大多数都是ApplicationContext-xxx.xml，它作为容器的高级形态而存在。<br>用生活中的容器水杯举例，BeanFactory就定义了可以作为水桶的基本功能（装水）。从下图可以看出，Spring容器的基本功能就是获取bean、判断bean是否存在、是否为单例、是否为原型、类型是否匹配、获取bean的类型、获取bean的别名。因此BeanFactory就是Spring的基本接口。<br> <img src="http://i1.tietuku.com/75daf2c913bddbdd.jpg" alt=""><br>那么BeanFactory是杯子，那么BeanDefinition就是水。BeanDefinition是用来管理基于Spring的应用中的各种对象以及它们之间的相互依赖关系，就Spring中Bean的主要数据结构，是设计出来水的抽象。如下代码。<br><figure class="highlight java"><figcaption><span>DefaultListableBeanFactory.java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** Map of bean definition objects, keyed by bean name */</span></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, BeanDefinitionbeanDefinitionMap = <span class="keyword">new</span> ConcurrentHashMap&lt;String, BeanDefinition&gt;();</div><div class="line"></div><div class="line">	<span class="comment">/** List of bean definition names, in registration order */</span></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> List&lt;StringbeanDefinitionNames = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div></pre></td></tr></table></figure></p>
<p>而ApplicationContext则提供了很多特殊的特性，从下图ApplicationContext接口的继承关系可以看出，它除了容器所需的基本特性外，还有其他许多附加特性，比如国际化的消息访问、资源访问、事件传播、载入多个上下文等。<br> <img src="http://i1.tietuku.com/84eaba13257e4c38.jpg" alt=""></p>
<h2 id="2-3-IoC容器的接口设计"><a href="#2-3-IoC容器的接口设计" class="headerlink" title="2.3 IoC容器的接口设计"></a>2.3 IoC容器的接口设计</h2><p>下图描述了IoC容器中的主要接口设计（图片拍自Spring技术内幕一书）。<br> <img src="http://i1.tietuku.com/8f45e01439fe6212.jpg" alt=""></p>
<h2 id="2-3-1-BeanFactory-HierarchicalBeanFactory-ConfigurableBeanFactory"><a href="#2-3-1-BeanFactory-HierarchicalBeanFactory-ConfigurableBeanFactory" class="headerlink" title="# 2.3.1 BeanFactory-HierarchicalBeanFactory-ConfigurableBeanFactory"></a># 2.3.1 BeanFactory-HierarchicalBeanFactory-ConfigurableBeanFactory</h2><p>在这条设计路径中，HierarchicalBeanFactory增加了getParentBeanFactory()的功能，是BeanFactory具备了双亲IoC容器的管理功能，在ConfigurableBeanFactory中主要定义了一些对BeanFactory的配置功能，比如通过setParentBeanFactory()设置双亲IoC容器，通过addBeanPostProcessor()定义了Bean后置处理器等。</p>
<h2 id="2-3-2-ApplicationContext路线"><a href="#2-3-2-ApplicationContext路线" class="headerlink" title="# 2.3.2 ApplicationContext路线"></a># 2.3.2 ApplicationContext路线</h2><p>该设计路线以ApplicationContext应用上下文接口为核心的接口设计，这里涉及的主要接口设计有，从BeanFactory到ListableBeanFactory，再到ApplicationContext，再到我们常用的WebApplicationContext或者ConfigurableApplicationContext接口。<br>在这个接口体系中，ListableBeanFactory和HierarchicalBeanFactory两个接口，连接BeanFactory接口定义和ApplicationConext应用上下文的接口定义。在ListableBeanFactory接口中，细化了许多BeanFactory的接口功能，比如定义了getBeanDefinitionNames()接口方法；对于HierarchicalBeanFactory接口，我们在前文中已经提到过；对于ApplicationContext接口，它通过继承MessageSource、ResourceLoader、ApplicationEventPublisher接口，在BeanFactory简单IoC容器的基础上添加了许多对高级容器的特性的支持，这些特性我们之前也都提到过了。<br>总体来说 ApplicationContext 必须要完成以下几件事：</p>
<ul>
<li>标识一个应用环境</li>
<li>利用 BeanFactory 创建 Bean 对象</li>
<li>保存对象关系表</li>
<li>能够捕获各种事件</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/03/28/2014-03-28-java-parse-xml-export-word/" itemprop="url">
                  Java解析Xml导出Word
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2014-03-28T10:42:00+08:00" content="2014-03-28">
              2014-03-28
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/模板引擎/" itemprop="url" rel="index">
                    <span itemprop="name">模板引擎</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/模板引擎/导出Word/" itemprop="url" rel="index">
                    <span itemprop="name">导出Word</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/模板引擎/导出Word/解析Xml/" itemprop="url" rel="index">
                    <span itemprop="name">解析Xml</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/模板引擎/导出Word/解析Xml/设计/" itemprop="url" rel="index">
                    <span itemprop="name">设计</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#需求概述<br>不知道大家有没做过用xml定义需要导出word的格式和需要的数据，然后通过Java代码来解析Xml完成导出。<br>本文不考虑解析Xml和怎么导出Word，只考虑如何用解析后的对象来生成需要导出的数据。<br>本文使用的Xml解析方法为Dom4j，Word导出方法为Itext。</p>
<p>#最初的想法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">    	<span class="keyword">try</span> &#123;</div><div class="line">    		Object data = getData();</div><div class="line">	    	Element xmlElement = DXmlUtil.getXmlElement(<span class="string">"format.xml"</span>, <span class="string">"/Doc"</span>);</div><div class="line">		IDocFactory factory = <span class="keyword">new</span> DDocFactory();</div><div class="line">         Document doc = factory.getDocFactory(out);</div><div class="line">	    	proc(xmlElement,data, doc, factory);</div><div class="line">	    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">	    	e.printStackTrace();</div><div class="line">	    &#125;</div><div class="line">	&#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">proc</span><span class="params">(Element element,Object obj,Document doc,IDocFactory factory)</span></span>&#123;</div><div class="line">    	<span class="comment">//TODO 接下来就是见证奇迹的时刻</span></div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight xml"><figcaption><span>需解析的模板</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">Doc</span> <span class="attr">title</span>=<span class="string">"$&#123;app.name&#125;"</span> <span class="attr">subtitle</span>=<span class="string">"运维服务报告"</span> <span class="attr">exportpath</span>=<span class="string">"F:\\音乐\\哈哈哈"</span> &gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">chapter</span> <span class="attr">level</span>=<span class="string">"1"</span> <span class="attr">num</span>=<span class="string">"1"</span> <span class="attr">title</span>=<span class="string">"目的"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">para</span> <span class="attr">type</span>=<span class="string">"content"</span>&gt;</span>本服务报告按月对系统运维情况进行总结，对出现的问题给与说明，以方便用户、部门领导等相关人员对系统状况和项目情况的了解，并为领导决策提供依据。<span class="tag">&lt;/<span class="name">para</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">chapter</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">chapter</span> <span class="attr">level</span>=<span class="string">"1"</span> <span class="attr">num</span>=<span class="string">"2"</span> <span class="attr">title</span>=<span class="string">"数据来源"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">para</span> <span class="attr">type</span>=<span class="string">"content"</span>&gt;</span>本服务报告的数据来源包括以下几个部分：<span class="tag">&lt;/<span class="name">para</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">list</span> <span class="attr">type</span>=<span class="string">"diamod"</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">item</span>&gt;</span>服务器运行状态巡检数据<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">item</span>&gt;</span>巨龙运维监控工具预警数据<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">item</span>&gt;</span>巨龙运维流程系统处置数据<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">list</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">chapter</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">chapter</span> <span class="attr">level</span>=<span class="string">"1"</span> <span class="attr">num</span>=<span class="string">"3"</span> <span class="attr">title</span>=<span class="string">"系统运维工作说明"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">chapter</span> <span class="attr">level</span>=<span class="string">"2"</span> <span class="attr">num</span>=<span class="string">"3.1"</span> <span class="attr">title</span>=<span class="string">"系统基础情况"</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">para</span> <span class="attr">type</span>=<span class="string">"contentItalic"</span>&gt;</span>$&#123;app.name&#125;共有xx台服务器CPU资源使用达到xx%，CPU资源占用xx，CPU处理出现了等待状态；<span class="tag">&lt;/<span class="name">para</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">para</span> <span class="attr">type</span>=<span class="string">"contentItalic"</span>&gt;</span>$&#123;app.name&#125;多少台内存消耗比例达到XX%，内存消耗了多少G，系统运行时剩余内存多少G，服务器内存出现XXX状态。<span class="tag">&lt;/<span class="name">para</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">para</span> <span class="attr">type</span>=<span class="string">"contentItalic"</span>&gt;</span>$&#123;app.name&#125;在什么时段出现磁盘IO瓶颈情况，每秒最高达到多少M/s，最低达到多少M/s。<span class="tag">&lt;/<span class="name">para</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">para</span> <span class="attr">type</span>=<span class="string">"contentItalic"</span>&gt;</span>综合以上分析，$&#123;app.name&#125;整体运行情况，系统运行资源紧张，CPU、内存、磁盘相对处于高负荷状态。其中XX系统的CPU资源使用过高，XX系统的内存使用明显异常，磁盘IO严重，磁盘增长明显过快，建议更换升级服务器资源或增加硬件资源，平衡系统资源。<span class="tag">&lt;/<span class="name">para</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">chapter</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">chapter</span> <span class="attr">level</span>=<span class="string">"2"</span> <span class="attr">num</span>=<span class="string">"3.2"</span> <span class="attr">title</span>=<span class="string">"系统运行状况"</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">chapter</span> <span class="attr">level</span>=<span class="string">"2"</span> <span class="attr">num</span>=<span class="string">"3.2.1"</span> <span class="attr">title</span>=<span class="string">"系统可用情况"</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">loop</span> <span class="attr">items</span>=<span class="string">"app.appSet"</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">arrow</span> <span class="attr">title</span>=<span class="string">"$&#123;name&#125;"</span>&gt;</span></div><div class="line">						<span class="tag">&lt;<span class="name">para</span> <span class="attr">type</span>=<span class="string">"content"</span>&gt;</span>故障次数$&#123;data.failTotal&#125;次，其中一级故障$&#123;data.failHigh&#125;次，二次故障$&#123;data.failMiddle&#125;次，三级故障$&#123;data.failLow&#125;次。<span class="tag">&lt;/<span class="name">para</span>&gt;</span></div><div class="line">						<span class="tag">&lt;<span class="name">para</span> <span class="attr">type</span>=<span class="string">"content"</span>&gt;</span>可用性说明：本月重点人系统运行正常，业务繁忙时段xx访问测试X次，正常访问X次。<span class="tag">&lt;/<span class="name">para</span>&gt;</span></div><div class="line">					<span class="tag">&lt;/<span class="name">arrow</span>&gt;</span></div><div class="line">				<span class="tag">&lt;/<span class="name">loop</span>&gt;</span></div><div class="line">			<span class="tag">&lt;/<span class="name">chapter</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">chapter</span> <span class="attr">level</span>=<span class="string">"2"</span> <span class="attr">num</span>=<span class="string">"3.2.2"</span> <span class="attr">title</span>=<span class="string">"系统可用情况"</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">loop</span> <span class="attr">items</span>=<span class="string">"app.appSet"</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">arrow</span> <span class="attr">title</span>=<span class="string">"$&#123;name&#125;"</span>&gt;</span></div><div class="line">						<span class="tag">&lt;<span class="name">para</span> <span class="attr">type</span>=<span class="string">"content"</span>&gt;</span>非计划中断次数$&#123;data.interruptNum&#125;次，系统稳定性$&#123;steady&#125;。<span class="tag">&lt;/<span class="name">para</span>&gt;</span></div><div class="line">					<span class="tag">&lt;/<span class="name">arrow</span>&gt;</span></div><div class="line">				<span class="tag">&lt;/<span class="name">loop</span>&gt;</span></div><div class="line">			<span class="tag">&lt;/<span class="name">chapter</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">chapter</span>&gt;</span></div><div class="line">		</div><div class="line">		<span class="tag">&lt;<span class="name">chapter</span> <span class="attr">level</span>=<span class="string">"2"</span> <span class="attr">num</span>=<span class="string">"3.3"</span> <span class="attr">title</span>=<span class="string">"系统运行状态趋势分析"</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">chapter</span> <span class="attr">level</span>=<span class="string">"2"</span> <span class="attr">num</span>=<span class="string">"3.3.1"</span> <span class="attr">title</span>=<span class="string">"系统故障趋势分析"</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">chapter</span> <span class="attr">level</span>=<span class="string">"2"</span> <span class="attr">num</span>=<span class="string">"3.3.1.1"</span> <span class="attr">title</span>=<span class="string">"XX系统"</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">arrow</span> <span class="attr">title</span>=<span class="string">"数据统计"</span>&gt;</span></div><div class="line">						<span class="tag">&lt;<span class="name">para</span> <span class="attr">type</span>=<span class="string">"desc"</span>&gt;</span>$&#123;app.name&#125;$&#123;app.twoPrevMonth&#125;故障数&#123;app.twoPreData.failTotal&#125;，$&#123;app.onePrevMonth&#125;故障数$&#123;app.onePreData.failTotal&#125;，本月$&#123;app.month&#125;故障数$&#123;app.data.failTotal&#125;。从故障数据分析来看，故障数呈$&#123;app.trend&#125;趋势。<span class="tag">&lt;/<span class="name">para</span>&gt;</span></div><div class="line">					<span class="tag">&lt;/<span class="name">arrow</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">arrow</span> <span class="attr">title</span>=<span class="string">"原因分析"</span>&gt;</span></div><div class="line">						<span class="tag">&lt;<span class="name">para</span> <span class="attr">type</span>=<span class="string">"desc"</span>&gt;</span>描述本月故障主要集中点，分析造成原因。<span class="tag">&lt;/<span class="name">para</span>&gt;</span></div><div class="line">					<span class="tag">&lt;/<span class="name">arrow</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">arrow</span> <span class="attr">title</span>=<span class="string">"改进措施"</span>&gt;</span></div><div class="line">						<span class="tag">&lt;<span class="name">para</span> <span class="attr">type</span>=<span class="string">"desc"</span>&gt;</span>针对本月故障上升的情况，提出改进措施。<span class="tag">&lt;/<span class="name">para</span>&gt;</span></div><div class="line">					<span class="tag">&lt;/<span class="name">arrow</span>&gt;</span></div><div class="line">				<span class="tag">&lt;/<span class="name">chapter</span>&gt;</span></div><div class="line">			<span class="tag">&lt;/<span class="name">chapter</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">chapter</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">chapter</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">chapter</span> <span class="attr">level</span>=<span class="string">"1"</span> <span class="attr">num</span>=<span class="string">"4"</span> <span class="attr">title</span>=<span class="string">"运维服务情况统计"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">para</span> <span class="attr">type</span>=<span class="string">"content"</span>&gt;</span>$&#123;app.month&#125;共进行系统升级xx次，自动监控$&#123;app.data.monitorFail&#125;次，人工巡检$&#123;app.data.requestFail&#125;次，事件响应xx次。具体情况如下：<span class="tag">&lt;/<span class="name">para</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">arrow</span> <span class="attr">title</span>=<span class="string">"人工巡检："</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">para</span> <span class="attr">type</span>=<span class="string">"content"</span>&gt;</span>故障数量$&#123;app.data.requestFail&#125;次，已解决数量$&#123;app.data.requestSolve&#125;次，未解决数量$&#123;app.data.requestUnsolve&#125;次，解决率$&#123;app.data.requestSolveRate&#125;%。<span class="tag">&lt;/<span class="name">para</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">arrow</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">arrow</span> <span class="attr">title</span>=<span class="string">"自动监控："</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">para</span> <span class="attr">type</span>=<span class="string">"content"</span>&gt;</span>故障数量$&#123;app.data.monitorFail&#125;次，已解决数量$&#123;app.data.monitorSolve&#125;次，未解决数量$&#123;app.data.monitorUnsolve&#125;次，解决率$&#123;app.data.requestSolveRate&#125;%。<span class="tag">&lt;/<span class="name">para</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">arrow</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">arrow</span> <span class="attr">title</span>=<span class="string">"事件响应："</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">para</span> <span class="attr">type</span>=<span class="string">"content"</span>&gt;</span>故障数量x次，已解决数量x次，未解决数量x次，解决率x%。<span class="tag">&lt;/<span class="name">para</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">arrow</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">arrow</span> <span class="attr">title</span>=<span class="string">"系统升级："</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">para</span> <span class="attr">type</span>=<span class="string">"content"</span>&gt;</span>故障数量x次，已解决数量x次，未解决数量x次，解决率x%。<span class="tag">&lt;/<span class="name">para</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">arrow</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">chapter</span> <span class="attr">level</span>=<span class="string">"2"</span> <span class="attr">num</span>=<span class="string">"4.1"</span> <span class="attr">title</span>=<span class="string">"重大事件报告"</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">para</span> <span class="attr">type</span>=<span class="string">"desc"</span>&gt;</span>如本月有运维相关的重大事件，可在此处简略报告。<span class="tag">&lt;/<span class="name">para</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">chapter</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">chapter</span>&gt;</span></div><div class="line">	</div><div class="line">	<span class="tag">&lt;<span class="name">endChapter</span> <span class="attr">num</span>=<span class="string">"5"</span> <span class="attr">title</span>=<span class="string">"用户评价及反馈"</span> &gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">para</span> <span class="attr">type</span>=<span class="string">"desc"</span>&gt;</span>报告打印出来后，由用户方运维工作接口人在本章节对运维工作进行评价。<span class="tag">&lt;/<span class="name">para</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">para</span> <span class="attr">type</span>=<span class="string">"content"</span>&gt;</span>本月运维报告用户签收确认：<span class="tag">&lt;/<span class="name">para</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">para</span> <span class="attr">type</span>=<span class="string">"content"</span>&gt;</span><span class="tag">&lt;/<span class="name">para</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">para</span> <span class="attr">type</span>=<span class="string">"content"</span>&gt;</span><span class="tag">&lt;/<span class="name">para</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">para</span> <span class="attr">type</span>=<span class="string">"content"</span>&gt;</span>本月运维工作用户评价：<span class="tag">&lt;/<span class="name">para</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">para</span> <span class="attr">type</span>=<span class="string">"content"</span>&gt;</span><span class="tag">&lt;/<span class="name">para</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">para</span> <span class="attr">type</span>=<span class="string">"content"</span>&gt;</span><span class="tag">&lt;/<span class="name">para</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">para</span> <span class="attr">type</span>=<span class="string">"content"</span>&gt;</span><span class="tag">&lt;/<span class="name">para</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">para</span> <span class="attr">type</span>=<span class="string">"right"</span>&gt;</span>用户签名：<span class="tag">&lt;/<span class="name">para</span>&gt;</span></div><div class="line">		&lt;para type="right"   日期：&lt;/para&gt;</div><div class="line">	<span class="tag">&lt;/<span class="name">endChapter</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Doc</span>&gt;</span></div></pre></td></tr></table></figure>
<p>#处理元素<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">procChild</span><span class="params">(Document doc, IDocFactory factory,</span></span></div><div class="line"><span class="function"><span class="params">           Object model, org.dom4j.Element element)</span> </span>&#123;</div><div class="line"></div><div class="line">       List elements = element.elements();</div><div class="line">       <span class="keyword">if</span> (elements != <span class="keyword">null</span> &amp;&amp; !elements.isEmpty()) &#123;</div><div class="line">           <span class="keyword">for</span> (Object obj : elements) &#123;</div><div class="line">               org.dom4j.Element ele = (org.dom4j.Element) obj;</div><div class="line">               String eleName = ele.getName();</div><div class="line">               <span class="comment">//..... 这里通过元素的名称来判断下一步通过哪种方法处理</span></div><div class="line">           &#125;</div><div class="line">       &#125;</div></pre></td></tr></table></figure></p>
<p>#生成无参数的模板内容<br>这里通过很多工具类，根据标签的不同使用不同的处理方法，方法如下图。</p>
<p>随便找一个方法出来举个例子<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">procPara</span><span class="params">(Document doc, IDocFactory factory,</span></span></div><div class="line"><span class="function"><span class="params">           Object model, org.dom4j.Element ele)</span> </span>&#123;</div><div class="line">   	<span class="comment">//获取该段的样式类型，如正文、斜体、初体、居右、注释</span></div><div class="line">       String type = getElementStr(ele, model,DocConstants.PARA_TYPE);</div><div class="line">       <span class="comment">//获取段落的内容</span></div><div class="line">       String text = getElementData(model, ele);</div><div class="line">       <span class="comment">//通过抽象工厂，根据类型生成段落</span></div><div class="line">       Paragraph para = factory.getParagraph(text, type);</div><div class="line">       <span class="comment">//将段落添加到文档输出流中,等close的时候统一输出</span></div><div class="line">       add(doc, para);</div><div class="line">       <span class="comment">//处理子节点，如果有的话</span></div><div class="line">       procChild(doc, factory, model, ele);</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>#处理循环<br>需求要求支持循环，类似<c:foreach>标签的效果。如下就是遍历平台的所有子系统。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">loop</span> <span class="attr">items</span>=<span class="string">"app.appSet"</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">arrow</span> <span class="attr">title</span>=<span class="string">"$&#123;name&#125;"</span>&gt;</span></div><div class="line">						<span class="tag">&lt;<span class="name">para</span> <span class="attr">type</span>=<span class="string">"content"</span>&gt;</span>故障次数$&#123;data.failTotal&#125;次，其中一级故障$&#123;data.failHigh&#125;次，二次故障$&#123;data.failMiddle&#125;次，三级故障$&#123;data.failLow&#125;次。<span class="tag">&lt;/<span class="name">para</span>&gt;</span></div><div class="line">						<span class="tag">&lt;<span class="name">para</span> <span class="attr">type</span>=<span class="string">"content"</span>&gt;</span>可用性说明：本月重点人系统运行正常，业务繁忙时段xx访问测试X次，正常访问X次。<span class="tag">&lt;/<span class="name">para</span>&gt;</span></div><div class="line">					<span class="tag">&lt;/<span class="name">arrow</span>&gt;</span></div><div class="line">				<span class="tag">&lt;/<span class="name">loop</span>&gt;</span></div></pre></td></tr></table></figure></c:foreach></p>
<p>#代码实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"> String itemsName = getElementStr(ele, model, DocConstants.LOOP_ITEMS);</div><div class="line">Set apps = (Set) getObjectAttribute(model, itemsName);</div><div class="line">      <span class="keyword">if</span> (apps.isEmpty()) &#123;</div><div class="line">             procChild(doc, factory, model, ele);</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">             <span class="keyword">for</span> (Object app : apps) &#123;</div><div class="line">                 procChild(doc, factory, app, ele);</div><div class="line">             &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>#处理对象<br>首先，在模板中有很多数据，我们要获取，就一定要有一个通过反射来获取数据的方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Object result = <span class="keyword">null</span>;</div><div class="line">      Method method = obj.getClass().getMethod(</div><div class="line">             <span class="string">"get"</span> + StringUtils.firstUpperCase(tempAttr));</div><div class="line">      <span class="comment">// 判断调用方法的返回类型</span></div><div class="line">      <span class="keyword">if</span> (method != <span class="keyword">null</span>) &#123;</div><div class="line">          result = method.invoke(obj);</div><div class="line">      &#125;</div><div class="line">  <span class="keyword">return</span> result;</div></pre></td></tr></table></figure></p>
<p>#嵌套对象处理<br>如果需要处理的参数属于存在对象嵌套的，那要先处理这层关系。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getDupObjectAttribute</span><span class="params">(Object model, String val)</span> </span>&#123;</div><div class="line">        String result = <span class="keyword">null</span>;</div><div class="line">        String[] vals = val.split(<span class="string">"\\."</span>, <span class="number">2</span>);</div><div class="line">        Object object = getObjectAttribute(model, vals[<span class="number">0</span>]);</div><div class="line">        <span class="keyword">if</span>(object == <span class="keyword">null</span>)&#123;</div><div class="line">            <span class="keyword">return</span> <span class="string">"-1"</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (vals[<span class="number">1</span>].contains(<span class="string">"."</span>)) &#123;</div><div class="line">            result = getDupObjectAttribute(object, vals[<span class="number">1</span>]);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            result = (String) getObjectAttribute(object, vals[<span class="number">1</span>]);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>#处理参数<br>那么可以处理数据了，那参数要怎么从模板中寻找出来呢？第一步就是使用正则表达式来寻找需要处理的参数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//REGEX = "\\$\\&#123;([^\\&#125;]+)?\\&#125;"</span></div><div class="line">	Pattern pat = Pattern.compile(REGEX);</div><div class="line">       Matcher mat = pat.matcher(text);</div><div class="line">       String result = text;</div><div class="line">       <span class="keyword">while</span> (mat.find()) &#123;</div><div class="line">           String val = mat.group(<span class="number">1</span>);</div><div class="line">           String resultVal = <span class="keyword">null</span>;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               <span class="keyword">if</span> (val.contains(<span class="string">"."</span>)) &#123;</div><div class="line">			<span class="comment">//如果存在嵌套，则通过反射先获取</span></div><div class="line">                   resultVal = getDupObjectAttribute(model, val);</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">else</span> &#123;</div><div class="line">                   resultVal = (String) getObjectAttribute(model, val);</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">if</span>(StringUtils.isNotBlank(resultVal) &amp;&amp; !<span class="string">"-1"</span>.equals(resultVal))&#123;</div><div class="line">                   result = result.replaceFirst(<span class="string">"\\$\\&#123;"</span> + val + <span class="string">"\\&#125;"</span>, resultVal);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">catch</span>(Throwable e) &#123;</div><div class="line">               e.printStackTrace();</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> result;</div></pre></td></tr></table></figure></p>
<p>#思考<br>用Java显然对于制作模板引擎不是很擅长。之前介绍Javascript正则的时候，用20行代码，就可以实现更强大的功能，不过安全性会有一点问题。存在被植入代码的可能。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/03/24/2014-03-24-individual-thinking/" itemprop="url">
                  “下个人”思维
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2014-03-24T14:29:00+08:00" content="2014-03-24">
              2014-03-24
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/人性/" itemprop="url" rel="index">
                    <span itemprop="name">人性</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/人性/总结/" itemprop="url" rel="index">
                    <span itemprop="name">总结</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/人性/总结/利他/" itemprop="url" rel="index">
                    <span itemprop="name">利他</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/人性/总结/利他/下个人思维/" itemprop="url" rel="index">
                    <span itemprop="name">下个人思维</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/人性/总结/利他/下个人思维/高大上/" itemprop="url" rel="index">
                    <span itemprop="name">高大上</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>应该也有一周没写博文了，Deadline和坑爹的队友就像两座大山，压的我快窒息了。还好周末来了，加班一天，带着我家小妞出去瞎晃一天半，心情是好多了。唯一有点美中不足的就是，不管是忠仑公园，还是十里蓝山，总是有很多游客践踏花草，掰着花朵、躺在花朵上拍照，还有刻字到此一游的。<br>《代码整洁之道》这本书里面我最喜欢一句话，就是请保证你离开的时候，比你进来的时候更加干净。我觉得这思想可以延伸的很广，也就是我想说的，下个人思维。这也是罗胖子早上发的微信的标题，他的文章给了我很多感悟，老样子，斜体部分是转载。<br><img src="http://case.ntu.edu.tw/hs/wordpress/wp-content/uploads/2011/08/76%E7%BE%A4%E9%AB%94%E5%8B%95%E7%89%A9%E7%9A%84%E5%88%A9%E4%BB%96%E8%A1%8C%E7%82%BA.jpg" alt="thinkother.jpg"><br>什么是下个人思维，用通俗的话来说，就是做一个事情的时候，可以为下个人考虑。网上经常看到很多人抱怨，老外存在偏见，总是看不起中国人，比如去国外旅游，我们经常被当做是很没素质的群体，在外国人眼里，我们就是Touch Then Leave，自己仔细想想，是不是自己出去玩，看到东西就有一股想要去摸的冲动，我承认，我有。而作为我们的邻居，作为我们仇恨的对象，日本人在这点上我觉得做的就很好。如果你觉得我在贬低自己民族，抬高猪狗不如的小日本，那么请别看下去了吧，我只抵制蠢货不抵制日货的。<br>我觉得日本人之所以能一次又一次的崛起，无外乎两点，一个是靠着勤奋和汗水可以实现梦想的日本梦，另一个就是协作能力，也就是下个人思维。<br>日本的很多厕所都写着这么一句话“为了下一位使用者，请保持干净”。每个人在自家的厕所，很自然的会保持干净，因为下一个人可能是你的妻子、儿子、父母，但是，这是公共厕所啊，下一个人我又不认识，我干嘛要辛苦保持干净呢？但是，如果我们这么想，我们也是上一个使用厕所的人眼里的下一个人，如果他不保持干净，那我们就没法使用到干净的厕所。如果我不保持干净，那么这必定会造成恶心循环，整个卫生就变脏了。以我旅游的经验，国内大多数城市旅游景区的厕所都很不干净。厦门可能算是国内比较干净的了，江西、云南的厕所，有的甚至让人作呕。有一些比较干净的，也是建立在厕所维护人员辛勤工作的基础上的。<br>日本人的下个人思维不仅仅是在这么一张小小的提示语上的，日本人对孩子的教育也是非常注重这些人性美的品质上，日本有一个童话故事，讲的是 <em>一只小熊，拿了一筐橡子赶路。他走着走着走累了，刚巧看到一把椅子，椅背上 写着“dozo（您请）”，于是他就在椅子上坐下，想休息一会，谁知不知不觉睡着了。这时来了一只小兔，小兔很饿，他看到了橡子和“dozo”，就吃了起 来。吃完了他想，呀，我把这橡子吃了，筐就空了，那下一个来的人咋办？于是他就去采了很多葡萄，放在筐里，高高兴兴的走了。这时来了一只小狗，小狗也饿了，看到葡萄和“dozo”很高兴，坐下来把葡萄吃了。吃完了也想，呀，那下一个人咋办？于是他就去采了蘑菇放在筐里。儿童的故事嘛，这种循环往复的桥段有点多，最后一个好像是小象，他采了栗子放在筐里。然后小熊睡醒了，他惊讶的发现：吚？我的橡子变栗子了！然后高高兴兴的走了。</em><br><strong>在儿童的教育中种下这种“下一个人”的概念的日本民族很了不起。这是一种为他人着想的善意，而且，也许会经历很长很久，但为善的，终究善会回来自己身上，这种观念实则也是利己主义。</strong><br>而我们从小的教育都是血淋淋的，比如我们“美好”的生活都是革命先辈们用血和肉堆积起来的，和孩子讲这样的故事，我觉得是完全偏离的人性的基本要素。虽然我今天写下个人思维，但是我自己就不是一个很有下个人思维的人，此文最根本目的也就是警示自己而已。<br>今天扯这个“高大上”的话题，难免陷入空洞说教的泥坑，所以我也赶紧把话题收了吧。其实，我一直有一个疑问，既然自私是人类的天性，为什么全世界的历朝历代，人类又在宣扬无私和利他，为什么要跟自己较劲？为什么制造出“高尚”“道德”这样 的概念来折磨自己？搞得好，我们也相信世界上的确存在典范和楷模，搞不好，不就是虚伪是绑架是卫道士么？为什么不能像动物一样直白的丛林法则？难道这不更顺应天性符合规律吗？ <strong>难道达尔文适者生存的进化论都是胡扯的吗？</strong><br>说一个历史事件，达尔文死后，1925年英国发生了法律史上著名的猴子审判，有大量的宗教人士推动立法，比如说1925年田纳西州就立了这么一个巴特勒法案，这个法案规定，不许在课堂上讲授一个字的进化论，否则就是犯法。这个事情不细说，就说说他们对进化论证伪的其中一个依据就是，动物有很多你观察到现象，用进化论是没法解释的，比如说互惠行为，吸血蝙蝠吸一口血，然后一看旁边的小伙伴没吃着，哎我喂你一口，发生这个事。有的鸟看见有天敌来了，它率先报警，要知道它报警会危害它自己的生命，但是它就愿意干这个事。在蜜蜂里面有一种叫工蜂，工蜂是没有后代的，但是它就是辛勤地哺乳，所有活都是它干，它没有任何进化上的利益。<br>但是，从我今天的主题来看，就是下个人思维，也就是利他。其实进化的单位不是物种，不是单个的生命，是一种叫基因的东西，基因是潜藏在每个生物体内部的，整个生物演化过程是基因的一个阴谋，它就一个目的，把我这玩意儿传下去。所谓的生物体不过是它搭的一辆公共汽车而已，只是它达到目的的手段。地球上的生物所有的协作行为，最后都导致该生物的基因可以更好的传下去。<br>从这点上可以明白，原来，利他，从而长久的利己，才是人类的本质。<br>所以啊，请你下次做事情的时候，请想一下下一个人，利他，从你我做起！</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/03/13/2014-03-13-linux-shell-programming-study-notes-d-process-variables/" itemprop="url">
                  Linux Shell编程学习笔记（五）-进程变量
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2014-03-13T00:02:00+08:00" content="2014-03-13">
              2014-03-13
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Linux/bash/" itemprop="url" rel="index">
                    <span itemprop="name">bash</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Linux/bash/Shell/" itemprop="url" rel="index">
                    <span itemprop="name">Shell</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Linux/bash/Shell/进程变量/" itemprop="url" rel="index">
                    <span itemprop="name">进程变量</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="进程变量"><a href="#进程变量" class="headerlink" title="进程变量"></a>进程变量</h1><h2 id="获得当前shell的PID"><a href="#获得当前shell的PID" class="headerlink" title="$$ 获得当前shell的PID"></a>$$ 获得当前shell的PID</h2><figure class="highlight bash"><figcaption><span>$$查看当前shell</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[David@localhost study]$ ps</div><div class="line">  PID TTY          TIME CMD</div><div class="line"> 4410 pts/7    00:00:00 ps</div><div class="line">27865 pts/7    00:00:00 bash</div><div class="line">[David@localhost study]$ <span class="built_in">echo</span> $$</div><div class="line">27865</div></pre></td></tr></table></figure>
<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><p>运行个脚本，把PID写到一个文件中去。然后不让改脚本结束，打开另一个窗口查看PID是否正确。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[David@localhost study]$ cat m.sh</div><div class="line"><span class="built_in">echo</span> <span class="string">"$$"</span> &gt;m.pid</div><div class="line"><span class="keyword">while</span> <span class="literal">true</span></div><div class="line"><span class="keyword">do</span></div><div class="line">    sleep 1</div><div class="line"><span class="keyword">done</span></div><div class="line">[David@localhost study]$ sh m.sh</div></pre></td></tr></table></figure></p>
<p>再打开一个窗口输入命令查看是否正确<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[David@localhost study]$ cat m.pid</div><div class="line">6022</div><div class="line">[David@localhost study]$ ps -ef|grep m.sh</div><div class="line">David     6022  4430  0 23:07 pts/9    00:00:00 sh m.sh</div><div class="line">David     6128 29747  0 23:08 pts/8    00:00:00 grep m.sh</div></pre></td></tr></table></figure></p>
<h2 id="获取执行上一个指令的返回值（0为成功，非0为失败）"><a href="#获取执行上一个指令的返回值（0为成功，非0为失败）" class="headerlink" title="$? 获取执行上一个指令的返回值（0为成功，非0为失败）"></a>$? 获取执行上一个指令的返回值（0为成功，非0为失败）</h2><figure class="highlight bash"><figcaption><span>$?查看上一指令的结果</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[David@localhost study]$ cat testPrevResult.sh</div><div class="line"><span class="comment">#/bin/sh</span></div><div class="line"></div><div class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></div><div class="line">    success)</div><div class="line">        <span class="built_in">exit</span> 0</div><div class="line">        ;;</div><div class="line">    *)</div><div class="line">        <span class="built_in">exit</span> 1</div><div class="line">        ;;</div><div class="line"><span class="keyword">esac</span></div><div class="line">[David@localhost study]$ sh testPrevResult.sh success</div><div class="line">[David@localhost study]$ <span class="built_in">echo</span> $?</div><div class="line">0</div><div class="line">[David@localhost study]$ <span class="built_in">echo</span> $?</div><div class="line">0</div><div class="line">[David@localhost study]$ sh testPrevResult.sh erro</div><div class="line">[David@localhost study]$ <span class="built_in">echo</span> $?</div><div class="line">1</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[David@localhost study]$ hahha</div><div class="line">bash: hahha: command not found</div><div class="line">[David@localhost study]$ echo $?</div><div class="line">127</div><div class="line">[David@localhost study]$ pwd</div><div class="line">/home/David/shellwork/study</div><div class="line">[David@localhost study]$ echo $?</div><div class="line">0</div></pre></td></tr></table></figure>
<h2 id="常见返回码"><a href="#常见返回码" class="headerlink" title="常见返回码"></a>常见返回码</h2><p>0 成功<br>2 权限拒绝<br>1-125 表示运行失败，脚本命令、系统命令错误或参数错误<br>126 找到该命令但是无法执行<br>127 未找到要运行的命令<br>128 命令被系统强制结束</p>
<h2 id="例子-1"><a href="#例子-1" class="headerlink" title="例子"></a>例子</h2><p>压缩当前文件夹，如果成功则提示。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[David@localhost study]$ cat zipCurr.sh</div><div class="line"><span class="comment">#/bin/bash</span></div><div class="line"><span class="built_in">cd</span> ..</div><div class="line">tar zcf studyShell.tar.gz ./study</div><div class="line"><span class="keyword">if</span> [ $? -eq 0 ];<span class="keyword">then</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"tar success"</span></div><div class="line"><span class="keyword">else</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"tar erro"</span></div><div class="line"><span class="keyword">fi</span></div><div class="line">[David@localhost study]$ sh zipCurr.sh</div><div class="line">tar success</div><div class="line">[David@localhost study]$ <span class="built_in">cd</span> ..</div><div class="line">[David@localhost shellwork]$ ls</div><div class="line">study  studyShell.tar.gz</div></pre></td></tr></table></figure></p>
<h2 id="上一个进程的PID"><a href="#上一个进程的PID" class="headerlink" title="#!上一个进程的PID"></a>#!上一个进程的PID</h2><p>不常用，不细说。</p>
<h2 id="上一个进程的最后一个参数"><a href="#上一个进程的最后一个参数" class="headerlink" title="#_上一个进程的最后一个参数"></a>#_上一个进程的最后一个参数</h2><p>也不常用，举个栗子带过。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[David@localhost study]$ sh m.sh</div><div class="line">已杀死</div><div class="line">[David@localhost study]$ echo $_</div><div class="line">m.sh</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/03/12/2014-03-12-linux-shell-programming-study-notes-d-variables/" itemprop="url">
                  Linux Shell编程学习笔记（四）位置变量
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2014-03-12T13:18:00+08:00" content="2014-03-12">
              2014-03-12
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Linux/bash/" itemprop="url" rel="index">
                    <span itemprop="name">bash</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Linux/bash/Shell/" itemprop="url" rel="index">
                    <span itemprop="name">Shell</span>
                  </a>
                </span>

                
                
                  . 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Linux/bash/Shell/位置变量/" itemprop="url" rel="index">
                    <span itemprop="name">位置变量</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="位置变量"><a href="#位置变量" class="headerlink" title="位置变量"></a>位置变量</h1><p>$0 shell脚本的文件名，会包括路径<br>$n 第几个参数<br>$* 获取当前shell的所有参数，将所有的命令行参数视为一个字符串。<br>$# shell脚本参数的总个数<br>$@ 获取当前shell的所有参数，并保留在内嵌在参数中的任何空白，常用于传参<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">/bin/sh</div><div class="line"><span class="built_in">echo</span> <span class="string">'$0:'</span><span class="variable">$0</span></div><div class="line"><span class="built_in">echo</span> <span class="string">'$1:'</span><span class="variable">$1</span></div><div class="line"><span class="built_in">echo</span> <span class="string">'$&#123;10:&#125;'</span><span class="variable">$&#123;10&#125;</span></div><div class="line"><span class="built_in">echo</span> <span class="string">'$#:'</span><span class="variable">$#</span>                                                                    </div><div class="line"><span class="built_in">echo</span> <span class="string">'$*:'</span>$*</div><div class="line"><span class="built_in">echo</span> <span class="string">'$@:'</span><span class="variable">$@</span></div></pre></td></tr></table></figure></p>
<p>控制台输出<br>[David@localhost study]$ ./echoDolar.sh ‘seq 11’<br>0:./echoDolar.sh<br>$1:1<br>${10:}10<br>$#:11<br>$*:1 2 3 4 5 6 7 8 9 10 11<br>$@:1 2 3 4 5 6 7 8 9 10 11</p>
<h1 id="例子-0、-1"><a href="#例子-0、-1" class="headerlink" title="例子-$0、$1"></a>例子-$0、$1</h1><p>做一个小例子，接受参数，参数为start则执行start函数，stop则执行stop函数。如果都不是的话，就提示错误，并提示如何输入正确的命令。例子中用到了$0和$1。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">start</span></span>() &#123;</div><div class="line">    <span class="built_in">echo</span> <span class="string">"start"</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="title">stop</span></span>()&#123;</div><div class="line">    <span class="built_in">echo</span> <span class="string">"stop"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="title">erro</span></span>()&#123;</div><div class="line">    <span class="built_in">echo</span> <span class="string">"Argument is erro ,please input what like '<span class="variable">$0</span> start|stop'"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -ne 1 ];<span class="keyword">then</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"Argument's number is Erro,please input only one argument."</span></div><div class="line"><span class="keyword">else</span></div><div class="line">    <span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></div><div class="line">        start)</div><div class="line">            start</div><div class="line">            ;;</div><div class="line">        stop)</div><div class="line">            stop</div><div class="line">            ;;</div><div class="line">        *)</div><div class="line">            erro</div><div class="line">            ;;</div><div class="line"></div><div class="line">    <span class="keyword">esac</span></div><div class="line"><span class="keyword">fi</span></div></pre></td></tr></table></figure>
<p>控制台：<br>[David@localhost study]$ ./operByName.sh  start<br>start<br>[David@localhost study]$ ./operByName.sh  stop<br>stop<br>[David@localhost study]$ ./operByName.sh  erro<br>Argument is erro ,please input what like ‘./operByName.sh start|stop’</p>
<h1 id="例子-、"><a href="#例子-、" class="headerlink" title="例子-$*、$@"></a>例子-$*、$@</h1><p>用个例子，可以看出，加了引号后$<em>变成一个字符串，而$@仍然是多个。<br>控制台：<br>[David@localhost study]$ set – “I am” David Wu.<br>[David@localhost study]$ echo $#<br>3<br>[David@localhost study]$ echo $</em><br>I am David Wu.<br>[David@localhost study]$ echo $@<br>I am David Wu.<br>[David@localhost study]$ for i in $<em>;do echo $i;done<br>I<br>am<br>David<br>Wu.<br>[David@localhost study]$ for i in $@;do echo $i;done<br>I<br>am<br>David<br>Wu.<br>[David@localhost study]$ for i in “$@”;do echo $i;done<br>I am<br>David<br>Wu.<br>[David@localhost study]$ for i in “$</em>“;do echo $i;done<br>I am David Wu.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/7/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/9/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="David Woo" />
          <p class="site-author-name" itemprop="name">David Woo</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/">
              <span class="site-state-item-count">107</span>
              <span class="site-state-item-name">Artikel</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">195</span>
                <span class="site-state-item-name">Kategorien</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">Tags</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">David Woo</span>
</div>

<div class="powered-by">
  Erstellt mit  <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  




  
  

  

  

  

</body>
</html>
